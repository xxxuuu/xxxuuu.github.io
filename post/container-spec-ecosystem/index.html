<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>å®¹å™¨æ ‡å‡†å’Œç”Ÿæ€ | xÂ³uÂ³</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="shortcut icon" href="https://xxxuuu.me/favicon.ico?v=1723216798723">
<link rel="stylesheet" href="https://xxxuuu.me/styles/main.css">



<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<style>
:root {
  --animate-duration: 800ms;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.9/dist/vue.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-T8WGT1LJ6G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T8WGT1LJ6G');
</script>


    <meta name="description" content="OCIï¼ˆOpen Container Initiativeï¼‰
OCIï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æè®®ï¼‰ï¼Œæ˜¯å›´ç»•å®¹å™¨é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è®¾ç«‹çš„æ ‡å‡†ï¼Œåœ¨ 2015 å¹´ 6 æœˆæ¨å‡ºã€‚åŸºäº Docker æèµ çš„ run..." />
    <meta name="keywords" content="Cloud Native" />
    
      <link href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="app" class="main">

      <header class="header">
  <div class="banner animate__animated animate__fadeIn">
    <div class="top-container">
      <div class="site-title-container">
        <img src="https://xxxuuu.me/images/avatar.png?v=1723216798723" class="site-logo">
        <div class="site-text">
          <h1 class="site-title">
            xÂ³uÂ³
          </h1>
          <div class="site-description-social">
            <div class="site-description">
              ğŸ—’ ç¢ç¢å¿µ
            </div>
            <div class="site-social">
              
                
                  <a class="social-link" href="https://github.com/xxxuuu" target="_blank">
                    <i class="fa fa-github"></i>
                  </a>
                
              
                
              
                
              
                
              
                
              
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="links">
      
        
            <a href="/" class="site-nav">
              ğŸ  é¦–é¡µ
            </a>
          
        
        
            <a href="/archives" class="site-nav">
              ğŸ“ƒ å½’æ¡£
            </a>
          
        
        
            <a href="/tags" class="site-nav">
              ğŸ· æ ‡ç­¾
            </a>
          
        
        
            <a href="/post/about" class="site-nav">
              ğŸ‘¤ å…³äº
            </a>
          
        
        
            <a href="/post/friend-links/" class="site-nav">
              ğŸ‘¬ å‹é“¾
            </a>
          
        
    </div>
  </div>
</header>

      <div class="main-container">
        <div class="content-container animate__animated animate__fadeInUp">
          <div class="post-detail">
            <h2 class="post-title">å®¹å™¨æ ‡å‡†å’Œç”Ÿæ€</h2>
            <div class="post-date">2023-07-12&emsp;&emsp;4275 å­— &emsp;é˜…è¯»æ—¶é—´ 21 åˆ†é’Ÿ</div>
            
            <div class="post-content" v-pre>
              <h2 id="ociopen-container-initiative">OCIï¼ˆOpen Container Initiativeï¼‰</h2>
<p><a href="https://opencontainers.org/about/overview/">OCIï¼ˆOpen Container Initiativeï¼Œå¼€æ”¾å®¹å™¨æè®®ï¼‰</a>ï¼Œæ˜¯å›´ç»•å®¹å™¨é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶è®¾ç«‹çš„æ ‡å‡†ï¼Œåœ¨ 2015 å¹´ 6 æœˆæ¨å‡ºã€‚åŸºäº Docker æèµ çš„ <a href="https://github.com/opencontainers/runc">runC</a> å®ç°ä¹‹ä¸Šå‘å±•è€Œæ¥</p>
<p>å…¶ä¸­ï¼Œé•œåƒæ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/image-spec">image-spec</a>ï¼‰è§„å®šäº†é•œåƒå¦‚ä½•ç»„ç»‡æ–‡ä»¶å±‚ï¼Œé•œåƒé…ç½®æ–‡ä»¶æ ¼å¼</p>
<p>è¿è¡Œæ—¶æ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/runtime-spec">runtime-spec</a>ï¼‰è§„å®šäº†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå’Œéœ€è¦æ”¯æŒçš„æ“ä½œã€é…ç½®é¡¹ç­‰</p>
<p>2022 å¹´ 5 æœˆæ–°å¢åŠ äº†åˆ†å‘æ ‡å‡†ï¼ˆ<a href="https://github.com/opencontainers/distribution-spec">distribution-spec</a>ï¼‰ï¼Œè§„å®šäº†é•œåƒåˆ†å‘çš„ API åè®®ï¼ŒåŒ…æ‹¬è®¤è¯æ–¹å¼ã€Pushã€Pullã€å†…å®¹å‘ç°ã€ç®¡ç†ç­‰</p>
<h3 id="é•œåƒç»„æˆ">é•œåƒç»„æˆ</h3>
<p>OCI æ ‡å‡†ä¸­ï¼Œé•œåƒç”± indexï¼Œconfig å’Œå„ä¸ª layer ç»„æˆ<br>
<img src="https://github.com/opencontainers/image-spec/raw/main/img/build-diagram.png" alt="img-spec" width=800></p>
<p>æ‹‰å–ä¸€ä¸ª nginx é•œåƒå¹¶è§£å‹ï¼Œå¯ä»¥çœ‹åˆ°å…¶ç›®å½•æ ¼å¼</p>
<pre><code class="language-bash">$ docker pull nginx
$ docker image save nginx -o nginx.tar
$ mkdir nginx-image
$ tar -C nginx-image -xvf nginx.tar
$ tree nginx-image/
nginx-image/
â”œâ”€â”€ 180ddd9cc15d32f0c1d5f85cf442ef1179f21ae197b60bf086b0e8c7ef153737
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 2002d33a54f72d1333751d4d1b4793a60a635eac6e94a98daf0acea501580c4f.json
â”œâ”€â”€ 3cba2048aa0f37f06b8b1a3949e6b67da78d9f49fb6d5f34fefa328a304dfe8e
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 570d178d9aab5e7b03bdf17302b91cece28924d72f204567dd6c2fcb1667e883
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 5839a53cafa501af1381d6f0db2084e32bb64d0a1461a278f587cc0ea4fc62e2
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 664733ad6a589f5aa51e830e2a10c0768b854f28cc278316938c00ce1c4c60e2
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ 907ca8c9f37f4bb34cef8feea392fff0d811b7d1fff826dc84c8330c0b158227
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ ae5db48f55baf22a5d27ab7965647d55c3f6aba87733e5f0ae57188d956a8a7b
â”‚Â Â  â”œâ”€â”€ VERSION
â”‚Â Â  â”œâ”€â”€ json
â”‚Â Â  â””â”€â”€ layer.tar
â”œâ”€â”€ manifest.json
â””â”€â”€ repositories

8 directories, 24 files
</code></pre>
<p>Docker é•œåƒå¹¶ä¸ç¬¦åˆ OCI é•œåƒæ ‡å‡†ï¼Œä½† OCI çš„é•œåƒæ ‡å‡†åŸºäº Docker é•œåƒæ ‡å‡†ï¼Œå› æ­¤ä¸¤è€…åœ¨ç»“æ„ä¸Šæ˜¯ç±»ä¼¼çš„ï¼Œæœ‰ä¸€å®šå¯¹åº”å…³ç³»</p>
<p>ä½¿ç”¨ <a href="https://github.com/containers/skopeo">skopeo</a> å¯ä»¥å°† Docker é•œåƒè½¬åŒ–ä¸º OCI é•œåƒ</p>
<pre><code class="language-bash">$ skopeo copy docker-archive:nginx.tar oci:nginx-oci-image
$ tree nginx-oci-image
nginx-oci-image
â”œâ”€â”€ blobs
â”‚Â Â  â””â”€â”€ sha256
â”‚Â Â      â”œâ”€â”€ 365ede46b010c470bbbd13f6bacc0df1700116f4c3a01f25a0fab726b7860e31
â”‚Â Â      â”œâ”€â”€ 50c4949e5433b622681d55d92f68bc289ed0b91536d07b0ed88d057fd95ba2bd
â”‚Â Â      â”œâ”€â”€ 55bc6f293903816a086b9803b0fac7d6e854976aa96cfaacd66b39b4754415d0
â”‚Â Â      â”œâ”€â”€ 7a33d678a8761d2b10b60fe4da32e70e201d65550d2601f9b2e3e5fb4cc6e115
â”‚Â Â      â”œâ”€â”€ 861c679dd19193ec028cddb97f5b1e18738ec0525617ff698df4a055606af93d
â”‚Â Â      â”œâ”€â”€ af84cea3992c73a86ca5b3fcb8043f0964308be3db3dbc93222c589b15e90ba7
â”‚Â Â      â”œâ”€â”€ ba28188e316f3a7d8b65f6496a57cb9ce5f59b636ed0b0fae8bf564723321448
â”‚Â Â      â”œâ”€â”€ c26fc88390de90988b10de0590c08942dd7b1346c9ec912e9a0c763bc6de1e9e
â”‚Â Â      â””â”€â”€ f0baa6626451c47bb1cb7f72d5cb0e732283a231fa4cb001a36b55e5fc31640f
â”œâ”€â”€ index.json
â””â”€â”€ oci-layout

3 directories, 11 files
</code></pre>
<p>index.json æ˜¯ <a href="https://github.com/opencontainers/image-spec/blob/main/image-index.md">image index</a>ï¼Œç”¨äºç´¢å¼• manifest æ–‡ä»¶ï¼Œè·¨å¹³å°å’Œæ¶æ„çš„é•œåƒå¯èƒ½å¯¹æ¯ä¸€ä¸ªå¹³å°éƒ½æœ‰ä¸€ä¸ª manifest æ–‡ä»¶</p>
<pre><code class="language-bash">$ cat nginx-oci-image/index.json | json_pp
{
   &quot;manifests&quot; : [
      {
         &quot;digest&quot; : &quot;sha256:c26fc88390de90988b10de0590c08942dd7b1346c9ec912e9a0c763bc6de1e9e&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.manifest.v1+json&quot;,
         &quot;size&quot; : 1338
      }
   ],
   &quot;schemaVersion&quot; : 2
}
</code></pre>
<p><code>manifests.digest</code> ä¸­å°±æ˜¯ manifest æ–‡ä»¶æ‘˜è¦å€¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–‡ä»¶åï¼Œç”±æ­¤å¯ä»¥å¾ˆå¿«æ‰¾åˆ° manifest æ–‡ä»¶ã€‚<a href="https://github.com/opencontainers/image-spec/blob/master/manifest.md">image manifest</a> ç´¢å¼•äº†é•œåƒçš„é…ç½®å’Œ layer å±‚æ–‡ä»¶ä½ç½®åŠå…¶ç±»å‹ã€‚å¯ä»¥çœ‹å‡ºï¼Œé…ç½®æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œè€Œæ¯ä¸€å±‚æ˜¯è¿›è¡Œå‹ç¼©åå­˜å‚¨çš„ã€‚</p>
<pre><code class="language-bash">$ cat nginx-oci-image/blobs/sha256/c26fc88390de90988b10de0590c08942dd7b1346c9ec912e9a0c763bc6de1e9e | json_pp
{
   &quot;config&quot; : {
      &quot;digest&quot; : &quot;sha256:50c4949e5433b622681d55d92f68bc289ed0b91536d07b0ed88d057fd95ba2bd&quot;,
      &quot;mediaType&quot; : &quot;application/vnd.oci.image.config.v1+json&quot;,
      &quot;size&quot; : 7075
   },
   &quot;layers&quot; : [
      {
         &quot;digest&quot; : &quot;sha256:861c679dd19193ec028cddb97f5b1e18738ec0525617ff698df4a055606af93d&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 29922714
      },
      {
         &quot;digest&quot; : &quot;sha256:f0baa6626451c47bb1cb7f72d5cb0e732283a231fa4cb001a36b55e5fc31640f&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 39120911
      },
      {
         &quot;digest&quot; : &quot;sha256:ba28188e316f3a7d8b65f6496a57cb9ce5f59b636ed0b0fae8bf564723321448&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 630
      },
      {
         &quot;digest&quot; : &quot;sha256:7a33d678a8761d2b10b60fe4da32e70e201d65550d2601f9b2e3e5fb4cc6e115&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 975
      },
      {
         &quot;digest&quot; : &quot;sha256:af84cea3992c73a86ca5b3fcb8043f0964308be3db3dbc93222c589b15e90ba7&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 376
      },
      {
         &quot;digest&quot; : &quot;sha256:365ede46b010c470bbbd13f6bacc0df1700116f4c3a01f25a0fab726b7860e31&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 1234
      },
      {
         &quot;digest&quot; : &quot;sha256:55bc6f293903816a086b9803b0fac7d6e854976aa96cfaacd66b39b4754415d0&quot;,
         &quot;mediaType&quot; : &quot;application/vnd.oci.image.layer.v1.tar+gzip&quot;,
         &quot;size&quot; : 1439
      }
   ],
   &quot;mediaType&quot; : &quot;application/vnd.oci.image.manifest.v1+json&quot;,
   &quot;schemaVersion&quot; : 2
}
</code></pre>
<p><a href="https://github.com/opencontainers/image-spec/blob/main/config.md">image configuration</a> æè¿°äº†é•œåƒæ‰€å±çš„å¹³å°ï¼Œé…ç½®ï¼ˆç±»ä¼¼åœ¨ Dockerfile ä¸­å®šä¹‰çš„ç¯å¢ƒå˜é‡ã€ç«¯å£ã€ENTRYPOINTã€CMD ç­‰ï¼‰ï¼Œä»¥åŠå„ä¸ªå±‚çš„å†å²è®°å½•ï¼Œ<code>created_by</code> æ˜¯åˆ›å»ºå±‚çš„å‘½ä»¤ï¼Œ<code>empty_layer</code> è¡¨ç¤ºè¯¥å±‚æ˜¯å¦å¯¼è‡´æ–‡ä»¶ç³»ç»Ÿå˜åŒ–ã€‚æœ€åæ˜¯å„ä¸ªå±‚æœªå‹ç¼©å†…å®¹çš„æ‘˜è¦ï¼ˆ<code>diff_ids</code>ï¼‰</p>
<pre><code class="language-bash">$ cat nginx-oci-image/blobs/sha256/50c4949e5433b622681d55d92f68bc289ed0b91536d07b0ed88d057fd95ba2bd | json_pp
{
   &quot;architecture&quot; : &quot;arm64&quot;,
   &quot;config&quot; : {
      &quot;Cmd&quot; : [
         &quot;nginx&quot;,
         &quot;-g&quot;,
         &quot;daemon off;&quot;
      ],
      &quot;Entrypoint&quot; : [
         &quot;/docker-entrypoint.sh&quot;
      ],
      &quot;Env&quot; : [
         &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,
         &quot;NGINX_VERSION=1.25.1&quot;,
         &quot;NJS_VERSION=0.7.12&quot;,
         &quot;PKG_RELEASE=1~bookworm&quot;
      ],
      &quot;ExposedPorts&quot; : {
         &quot;80/tcp&quot; : {}
      },
      &quot;Labels&quot; : {
         &quot;maintainer&quot; : &quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;
      },
      &quot;StopSignal&quot; : &quot;SIGQUIT&quot;
   },
   &quot;created&quot; : &quot;2023-07-04T04:07:41.151938228Z&quot;,
   &quot;history&quot; : [
      {
         &quot;created&quot; : &quot;2023-07-04T01:57:35.692631089Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) ADD file:71fd66666294148382f2e6a09ae5e277d4c4e9c74402ab64b693a79387b67a09 in / &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T01:57:36.102524763Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  CMD [\&quot;bash\&quot;]&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:14.692138315Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  LABEL maintainer=NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:14.774865505Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  ENV NGINX_VERSION=1.25.1&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:14.852567081Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  ENV NJS_VERSION=0.7.12&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:14.931774163Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  ENV PKG_RELEASE=1~bookworm&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.172513807Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c set -x     &amp;&amp; groupadd --system --gid 101 nginx     &amp;&amp; useradd --system --gid nginx --no-create-home --home /nonexistent --comment \&quot;nginx user\&quot; --shell /bin/false --uid 101 nginx     &amp;&amp; apt-get update     &amp;&amp; apt-get install --no-install-recommends --no-install-suggests -y gnupg1 ca-certificates     &amp;&amp;     NGINX_GPGKEY=573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62;     NGINX_GPGKEY_PATH=/usr/share/keyrings/nginx-archive-keyring.gpg;     export GNUPGHOME=\&quot;$(mktemp -d)\&quot;;     found='';     for server in         hkp://keyserver.ubuntu.com:80         pgp.mit.edu     ; do         echo \&quot;Fetching GPG key $NGINX_GPGKEY from $server\&quot;;         gpg1 --keyserver \&quot;$server\&quot; --keyserver-options timeout=10 --recv-keys \&quot;$NGINX_GPGKEY\&quot; &amp;&amp; found=yes &amp;&amp; break;     done;     test -z \&quot;$found\&quot; &amp;&amp; echo &gt;&amp;2 \&quot;error: failed to fetch GPG key $NGINX_GPGKEY\&quot; &amp;&amp; exit 1;     gpg1 --export \&quot;$NGINX_GPGKEY\&quot; &gt; \&quot;$NGINX_GPGKEY_PATH\&quot; ;     rm -rf \&quot;$GNUPGHOME\&quot;;     apt-get remove --purge --auto-remove -y gnupg1 &amp;&amp; rm -rf /var/lib/apt/lists/*     &amp;&amp; dpkgArch=\&quot;$(dpkg --print-architecture)\&quot;     &amp;&amp; nginxPackages=\&quot;         nginx=${NGINX_VERSION}-${PKG_RELEASE}         nginx-module-xslt=${NGINX_VERSION}-${PKG_RELEASE}         nginx-module-geoip=${NGINX_VERSION}-${PKG_RELEASE}         nginx-module-image-filter=${NGINX_VERSION}-${PKG_RELEASE}         nginx-module-njs=${NGINX_VERSION}+${NJS_VERSION}-${PKG_RELEASE}     \&quot;     &amp;&amp; case \&quot;$dpkgArch\&quot; in         amd64|arm64)             echo \&quot;deb [signed-by=$NGINX_GPGKEY_PATH] https://nginx.org/packages/mainline/debian/ bookworm nginx\&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list             &amp;&amp; apt-get update             ;;         *)             echo \&quot;deb-src [signed-by=$NGINX_GPGKEY_PATH] https://nginx.org/packages/mainline/debian/ bookworm nginx\&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list                         &amp;&amp; tempDir=\&quot;$(mktemp -d)\&quot;             &amp;&amp; chmod 777 \&quot;$tempDir\&quot;                         &amp;&amp; savedAptMark=\&quot;$(apt-mark showmanual)\&quot;                         &amp;&amp; apt-get update             &amp;&amp; apt-get build-dep -y $nginxPackages             &amp;&amp; (                 cd \&quot;$tempDir\&quot;                 &amp;&amp; DEB_BUILD_OPTIONS=\&quot;nocheck parallel=$(nproc)\&quot;                     apt-get source --compile $nginxPackages             )                         &amp;&amp; apt-mark showmanual | xargs apt-mark auto &gt; /dev/null             &amp;&amp; { [ -z \&quot;$savedAptMark\&quot; ] || apt-mark manual $savedAptMark; }                         &amp;&amp; ls -lAFh \&quot;$tempDir\&quot;             &amp;&amp; ( cd \&quot;$tempDir\&quot; &amp;&amp; dpkg-scanpackages . &gt; Packages )             &amp;&amp; grep '^Package: ' \&quot;$tempDir/Packages\&quot;             &amp;&amp; echo \&quot;deb [ trusted=yes ] file://$tempDir ./\&quot; &gt; /etc/apt/sources.list.d/temp.list             &amp;&amp; apt-get -o Acquire::GzipIndexes=false update             ;;     esac         &amp;&amp; apt-get install --no-install-recommends --no-install-suggests -y                         $nginxPackages                         gettext-base                         curl     &amp;&amp; apt-get remove --purge --auto-remove -y &amp;&amp; rm -rf /var/lib/apt/lists/* /etc/apt/sources.list.d/nginx.list         &amp;&amp; if [ -n \&quot;$tempDir\&quot; ]; then         apt-get purge -y --auto-remove         &amp;&amp; rm -rf \&quot;$tempDir\&quot; /etc/apt/sources.list.d/temp.list;     fi     &amp;&amp; ln -sf /dev/stdout /var/log/nginx/access.log     &amp;&amp; ln -sf /dev/stderr /var/log/nginx/error.log     &amp;&amp; mkdir /docker-entrypoint.d&quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.509711194Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) COPY file:7b307b62e82255f040c9812421a30090bf9abf3685f27b02d77fcca99f997911 in / &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.592126807Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) COPY file:5c18272734349488bd0c94ec8d382c872c1a0a435cca13bd4671353d6021d2cb in /docker-entrypoint.d &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.669169781Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) COPY file:d4375883ed5db364232ccf781e8ad28514cd005edb385d43dbfb984f2c63edb9 in /docker-entrypoint.d &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.748027972Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) COPY file:36429cfeeb299f9913b84ea136b004be12fbe4bb4f975a977a3608044e8bfa91 in /docker-entrypoint.d &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.825522699Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop) COPY file:e57eef017a414ca793499729d80a7b9075790c9a804f930f1417e56d506970cf in /docker-entrypoint.d &quot;
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.903102418Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  ENTRYPOINT [\&quot;/docker-entrypoint.sh\&quot;]&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:40.983008834Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  EXPOSE 80&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:41.065899155Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  STOPSIGNAL SIGQUIT&quot;,
         &quot;empty_layer&quot; : true
      },
      {
         &quot;created&quot; : &quot;2023-07-04T04:07:41.151938228Z&quot;,
         &quot;created_by&quot; : &quot;/bin/sh -c #(nop)  CMD [\&quot;nginx\&quot; \&quot;-g\&quot; \&quot;daemon off;\&quot;]&quot;,
         &quot;empty_layer&quot; : true
      }
   ],
   &quot;os&quot; : &quot;linux&quot;,
   &quot;rootfs&quot; : {
      &quot;diff_ids&quot; : [
         &quot;sha256:efd1965f1684506744544d66c57387a60bd89607480e2dbc89bf3e8a30081bc1&quot;,
         &quot;sha256:c58d5a26ffa8db76c403fb4c29965689bb96d291f6b7973fcd2da7458e77b09f&quot;,
         &quot;sha256:4e6bef96e37ee051573dda6c367adb7310ef7a87128ce00fcf0ce2cbd2d8779b&quot;,
         &quot;sha256:ad6517b0c9140f029ee765885ec82f571513bc8db2f834aa1d204f67d61cad12&quot;,
         &quot;sha256:7cd1e5cbf1244b4fcca08e842c7672aba5ead973c2a4532496278aa5846802a3&quot;,
         &quot;sha256:45437bbd87f23643f7893993d62b4affddbdf91808ff8cd0530b301acbc5f120&quot;,
         &quot;sha256:0a13d2aaa54c14621a732a3ffe6f25a487aa726529ad152c4174d2e741b7ef66&quot;
      ],
      &quot;type&quot; : &quot;layers&quot;
   },
   &quot;variant&quot; : &quot;v8&quot;
}
</code></pre>
<p>å¦‚æœå¯¹å±‚è¿›è¡Œè§£å‹ï¼Œå°±å¯ä»¥å¾—åˆ°é‡Œé¢æ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹</p>
<pre><code class="language-bash">$ mkdir rootfs
$ tar -zxvf nginx-oci-image/blobs/sha256/861c679dd19193ec028cddb97f5b1e18738ec0525617ff698df4a055606af93d -C rootfs/
$ tree rootfs -L 1
rootfs
â”œâ”€â”€ bin -&gt; usr/bin
â”œâ”€â”€ boot
â”œâ”€â”€ dev
â”œâ”€â”€ etc
â”œâ”€â”€ home
â”œâ”€â”€ lib -&gt; usr/lib
â”œâ”€â”€ media
â”œâ”€â”€ mnt
â”œâ”€â”€ opt
â”œâ”€â”€ proc
â”œâ”€â”€ root
â”œâ”€â”€ run
â”œâ”€â”€ sbin -&gt; usr/sbin
â”œâ”€â”€ srv
â”œâ”€â”€ sys
â”œâ”€â”€ tmp
â”œâ”€â”€ usr
â””â”€â”€ var

19 directories, 0 files
</code></pre>
<h3 id="è¿è¡Œæ—¶">è¿è¡Œæ—¶</h3>
<p>runC æ˜¯çº¯ç²¹çš„ runtimeï¼ŒOCI çš„ runtime-spec åŸºäº runC åˆ¶å®š</p>
<p>è¦å¯åŠ¨ runCï¼ˆæˆ–å…¶å®ƒç¬¦åˆ OCI runtime-spec çš„è¿è¡Œæ—¶ï¼‰ï¼Œéœ€è¦ä¸€ä¸ª rootfs å’Œ <code>config.json</code>ï¼Œrootfs å°±æ˜¯å®¹å™¨è¿è¡Œçš„æ–‡ä»¶ç³»ç»Ÿï¼Œ<code>config.json</code> åˆ™å®šä¹‰äº†è¿è¡Œçš„é…ç½®</p>
<p>rootfs å¯ä»¥ä»é•œåƒ layer ä¸­ä¸€å±‚å±‚è§£åŒ…åˆå¹¶å¾—åˆ°ã€‚<code>config.json</code> çš„ä¸€ä¸ªå¯èƒ½ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
  &quot;ociVersion&quot;: &quot;0.1.0&quot;,
  &quot;root&quot;: {
    &quot;path&quot;: &quot;rootfs&quot;,
    &quot;readonly&quot;: true
  },
  &quot;mounts&quot;: [
    {
      &quot;destination&quot;: &quot;/data&quot;,
      &quot;type&quot;: &quot;none&quot;,
      &quot;source&quot;: &quot;/volumes/testing&quot;,
      &quot;options&quot;: [&quot;rbind&quot;,&quot;rw&quot;]
    }
  ],
  &quot;process&quot;: {
    &quot;env&quot;: [
      &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,
      &quot;TERM=xterm&quot;
    ],
    &quot;args&quot;: [&quot;sh&quot;]
  }
}
</code></pre>
<p>é€šè¿‡ <code>runc run</code> å³å¯å¯åŠ¨å®¹å™¨ï¼Œä¼šè‡ªåŠ¨è¯»å–è·¯å¾„ä¸‹çš„ <code>config.json</code>ã€‚å…¶ä¸­ <code>root.path</code> æŒ‡å®šäº† rootfs çš„è·¯å¾„</p>
<p><code>config.json</code> çš„é…ç½®å’Œå¹³å¸¸ä½¿ç”¨çš„ Docker ç­‰åŸºæœ¬éƒ½èƒ½å¤§è‡´å¯¹ä¸Šï¼Œä½† runC æ˜¯ä¸åŒ…æ‹¬ç½‘ç»œå®ç°çš„ï¼Œé€šè¿‡ <code>runc exec</code> è¿›å…¥å®¹å™¨å†…å°±å¯ä»¥å‘ç°åªæœ‰ä¸€å¼  loop ç½‘å¡</p>
<p>è¿™äº›éƒ¨åˆ†æ˜¯ç•™ç»™æ›´é«˜çº§çš„å®¹å™¨è¿è¡Œæ—¶å»å®Œæˆï¼Œä¾‹å¦‚å¯ä»¥åœ¨æ ‡å‡†ä¸­ç”Ÿå‘½å‘¨æœŸçš„ <code>createContainer</code> å’Œ <code>start</code> ä¹‹é—´è¿›è¡Œç½‘å¡åˆ›å»ºï¼Œå­˜å‚¨æŒ‚è½½ç­‰æ“ä½œ</p>
<p>runtime è¿™å—è¿˜æœ‰ä¸€äº›æœ‰æ„æ€çš„å®ç°ï¼Œæ¯”å¦‚ <a href="https://katacontainers.io/">Kata</a> å’Œ <a href="https://gvisor.dev/">gVisor</a> ä¹‹ç±»çš„å†…æ ¸å®¹å™¨ï¼Œå‰è€…ç»™å®¹å™¨è·‘äº†ä¸€ä¸ªå®Œæ•´çš„ VMMï¼ˆQEMU/KVM ç­‰ï¼‰æ¥åšå†…æ ¸éš”ç¦»ï¼Œåè€…ç»™æ¯ä¸ªå®¹å™¨å¡äº†ä¸€ä¸ª Go å†™çš„æ¨¡æ‹Ÿå†…æ ¸ï¼Œé‡å®šå‘æ‰€æœ‰ syscall è¿‡å»ï¼Œä»£æ›¿å®¿ä¸»æœºå†…æ ¸</p>
<h3 id="ä¸€äº›å†å²">ä¸€äº›å†å²</h3>
<p>åœ¨æ—©æœŸï¼ŒDocker æ‹¥æœ‰å®¹å™¨é¢†åŸŸçš„ç»å¯¹é¢†å¯¼æƒï¼Œä½†ä½œä¸ºä¸€ä¸ªå•†ä¸šå…¬å¸ï¼Œè¿™å®é™…ä¸Šå¼•å‘äº†å…¶å®ƒå…¬å¸ï¼ˆRed Hatã€Google ç­‰ï¼‰çš„ä¸æ»¡å’Œæ‹…å¿§</p>
<p>Google ä¹Ÿå°è¯•è¿‡å¼€æºè‡ªèº«çš„å®¹å™¨æ–¹æ¡ˆï¼Œä½†æœªèƒ½æˆåŠŸã€‚å› æ­¤ Google å‘ Docker æè®®å…±åŒæ¨åŠ¨ä¸€ä¸ªä¸­ç«‹çš„å®¹å™¨è¿è¡Œæ—¶ä½œä¸º Docker é¡¹ç›®çš„æ ¸å¿ƒä¾èµ–ï¼Œä½†æ²¡æœ‰å¾—åˆ° Docker çš„åŒæ„</p>
<p>åœ¨ 2015 å¹´ï¼ŒDocker å…¬å¸çš„å¼ºåŠ¿é•¿æœŸé¥±å—ç¤¾åŒºè¯Ÿç—…ï¼Œä¸ºäº†è¡¨ç¤ºè¯šæ„ï¼ŒDocker å’Œ Googleã€Red Hatã€CoreOS å†³å®šæˆç«‹ä¸€ä¸ªã€Œä¸­ç«‹ã€çš„åŸºé‡‘ä¼šï¼Œå…±åŒåˆ¶å®šä¸€å¥—å®¹å™¨çš„æ ‡å‡†å’Œè§„èŒƒï¼Œè¿™å¥—æ ‡å‡†å°±æ˜¯ OCIã€‚Docker ä¹Ÿå°†è‡ªèº«çš„ libcontainer æå‡ºï¼Œæ”¹åä¸º runCï¼Œä½œä¸º OCI æ ‡å‡†åˆ¶å®šçš„åŸºç¡€</p>
<p>Docker ä½œä¸ºå½“æ—¶å®¹å™¨çš„äº‹å®æ ‡å‡†ï¼Œæœ¬èº«å¹¶æ— å¤šå¤§åŠ¨åŠ›å»æ¨è¿› OCI çš„å‘å±•ï¼ŒOCI ä¹Ÿæœªèƒ½å‰Šå¼± Docker çš„åœ°ä½ã€‚Google å’Œ Red Hat åˆ©ç”¨è‡ªå·±åœ¨å¤§è§„æ¨¡é›†ç¾¤å’Œå¹³å°ä¸Šçš„ç»éªŒï¼Œåˆæˆç«‹äº† CNCFï¼ˆCloud Native Computing Foundationï¼‰ï¼Œä»¥ Google å†…éƒ¨çš„ Borg å­µåŒ–å‡ºçš„ Kubernetes é¡¹ç›®ä¸ºåŸºç¡€ï¼Œä»å¹³å°ä¾§æ¶ç©º Dockerï¼Œä»ç°åœ¨æ¥çœ‹ï¼Œè¿™ä¸ªæˆ˜ç•¥éå¸¸æˆåŠŸï¼ŒDocker Swarm é¢å¯¹ Kubernetes æ— ç–‘æ˜¯å¤±è´¥çš„ï¼ŒSwarm é¡¹ç›®è¢«å–æ¶ˆï¼ŒDocker ä¼ä¸šç‰ˆç›´æ¥å†…ç½® Kubernetesï¼Œæ”¾å¼ƒå¼€æºç¤¾åŒºç«äº‰ï¼Œè¿›è¡Œå•†ä¸šåŒ–è½¬å‹ã€‚ç°åœ¨ï¼ŒCNCF æ¶‰åŠè¶Šæ¥è¶Šå¤šçš„é¢†åŸŸï¼Œæˆä¸ºäº†äº‘åŸç”Ÿæ–°çš„ç»å¯¹æƒå¨</p>
<h2 id="é«˜çº§å®¹å™¨è¿è¡Œæ—¶">é«˜çº§å®¹å™¨è¿è¡Œæ—¶</h2>
<p>runC åªå®ç°äº† OCI çš„ runtime-specï¼ˆè¿™å¥è¯æœ‰ç‚¹åˆ«æ‰­ï¼Œæ˜¯å…ˆæœ‰çš„ runCï¼Œæ‰æœ‰çš„ OCIï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯æ— æ³•å¤„ç†é•œåƒçš„ï¼Œåªè´Ÿè´£è¿è¡Œè¿›ç¨‹å’Œéš”ç¦»ã€‚è¿™æ˜¯ä¸€ç§ä½çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œè€Œä¸” OCI ä¹Ÿåªä¸“æ³¨æ ¸å¿ƒçš„å®¹å™¨åŠŸèƒ½ï¼Œç½‘ç»œã€å­˜å‚¨æ ‡å‡†éƒ½æ²¡æœ‰è¿›è¡Œå®šä¹‰ï¼ˆç›®å‰æ¯”è¾ƒæµè¡Œçš„ç½‘ç»œå’Œå­˜å‚¨æ ‡å‡†åˆ†åˆ«æ˜¯ <a href="https://github.com/containernetworking/cni">CNI</a> å’Œ <a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">CSI</a>ï¼‰</p>
<p>æ›´å¤šæ—¶å€™ï¼Œæˆ‘ä»¬æŒ‡çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯é«˜çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œé«˜çº§å®¹å™¨è¿è¡Œæ—¶æœ€åŸºæœ¬çš„åŠŸèƒ½å°±æ˜¯èƒ½å¤Ÿå°†é•œåƒå¤„ç†æˆ rootfs æ¥ä¼ é€’ç»™ runC ç­‰ä½çº§è¿è¡Œæ—¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­è¿˜è¦å¤„ç†é•œåƒçš„ layer å…±äº«ç­‰å¾ˆå¤šé—®é¢˜ã€‚é€šå¸¸ä¹Ÿä¼šåŒ…æ‹¬ç›‘æ§ã€æ—¥å¿—ã€ç®¡ç†ã€API ç­‰æ›´å¤šåŠŸèƒ½</p>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/cncf-container-runtime.png" alt="container-runtime" width=800>
<h3 id="containerd">containerd</h3>
<p>ä¸€ä¸ªå…¸å‹çš„é«˜çº§å®¹å™¨è¿è¡Œæ—¶å°±æ˜¯ containerdï¼ˆæœ€å…¸å‹çš„åº”è¯¥æ˜¯ Dockerï¼Œä½†å¤§å®¶éƒ½å¤ªç†Ÿæ‚‰äº†å°±æ‡’å¾—è¯´äº†ï¼‰ï¼Œcontainerd ä» Docker é¡¹ç›®ä¸­ç‹¬ç«‹å‡ºæ¥</p>
<img src="https://containerd.io/img/architecture.png" alt="containerd-arch" width=800>
<p><em>â¬†ï¸ Docker æ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œä»¥è‡³äºåœ¨è¿™é‡Œç”šè‡³å°†å®ƒåˆ’åˆ†ä¸ºäº†ä¸€ä¸ªå¹³å°</em></p>
<p>containerd çš„å®ç°é«˜åº¦æ¨¡å—åŒ–ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´ä½¿ç”¨ ttrpcï¼ˆgRPC çš„æ”¹è‰¯ï¼‰é€šä¿¡ï¼Œå¹¶ä¸”æ”¯æŒé€šè¿‡æ’ä»¶æ¥æ‰©å±•ã€‚containerd ä¸­é»˜è®¤ä½¿ç”¨ runC ä½œä¸ºä½çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œä¹Ÿæ”¯æŒæ ¹æ®å¹³å°å’Œéœ€æ±‚æ›¿æ¢æˆ runhcsã€Kata ç­‰</p>
<p>containerd æ²¡æœ‰æ‰“åŒ…ç½‘ç»œå’Œå­˜å‚¨çš„å®ç°ï¼Œåƒç½‘ç»œå°±æ˜¯ä½¿ç”¨ CNI æ¥è®©å¤–éƒ¨æä¾›å…·ä½“å®ç°</p>
<p>containerd çš„è®¾è®¡ç›®æ ‡æ˜¯æˆä¸ºæ›´é«˜çº§ç³»ç»Ÿä¸­çš„ä¸€ä¸ªç»„ä»¶æ¥è¢«è°ƒç”¨ï¼Œè€Œéç›´æ¥æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ï¼ŒDocker ç›®å‰å°±æ˜¯é€šè¿‡ containerd æ¥ç®¡ç†å®¹å™¨</p>
<h3 id="cri-o">CRI-O</h3>
<p>CRI-O çš„ç›®çš„æ˜¯æ„å»ºä¸€ä¸ªæœ€ç®€å•çš„ K8s ä¸“ç”¨è¿è¡Œæ—¶ï¼Œæ˜¯ä¸€ä¸ªæœ€å°åŒ–çš„å®ç°ï¼Œä¸éœ€è¦é¢å‘æœ€ç»ˆç”¨æˆ·çš„é‚£äº›å¤æ‚åŠŸèƒ½</p>
<img src="https://cri-o.io/assets/images/architecture.png" alt="cri-o-arch" width=800>
<p>å½“ä¸€ä¸ª kubelet çš„åˆ›å»ºè¯·æ±‚æ¥ä¸´æ—¶ï¼š</p>
<ol>
<li>CRI-O ä¼šæ‹‰å–é•œåƒï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰</li>
<li>å°†é•œåƒè§£å‹ï¼Œæ„å»º rootfs å’Œ OCI runtime-spec çš„ <code>config.json</code></li>
<li>è°ƒç”¨ä½å±‚çš„ OCI runtimeï¼ˆrunC ç­‰ï¼‰</li>
<li>æ¯ä¸ªå®¹å™¨ç”±ä¸€ä¸ª conmon è¿›ç¨‹è¿›è¡Œç›‘æ§ï¼Œå®ƒä¼šä¸º PID ä¸º 1 çš„è¿›ç¨‹æä¾›ä¸€ä¸ª <code>pty</code>ï¼ŒåŒæ—¶å¤„ç†æ—¥å¿—å’Œè®°å½•é€€å‡ºä»£ç </li>
<li>é€šè¿‡ CNI è°ƒç”¨ç½‘ç»œæ’ä»¶é…ç½®ç½‘ç»œ</li>
</ol>
<h3 id="podman">Podman</h3>
<p>containerd å’Œ CRI-O éƒ½ä¸æ˜¯ç›´æ¥é¢å‘ç”¨æˆ·çš„ï¼Œé¢å‘ç”¨æˆ·çš„å®¹å™¨è¿è¡Œæ—¶æœ€å…¸å‹çš„å°±æ˜¯ Dockerï¼Œè€Œ Podman ä¹Ÿæ˜¯ä¸€ä¸ª Docker çš„ç«å“ï¼Œç”± Red Hat æ¨å‡º</p>
<p>Podman å…¼å®¹å¤§éƒ¨åˆ†çš„ Docker å‘½ä»¤ï¼Œç”šè‡³å¯ä»¥ç›´æ¥ <code>alias podman=docker</code> æ¥æ— ç¼æ›¿æ¢ã€‚</p>
<p>Podman çš„ç‰¹è‰²åœ¨äºå¯¹ rootless container çš„è‰¯å¥½æ”¯æŒï¼Œè¿™èƒ½å¸¦æ¥æ›´å¥½çš„å®‰å…¨æ€§ï¼›å¦å¤–æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯ Pod æ¨¡å¼ï¼Œèƒ½ç›´æ¥ä»ä¸€ä¸ª K8s çš„ Pod YAML ä¸­æ¥è¿è¡Œå®¹å™¨</p>
<h2 id="cricontainer-runtime-interface">CRIï¼ˆContainer Runtime Interfaceï¼‰</h2>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md">CRIï¼ˆContainer Runtime Interfaceï¼‰</a> æ˜¯ K8s çš„ä¸€å¥—å®¹å™¨æ¥å£åè®®ï¼Œç”¨äº kubelet å’Œå®¹å™¨è¿è¡Œæ—¶ä¹‹é—´çš„é€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–å…·ä½“å®ç°</p>
<p>OCI runtime-spec æ˜¯é¢å‘ä½çº§å®¹å™¨è¿è¡Œæ—¶çš„æ ‡å‡†ï¼Œè€Œ CRI æ˜¯é¢å‘é«˜çº§å®¹å™¨è¿è¡Œæ—¶çš„åè®®ï¼Œè¿˜åŒ…æ‹¬äº†ä¸€äº› Pod æ˜ å°„åˆ°å®¹å™¨æ‰€éœ€çš„ç›¸å…³æ¥å£ï¼Œå…¶åŸºäº gRPCï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹</p>
<pre><code>service RuntimeService {
    rpc Version(VersionRequest) returns (VersionResponse) {}
    rpc RunPodSandbox(RunPodSandboxRequest) returns (RunPodSandboxResponse) {}
    rpc StopPodSandbox(StopPodSandboxRequest) returns (StopPodSandboxResponse) {}
    rpc RemovePodSandbox(RemovePodSandboxRequest) returns (RemovePodSandboxResponse) {}
    rpc PodSandboxStatus(PodSandboxStatusRequest) returns (PodSandboxStatusResponse) {}
    rpc ListPodSandbox(ListPodSandboxRequest) returns (ListPodSandboxResponse) {}
    rpc CreateContainer(CreateContainerRequest) returns (CreateContainerResponse) {}
    rpc StartContainer(StartContainerRequest) returns (StartContainerResponse) {}
    rpc StopContainer(StopContainerRequest) returns (StopContainerResponse) {}
    rpc RemoveContainer(RemoveContainerRequest) returns (RemoveContainerResponse) {}
    rpc ListContainers(ListContainersRequest) returns (ListContainersResponse) {}
    rpc ContainerStatus(ContainerStatusRequest) returns (ContainerStatusResponse) {}
    rpc UpdateContainerResources(UpdateContainerResourcesRequest) returns (UpdateContainerResourcesResponse) {}
    rpc ReopenContainerLog(ReopenContainerLogRequest) returns (ReopenContainerLogResponse) {}
    rpc ExecSync(ExecSyncRequest) returns (ExecSyncResponse) {}
    rpc Exec(ExecRequest) returns (ExecResponse) {}
    rpc Attach(AttachRequest) returns (AttachResponse) {}
    rpc PortForward(PortForwardRequest) returns (PortForwardResponse) {}
    rpc ContainerStats(ContainerStatsRequest) returns (ContainerStatsResponse) {}
    rpc ListContainerStats(ListContainerStatsRequest) returns (ListContainerStatsResponse) {}
    rpc PodSandboxStats(PodSandboxStatsRequest) returns (PodSandboxStatsResponse) {}
    rpc ListPodSandboxStats(ListPodSandboxStatsRequest) returns (ListPodSandboxStatsResponse) {}
    rpc UpdateRuntimeConfig(UpdateRuntimeConfigRequest) returns (UpdateRuntimeConfigResponse) {}
    rpc Status(StatusRequest) returns (StatusResponse) {}
    rpc CheckpointContainer(CheckpointContainerRequest) returns (CheckpointContainerResponse) {}
    rpc GetContainerEvents(GetEventsRequest) returns (stream ContainerEventResponse) {}
    rpc ListMetricDescriptors(ListMetricDescriptorsRequest) returns (ListMetricDescriptorsResponse) {}
    rpc ListPodSandboxMetrics(ListPodSandboxMetricsRequest) returns (ListPodSandboxMetricsResponse) {}
}

service ImageService {
    rpc ListImages(ListImagesRequest) returns (ListImagesResponse) {}
    rpc ImageStatus(ImageStatusRequest) returns (ImageStatusResponse) {}
    rpc PullImage(PullImageRequest) returns (PullImageResponse) {}
    rpc RemoveImage(RemoveImageRequest) returns (RemoveImageResponse) {}
    rpc ImageFsInfo(ImageFsInfoRequest) returns (ImageFsInfoResponse) {}
}
</code></pre>
<p>æ—©æœŸï¼ˆ1.6 ç‰ˆæœ¬ä¹‹å‰ï¼‰K8s æ˜¯ç›´æ¥è°ƒç”¨ Docker API çš„ï¼Œä½†éšç€å®¹å™¨ç”Ÿæ€çš„å‘å±•ï¼Œå„ä¸ªå®¹å™¨è¿è¡Œæ—¶éƒ½å¸Œæœ›èƒ½åœ¨ K8s è¿™æºä¸€è„šï¼Œè¿™ä¸º kubelet çš„ç»´æŠ¤å¸¦æ¥äº†å¾ˆå¤§çš„è´Ÿæ‹…ã€‚å› æ­¤å°±æœ‰äº† CRIã€‚åœ¨è¿‡æ¸¡æœŸæ—¶ä¸ºäº†ä¿æŒå…¼å®¹ï¼ŒK8s å†…ç½®äº† dockershim ä½œä¸º CRI è¯·æ±‚åˆ° Docker API çš„é€‚é…å™¨ï¼Œåæ¥ K8s çš„æ‰€è°“ã€Œå¼ƒç”¨ Dockerã€æŒ‡çš„ containerd æˆç†Ÿåä¸å†å•ç‹¬ä¸º Docker ç»´æŠ¤ä¸€å¥—æ¥å£é€‚é…å™¨ï¼ˆdockershimï¼‰ï¼Œè€Œæ˜¯ç›´æ¥é‡‡ç”¨ CRI æ¥å£ï¼Œå„ä¸ª shimï¼ˆæ¥å£é€‚é…å™¨ï¼‰éœ€è¦ç”±ç”¨æˆ·è‡ªå·±å®‰è£…ï¼Œè„±ç¦»å‡º K8s çš„ä»£ç ï¼Œäºæ˜¯å°±æœ‰äº†è¯¥è¯´æ³•</p>
<h2 id="wasm">WASM</h2>
<p>ä¹‹å‰å°±æœ‰çœ‹åˆ°ç±»ä¼¼ã€ŒWASM+WASI æ›¿ä»£ Dockerã€çš„è¯´æ³•ï¼Œä¸€ç›´ä¸æ˜¯å¾ˆèƒ½ç†è§£ï¼ŒWASM åœ¨æˆ‘çš„è®¤çŸ¥ä¸­åº”è¯¥æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒWASI æ˜¯ WASM çš„ç³»ç»Ÿæ¥å£ï¼Œä¸ºäº†è®© WASM è¿è¡Œåœ¨éæµè§ˆå™¨çš„ native ç¯å¢ƒä¸­ï¼ˆåƒ Node ä¸€æ ·ï¼‰ã€‚å› æ­¤ WASM+WASI çš„å¯¹æ¯”å¯¹è±¡åº”è¯¥æ˜¯ç±»ä¼¼ JVM ä¸€æ ·çš„ä¸œè¥¿ï¼Œä¸ºä»€ä¹ˆä¸å®¹å™¨æ‰¯ä¸Šäº†å…³ç³»ï¼Ÿ</p>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/wasm1.png" alt="wasm-arch" width=800>
<p>å‚è€ƒè¿™ç¯‡æ–‡ç« å’Œ Docker çš„å®˜æ–¹æ–‡æ¡£</p>
<ol>
<li>https://wasmlabs.dev/articles/docker-without-containers/</li>
<li>https://www.docker.com/blog/docker-wasm-technical-preview/</li>
</ol>
<p>ç®€å•æ¥è¯´ï¼ŒWasmEdge æä¾›äº†ä¸€ä¸ªç¬¦åˆ OCI runtime-spec çš„ WASI è¿è¡Œæ—¶ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ WasmEdge æ›¿ä»£ Docker ä¸­çš„å®¹å™¨è¿è¡Œæ—¶ã€‚åŒæ—¶é•œåƒä¸éœ€è¦åŒ…å«æ“ä½œç³»ç»Ÿæˆ–ä»»ä½•åŸºç¡€é•œåƒï¼Œå•ä¸ª <code>.wasm</code> äºŒè¿›åˆ¶æ–‡ä»¶å°±å¯ä»¥ç›´æ¥æ‰§è¡Œ</p>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/wasm2.png" alt="wasm-arch-2" width=800>
<p>ä¸ºä»€ä¹ˆ WASM+WASI çš„æ–¹å¼è¢«æ¨å´‡ï¼š</p>
<ol>
<li>å¼€æ”¾ï¼Œä¸šç•Œå¹¿æ³›é‡‡ç”¨çš„æ ‡å‡†ï¼Œå¼€æºç¤¾åŒºç”Ÿæ€åŠ æˆ</li>
<li>å¿«é€Ÿï¼Œæ²¡æœ‰ VM æˆ–å®¹å™¨çš„å†·å¯åŠ¨</li>
<li>å®‰å…¨ï¼Œæ²™ç›’è¿è¡Œ</li>
<li>å¯ç§»æ¤ï¼Œæ”¯æŒå¤§å¤šæ•° CPU å’Œæ“ä½œç³»ç»Ÿ</li>
<li>é«˜æ•ˆï¼Œæœ€å°å†…å­˜å’Œ CPU å ç”¨</li>
</ol>
<p>ä½†ç›®å‰æ¥è®²ç”Ÿæ€è¿˜ä¸å¤Ÿå®Œå–„ï¼Œä¸»è¦åœ¨äºå¾ˆå¤šè¯­è¨€å¯¹ç¼–è¯‘ä¸º <code>.wasm</code> æœ‰è¯¸å¤šé™åˆ¶ï¼Œå¤§é‡å¸¸ç”¨çš„ä¾èµ–åº“ä¸è¿›è¡Œä¿®æ”¹çš„è¯éƒ½æ— æ³•ç¼–è¯‘ã€‚åŒæ—¶ä½œä¸ºå®¹å™¨ runtime çš„è¯æ²¡æœ‰ Linux å†…æ ¸ï¼Œä¹Ÿå¯¼è‡´å¾ˆå¤š specific çš„åŠŸèƒ½æ— æ³•å®ç°ã€‚æ˜æ˜¾ä¼˜åŠ¿åŸºæœ¬åªæœ‰é•œåƒéå¸¸è½»é‡äº†ï¼Œå¤§å°åœ¨å‡ ç™¾ K åˆ°å‡  Mï¼Œé€‚åˆçš„åœºæ™¯è¿˜æ˜¯åƒ WasmEdge æœ¬èº«çš„åå­—ä¸€æ ·ï¼Œåšäº›åº”ç”¨å±‚çš„ Edge Computing å§</p>

            </div>

            <div class="not-by-ai">
              <img src="/media/images/not-by-ai-cn.svg"/>
              <img src="/media/images/not-by-ai-jp.svg"/>
              <img src="/media/images/not-by-ai-en.svg"/>
            </div>

            
              <div class="tag-container">
                
                  <a href="https://xxxuuu.me/tag/7-RPfhUxG/" class="tag">
                    Cloud Native
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://xxxuuu.me/post/vim-as-an-ide/">
                  <h3 class="post-title">
                    Vim as an IDE
                  </h3>
                </a>
              </div>
            

            
            
              <div id="giscus" class="giscus">
                <script src="https://giscus.app/client.js" data-repo="xxxuuu/xxxuuu.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg=" data-category="Announcements"  data-category-id="DIC_kwDOCwLAgM4ChgWc" data-mapping="title"  data-strict="0"  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script>
              </div>
            
          </div>

          

<div class="post-toc animate__animated animate__fadeInUp">
  <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#ociopen-container-initiative">OCIï¼ˆOpen Container Initiativeï¼‰</a>
<ul>
<li><a href="#%E9%95%9C%E5%83%8F%E7%BB%84%E6%88%90">é•œåƒç»„æˆ</a></li>
<li><a href="#%E8%BF%90%E8%A1%8C%E6%97%B6">è¿è¡Œæ—¶</a></li>
<li><a href="#%E4%B8%80%E4%BA%9B%E5%8E%86%E5%8F%B2">ä¸€äº›å†å²</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6">é«˜çº§å®¹å™¨è¿è¡Œæ—¶</a>
<ul>
<li><a href="#containerd">containerd</a></li>
<li><a href="#cri-o">CRI-O</a></li>
<li><a href="#podman">Podman</a></li>
</ul>
</li>
<li><a href="#cricontainer-runtime-interface">CRIï¼ˆContainer Runtime Interfaceï¼‰</a></li>
<li><a href="#wasm">WASM</a></li>
</ul>
</li>
</ul>

</div>


<script>
  let lastTop = 0, linkList = [], headList = [], postBody, lastIndex = -1;
  let activeClass = 'active-toc';
  let tocContent;

  function addActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.remove(activeClass);
    }
  }

  function getElementTop (el) {
    let actualTop = el.offsetTop
    let current = el.offsetParent
    while (current !== null) {
      actualTop += current.offsetTop
      current = current.offsetParent
    }
    return actualTop
  }

  function syncActiveClass() {
    if (linkList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop;
    let eps = window.innerHeight;

    let current = 0, closestOffset = 0x3f3f3f3f, hasFind = false;
    for (let i = 0; i < headList.length; i++) {
      let offset = Math.abs(getElementTop(headList[i]) - scrollTop);
      if (offset > eps) {
        continue;
      }
      if (offset < closestOffset) {
        current = i;
        closestOffset = offset;
        hasFind = true;
      }
    }
    if(!hasFind) {
      return;
    }

    removeActiveClass(lastIndex)
    addActiveClass(current);
    lastIndex = current;
  }

  document.addEventListener('scroll', syncActiveClass);
  window.addEventListener('load', function () {
    tocContent = document.querySelector('.markdownIt-TOC');
    if (!tocContent) return;

    postBody = document.querySelector('.post-content');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        headList.push(postBody.children[i]);
      }
    }
    linkList = document.querySelectorAll('.post-toc a');

    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })
</script>

        </div>
      </div>

      <footer class="footer animate__animated animate__flipInX">
  <div class="site-footer">
    <p></p>
    <p>Â© xÂ³uÂ³ Â· Powered by <a href="https://gridea.dev/">Gridea</a> & <a href="https://github.com/xxxuuu/gridea-theme-autumn">Autumn</a> | <a class="rss" href="https://xxxuuu.me/atom.xml" target="_blank">RSS</a></p>
  </div>
</footer>


    </div>

    <script type="application/javascript">

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
  <script>
    window.onload = () => {
        hljs.highlightAll()
    }
  </script>


<script>
  const images = document.querySelectorAll('.post-content img');

  for (let i = 0; i < images.length; i++) {
    const img = images[i];

    const link = document.createElement('a');
    link.href = img.src;
    link.setAttribute("data-fancybox", "gallery");

    img.parentNode.insertBefore(link, img);
    link.appendChild(img);
  }
</script>




  </body>
</html>
