<!DOCTYPE html><html data-astro-cid-pjvcz6dw lang=zh-CN><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F49b4570c-b2f0-457b-81b7-b68e2693a471%2Favatar.png?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" rel=icon><link href=https://xxxuuu.me/post/longhorn/ rel=canonical><link href=/rss/feed.xml rel=alternate title=x³u³ type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap><title>Longhorn 浅析 | x³u³</title><meta content="Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化" name=description><meta content=website property=og:type><meta content=https://xxxuuu.me/post/longhorn/ property=og:url><meta content="Longhorn 浅析 | x³u³" property=og:title><meta content="Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化" property=og:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" property=og:image><meta content=summary_large_image name=twitter:card><meta content=@xxuuu0 name=twitter:site><meta content="Longhorn 浅析 | x³u³" name=twitter:title><meta content="Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化" name=twitter:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" name=twitter:image><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=stylesheet></noscript><script>!function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.add(e)}()</script><link href=/_astro/katex.CVb4srxQ.css rel=stylesheet><link href=/_astro/_slug_.Hsk_LU_h.css rel=stylesheet><link href=/_astro/_slug_.BzJEnS8p.css rel=stylesheet><link href=/_astro/_slug_.DOIB7y8p.css rel=stylesheet><script src=/_astro/hoisted.B871fABB.js type=module></script></head><body data-astro-cid-pjvcz6dw><header class=notion-header data-astro-cid-4f4rmh32><div class=header-container data-astro-cid-4f4rmh32><div class=header-content data-astro-cid-4f4rmh32><div class=logo data-astro-cid-4f4rmh32><a href=/ class=logo-link data-astro-cid-4f4rmh32>x³u³</a></div><div class=header-actions data-astro-cid-4f4rmh32><nav class=nav data-astro-cid-4f4rmh32><a href=/ class=nav-link data-astro-cid-4f4rmh32>🏠 首页 </a><a href=/archive class=nav-link data-astro-cid-4f4rmh32>📃 归档 </a><a href=/links class=nav-link data-astro-cid-4f4rmh32>👬 友链 </a><a href=https://p.xxxuuu.me class=nav-link data-astro-cid-4f4rmh32 rel="noopener noreferrer" target=_blank>📷 摄影 <span class=external-icon data-astro-cid-4f4rmh32>↗</span> </a><a href=/about class=nav-link data-astro-cid-4f4rmh32>👤 关于</a></nav><button aria-label="Toggle theme" title=切换主题 data-astro-cid-44mn2ykx id=theme-toggle><svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=sun-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 data-astro-cid-44mn2ykx r=5></circle><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=1 y2=3></line><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=21 y2=23></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line data-astro-cid-44mn2ykx x1=1 x2=3 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=21 x2=23 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg> <svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=moon-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-44mn2ykx></path></svg></button></div></div></div></header><main class=notion-main data-astro-cid-pjvcz6dw><article class=content data-astro-cid-gbhzkc2y><div class=notion-page data-astro-cid-gbhzkc2y><div class=page-cover data-astro-cid-gbhzkc2y><img alt="Longhorn 浅析" loading=eager src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fc3967b7e-bde2-4b5b-b5f6-97de21642f16%2Flonghorn.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466VDS6BHZJ%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163632Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIFKjwWUkdnnUj0H3QmDxVYM6tMYcwYLab7BoeJ0nWsuNAiEAwa3p0gu3cyjgjlvF0iL%252BhRLumgaR7mU1L9o295OZ7uMq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDEtdUvXDQoQ%252FfM8wxyrcA8ek98ikNFjODJlaIbEI65D8iUraAUTErONUCDyrAWAI1SLj5wW8zDxdRFwSl3D%252B8v3sb1UMmuY7a%252FusrbEVfWBgADyP5oxaIFOte7idqdW98gZ%252FhlKGxEL5MNxKCpyHdwOhc8EW7c7ztWm9W6Pwr1Sp31TQFPkiMIjZgQdLa%252B0%252BuY5te3DPjOdCVJ%252BKqKJ%252FBg6voHsNFnXmjL%252FIr6bIIw70rYHOuG4Pc%252BS31bohxWjhNAzwLcrGBl%252BvloO2l5sJbfMgHwat1nx4nyE7o2QBkYcJrsTPO8iQ5Q8h0AZioV441WeTXwlDK0mhU4daIAjekf4DYsGBSnQ5T610sDVJMKtdB55yuNcE%252FGtL3fIvVaRwqi%252BXKqmmMAmKDIwlIGXRXA%252BxgAqqXNXb2H5kkGBukftBqnzVwbvwpyXYuSWtea%252BYqXQtQy4mgxFtopecSlbY2vk5IYFUIB7XVpOpaQJ4nQL5u4brZahiQk5BJyB9rvG0P7Uy5Xr81zhoOmq%252FIRayCCNQ4ulyKswvGmxBQl9GXar%252FS8RYSZb%252FV7%252Bdq7hdygM7PXrMqQ1pvmsXVb3VnaIErNfbcemR0DlwURFsqj8mJk1qAqapS4Jd0vylenLXwPXnJ9ZtsXDjdfV%252BsYKuML%252BT3ssGOqUBK5JukVbPYmSJ4ZMWWlqKJV0acsuX5fyJFzBoFvkNYVgQ07S%252BKi4PgbCFezbdtFgCLBUUIFSZhBFMLBSu8C1%252FR8ANabExCn3ftY6zdABGFYG3ENxroNzOKlUWd8rQovgcpgHD1iet1JqD39JokwAi9ggMZpxgFz77O1NhgRe6ka%252BiZyqLzhIJSqur6laCW8k5v8BZfqa%252BBhhsAw7Ma7N0O%252BN7obVw%26X-Amz-Signature%3D18ec2eda4b92120e03c2b94067b6debe0a76d9c86248c8f0faa2fcbe56c0690c%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&id=bde25ba8-2381-4da6-bb5e-5787ace45def" data-astro-cid-gbhzkc2y></div><div class=page-container data-astro-cid-gbhzkc2y><div class=page-main data-astro-cid-gbhzkc2y><header class=page-header data-astro-cid-gbhzkc2y><h1 class=page-title data-astro-cid-gbhzkc2y>Longhorn 浅析</h1></header><div class=page-meta data-astro-cid-gbhzkc2y><div class=meta-info data-astro-cid-gbhzkc2y><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>📅</span> <time data-astro-cid-gbhzkc2y datetime=2024-08-08>2024年08月08日</time> </span><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>⏱️</span> <span data-astro-cid-gbhzkc2y>10 分钟阅读</span></span></div><div class=meta-tags data-astro-cid-gbhzkc2y><span class=tags-icon data-astro-cid-gbhzkc2y>🏷️</span> <a href=/tag/存储 class=tag-pill data-astro-cid-gbhzkc2y>存储</a><a href=/tag/分布式系统 class=tag-pill data-astro-cid-gbhzkc2y>分布式系统</a></div><div class=meta-description data-astro-cid-gbhzkc2y>Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化</div></div><hr class=page-divider data-astro-cid-gbhzkc2y><div class=notion-content data-astro-cid-gbhzkc2y><p><br></p><p>Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化</p><p><br></p><p>从宏观视角来看，Longhorn 的数据流如下， Engine 是 volume 的 controller，每个 volume 都会有一个 engine 实例，replica 是卷的一个副本实例，负责具体的落盘，显然 Engine 就是数据面的核心</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F74bdb399-f643-4c60-af08-0435670cf958%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D64d91cc4d3c649ff1ca99a02d092be6637417b6604aa3c551df7d88dfe1a4542%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=f09b7b63-717c-43f5-8e2d-00daafae5408" class=glightbox data-aspect-ratio=1.658590 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.658590><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F74bdb399-f643-4c60-af08-0435670cf958%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D64d91cc4d3c649ff1ca99a02d092be6637417b6604aa3c551df7d88dfe1a4542%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=f09b7b63-717c-43f5-8e2d-00daafae5408"/></a></figure><p>Longhorn 是控制面则是基于 K8s 的，所有资源都以 K8s CRD 提供，通过 Operator 管控，称为 Manager</p><p><br></p><h1 id=v1-engine>V1 Engine</h1><h2 id=replica>Replica</h2><p>Engine 有 V1 和 V2 两个版本，先从 V1 Engine 开始分析，自底向上看，最下面的是 replica。replica server 在启动时就会创建/打开对应的 replica，然后启动两个 grpc server，分别处理控制流和数据流</p><p><br></p><p>replica 在节点上对应一组 sparse file，代码中这个结构称为 <code>diffDisk</code>，每个 file 有点类似于 LSM-Tree 中的 layer/level，这里称为 snapshot（除了最新一层叫 head/live data）：</p><figure class="notion-image notion-image-center" style=max-width:576px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F09606cc3-8f19-4e2f-9a02-c9c0ace747f9%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Dfe1cac70dd013040330af318de6d9e8348165be27927a8a4d1d4d0a0c77a1148%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=c0ea8054-fb66-4660-9340-c9e8e46a1185" class=glightbox data-aspect-ratio=1.332594 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.332594><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F09606cc3-8f19-4e2f-9a02-c9c0ace747f9%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Dfe1cac70dd013040330af318de6d9e8348165be27927a8a4d1d4d0a0c77a1148%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=c0ea8054-fb66-4660-9340-c9e8e46a1185"/></a></figure><p>每个 <code>diffDisk</code> 的元数据存在一个 <code>volume.meta</code> 文件中，还会有一个 <code>revision.counter</code> 文件记录写入的版本号。每一层 file 划分为多个 4K 大小的 sector，这是写入的最小单元，因为都是 sparse file，所以 Longhorn 的卷自然支持精简配置。file 之间从新到旧连接起来，索引表 <code>location</code> 则存储 sector 位于哪一个 file 中</p><p><br></p><p>读写流程</p><ul><li>写入时先自增 revision，元数据中标为为 dirty，这里 revision 会落盘，但元数据不会。然后在 <code>diffDisk</code> 只会写入最新的一层，即 live data 或 head，是原地写入的，同时更新索引。前面提到 sector 是写入最小单元，如果写入不够一个 sector，就会先读出原数据，修改后再写</li><li>读取时从索引中找到 sector 对应第几层的 file，如果找到就直接去读。否则从新到旧的 file 查找，对于每一个 file 使用 FIEMAP ioctl 查询指定范围内是否存在 extent，是则说明 sector 位于这个 file 中，更新索引后读取</li></ul><p><br></p><p>快照&amp;扩容流程</p><ul><li>快照：快照很简单，只是创建一个新的 head。删除就是将其内容覆盖到上一层 snapshot 中</li><li>扩容：创建一个新的 head，相当于打了个快照，head 的大小被 truncate 为扩容后的大小，同时还需要修改元数据。由于 sector 变多了，<code>diffDisk</code> 内的 <code>location</code> 索引表也要扩容</li></ul><p><br></p><p>一开始还以为 <code>diffDisk</code> 会是类似 RocksDB 这种 LSM-Tree based 的存储引擎，但完全不是一回事。它没有存储引擎必须的各种功能，可以说只是一个能支持 snapshot 的数据格式</p><p>首先接口语义上，<code>diffDisk</code> 是为块存储设计的，并不是 key-value 的，或者说 key 就是 offset；也没有删除接口，只有读和写。不过这也问题不大，块存储本身也没有“删除”的概念，真要添加删除接口也可以通过写入墓碑标记实现</p><p><code>diffDisk</code> 中单个文件的数据布局和元数据维护是依赖文件系统的 extent 功能实现的，没有定义自己的格式。所以这套实现对文件系统有要求，需要支持 extent 功能，优点是文件很“干净“，这里如果没有 snapshot，实际上就是对单个文件的直接读写。但反之可以说没有任何优化，性能需要打个问号</p><p>同时它没有 WAL，无法保证崩溃一致性。这种情况需要 rebuild，更不用提快照（revision）读和事务之类的功能了。rebuild 这些操作都依赖上层控制面触发，后续会提到</p><p><br></p><h2 id=controller>Controller</h2><p>Controller 负责整个 volume 视角的读写，它被调度在和最终 client 的 Pod 相同的节点上，从 frontend 中接受读写请求，往后连接到一个或多个 replica 上，将读写转发给这些 replica</p><p>为了避免和 K8s 中的 Controller 混淆，后面都直接称这个 Controller 为 Engine</p><figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd7d422a8-aa34-4ff3-b059-b898eb14bf56%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Db805b9b6fc18c47ddccc13294bbe6058a1d0ef7da1a3988f00d9b866566ca762%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=6080c1ce-0625-443b-a0dc-fc07904694e3" class=glightbox data-aspect-ratio=1.705759 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.705759><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd7d422a8-aa34-4ff3-b059-b898eb14bf56%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Db805b9b6fc18c47ddccc13294bbe6058a1d0ef7da1a3988f00d9b866566ca762%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=6080c1ce-0625-443b-a0dc-fc07904694e3"/></a></figure><p><br></p><p>Engine 启动时会监听一个 UDS（<code>/var/run/longhorn-{volume-name}.sock</code>），同时创建 frontend，frontend 实际上就是一个 iSCSI Target，通过<a href=https://github.com/rancher/tgt rel="noopener noreferrer" target=_blank>定制的 tgtd</a> 创建，这个定制 tgtd 做的工作不多，主要是能支持将 iSCSI 流量包装成 Longhorn 自己的一个简单协议转发到前面的 UDS 中</p><p>协议结构如下：</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>type Message struct {
	MagicVersion uint16
	Seq          uint32
	Type         uint32
	Offset       int64
	Size         uint32
	Data         []byte
}

const (
	TypeRead = iota
	TypeWrite
	TypeResponse
	TypeError
	TypeEOF
	TypeClose
	TypePing
	TypeUnmap
)

const (
	MagicVersion = uint16(0x1b01) // LongHorn01
)</code></pre></div><p>有了 iSCSI Target 后，还需要启动 iSCSI Initator 连接这个 Target，这步的目的是需要创建出一个块设备，然后通过 mknod 指定相同的主次设备号再创建出 <code>/dev/longhorn/{vol_name}</code>。这就是 client 最终直接操作的设备，对它的 I/O 会一路到 Initator → Target → UDS 上。到此 frontend 就算创建完成</p><p><br></p><p>Engine 之后为 volume 的每一个 replica 创建对应的 backend(replicator)，并维持心跳。会从前面监听的 UDS 中解析协议并转发给 replica</p><p>具体读写上 Engine 通过一个读写锁控制并发，read 只要任一一个 replica 成功即可，用的 round-robin 的策略做 balance。write 和 unmap 等操作是并发执行的，要求全部成功。IOPS 之类的监控和统计也在这个层级实现</p><p>最后 Engine 会再启动一个 grpc server，处理控制流，例如卷扩容、快照等命令，也是通过 backend(replicator) 转发到 replica 上执行的。当然，这里调用的是处理控制流的 grpc server</p><p><br></p><p>这里有一个优化，如果 volume 只有一个 replica（单副本）且设置了 struct local 模式。Manager 会将 replica 调度到和 Engine 同一个节点上。Engine 在创建 backend 时就会通过 UDS 连接而不是 TCP 连接。这种本地化的策略能够有效提升 IOPS 和改善延迟，不过这里约束了只能用单副本，限制比较大</p><p>虽然 Engine 自身是单点，但是它运行在和 client 相同的节点上，因此如果节点故障，一般 client 也会同时不可用，是个不错的策略</p><p><br></p><h1 id=manager>Manager</h1><p>一开始提到，Longhorn 的控制面是作为 K8s Operator 实现的，称为 Manager。Longhorn 里所有元数据，包括 Engine 和 Replica 都以 CRD 呈现。</p><p>这套方案的优点是很多东西都能依赖 K8s 的能力提供和管理，还能很好地融入生态。但同样很多元数据操作的链路都要通过 K8s，感觉还是会比较慢，也限制了规模和能力</p><p><br></p><h2 id=rebuild-add-replica>rebuild &amp; add replica</h2><p>如果 Engine 到某个 replica 心跳失败或读写或控制流命令错误，或发现 replica 的 revision 不是最新的，这个 replica 的 mode 就被设置为 ERR 不再读写</p><p>Manager 中的 monitor 会定时请求 Engine 中处理控制流的 grpc server 获取其所有的 replica 信息，更新到 Engine CR 的 status 中。因此当在 Manager 中的 Engine Controller 对该 Engin CR 进行 reconcile 时就能检测到 replica 处于 ERR mode 或不存在，调用 Engine 触发 rebuild</p><p><br></p><p>V1 Engine 的 rebuild 最终执行了 AddReplica Task，所以 rebuild 实际上流程和新增 replica 一致</p><ul><li>Engine 在创建新 replica 之前，会先对其他 replica 打一个快照，然后创建一个 WO（仅写入）模式的新 replica，因此它马上就可以接收写入</li><li>然后从已有的 replica 中将 <code>diffDisk</code> 的元数据和剩下 snapshot 给 sync 过去。在 sync 完成后，通知 Engine 重新检验合法性，此时 replica 正式可用，设置回 RW 模式，启动对新 replica 的心跳</li></ul><p>这里在打完快照后，新 replica 的写入就全都在 head/live data 上了，写入是安全的。snapshot 的 sync 在后台异步进行，利用了 <code>diffDisk</code> 的特性和快照实现了在线 rebuild</p><figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F4984c535-3b59-4ae9-b363-c56f764adf27%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D9d03baab9522946ac7ebd034a4d3ff6fd78c175939dfc3c63b06ff53eac496a1%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=aa4a4965-7412-479a-b045-9d4061d971fe" class=glightbox data-aspect-ratio=1.037578 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.037578><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F4984c535-3b59-4ae9-b363-c56f764adf27%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D9d03baab9522946ac7ebd034a4d3ff6fd78c175939dfc3c63b06ff53eac496a1%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=aa4a4965-7412-479a-b045-9d4061d971fe"/></a></figure><p><br></p><h1 id=file-storage>File storage</h1><p>Longhorn 提供的 CSI 不支持 Block PVC 的 RWX 挂载，因为块层无法感知更高层（文件系统）的写入模式和内容，多个 client 写入就会把挂载的文件系统元数据写坏。为了支持 RWX 的 PVC，Longhorn 额外通过 Share Manager 组件提供了文件存储。这里有意思的是，它不叫 Filesystem Manager 而是叫 Share Manager，可以看出是完全以 K8s 视角考虑的</p><p><br></p><p>当创建 RWX 的 volume （Longhorn 的 CR，非 PVC）时，Manager 中 volume controller 会创建对应的 share manager CR。share manager controller 再创建 share manager pod 并修改 volume 让其实际挂载在这个 share manager pod 的节点上</p><p>controller 检测到 pod 启动之后，就会给其发起 RPC 请求将 <code>/dev/longhorn/{vol_name}</code> 块设备格式化为指定文件系统挂载到 <code>/export/{vol_name}</code> 中</p><p>share manager 内运行了一个 nfs ganesha，作为 NFS server。最后 share manager 更新 nfs ganesha 配置，将 <code>/export/{vol_name}</code> 导出</p><p>share manager 和 volume 的 status 在 controller reconcile 中被更新，设置 NFS 连接信息，现在 CSI 就可以获取到 NFS 连接配置，完成最终的用户 Pod 挂载流程</p><figure class="notion-image notion-image-center" style=max-width:624px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F634f0ba3-651c-4cb3-ade9-b46c64d446bb%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Dc5cbde7ab3ff3ba1c1105fc8779c010e533ea5c573387d56b8ad5bc8e75bd2dd%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=30cca0e4-3eeb-4644-83e6-a121dc1ec3a0" class=glightbox data-aspect-ratio=1.138387 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.138387><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F634f0ba3-651c-4cb3-ade9-b46c64d446bb%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Dc5cbde7ab3ff3ba1c1105fc8779c010e533ea5c573387d56b8ad5bc8e75bd2dd%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=30cca0e4-3eeb-4644-83e6-a121dc1ec3a0"/></a></figure><p><br></p><p>这里 NFS server 是一个单点的 gateway。为了故障恢复，Longhorn 修改 nfs ganesha 添加了一个新的 recovery backend 类型 longhorn，这个定制的 recovery backend 的作用是将 nfs ganesha 的内部状态信息存储到 K8s ConfigMap 中</p><p>当发生故障，新的 share manager pod 被创建出来后，nfs ganesha 就能从 ConfigMap 中恢复状态，nfs client 可以配置一定宽限期，此时再重试请求就能成功，恢复运行</p><p><br></p><p>实际上 NFS server 可以配置 active/active（多活）和 active/passive（主备） 模式。这样恢复速度能比等待重建快得多，可以做到高可用，但目前看起来在这套架构上并不好实现</p><p>首先这里 NFS server 本身就是跑在 iSCSI 块设备上的，无法处理多 client 写入，这就回到一开始的情况了，因此无法做到 active/active。而 Engine 则限制了必须和 Pod 在同一节点上，目前不支持存在一个备用的 Engine 连接同样的 Replica，自然也无法做到 active/passive</p><p><br></p><h1 id=v2-engine>V2 Engine</h1><p>V2 Engine 使用了 SPDK，基本是复用了 SPDK 自带的功能，Go 只是调用来创建，不会再直接处理 I/O，性能应该能得到很大提高。V2 Engine 目前还是 preview feature，一些功能支持的不完善，例如扩容</p><p><br></p><p>在 V2 Engine 上，总体设计也类似于 V1 Engine，Engine 连接多个 Replica。Replica 就是一个 SPDK 的 lvol bdev（逻辑卷），还包括一个 NVMf Target 将 bdev 暴露出去。剩下的例如精简配置、快照等功能都是 SPDK 自身已经支持的，直接通过 JSON-RPC 调用即可</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Facdac30c-0f7c-4d5d-a678-43c4dfb4897b%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D25826a302ecd8b242ff3c462a6d7c8173594cd0e6d068e463fddaff27faee831%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=44824160-de3d-43d5-a6c9-915fdffdaf24" class=glightbox data-aspect-ratio=2.075710 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.075710><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Facdac30c-0f7c-4d5d-a678-43c4dfb4897b%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D25826a302ecd8b242ff3c462a6d7c8173594cd0e6d068e463fddaff27faee831%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=44824160-de3d-43d5-a6c9-915fdffdaf24"/></a></figure><p>Replica 已经暴露了 NVMf bdev，Engine 同样通过 SPDK 连接到每个 Replica 的 NVMf bdev，再组成 RAID1 bdev，这样又利用了 SPDK 直接实现了多副本，最后暴露出 NVMf Target 给 client 连接</p><figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdcf8bbf2-409a-4d6c-bff0-bf9dc67fdcc1%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D5ca1e94ddb307967040fda5034265e105aaac894277a8735d5d17ece649aaace%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=6e079fd5-54fa-4c0f-8fd9-9c090bea781e" class=glightbox data-aspect-ratio=1.601173 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.601173><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdcf8bbf2-409a-4d6c-bff0-bf9dc67fdcc1%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D5ca1e94ddb307967040fda5034265e105aaac894277a8735d5d17ece649aaace%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=6e079fd5-54fa-4c0f-8fd9-9c090bea781e"/></a></figure><p><br></p><p>由于并不插手 I/O 流程，这里的容错处理稍微被动些。健康检查不再是心跳，而是定期（3s）获取 replica 上的 SPDK bdev 列表，在这个过程中更新一些统计数据。当 bdev 不存在或信息不一致时，就会设置为 ERR mode 让其 rebuild</p><p>V2 Engine 中 rebuild 和 add replica 流程和 V1 Engine 大体类似：</p><ol><li>首先打快照，然后让新的 replica 直接通过 NVMf 连接源 replica 的 bdev，作为 external snapshot 创建新的 lvol bdev</li><li>回到 V2 Engine，现在新 replica 的 lvol bdev 已经存在了，可以连接并添加到 RAID1 bdev 中。虽然这时也给新 replica 设置了 WO mode，但 Engine 已经不在 I/O 流程中了 管不着，SPDK 仍然可能从新的 bdev 中读，SPDK 能正确处理，但会有一定性能下降</li><li>虽然新 replica 的 bdev 中已经有了完整数据（RAID1 bdev 会自动处理），但它上面并没有源 replica 上那些历史快照链，还需要一个恢复快照链的过程。这里会再创建一个新的 rebuilding lvol，使用 shallow copy 将源 replica 的快照一层层 copy 过去，每 copy 完一层就给 rebuilding lvol 打一次快照。这样从头给 rebuilding lvol 构建历史快照链</li><li>最后再将第 1 步中的新 lvol 的 parent 从 external snapshot 改为 rebuilding lvol</li></ol><p><br></p><p>V2 Engine 的模式让我想起了 Kafka，Kafka 虽然是 Java 实现，但实际上 Java 本身没有做太多 key path 上的数据处理，而是 offload 到 kernel 去做，避免了 Java 的性能劣势。从这个角度来说，Kafka 的数据面更像一个细粒度的对 kernel 的控制面。Longhorn 的 V2 Engine 也是如此，基本就是对 SPDK 的控制面</p><p><br></p><h1 id=performance>Performance</h1><p>看一下性能，benchmark 可以看到，V1 Engine 的性能比较差，也在预期之内。不过这里测试用的 SSD 比较一般，完全没发挥出 SPDK 的性能，但到了那种程度网络也是瓶颈了，Longhorn 目前还不支持 RDMA</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F79cf5471-dca4-4a90-a6ee-9ec25beb9771%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Da8cfcf082ead96e7ab0ae9f2a2b826ab92e29787b0a4c849d2c34b17bc17b39f%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7c840412-5919-4a47-bf3b-2417b4e8b9a8" class=glightbox data-aspect-ratio=2.672854 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.672854><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F79cf5471-dca4-4a90-a6ee-9ec25beb9771%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3Da8cfcf082ead96e7ab0ae9f2a2b826ab92e29787b0a4c849d2c34b17bc17b39f%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7c840412-5919-4a47-bf3b-2417b4e8b9a8"/></a></figure><p><br></p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F22ca52d1-17b5-4860-aa1b-4da95b25cc58%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D9fdf6eaa268499d547d1753a568cc61094315e42e38b211f8fd53433c66e35b5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7c1c4ce9-4e19-43d7-86b5-6207c665bbf9" class=glightbox data-aspect-ratio=2.672854 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.672854><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F22ca52d1-17b5-4860-aa1b-4da95b25cc58%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D9fdf6eaa268499d547d1753a568cc61094315e42e38b211f8fd53433c66e35b5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7c1c4ce9-4e19-43d7-86b5-6207c665bbf9"/></a></figure><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe9c48585-311b-4ce5-a5c7-3c73dabcbc57%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D64410383109c10477f122fff89bfc58453d1df30331c3420a86dd96dd0f0f872%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=0ecfb0ba-a047-4a58-ac81-55cb200e0303" class=glightbox data-aspect-ratio=2.672854 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.672854><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe9c48585-311b-4ce5-a5c7-3c73dabcbc57%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QVBNLAY5%252F20260126%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260126T163644Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEHgaCXVzLXdlc3QtMiJHMEUCIH1FpQprdWWfka3CEVxtMOvvajJpvG8Y7lk0uwsBPC9uAiEAmZpT6j%252BDBFKf9vWXODDityeIgwRXn3SVSRyQfGOvxZwq%252FwMIQRAAGgw2Mzc0MjMxODM4MDUiDGFjwJcFfj2tJUV7XSrcA17SIJUPkGRKZhblCHCjiWRLuCeFYpugV78lMW%252BE8M2Ta20y8hdqGxLrdeWFO0X9G3FhdFQoAjpeNbRHSYGpbDc%252FVJXwy0c7EOibjfKYEAwfR5VSUstBDpR1dx%252BrVijU9qSHCxoO70pzBC6XZoD181ArYW4wzwP7NCL3GAQNeot%252F2%252FFEa%252BZLatNksgeTnU05ZGdu2DR9HsIBAKpDsPpv08a2fNRUtc9ZbL8JbVsq7ZdoGGU1Rxw%252BXBq24xtI7WHBd5oPB46728vRl2o000X5OVOOL4oPxyG%252FoIlfl98mwyV04CUvyrNW23d%252B2ZfoRClYTUEunAANWfQG5RLQ0FYS%252F5elA4hLgPFymJAsRJ1c0W3RJ0WVvPD%252FeDd6qA89%252FjBdFcWDFX1XvdX%252FiIEnZhOn1sA8NBmGu41GFz5xgmR2E%252FXzu3SlOBAid6Xx4ptrrUy6kIZVorCGuUGNcoQmISeut0dpdyIRDrh5i8zFQl0SAo7swgE6MCWhO58zdKM2bDli24J1oEoiZyi%252BG5Y2odhvkMMK6w6U%252F4CPZb6Su%252B96QAXNeJYeTglDClHUTs6V4bSQPflB8ZAuSv6xr4IDT8qzMflKGXjMN%252Bx2Af4xnNKZbnLc6HUwgd%252F0usiBlQNdMJKU3ssGOqUBvud7QgtOtVrMLoxR5yH28fwCB5juDd6UcfZg%252B28hpYDDHK4N04At1XwJsgSXdienqjCfGv2GArXABncLY9uKmXE2yFhbQvk4w5wVme8Jh6%252FbQUuTBuzEUm%252FzK9xJkfQBRWk81Y7xZeDFzOcdxQjUlstIikdSlz%252B6ULj3rxf9DIWuV1DkRFn6jkwZVobHvz3UnKpozJQHM3SvDnVamxcPIwJxZ4eB%26X-Amz-Signature%3D64410383109c10477f122fff89bfc58453d1df30331c3420a86dd96dd0f0f872%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=0ecfb0ba-a047-4a58-ac81-55cb200e0303"/></a></figure><p><br></p><h1 id=summary>Summary</h1><p>总的来说，Longhorn 架构简洁，基于简单朴素的想法构建，又很好地复用了已有的成熟组件，无论是基于 K8s 的控制面，还是 V1 Engine 中的 sparse file，tgtd，nfs ganesha，V2 Engine 的 SPDK，都是这种想法的体现。使用起来也很友好</p><p>缺点是一旦有舒适区内无法满足的需求，就会比较麻烦。例如现在已经修改了 tgtd 和 nfs ganesha，但这种零碎的修改又很难维护，特别是 SPDK 不是简单包装一下就可以产品化的，这在未来可能会是一个挑战。另外，存算融合也可能会导致负载互相影响，进一步降低性能，控制面的调度收敛速度估计也受限于 K8s，万卷规模时各种 CR 可能就数十万个了，而 etcd 还是单 Raft Group 的，瓶颈明显</p><p><br></p><p>后续可以考虑的优化点不少，首先存储层就不支持 chunk/block 之类的 partition，这直接限制了单个卷能提供的容量，而且没有细粒度的 partition，容错和调度都会不够灵活。现在 rebuild 都是全量的，不仅影响速度，在大卷时这样的流量对集群也有压力。最后是一些业务功能，例如 QoS 等比较刚需的还不支持</p><p>Longhorn 的性能、扩展性和容错可以说都是很差的，但却仍然有着不少的应用，这不禁让我想起同事说过的一句话：「大部分客户和场景根本不在乎性能，只关注成本、易用性和稳定性」</p><p>值得一提的是 Longhorn 的文档写的很不错，大部分 feature 都有详细提案文档和需求来源追溯，这点非常好，还是很适合作为入门学习的分布式存储项目</p><p><br></p><p><br></p><p>Ref：</p><ul><li><a href=https://longhorn.io/docs/1.6.2/concepts/ rel="noopener noreferrer" target=_blank>Longhorn | Architecture and Concepts</a></li><li><a href=https://github.com/longhorn/longhorn/wiki/Architecture-Overview-For-Developers rel="noopener noreferrer" target=_blank>Architecture Overview For Developers</a></li><li><a href=https://peteryj.github.io/2020/10/11/longhorn-engine-code-analysis/ rel="noopener noreferrer" target=_blank>longhorn-engine 源码分析 - Peter Yang&#039;s Blog</a></li><li><a href=https://github.com/longhorn/longhorn/blob/master/enhancements/20221123-local-volume.md rel="noopener noreferrer" target=_blank>20221123-local-volume.md</a></li><li><a href=https://mp.weixin.qq.com/s/9eFYJ5OFRrShaKJezxV6Bg rel="noopener noreferrer" target=_blank>Longhorn 的正确使用姿势：如何处理增量 replica 与其中的 snapshot/backup</a></li><li><a href=https://longhorn.io/docs/1.6.2/nodes-and-volumes/volumes/rwx-volumes/ rel="noopener noreferrer" target=_blank>Longhorn | ReadWriteMany (RWX) Volume</a></li><li><a href=https://github.com/longhorn/longhorn/blob/master/enhancements/20201220-rwx-volume-support.md rel="noopener noreferrer" target=_blank>20201220-rwx-volume-support.md</a></li><li><a href=https://github.com/longhorn/longhorn/blob/d5e8a44104f5e03c310870b47da7c8ab55f671b3/enhancements/20220727-dedicated-recovery-backend-for-rwx-volume-nfs-server.md rel="noopener noreferrer" target=_blank>20220727-dedicated-recovery-backend-for-rwx-volume-nfs-server.md</a></li><li><a href=https://github.com/longhorn/longhorn/blob/master/enhancements/20230619-spdk-engine.md rel="noopener noreferrer" target=_blank>20230619-spdk-engine.md</a></li><li><a href=https://spdk.io/doc/logical_volumes.html rel="noopener noreferrer" target=_blank>SPDK: Logical Volumes</a></li><li><a href=https://spdk.io/doc/nvmf.html rel="noopener noreferrer" target=_blank>SPDK: NVMe over Fabrics Target</a></li><li><a href=https://spdk.io/doc/bdev.html rel="noopener noreferrer" target=_blank>SPDK: Block Device User Guide</a></li><li><a href=https://github.com/longhorn/longhorn/issues/7199 rel="noopener noreferrer" target=_blank>v2 volume replica online rebuilding</a></li><li><a href=https://github.com/longhorn/longhorn/blob/b58a7a3849e12fa4674723c1ce0dfe708fd8423a/enhancements/20231030-spdk-raid-delta-copy.md rel="noopener noreferrer" target=_blank>20231030-spdk-raid-delta-copy.md</a></li><li><a href=https://longhorn.io/docs/1.6.2/v2-data-engine/performance/ rel="noopener noreferrer" target=_blank>Longhorn | Performance</a></li></ul><p><br></p></div><nav class=post-navigation data-astro-cid-gbhzkc2y><a href=/post/kernel-rwlock class="nav-link nav-prev" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>← 上一篇</span> <span class=nav-title data-astro-cid-gbhzkc2y>从 Linux 内核看读写锁设计</span> </a><a href=/post/migrate-blog-to-notion class="nav-link nav-next" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>下一篇 →</span> <span class=nav-title data-astro-cid-gbhzkc2y>迁移博客到 Notion</span></a></nav><footer class=page-footer data-astro-cid-gbhzkc2y><a href=/ class=back-link data-astro-cid-gbhzkc2y>← 返回首页</a></footer><section class=comments-section data-astro-cid-gbhzkc2y><div class=comments-container data-astro-cid-te6ksoa6 data-giscus-config="{&#34;slug&#34;:&#34;longhorn&#34;,&#34;title&#34;:&#34;Longhorn 浅析&#34;,&#34;config&#34;:{&#34;repo&#34;:&#34;xxxuuu/xxxuuu.github.io&#34;,&#34;repoId&#34;:&#34;MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg&#34;,&#34;category&#34;:&#34;Announcements&#34;,&#34;categoryId&#34;:&#34;DIC_kwDOCwLAgM4ChgWc&#34;,&#34;mapping&#34;:&#34;title&#34;,&#34;strict&#34;:&#34;0&#34;,&#34;reactionsEnabled&#34;:&#34;1&#34;,&#34;emitMetadata&#34;:&#34;0&#34;,&#34;inputPosition&#34;:&#34;bottom&#34;,&#34;lang&#34;:&#34;zh-CN&#34;,&#34;lazy&#34;:true}}" data-provider=giscus id=comments><div class=comments-loading data-astro-cid-te6ksoa6>加载评论中...</div></div></section></div><aside class=toc-container data-astro-cid-gbhzkc2y><div class=toc-wrapper data-astro-cid-gbhzkc2y><div class=toc-title data-astro-cid-gbhzkc2y>目录</div><nav class=toc-nav data-astro-cid-gbhzkc2y></nav></div></aside></div></div></article></main><footer data-astro-cid-aoh3bln3><div class=container data-astro-cid-aoh3bln3><div class=footer-content data-astro-cid-aoh3bln3><div class=copyright data-astro-cid-aoh3bln3><p data-astro-cid-aoh3bln3>&copy; 2026 x³u³. All rights reserved.</p><p data-astro-cid-aoh3bln3 class=powered-by>Powered by <a href=https://github.com/xxxuuu/nopress rel="noopener noreferrer" target=_blank data-astro-cid-aoh3bln3>Nopress</a></p></div><div class=social-links data-astro-cid-aoh3bln3><a href=https://github.com/xxxuuu class=social-icon aria-label=github data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></span></a><a href=https://x.com/xxuuu0 class=social-icon aria-label=twitter data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span></a><a href=mailto:xxuuu0@outlook.com class=social-icon aria-label=email data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg></span></a><a href=/rss/feed.xml class="social-icon rss" aria-label=RSS订阅 data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></span></a></div></div></div></footer></body></html>