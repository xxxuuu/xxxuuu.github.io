<!DOCTYPE html><html data-astro-cid-pjvcz6dw lang=zh-CN><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F49b4570c-b2f0-457b-81b7-b68e2693a471%2Favatar.png?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" rel=icon><link href=https://xxxuuu.me/post/db-mmap/ rel=canonical><link href=/rss/feed.xml rel=alternate title=x³u³ type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap><title>应该在 DBMS 中使用 MMAP 吗？ | x³u³</title><meta content="🗒 碎碎念" name=description><meta content=website property=og:type><meta content=https://xxxuuu.me/post/db-mmap/ property=og:url><meta content="应该在 DBMS 中使用 MMAP 吗？ | x³u³" property=og:title><meta content="🗒 碎碎念" property=og:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" property=og:image><meta content=summary_large_image name=twitter:card><meta content=@xxuuu0 name=twitter:site><meta content="应该在 DBMS 中使用 MMAP 吗？ | x³u³" name=twitter:title><meta content="🗒 碎碎念" name=twitter:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" name=twitter:image><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=stylesheet></noscript><script>!function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.add(e)}()</script><link href=/_astro/katex.CVb4srxQ.css rel=stylesheet><link href=/_astro/_slug_.CtQEHxK0.css rel=stylesheet><link href=/_astro/_slug_.DhuirupF.css rel=stylesheet><link href=/_astro/_slug_.DOIB7y8p.css rel=stylesheet><script src=/_astro/hoisted.B871fABB.js type=module></script></head><body data-astro-cid-pjvcz6dw><header class=notion-header data-astro-cid-4f4rmh32><div class=header-container data-astro-cid-4f4rmh32><div class=header-content data-astro-cid-4f4rmh32><div class=logo data-astro-cid-4f4rmh32><a href=/ class=logo-link data-astro-cid-4f4rmh32>x³u³</a></div><div class=header-actions data-astro-cid-4f4rmh32><nav class=nav data-astro-cid-4f4rmh32><a href=/ class=nav-link data-astro-cid-4f4rmh32>🏠 首页 </a><a href=/archive class=nav-link data-astro-cid-4f4rmh32>📃 归档 </a><a href=/links class=nav-link data-astro-cid-4f4rmh32>👬 友链 </a><a href=https://p.xxxuuu.me class=nav-link data-astro-cid-4f4rmh32 rel="noopener noreferrer" target=_blank>📷 摄影 <span class=external-icon data-astro-cid-4f4rmh32>↗</span> </a><a href=/about class=nav-link data-astro-cid-4f4rmh32>👤 关于</a></nav><button aria-label="Toggle theme" data-astro-cid-44mn2ykx id=theme-toggle title=切换主题><svg fill=none viewBox="0 0 24 24" class=sun-icon data-astro-cid-44mn2ykx height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 data-astro-cid-44mn2ykx r=5></circle><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=1 y2=3></line><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=21 y2=23></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line data-astro-cid-44mn2ykx x1=1 x2=3 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=21 x2=23 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg> <svg fill=none viewBox="0 0 24 24" class=moon-icon data-astro-cid-44mn2ykx height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-44mn2ykx></path></svg></button></div></div></div></header><main class=notion-main data-astro-cid-pjvcz6dw><article class=content data-astro-cid-gbhzkc2y><div class=notion-page data-astro-cid-gbhzkc2y><div class=page-container data-astro-cid-gbhzkc2y><div class=page-main data-astro-cid-gbhzkc2y><header class=page-header data-astro-cid-gbhzkc2y><h1 class=page-title data-astro-cid-gbhzkc2y>应该在 DBMS 中使用 MMAP 吗？</h1></header><div class=page-meta data-astro-cid-gbhzkc2y><div class=meta-info data-astro-cid-gbhzkc2y><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>📅</span> <time data-astro-cid-gbhzkc2y datetime=2024-10-27>2024年10月27日</time> </span><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>⏱️</span> <span data-astro-cid-gbhzkc2y>8 分钟阅读</span></span></div><div class=meta-tags data-astro-cid-gbhzkc2y><span class=tags-icon data-astro-cid-gbhzkc2y>🏷️</span> <a href=/tag/论文阅读 class=tag-pill data-astro-cid-gbhzkc2y>论文阅读</a><a href=/tag/数据库 class=tag-pill data-astro-cid-gbhzkc2y>数据库</a></div></div><hr class=page-divider data-astro-cid-gbhzkc2y><div class=notion-content data-astro-cid-gbhzkc2y><h1 id=buffer-pool-mmap>Buffer Pool 和 MMAP</h1><p>对于（基于磁盘的）数据库来说，缓存（cache + buffer）管理是很重要的，因为次级存储速度很慢，必须设计一个缓存机制才能让数据库高效地进行读写</p><p><br></p><p>传统的方法是数据库实现一个缓冲池（Buffer Pool），像 CMU 15-445 这样的数据库课程，通常第一个 Lab 就是实现一个 Buffer Pool 作为页面和缓存管理的组件</p><p>另一个方法是将一切交给操作系统，也就是使用 <code>mmap()</code> 系统调用，mmap 将文件映射到内存地址空间上，程序透明地对内存进行访问，由内核负责管理页面的加载和刷写</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F0bb67f4b-fc66-4c7f-8b45-af39e6585204%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D023870716ac2988461e4d5682fdf172a13a2aca2c6a8a507d370c17a99e2a6bf%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=e633f5c6-aac9-4be2-be6c-e7d79fca0959" class=glightbox data-description="" data-gallery=article-images data-title=Image><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F0bb67f4b-fc66-4c7f-8b45-af39e6585204%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D023870716ac2988461e4d5682fdf172a13a2aca2c6a8a507d370c17a99e2a6bf%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=e633f5c6-aac9-4be2-be6c-e7d79fca0959"/></a></figure><p>使用 mmap 能大大简化开发，并且能避免 <code>read</code>/<code>write</code> 等系统调用和缓冲区拷贝的开销，理论上有更高的性能。因此不少数据库或存储系统也使用了 mmap，但也有一些不同的观点</p><p><br></p><h1 id=-mmap>反方：不应该使用 MMAP</h1><p>反方出自 CIDR 2022 上一篇比较短的 paper：<em><a href=https://db.cs.cmu.edu/papers/2022/cidr2022-p13-crotty.pdf rel="noopener noreferrer" target=_blank>Are You Sure You Want to Use MMAP in Your Database Management System?</a></em> 作者之一是 Andy Pavlo，刷过 CMU 15-445 的同学肯定不陌生</p><p><br></p><p>PS：页眉有惊喜</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe6a32e12-65cc-426e-881b-8c2a4eb6b942%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D959dff05a6e6bf2e252ec134c5015016def79991fbf41acc6f68f4de185ca7c5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12988756-3979-80d3-9666-e98f30e6c92f" class=glightbox data-description="" data-gallery=article-images data-title=Image><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe6a32e12-65cc-426e-881b-8c2a4eb6b942%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D959dff05a6e6bf2e252ec134c5015016def79991fbf41acc6f68f4de185ca7c5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12988756-3979-80d3-9666-e98f30e6c92f"/></a></figure><p><br></p><p>文章的主要观点是在 DBMS 内不应该使用 mmap，论文提出，mmap 存在一些阴暗面（dark side）会带来棘手的问题，而为了解决这些问题，在工程上带来的复杂性，会使得 mmap 本身的收益（简单和性能）都被抵消</p><p><br></p><p>论文具体讨论了 mmap 的以下几宗罪</p><h2 id="">事务安全</h2><p>mmap 对程序来说是透明的，何时将脏页刷到磁盘上取决于操作系统。虽然通过 <code>msync</code> 可以强制刷盘，但没有办法能够阻止刷盘（这相当于强制数据库是 steal policy 的），也无法在静默刷盘时得到通知</p><p><br></p><p>为此数据库就需要一些复杂的协议来保证事务安全，论文总结了三种处理方法，都是写时复制的（Copy-on-Write，COW）想法：</p><ol><li>内核写时复制<p>通过 <code>MAP_PRIVATE</code> flag 创建 mmap，映射出来的地址空间就是写时复制的，不会作用到底层的文件。通过这个方法，可以创建一个私有的副本工作区用来修改数据，最后在私有工作区更新的数据并写入 WAL，再传播修改回主工作区</p><p>这里要确保已提交事务的更新必须在其他冲突事务运行之前就传播到主工作区上，需要一些额外的数据结构去追踪脏页</p><p>另外因为是 COW 的，私有工作区会随着写入逐渐增长，最终可能会在内存中存在两个完整的数据库副本，可以通过 <code>mremap</code> 定期收缩私有工作区的大小避免无限扩张，但同样有上面的问题，需要确保脏页传播到主工作区上，并在此期间阻止并发更新</p><p>MongoDB 的 MMAPv1 引擎使用了这种方法</p></li><li>用户态写时复制<p>第二种方法类似，但是在用户态进行。待更新页面从 mmap 区域手动复制到另一块单独维护的缓冲区上进行更新并写入 WAL，然后再复制回 mmap 区域</p><p>SQLite，RavenDB 使用了类似的方法</p></li><li>影子分页<p>影子分页类似一种 swapping pointer 的做法，通过 mmap 映射两份出副本，其中一个是主副本。当要修改时将页面复制到影子副本上进行更新，<code>msync</code> 刷盘后 swap pointer 将影子副本变为主副本，原主副本变为新的影子副本</p><p>LMDB 使用了这种方法，但只允许单个写者进行更新</p></li></ol><p><br></p><h2 id=io->I/O 停顿</h2><p>很多 DBMS 都使用了异步 I/O（例如 libaio 或 io_uring），例如对 B+ Tree 的叶子节点扫描可以通过异步 I/O 访问以避免非连续页面的阻塞读取导致的延迟。但 mmap 是不支持异步的</p><p>此外，操作系统可能会随时会将页面驱逐，再次访问就会导致缺页中断，会有明显的性能抖动。DBMS 无法知道页面是否真正在内存中，虽然可以使用 <code>mlock</code> 将页面 pin 在内存中，但这又需要实现一些额外的页面管理工作</p><p>或者通过 <code>madvise</code> 来告知操作系统应用的访问模式以尽量避免接下来访问的页面被驱逐，但这只是一种 “advise” 而不是强力的控制，并且也只提供了简单的 <code>MADV_SEQUENTIAL</code>、<code>MADV_RANDOM</code> 和 <code>MADV_WILLNEED</code> 等几个 flag，无法精细管理</p><p><br></p><p>也许还可以创建额外的线程去做预取以避免阻塞主线程，但这额外的复杂性完全违背了使用 mmap 的初衷</p><p><br></p><h2 id="">错误处理</h2><p>DBMS 的一个核心职责是确保数据的完整性，大多数 DBMS 都会在各种级别的数据上维护 checksum，例如 SQL Server 在页面级别上维护了 checksum，从磁盘上读取数据时就会进行校验</p><p><br></p><p>但使用 mmap 的话难以实现，原因还是 DBMS 无法知道页面到底在哪里，没有一个明确的边界隔离内存和磁盘访问。操作系统可能在任意时刻将页面驱逐，下次访问再透明地重新从磁盘读取，因此必须每次进行页面访问都重新校验才能确保安全，但显然很多时候这种校验是不必要的</p><p>另外从语言角度考虑，如果使用了非内存安全的语言，有可能在不经意间破坏了 mmap 映射区域的内存数据，而这些错误的数据又会被静默地写入磁盘，永久损坏。如果是 Buffer Pool 实现，则可以在刷盘时显式检查</p><p><br></p><p>mmap 这种透明性的「优点」也会导致在代码里更难进行 I/O 错误处理。Buffer Pool 实现中 I/O 交互只局限于它自身，可以很轻易地包装对 I/O 错误的处理。但 mmap 中任意时刻的内存访问都可能导致 I/O 错误，给异常处理流带来很大的不便</p><p><br></p><h2 id="">性能问题</h2><p>最后，mmap 真的性能更好吗？</p><p><br></p><p>传统观点认为 mmap 性能好的点在于避免了 <code>read</code>/<code>write</code> 的系统调用，以及避免内核和用户态缓冲区来回拷贝的开销（这也降低了内存使用）。从这些点来看，随着 NVMe SSD 的提升，理论上 mmap 和传统 I/O 方法的差距还会进一步扩大</p><p><br></p><p>但论文指出，内核的页面驱逐机制成为主要瓶颈，该机制无法扩展到更多的线程和更大带宽的存储设备上。除非没有内核级别的重大重写，这个问题无法解决。具体来说有下面三个瓶颈：</p><ol><li>页表竞争：内核需要同步页面，在大量更新的时候会有显著竞争开销</li><li>单线程页面驱逐：内核使用单线程进行页面驱逐，扩展性受限</li><li>TLB shootdown：驱逐页面时，内核还要清理每个核心上的 TLB 项，这里多核设备的核间中断会有高昂的开销，需要数千个周期</li></ol><p><br>OLTP 比较常见的随机读负载实验中，mmap 如果使用 <code>MADV_RANDOM</code> 的 hint，在一开始还能达到 fio 的基线性能，但马上就会 I/O 跌 0 将近 5 秒，最终恢复到基线性能的一半。右图可以看到此时正好是 Page cache 被填满，开始驱逐页面</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fca6f2a55-8f94-4ce6-a6ff-9816dc9898ef%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D0df94b7595d8f41e4c194f37b0b5176dfbfefdfbd32034ebc343bca8b58de592%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12b88756-3979-80af-9b95-e0d8d5496145" class=glightbox data-description="" data-gallery=article-images data-title=Image><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fca6f2a55-8f94-4ce6-a6ff-9816dc9898ef%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D0df94b7595d8f41e4c194f37b0b5176dfbfefdfbd32034ebc343bca8b58de592%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12b88756-3979-80af-9b95-e0d8d5496145"/></a></figure><p>对于 OLAP 场景的顺序读负载试验，<code>MADV_SEQUENTIAL</code> hint 的 mmap 在一开始还能维持较高的性能，但同样在 20 秒左右 Page cache 被打满，性能严重下降。而在同时使用 10 块 SSD 的场景，mmap 性能和只有 1 块 SSD 时几乎完全一样，说明 mmap 性能无法随着硬件线性提升</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F4bffeaa1-bcba-4bbc-baf3-2a9c49313af1%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D41fbf9de1f1ed0612d782f0eeecb75ab8dcaf71bf3022acfad9e37addc19392e%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12b88756-3979-8082-830a-dc6913a96ed5" class=glightbox data-description="" data-gallery=article-images data-title=Image><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F4bffeaa1-bcba-4bbc-baf3-2a9c49313af1%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46625YKOQIA%252F20260125%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260125T140838Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEFoaCXVzLXdlc3QtMiJIMEYCIQC38%252FY7TrHD6hEZ4ZJWUWCyeO4OcVO25tiiiNcdc8PJAAIhAK6xLqgt9jjXUUiWDMNQaIVG1zmk2IUtGdg3%252F6WRrUCsKv8DCCMQABoMNjM3NDIzMTgzODA1IgyZBYUlVVqmWZiB7fEq3APzIOHpWZXJvgWPYJsn%252FyvG7rLHjbhltdjEVx%252B9gm0YIgYsHCLp8pxirlmj26Jz9W33lDjMEmkn5f6I%252BjHIU09eBrr%252F25v%252BhJbTI1tXHRZVjfH6KKxd1Rv7zVsaCA3n6Uy0qRTmdcSH42MqHedWGSv5ouXDd%252BavZ7zulF2Iu3bicGRhO38%252FnZudnK2w3XKOql0s40piXqHuyku1468jb9i8s6M%252FCMfbgc7evcvgsaHgYd5ZZNoZsMLv%252B9pG%252BsTN1DHAPeTpmkkfk7io0dAe7ad1WU4Jjqb3mZeCjSTz9Rfwhf09V6hLF0FclgoFMxpZ8DVvMERwQ3QB51x9D8wmKdfLVOBMrVIooX4fqhtEXjU35uT9uAX%252FPBXrK3Zowu6zhCuRZyjjZTubbVFSFLKyw4unw3e8AcwoeSrSS%252BYmeXTREpTuPQ9wDan2MVUZKlU3%252FUHdb0XxnUtBhtl%252BCT6AkmYjq8JMciyPLiXpzCqIeWke9GBO4KOvapz14zEcMQT50%252BDUZlo5HJo6iMaIoGb92v8QcMz6m3Pkvth1et2dwccV3eoT1XWlnFgVByX9f0coqLCxd8hWHWlFKTl26y117Qeb4YQW7UsksiM%252FRy4MdzUm81LXYjuKUAvq%252FfCkDTCyyNfLBjqkAfO%252FeNoAdR9dVj%252FdRmygGIpx9kVJ69zvev0a%252BYVuI%252Fi2R9ttWFyJKgOakqH9weqbOqKC4XLkpD3LwEYp1fYFIds8lebp8U6%252BFFReN04H6c6s%252BBIbSUctZadyhq%252FdgC3fd8J36aHl9%252B6d6l%252FYJka5EdFR9rCGPC8LmkNlDHzIEMrYpCFMPQghSSwVTCLD0FLfYeQkx3jJIA%252Feuxd%252FiENZlyvY3PjA%26X-Amz-Signature%3D41fbf9de1f1ed0612d782f0eeecb75ab8dcaf71bf3022acfad9e37addc19392e%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=12b88756-3979-8082-830a-dc6913a96ed5"/></a></figure><p><br></p><p>不过在我看来这个 benchmark 应该得加上 Buffer Pool 的数据，只和 fio 来比较显然是不公平的，fio 读写方式和真实数据库的负载不同，Buffer Pool 肯定也远达不到 fio 压测的基线性能</p><p><br></p><h1 id=-mmap->正方：使用 MMAP 完全没问题</h1><p>RavenDB 的 CEO, Oren Eini 发表了一篇文章回复：<em><a href=https://ayende.com/blog/196161-C/re-are-you-sure-you-want-to-use-mmap-in-your-database-management-system rel="noopener noreferrer" target=_blank>Re: Are You Sure You Want to Use MMAP in Your Database Management System?</a></em></p><p>RavenDB 的 Voron 存储引擎使用 mmap 构建，他们还出了一本<a href=https://github.com/ayende/libgavran rel="noopener noreferrer" target=_blank>关于如何构建存储引擎的书</a>，其内部也使用了 mmap</p><p><br></p><p>文章首先指出了 Buffer Pool 要做的事情并不少，而且也对实现有一定要求，如果不是高度优化的实现，不会有好的性能，而在 mmap 这些都能由操作系统来保障</p><p><br></p><p>接下来，文章对四个问题进行了逐一反驳</p><h2 id="">事务安全</h2><p>mmap 确实无法知道数据何时落盘，但作者认为这本质上与使用 Buffer Pool 时没有区别，在 Buffer Pool 中也同样需要考虑页面的驱逐和各种管理</p><p>文中还提到 RavenDB 使用写时复制的主要目的也是为了方便实现 MVCC，更容易处理并发事务。并且单写者模型在 DBMS 中并不罕见</p><p><br></p><h2 id=io->I/O 停顿</h2><p>作者承认关于缺页导致的 I/O 抖动是使用 mmap 必须要处理的最重要的问题，但实际情况并没有想象中那么严重。RavenDB 中通过在专用线程上调用 <code>madvise(WILL_NEED)</code>，他认为这和异步 I/O 的方式没什么不同</p><p><br></p><h2 id="">错误处理</h2><p>校验和的问题，即使在 Buffer Pool 中也会存在，因为数据可能从 cache 中读取，但实际上在磁盘中损坏；RavenDB 只会进行一次校验和检查，不需要每次都检查，两者没什么差别</p><p>对于 I/O 错误，作者认为在数据库中处理该类错误的唯一答案是 crash 掉整个数据库然后从头恢复运行，因此在这里不需要什么额外工作</p><p><br></p><h2 id="">性能问题</h2><p>对于 mmap 的三个性能瓶颈:</p><ol><li>页表竞争：是一个<a href=https://ravendb.net/articles/production-postmortem-the-guinness-record-for-page-faults-high-cpu rel="noopener noreferrer" target=_blank>已修复的内核 bug</a>，现在无需操心</li><li>单线程页面驱逐：RavenDB 从未遇到过，脏页是少数，页面驱逐的压力并不大</li><li>TLB shootdown：触发这个问题需要极快的 I/O 加上远超内存大小的工作集</li></ol><p>作者认为论文中的基准测试假设了不使用 mmap（也就是使用 Buffer Pool）的情况下没有其他成本，这是不现实的，例如使用 Buffer Pool，也同样需要考虑这些页面驱逐的问题，只不过现在是由 Buffer Pool 来负责。这个观点我是赞同的，前文的基准测试确实没有体现出 Buffer Pool 的对比</p><p><br></p><h1 id="">总结</h1><p>两篇文章看下来，个人感觉 Oren Eini 反驳的文章中内容稍显空洞，没有什么特别有力的证据或数据支撑，例如异步 I/O 性能那块没有给出具体数据，在我个人的经验中异步 I/O 还是能带来很大的提升的，除非这里的数据集很小，能大部分都缓存命中</p><p>但这篇文章也可以作为一个不同角度的参考，有些地方还是值得思考的，比如关于错误处理，另一个相似的问题是，对于底层软件，内存分配失败的情况下应该如何处理？mmap 无法像手动实现 Buffer Pool 一样限制缓存容量，可能更需要考虑这个问题</p><p>另外还可以参考下 codedump 老师的这篇 blog：</p><ul><li><a href=https://www.codedump.info/post/20220327-weekly-11/ rel="noopener noreferrer" target=_blank>周刊（第11期）：mmap适用于存储引擎吗？ - codedump的网络日志</a></li></ul><p><br></p><p>回到 mmap 上，使用 mmap 确实需要考虑比想象中更多的问题，但随着内核发展，某些痛点也逐渐被解决了，例如现在内核支持了原子 <code>msync</code> 调用，如果它失败了，就会禁用内核的透明页驱逐功能，这样就不需要再操心一些使用 mmap 带来的事务安全问题了</p><p>但总的来说我认为是否使用 mmap 是一个 trade-off，如果你希望系统更加简单，有更低的开发成本，那就使用 mmap，把一切都交给内核；但反之这也可能会让内核实现成为整个系统的瓶颈，因为内核是 general-purpose 的实现，而不是针对数据库的 special-purpose 的实现。当内核会成为你的瓶颈，或需要更多细粒度的控制，为此需要进行大量改造的话，还不如从头就开始自己实现</p><p><br></p></div><nav class=post-navigation data-astro-cid-gbhzkc2y><a href=/post/japan-travel class="nav-link nav-prev" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>← 上一篇</span> <span class=nav-title data-astro-cid-gbhzkc2y>日本游记</span> </a><a href=/post/memorydb class="nav-link nav-next" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>下一篇 →</span> <span class=nav-title data-astro-cid-gbhzkc2y>MemoryDB: Redis + Remote Log</span></a></nav><footer class=page-footer data-astro-cid-gbhzkc2y><a href=/ class=back-link data-astro-cid-gbhzkc2y>← 返回首页</a></footer><section class=comments-section data-astro-cid-gbhzkc2y><div class=comments-container data-astro-cid-te6ksoa6 data-giscus-config="{&#34;slug&#34;:&#34;db-mmap&#34;,&#34;title&#34;:&#34;应该在 DBMS 中使用 MMAP 吗？&#34;,&#34;config&#34;:{&#34;repo&#34;:&#34;xxxuuu/xxxuuu.github.io&#34;,&#34;repoId&#34;:&#34;MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg&#34;,&#34;category&#34;:&#34;Announcements&#34;,&#34;categoryId&#34;:&#34;DIC_kwDOCwLAgM4ChgWc&#34;,&#34;mapping&#34;:&#34;title&#34;,&#34;strict&#34;:&#34;0&#34;,&#34;reactionsEnabled&#34;:&#34;1&#34;,&#34;emitMetadata&#34;:&#34;0&#34;,&#34;inputPosition&#34;:&#34;bottom&#34;,&#34;lang&#34;:&#34;zh-CN&#34;,&#34;lazy&#34;:true}}" data-provider=giscus id=comments><div class=comments-loading data-astro-cid-te6ksoa6>加载评论中...</div></div></section></div><aside class=toc-container data-astro-cid-gbhzkc2y><div class=toc-wrapper data-astro-cid-gbhzkc2y><div class=toc-title data-astro-cid-gbhzkc2y>目录</div><nav class=toc-nav data-astro-cid-gbhzkc2y></nav></div></aside></div></div></article></main><footer data-astro-cid-aoh3bln3><div class=container data-astro-cid-aoh3bln3><div class=footer-content data-astro-cid-aoh3bln3><div class=copyright data-astro-cid-aoh3bln3><p data-astro-cid-aoh3bln3>&copy; 2026 x³u³. All rights reserved.</p><p data-astro-cid-aoh3bln3 class=powered-by>Powered by <a href=https://github.com/xxxuuu/nopress rel="noopener noreferrer" target=_blank data-astro-cid-aoh3bln3>Nopress</a></p></div><div class=social-links data-astro-cid-aoh3bln3><a href=https://github.com/xxxuuu class=social-icon aria-label=github data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></span></a><a href=https://x.com/xxuuu0 class=social-icon aria-label=twitter data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span></a><a href=mailto:xxuuu0@outlook.com class=social-icon aria-label=email data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg></span></a><a href=/rss/feed.xml class="social-icon rss" aria-label=RSS订阅 data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></span></a></div></div></div></footer></body></html>