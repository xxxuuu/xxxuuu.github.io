<!DOCTYPE html><html data-astro-cid-pjvcz6dw lang=zh-CN><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F49b4570c-b2f0-457b-81b7-b68e2693a471%2Favatar.png?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" rel=icon><link href=https://xxxuuu.me/post/kernel-rwlock/ rel=canonical><link href=/rss/feed.xml rel=alternate title=xÂ³uÂ³ type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap><title>ä» Linux å†…æ ¸çœ‹è¯»å†™é”è®¾è®¡ | xÂ³uÂ³</title><meta content="å‰æ®µæ—¶é—´çœ‹äº†ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ï¼Œç¬¬ 10 ç« ã€Œå†…æ ¸åŒæ­¥æ–¹æ³•ã€ä¸­æåˆ°äº†å‡ ç§å†…æ ¸ä¸­çš„è¯»å†™é”ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†å‡ ç§æ¯”è¾ƒå…¸å‹çš„è¯»å†™é”è®¾è®¡ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œè®¨è®ºæ˜¯åŸºäº 2.6 å†…æ ¸å’Œ x86 ä½“ç³»ç»“æ„çš„åŸºç¡€ä¸Šè¿›è¡Œçš„" name=description><meta content=website property=og:type><meta content=https://xxxuuu.me/post/kernel-rwlock/ property=og:url><meta content="ä» Linux å†…æ ¸çœ‹è¯»å†™é”è®¾è®¡ | xÂ³uÂ³" property=og:title><meta content="å‰æ®µæ—¶é—´çœ‹äº†ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ï¼Œç¬¬ 10 ç« ã€Œå†…æ ¸åŒæ­¥æ–¹æ³•ã€ä¸­æåˆ°äº†å‡ ç§å†…æ ¸ä¸­çš„è¯»å†™é”ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†å‡ ç§æ¯”è¾ƒå…¸å‹çš„è¯»å†™é”è®¾è®¡ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œè®¨è®ºæ˜¯åŸºäº 2.6 å†…æ ¸å’Œ x86 ä½“ç³»ç»“æ„çš„åŸºç¡€ä¸Šè¿›è¡Œçš„" property=og:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" property=og:image><meta content=summary_large_image name=twitter:card><meta content=@xxuuu0 name=twitter:site><meta content="ä» Linux å†…æ ¸çœ‹è¯»å†™é”è®¾è®¡ | xÂ³uÂ³" name=twitter:title><meta content="å‰æ®µæ—¶é—´çœ‹äº†ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ï¼Œç¬¬ 10 ç« ã€Œå†…æ ¸åŒæ­¥æ–¹æ³•ã€ä¸­æåˆ°äº†å‡ ç§å†…æ ¸ä¸­çš„è¯»å†™é”ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†å‡ ç§æ¯”è¾ƒå…¸å‹çš„è¯»å†™é”è®¾è®¡ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œè®¨è®ºæ˜¯åŸºäº 2.6 å†…æ ¸å’Œ x86 ä½“ç³»ç»“æ„çš„åŸºç¡€ä¸Šè¿›è¡Œçš„" name=twitter:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" name=twitter:image><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=stylesheet></noscript><script>!function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.add(e)}()</script><link href=/_astro/katex.CVb4srxQ.css rel=stylesheet><link href=/_astro/_slug_.CtQEHxK0.css rel=stylesheet><link href=/_astro/_slug_.DhuirupF.css rel=stylesheet><link href=/_astro/_slug_.DOIB7y8p.css rel=stylesheet><script src=/_astro/hoisted.B871fABB.js type=module></script></head><body data-astro-cid-pjvcz6dw><header class=notion-header data-astro-cid-4f4rmh32><div class=header-container data-astro-cid-4f4rmh32><div class=header-content data-astro-cid-4f4rmh32><div class=logo data-astro-cid-4f4rmh32><a href=/ class=logo-link data-astro-cid-4f4rmh32>xÂ³uÂ³</a></div><div class=header-actions data-astro-cid-4f4rmh32><nav class=nav data-astro-cid-4f4rmh32><a href=/ class=nav-link data-astro-cid-4f4rmh32>ğŸ  é¦–é¡µ </a><a href=/archive class=nav-link data-astro-cid-4f4rmh32>ğŸ“ƒ å½’æ¡£ </a><a href=/links class=nav-link data-astro-cid-4f4rmh32>ğŸ‘¬ å‹é“¾ </a><a href=https://p.xxxuuu.me class=nav-link data-astro-cid-4f4rmh32 rel="noopener noreferrer" target=_blank>ğŸ“· æ‘„å½± <span class=external-icon data-astro-cid-4f4rmh32>â†—</span> </a><a href=/about class=nav-link data-astro-cid-4f4rmh32>ğŸ‘¤ å…³äº</a></nav><button aria-label="Toggle theme" title=åˆ‡æ¢ä¸»é¢˜ data-astro-cid-44mn2ykx id=theme-toggle><svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=sun-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 data-astro-cid-44mn2ykx r=5></circle><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=1 y2=3></line><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=21 y2=23></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line data-astro-cid-44mn2ykx x1=1 x2=3 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=21 x2=23 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg> <svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=moon-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-44mn2ykx></path></svg></button></div></div></div></header><main class=notion-main data-astro-cid-pjvcz6dw><article class=content data-astro-cid-gbhzkc2y><div class=notion-page data-astro-cid-gbhzkc2y><div class=page-container data-astro-cid-gbhzkc2y><div class=page-main data-astro-cid-gbhzkc2y><header class=page-header data-astro-cid-gbhzkc2y><h1 class=page-title data-astro-cid-gbhzkc2y>ä» Linux å†…æ ¸çœ‹è¯»å†™é”è®¾è®¡</h1></header><div class=page-meta data-astro-cid-gbhzkc2y><div class=meta-info data-astro-cid-gbhzkc2y><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>ğŸ“…</span> <time data-astro-cid-gbhzkc2y datetime=2024-01-04>2024å¹´01æœˆ04æ—¥</time> </span><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>â±ï¸</span> <span data-astro-cid-gbhzkc2y>11 åˆ†é’Ÿé˜…è¯»</span></span></div><div class=meta-tags data-astro-cid-gbhzkc2y><span class=tags-icon data-astro-cid-gbhzkc2y>ğŸ·ï¸</span> <a href=/tag/linux class=tag-pill data-astro-cid-gbhzkc2y>Linux</a><a href=/tag/æ“ä½œç³»ç»Ÿ class=tag-pill data-astro-cid-gbhzkc2y>æ“ä½œç³»ç»Ÿ</a></div><div class=meta-description data-astro-cid-gbhzkc2y>å‰æ®µæ—¶é—´çœ‹äº†ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ï¼Œç¬¬ 10 ç« ã€Œå†…æ ¸åŒæ­¥æ–¹æ³•ã€ä¸­æåˆ°äº†å‡ ç§å†…æ ¸ä¸­çš„è¯»å†™é”ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†å‡ ç§æ¯”è¾ƒå…¸å‹çš„è¯»å†™é”è®¾è®¡ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œè®¨è®ºæ˜¯åŸºäº 2.6 å†…æ ¸å’Œ x86 ä½“ç³»ç»“æ„çš„åŸºç¡€ä¸Šè¿›è¡Œçš„</div></div><hr class=page-divider data-astro-cid-gbhzkc2y><div class=notion-content data-astro-cid-gbhzkc2y><p>å‰æ®µæ—¶é—´çœ‹äº†ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹ï¼Œç¬¬ 10 ç« ã€Œå†…æ ¸åŒæ­¥æ–¹æ³•ã€ä¸­æåˆ°äº†å‡ ç§å†…æ ¸ä¸­çš„è¯»å†™é”ã€‚å®ƒä»¬åˆ†åˆ«ä»£è¡¨äº†å‡ ç§æ¯”è¾ƒå…¸å‹çš„è¯»å†™é”è®¾è®¡ï¼Œéå¸¸å€¼å¾—å­¦ä¹ ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ï¼Œè®¨è®ºæ˜¯åŸºäº 2.6 å†…æ ¸å’Œ x86 ä½“ç³»ç»“æ„çš„åŸºç¡€ä¸Šè¿›è¡Œçš„</p><h2 id="">è¯»/å†™è‡ªæ—‹é”</h2><p>å†…æ ¸ä»£ç ä¸­ï¼Œè¦å®šä¹‰è¯»/å†™è‡ªæ—‹é”ï¼Œé€šè¿‡ä¸‹é¢çš„å®è¿›è¡Œåˆå§‹åŒ–ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>DEFINE_RWLOCK(mr_rwlock);</code></pre></div><p>ä½¿ç”¨ä¸Šè¯»é”å’Œå†™é”æ˜¯åˆ†å¼€åŠ é”çš„</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>read_lock(&amp;mr_rwlock);
// åªè¯»ä¸´ç•ŒåŒº
read_unlock(&amp;mr_rwlock);

write_lock(&amp;mr_rwlock);
// è¯»å†™ä¸´ç•ŒåŒº
write_unlock(&amp;mr_rwlock);</code></pre></div><p><strong>ä¸èƒ½</strong>åƒè¿™æ ·å°†ä¸€ä¸ªè¯»é”å‡çº§æˆå†™é”ï¼Œè¿™ä¼šå¯¼è‡´æ­»é”ï¼›å¹¶ä¸”å†™é”ä¹Ÿæ˜¯ä¸å¯é‡å…¥çš„ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>read_lock(&amp;mr_rwlock);
write_lock(&amp;mr_rwlock);</code></pre></div><p><br></p><p>è¯»/å†™è‡ªæ—‹é”çš„æ±‡ç¼–çº§åˆ«å®ç°æ¯”è¾ƒç±»ä¼¼ä¿¡å·é‡ï¼Œéƒ½æ˜¯åœ¨å¯„å­˜å™¨ä¸Šå¯¹å€¼åšå¢å‡ï¼Œä½†ä¸ºäº†åŒºåˆ†è¯»é”å’Œå†™é”ï¼Œè¯»é”æ˜¯å›ºå®šå‡ 1ï¼Œå†™é”åˆ™æ˜¯å›ºå®šå‡å»ä¸€ä¸ªå¾ˆå¤§çš„ magic numberï¼Œé€šè¿‡ç»“æœå€¼æ¯”è¾ƒå°±èƒ½åˆ¤æ–­é”æŒæœ‰æƒ…å†µ</p><p>ä»£ç åˆ†åˆ«ä½äº <a href=https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/rwlock.h rel="noopener noreferrer" target=_blank>include/asm-x86_64/rwlock.h</a> å’Œ <a href=https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/spinlock.h rel="noopener noreferrer" target=_blank>/include/asm-x86_64/spinlock.h</a> ä¸­ï¼Œè¿™ä¸¤å—æ¶‰åŠçš„æ ¸å¿ƒä»£ç èåˆä¸€ä¸‹å¤§è‡´å¦‚ä¸‹ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>#define RW_LOCK_BIAS 0x01000000

// åˆå§‹åŒ–æ—¶è®¾ç½®è¿™ä¸ªå€¼ä¸º magic number
#define rwlock_init(x)	do { *(x) = RW_LOCK_UNLOCKED; } while(0)

// è·å–è¯»é”
// å°†eaxå¯„å­˜å™¨æŒ‡å‘çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯å˜é‡rwçš„å€¼å‡1ï¼ˆsubl $1ï¼‰
// æ ¹æ®ç»“æœæ˜¯å¦å°äº0ï¼ˆjs 2fï¼‰åšè·³è½¬ï¼Œå°äº0å°±å»è°ƒç”¨ä¼ å…¥çš„helperåšè·å–å¤±è´¥çš„å¤„ç†
// æ²¡æœ‰å†™é”çš„æƒ…å†µä¸‹æ˜¯ä¸ä¼šå°äº0çš„ï¼Œä¸å¯èƒ½æœ‰è¿™ä¹ˆå¤šè¯»è€…èƒ½è®©å®ƒå‡åˆ°0ï¼Œæ‰€ä»¥ä¸å°äº0å°±æ˜¯è·å–æˆåŠŸ
#define __build_read_lock_ptr(rw, helper)   \
	asm volatile(LOCK &quot;subl $1,(%0)\n\t&quot; \ 
		     &quot;js 2f\n&quot; \ 
		     &quot;1:\n&quot; \
		    LOCK_SECTION_START(&quot;&quot;) \
		     &quot;2:\tcall &quot; helper &quot;\n\t&quot; \
		     &quot;jmp 1b\n&quot; \
		    LOCK_SECTION_END \
		     ::&quot;a&quot; (rw) : &quot;memory&quot;)

// ä¼ å…¥çš„helperä½äºarch/i386/kernel/semaphore.c
// è¿™é‡Œå°±æ˜¯ä¸€ä¸ªè‡ªæ—‹çš„é€»è¾‘ï¼ŒæŒç»­æ“ä½œrwç›´åˆ°å®ƒæ˜¯å¤§äºç­‰äº0çš„ï¼Œç›¸å½“äº:
// 
// lock_failed:
// rw++;
// while(rw &lt; 1) {}
// rw--;
// if(rw &lt; 0) goto lock_failed;
// 
// è¿™é‡Œç»“å°¾è¿˜è¦åˆ¤æ–­ä¸€æ¬¡ï¼Œæ˜¯å› ä¸ºå‰é¢çš„æ“ä½œæ•´ä½“ä¸Šä¸æ˜¯åŸå­æˆ–äº’æ–¥çš„ï¼Œæ‰€ä»¥declåè¦å†checkä¸€ä¸‹
asm(
&quot;.text\n&quot;
&quot;.align	4\n&quot;
&quot;.globl	__read_lock_failed\n&quot;
&quot;__read_lock_failed:\n\t&quot;
	LOCK &quot;incl	(%eax)\n&quot;
&quot;1:	rep; nop\n\t&quot;
	&quot;cmpl	$1,(%eax)\n\t&quot;
	&quot;js	1b\n\t&quot;
	LOCK &quot;decl	(%eax)\n\t&quot;
	&quot;js	__read_lock_failed\n\t&quot;
	&quot;ret&quot;
);

// è·å–å†™é”
// eaxå¯„å­˜å™¨æŒ‡å‘çš„åœ°å€å€¼ï¼Œä¹Ÿå°±æ˜¯rwå‡å»magic number
// åˆ¤æ–­ç»“æœæ˜¯å¦åˆšå¥½ä¸º0ï¼ˆjnz 2fï¼‰ï¼Œä¸æ˜¯åˆ™è¯´æ˜æœ‰è¯»é”åœ¨å ç”¨ï¼Œè·³è½¬åˆ°helperè°ƒç”¨
#define __build_write_lock_ptr(rw, helper) \
	asm volatile(LOCK &quot;subl $&quot; RW_LOCK_BIAS_STR &quot;,(%0)\n\t&quot; \
		     &quot;jnz 2f\n&quot; \
		     &quot;1:\n&quot; \
		     LOCK_SECTION_START(&quot;&quot;) \
		     &quot;2:\tcall &quot; helper &quot;\n\t&quot; \
		     &quot;jmp 1b\n&quot; \
		     LOCK_SECTION_END \
		     ::&quot;a&quot; (rw) : &quot;memory&quot;)

// å†™é”ä¼ å…¥çš„helperåŒæ ·ä½äºarch/i386/kernel/semaphore.c
// é€»è¾‘å’Œè¯»é”çš„åŸºæœ¬ä¸€æ ·
asm(
&quot;.text\n&quot;
&quot;.align	4\n&quot;
&quot;.globl	__write_lock_failed\n&quot;
&quot;__write_lock_failed:\n\t&quot;
	LOCK &quot;addl	$&quot; RW_LOCK_BIAS_STR &quot;,(%eax)\n&quot;
&quot;1:	rep; nop\n\t&quot;
	&quot;cmpl	$&quot; RW_LOCK_BIAS_STR &quot;,(%eax)\n\t&quot;
	&quot;jne	1b\n\t&quot;
	LOCK &quot;subl	$&quot; RW_LOCK_BIAS_STR &quot;,(%eax)\n\t&quot;
	&quot;jnz	__write_lock_failed\n\t&quot;
	&quot;ret&quot;
);

// è§£é”æ—¶å°±æ˜¯åŠ ä¸Š1æˆ–magic number
#define _raw_read_unlock(rw) asm volatile(&quot;lock ; incl %0&quot; :&quot;=m&quot; ((rw)-&gt;lock) : : &quot;memory&quot;)
#define _raw_write_unlock(rw)	asm volatile(&quot;lock ; addl $&quot; RW_LOCK_BIAS_STR &quot;,%0&quot;:&quot;=m&quot; ((rw)-&gt;lock) : : &quot;memory&quot;)</code></pre></div><p>å¯ä»¥çœ‹å‡ºï¼Œè¯»/å†™è‡ªæ—‹é”æ˜¯<strong>è¯»ä¼˜å…ˆ</strong>çš„ï¼Œä¼šå¯¼è‡´å†™é¥¥é¥¿ã€‚å½“æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¯»è€…æŒæœ‰è¯»é”æ—¶ï¼Œå†™æ“ä½œæ— æ³•è·å–é”ï¼Œå¦‚æœæ­¤æ—¶è¯»é”è¢«é•¿æ—¶é—´å æœ‰ï¼Œå†™é”å°†ä¸€ç›´è‡ªæ—‹ç­‰å¾…ï¼Œæ­¤æ—¶è‡ªæ—‹ä¼šå¯¼è‡´ä¸€ä¸ªæ ¸å¿ƒä¸Šçš„é«˜æ˜‚å¼€é”€</p><p><br></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¤„ç†ä¸Šçš„ç»†èŠ‚ï¼Œåœ¨çœŸæ­£å¼€å§‹è‡ªæ—‹è·å–åˆ°å†™é”ä¹‹å‰ï¼Œå°±å·²ç»äº’æ–¥äº†ï¼ˆå‡å» magic numberï¼‰ï¼Œè¿™æ—¶å€™æ–°çš„è¯»é”æ˜¯æ— æ³•è·å–çš„ï¼Œè¿™é¿å…äº†å†™é”å’Œè¯»é”çš„äº‰æŠ¢ï¼Œèƒ½ç¨å¾®ç¼“è§£ä¸‹å†™é¥¥é¥¿é—®é¢˜ï¼Œä¾‹å¦‚è¿™æ ·çš„æƒ…å†µï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Plain text</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class="language-plain text">                            TIME
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚    reader    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   spin   â”‚       writer       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚           spin          â”‚     reader    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚    spin    â”‚   reader  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre></div><p><br></p><h2 id="">è¯»/å†™ä¿¡å·é‡</h2><p>è¯»/å†™ä¿¡å·é‡çš„ä½¿ç”¨ä¸Šå’Œè¯»/å†™è‡ªæ—‹é”æ˜¯ç±»ä¼¼çš„ï¼Œä½†åŠŸèƒ½ä¸Šè¦å¼ºå¤§ä¸€äº›ï¼Œåˆ†åˆ«æ”¯æŒé™æ€å’ŒåŠ¨æ€çš„åˆå§‹åŒ–æ–¹æ³•</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>// é™æ€å®šä¹‰
static DECLARE_RWSEM(name);
// åŠ¨æ€å®šä¹‰
init_rwsem(struct rw_semaphore *sem);</code></pre></div><p>è¯»/å†™ä¿¡å·é‡æ”¯æŒ trylock æ“ä½œå’ŒåŠ¨æ€åœ°å°†å†™é”é™çº§ä¸ºè¯»é”</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>static DECLARE_RWSEM(mr_rwsem);

down_read(&amp;mr_rwsem);
// åªè¯»ä¸´ç•ŒåŒº
up_read(&amp;mr_rwsem);

down_write(&amp;mr_rwsem);
// è¯»å†™ä¸´ç•ŒåŒº
up_write(&amp;mr_rwsem);

down_write(&amp;mr_rwsem);
// è¯»å†™ä¸´ç•ŒåŒº
downgrade_write(&amp;mr_rwsem); // å†™é”é™çº§è¯»é”
// åªè¯»ä¸´ç•ŒåŒº
up_read(&amp;mr_rwsem);</code></pre></div><p><br></p><p><a href=https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/rwsem.h#L99 rel="noopener noreferrer" target=_blank>include/asm-x86_64/rwsem.h</a> ä¸­å®šä¹‰äº†æ±‡ç¼–çº§åˆ«ä¸Šçš„å®ç°ï¼Œå’Œå‰é¢è¯»/å†™è‡ªæ—‹é”æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ²¡æœ‰è‡ªæ—‹ï¼Œè¿™é‡Œå°±ä¸ç»†è¯´ï¼Œå†…æ ¸æºç è¿™é‡Œä¹Ÿç›´æ¥é™„å¸¦æ³¨é‡Šäº†ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>#define RWSEM_UNLOCKED_VALUE		  0x00000000
#define RWSEM_ACTIVE_BIAS		      0x00000001
#define RWSEM_ACTIVE_MASK		      0x0000ffff
#define RWSEM_WAITING_BIAS		    (-0x00010000)
#define RWSEM_ACTIVE_READ_BIAS		RWSEM_ACTIVE_BIAS
#define RWSEM_ACTIVE_WRITE_BIAS		(RWSEM_WAITING_BIAS + RWSEM_ACTIVE_BIAS)

/*
 * lock for reading
 */
static inline void __down_read(struct rw_semaphore *sem)
{
	__asm__ __volatile__(
		&quot;# beginning down_read\n\t&quot;
LOCK_PREFIX	&quot;  incl      (%%rdi)\n\t&quot; /* adds 0x00000001, returns the old value */
		&quot;  js        2f\n\t&quot; /* jump if we weren&#039;t granted the lock */
		&quot;1:\n\t&quot;
		LOCK_SECTION_START(&quot;&quot;) \
		&quot;2:\n\t&quot;
		&quot;  call      rwsem_down_read_failed_thunk\n\t&quot;
		&quot;  jmp       1b\n&quot;
		LOCK_SECTION_END \
		&quot;# ending down_read\n\t&quot;
		: &quot;+m&quot;(sem-&gt;count)
		: &quot;D&quot;(sem)
		: &quot;memory&quot;, &quot;cc&quot;);
}

/*
 * lock for writing
 */
static inline void __down_write(struct rw_semaphore *sem)
{
	int tmp;

	tmp = RWSEM_ACTIVE_WRITE_BIAS;
	__asm__ __volatile__(
		&quot;# beginning down_write\n\t&quot;
LOCK_PREFIX	&quot;  xaddl      %0,(%%rdi)\n\t&quot; /* subtract 0x0000ffff, returns the old value */
		&quot;  testl     %0,%0\n\t&quot; /* was the count 0 before? */
		&quot;  jnz       2f\n\t&quot; /* jump if we weren&#039;t granted the lock */
		&quot;1:\n\t&quot;
		LOCK_SECTION_START(&quot;&quot;)
		&quot;2:\n\t&quot;
		&quot;  call      rwsem_down_write_failed_thunk\n\t&quot;
		&quot;  jmp       1b\n&quot;
		LOCK_SECTION_END
		&quot;# ending down_write&quot;
		: &quot;=&amp;r&quot; (tmp) 
		: &quot;0&quot;(tmp), &quot;D&quot;(sem)
		: &quot;memory&quot;, &quot;cc&quot;);
}

/*
 * unlock after reading
 */
static inline void __up_read(struct rw_semaphore *sem)
{
	__s32 tmp = -RWSEM_ACTIVE_READ_BIAS;
	__asm__ __volatile__(
		&quot;# beginning __up_read\n\t&quot;
LOCK_PREFIX	&quot;  xaddl      %[tmp],(%%rdi)\n\t&quot; /* subtracts 1, returns the old value */
		&quot;  js        2f\n\t&quot; /* jump if the lock is being waited upon */
		&quot;1:\n\t&quot;
		LOCK_SECTION_START(&quot;&quot;)
		&quot;2:\n\t&quot;
		&quot;  decw      %w[tmp]\n\t&quot; /* do nothing if still outstanding active readers */
		&quot;  jnz       1b\n\t&quot;
		&quot;  call      rwsem_wake_thunk\n\t&quot;
		&quot;  jmp       1b\n&quot;
		LOCK_SECTION_END
		&quot;# ending __up_read\n&quot;
		: &quot;+m&quot;(sem-&gt;count), [tmp] &quot;+r&quot; (tmp)
		: &quot;D&quot;(sem)
		: &quot;memory&quot;, &quot;cc&quot;);
}

/*
 * unlock after writing
 */
static inline void __up_write(struct rw_semaphore *sem)
{
	unsigned tmp; 
	__asm__ __volatile__(
		&quot;# beginning __up_write\n\t&quot;
		&quot;  movl     %[bias],%[tmp]\n\t&quot;
LOCK_PREFIX	&quot;  xaddl     %[tmp],(%%rdi)\n\t&quot; /* tries to transition 0xffff0001 -&gt; 0x00000000 */
		&quot;  jnz       2f\n\t&quot; /* jump if the lock is being waited upon */
		&quot;1:\n\t&quot;
		LOCK_SECTION_START(&quot;&quot;)
		&quot;2:\n\t&quot;
		&quot;  decw      %w[tmp]\n\t&quot; /* did the active count reduce to 0? */
		&quot;  jnz       1b\n\t&quot; /* jump back if not */
		&quot;  call      rwsem_wake_thunk\n\t&quot;
		&quot;  jmp       1b\n&quot;
		LOCK_SECTION_END
		&quot;# ending __up_write\n&quot;
		: &quot;+m&quot;(sem-&gt;count), [tmp] &quot;=r&quot; (tmp)
		: &quot;D&quot;(sem), [bias] &quot;i&quot;(-RWSEM_ACTIVE_WRITE_BIAS)
		: &quot;memory&quot;, &quot;cc&quot;);
}</code></pre></div><p><br></p><p>ä¿¡å·é‡æ˜¯ç¡çœ é”ï¼Œè¯»é”å’Œå†™é”åœ¨è·å–é”å¤±è´¥æ—¶æœ€åéƒ½ä¼šè¿›å…¥åˆ° <code>rwsem_down_failed_common</code>ï¼ˆä½äº <a href=https://elixir.bootlin.com/linux/v2.6.0/source/lib/rwsem.c#L123 rel="noopener noreferrer" target=_blank>lib/rwsem.c</a>ï¼‰ ä¸­ï¼Œè¿™é‡Œä¼šå°†è¿›ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åé‡æ–°è°ƒåº¦è¿›ç¨‹</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>static inline struct rw_semaphore *rwsem_down_failed_common(struct rw_semaphore *sem,
								 struct rwsem_waiter *waiter,
								 signed long adjustment)
{
	struct task_struct *tsk = current;
	signed long count;

	set_task_state(tsk,TASK_UNINTERRUPTIBLE);

	/* set up my own style of waitqueue */
	spin_lock(&amp;sem-&gt;wait_lock);
	waiter-&gt;task = tsk;

	list_add_tail(&amp;waiter-&gt;list,&amp;sem-&gt;wait_list);

	/* note that we&#039;re now waiting on the lock, but no longer actively read-locking */
	count = rwsem_atomic_update(adjustment,sem);

	/* if there are no longer active locks, wake the front queued process(es) up
	 * - it might even be this process, since the waker takes a more active part
	 */
	if (!(count &amp; RWSEM_ACTIVE_MASK))
		sem = __rwsem_do_wake(sem,1);

	spin_unlock(&amp;sem-&gt;wait_lock);

	/* wait to be given the lock */
	for (;;) {
		if (!waiter-&gt;flags)
			break;
		schedule();
		set_task_state(tsk, TASK_UNINTERRUPTIBLE);
	}

	tsk-&gt;state = TASK_RUNNING;

	return sem;
}</code></pre></div><p><br></p><p>å€¼å¾—ä¸€æçš„æ˜¯ <code>trylock</code> å’Œ <code>downgrade_write</code> æ“ä½œï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯è¯»/å†™è‡ªæ—‹é”ä¸­æ²¡æœ‰çš„</p><p>ä¸¤ä¸ª <code>trylock</code> æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯ç”¨ <code>cmpxchg</code> æŒ‡ä»¤æ¥åš CASï¼ˆcompare-and-swapï¼‰ æ“ä½œã€‚å†™é”çš„ <code>trylock</code> æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ˜¯äº’æ–¥çš„ï¼Œæ‰€ä»¥åªéœ€è¦å¯¹åˆå§‹å€¼åš CAS å³å¯ã€‚è€Œè¯»é”å¯èƒ½è¢«æŒæœ‰å¤šä¸ªï¼Œæ‰€ä»¥å®ƒçš„ <code>trylock</code> éœ€è¦å…ˆå°† <code>sem-&gt;count</code> èµ‹å€¼ç»™ <code>tmp</code>ï¼Œå†è‡ªå¢ <code>tmp</code> ï¼Œåˆ©ç”¨ <code>tmp</code> çš„å€¼è¿›è¡Œ CAS</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>/*
 * trylock for reading -- returns 1 if successful, 0 if contention
 */
static inline int __down_read_trylock(struct rw_semaphore *sem)
{
	__s32 result, tmp;
	__asm__ __volatile__(
		&quot;# beginning __down_read_trylock\n\t&quot;
		&quot;  movl      %0,%1\n\t&quot;
		&quot;1:\n\t&quot;
		&quot;  movl	     %1,%2\n\t&quot;
		&quot;  addl      %3,%2\n\t&quot;
		&quot;  jle	     2f\n\t&quot;
LOCK_PREFIX	&quot;  cmpxchgl  %2,%0\n\t&quot;
		&quot;  jnz	     1b\n\t&quot;
		&quot;2:\n\t&quot;
		&quot;# ending __down_read_trylock\n\t&quot;
		: &quot;+m&quot;(sem-&gt;count), &quot;=&amp;a&quot;(result), &quot;=&amp;r&quot;(tmp)
		: &quot;i&quot;(RWSEM_ACTIVE_READ_BIAS)
		: &quot;memory&quot;, &quot;cc&quot;);
	return result&gt;=0 ? 1 : 0;
}

/*
 * trylock for writing -- returns 1 if successful, 0 if contention
 */
static inline int __down_write_trylock(struct rw_semaphore *sem)
{
	signed long ret = cmpxchg(&amp;sem-&gt;count,
				  RWSEM_UNLOCKED_VALUE, 
				  RWSEM_ACTIVE_WRITE_BIAS);
	if (ret == RWSEM_UNLOCKED_VALUE)
		return 1;
	return 0;
}</code></pre></div><p>downgrade_write çš„å®ç°åˆ™ç±»ä¼¼å†™é”è§£é”ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æœ‰å¿…è¦å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„é¡¹ï¼Œè¿™é‡Œå…¶å®å’Œå†™é”è§£é”ï¼ˆ<code>up_write</code>ï¼‰çš„ä¸»è¦å·®åˆ«å°±æ˜¯ç»™ <code>sem-&gt;count</code> åŠ ä¸Šçš„åç§»é‡å°‘äº† 1ï¼ˆå¯ä»¥å›å»çœ‹å‰é¢å‡ ä¸ª <code>RWSEM_</code> å¼€å¤´çš„å®å®šä¹‰ï¼‰ï¼Œè€Œè¿™ä¸ª 1 å°±æ˜¯è¯»é”å çš„å€¼</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>/*
 * downgrade write lock to read lock
 */
static inline void __downgrade_write(struct rw_semaphore *sem)
{
	__asm__ __volatile__(
		&quot;# beginning __downgrade_write\n\t&quot;
LOCK_PREFIX	&quot;  addl      %[bias],(%%rdi)\n\t&quot; /* transitions 0xZZZZ0001 -&gt; 0xYYYY0001 */
		&quot;  js        2f\n\t&quot; /* jump if the lock is being waited upon */
		&quot;1:\n\t&quot;
		LOCK_SECTION_START(&quot;&quot;)
		&quot;2:\n\t&quot;
		&quot;  call	     rwsem_downgrade_thunk\n&quot;
		&quot;  jmp       1b\n&quot;
		LOCK_SECTION_END
		&quot;# ending __downgrade_write\n&quot;
		: &quot;=m&quot;(sem-&gt;count)
		: &quot;D&quot;(sem), [bias] &quot;i&quot;(-RWSEM_WAITING_BIAS), &quot;m&quot;(sem-&gt;count)
		: &quot;memory&quot;, &quot;cc&quot;);
}

/*
 * downgrade a write lock into a read lock
 * - caller incremented waiting part of count, and discovered it to be still negative
 * - just wake up any readers at the front of the queue
 */
struct rw_semaphore *rwsem_downgrade_wake(struct rw_semaphore *sem)
{
	rwsemtrace(sem,&quot;Entering rwsem_downgrade_wake&quot;);

	spin_lock(&amp;sem-&gt;wait_lock);

	/* do nothing if list empty */
	if (!list_empty(&amp;sem-&gt;wait_list))
		sem = __rwsem_do_wake(sem,0);

	spin_unlock(&amp;sem-&gt;wait_lock);

	rwsemtrace(sem,&quot;Leaving rwsem_downgrade_wake&quot;);
	return sem;
}</code></pre></div><p>æ€»ç»“ä¸€ä¸‹ï¼Œè¯»/å†™ä¿¡å·é‡å’Œè¯»/å†™è‡ªæ—‹é”ç±»ä¼¼ï¼Œä¸¤è€…è¯­ä¹‰ä¸Šæ˜¯ç›¸åŒçš„ï¼Œä¹Ÿéƒ½æ˜¯è¯»ä¼˜å…ˆçš„ï¼Œåªä¸è¿‡ä¿¡å·é‡æ˜¯ç¡çœ é”ï¼Œå½“æœ‰é•¿æ—¶é—´è·å–ä¸åˆ°é”çš„æƒ…å†µæ—¶ï¼Œä¸ä¼šå¯¼è‡´è¿‡å¤šçš„ CPU å¼€é”€</p><p><br></p><h2 id="">é¡ºåºé”</h2><p>é¡ºåºé”å’Œå‰é¢ä¸¤è€…æœ‰ä¸ªé‡è¦çš„åŒºåˆ«ï¼Œé¡ºåºé”æ˜¯<strong>å†™ä¼˜å…ˆ</strong>çš„ï¼Œè®©æˆ‘ä»¬æ¥åˆ†æä¸‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„</p><p>é¦–å…ˆè¿˜æ˜¯ä½¿ç”¨æ–¹å¼ä¸Šï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>// å®šä¹‰ä¸€ä¸ªé¡ºåºé”
seqlock_t mr_seq_lock = DEFINE_SEQLOCK(mr_seq_lock);

write_seqlock(&amp;mr_seq_lock);
// è¯»å†™ä¸´ç•ŒåŒº
write_sequnlock(&amp;mr_seq_lock);

// è¯»é”çš„ä½¿ç”¨æœ‰è¾ƒå¤§åŒºåˆ«
unsigned long seq;
do {
	seq = read_seqbegin(&amp;mr_seq_lock);
  // è¯»å–æ•°æ®...
} while (read_seqretry(&amp;mr_seq_lock, seq));</code></pre></div><p>ä¸€ä¸ªä½¿ç”¨ä¾‹å­æ˜¯å†…æ ¸çš„ jiffiesï¼Œå®ƒå­˜å‚¨äº†æœºå™¨å¯åŠ¨åˆ°å½“å‰çš„æ—¶é’ŸèŠ‚æ‹ï¼Œæ¯æ¬¡æ—¶é’Ÿä¸­æ–­æ—¶éƒ½ä¼šæ›´æ–°è¿™ä¸ªå€¼ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªé«˜é¢‘å†™å…¥çš„åœºæ™¯ï¼Œ<code>get_jiffies_64()</code> å‡½æ•°ç”¨æ¥è·å–è¿™ä¸ªå€¼ï¼Œå®ƒçš„å®ç°æ˜¯è¿™æ ·çš„</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>u64 get_jiffies_64(void)
{
	unsigned long seq;
	u64 ret;

	do {
		seq = read_seqbegin(&amp;xtime_lock);
		ret = jiffies_64;
	} while (read_seqretry(&amp;xtime_lock, seq));
	return ret;
}</code></pre></div><p>é¡ºåºé”åœ¨è¯»å–æ—¶éœ€è¦ä¸€ä¸ªå¾ªç¯ï¼Œè¿™æ˜¯ä¸ºäº†åˆ¤æ–­åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯å¦æœ‰å‘ç”Ÿå†™å…¥ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆè¯»å–å°±æ˜¯å®‰å…¨çš„ï¼Œå¦åˆ™éœ€è¦é‡è¯•</p><p>å®ç°ä¸Šï¼Œä»£ç ä½äº <a href=https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/seqlock.h#L50 rel="noopener noreferrer" target=_blank>/include/linux/seqlock.h</a>ï¼Œæœ‰æ¯”è¾ƒæ¸…æ™°çš„æ³¨é‡Šï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c>#define SEQLOCK_UNLOCKED { 0, SPIN_LOCK_UNLOCKED }
#define seqlock_init(x)	do { *(x) = (seqlock_t) SEQLOCK_UNLOCKED; } while (0)

/* Lock out other writers and update the count.
 * Acts like a normal spin_lock/unlock.
 * Don&#039;t need preempt_disable() because that is in the spin_lock already.
 */
static inline void write_seqlock(seqlock_t *sl)
{
	spin_lock(&amp;sl-&gt;lock);
	++sl-&gt;sequence;
	smp_wmb();			
}	

static inline void write_sequnlock(seqlock_t *sl) 
{
	smp_wmb();
	sl-&gt;sequence++;
	spin_unlock(&amp;sl-&gt;lock);
}

static inline int write_tryseqlock(seqlock_t *sl)
{
	int ret = spin_trylock(&amp;sl-&gt;lock);

	if (ret) {
		++sl-&gt;sequence;
		smp_wmb();			
	}
	return ret;
}

/* Start of read calculation -- fetch last complete writer token */
static inline unsigned read_seqbegin(const seqlock_t *sl)
{
	unsigned ret = sl-&gt;sequence;
	smp_rmb();
	return ret;
}

/* Test if reader processed invalid data.
 * If initial values is odd, 
 *	then writer had already started when section was entered
 * If sequence value changed
 *	then writer changed data while in section
 *    
 * Using xor saves one conditional branch.
 */
static inline int read_seqretry(const seqlock_t *sl, unsigned iv)
{
	smp_rmb();
	return (iv &amp; 1) | (sl-&gt;sequence ^ iv);
}</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œé¡ºåºé”æ˜¯åŸºäºä¸€ä¸ªè‡ªæ—‹é”å®ç°çš„ã€‚ä½†é¢å¤–ä¾èµ–ä¸€ä¸ªåºåˆ—è®¡æ•°å™¨ï¼Œå½“è·å–å†™é”æ—¶ï¼Œè¿™ä¸ªåºåˆ—å€¼ä¼šå¢åŠ ã€‚è¯»å–æ•°æ®æ—¶è¦å…ˆè°ƒç”¨ <code>read_seqbegin</code>ï¼Œå®ƒä¼šè¿”å›è¿™ä¸ªåºåˆ—å€¼ï¼Œè¯»å–å®Œæˆåé€šè¿‡ <code>read_seqretry</code> æ£€æŸ¥ä¼ å…¥çš„å€¼ <code>iv</code>ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶åˆ™è¯´æ˜è¯»æ˜¯å®‰å…¨çš„ï¼š</p><ul><li>å¦‚æœ <code>iv</code> æ˜¯å¶æ•°ï¼ˆåˆå§‹å€¼ä¸º 0ï¼Œå†™é”ä¼šåŠ  1ï¼‰åˆ™è¯´æ˜ä¸æ˜¯å¤„åœ¨ä¸€ä¸ªå†™æ“ä½œè¿›è¡Œçš„è¿‡ç¨‹ä¸­</li><li><code>iv</code> å’Œåºåˆ—å€¼ç›¸åŒï¼ˆç›¸åŒå€¼å¼‚æˆ–ç»“æœä¸º 0ï¼‰è¯´æ˜æ²¡æœ‰å†™æ“ä½œå‘ç”Ÿè¿‡</li></ul><p>è¿™ä¸¤è€…éƒ½æ»¡è¶³ï¼Œè¯»å–çš„å€¼å°±æ˜¯æœ‰æ•ˆçš„</p><p><br></p><p>æ‰€ä»¥ï¼Œé¡ºåºé”æ˜¯ä¸€ç§<strong>ä¹è§‚é”</strong>ï¼Œæ˜¯ä¸å­˜åœ¨ã€Œè¯»é”ã€çš„ï¼Œè€Œæ˜¯é€šè¿‡ç±»ä¼¼ç‰ˆæœ¬å·çš„æœºåˆ¶æ¥è¯»ï¼Œå› æ­¤åªè¦æ²¡æœ‰å…¶ä»–å†™è€…ï¼Œéšæ—¶éƒ½å¯ä»¥è·å–åˆ°å†™é”ï¼Œä»¥æ­¤å®ç°å†™ä¼˜å…ˆ</p></div><nav class=post-navigation data-astro-cid-gbhzkc2y><a href=/post/2023summary class="nav-link nav-prev" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>â† ä¸Šä¸€ç¯‡</span> <span class=nav-title data-astro-cid-gbhzkc2y>2023 å¹´åº¦æ€»ç»“</span> </a><a href=/post/longhorn class="nav-link nav-next" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>ä¸‹ä¸€ç¯‡ â†’</span> <span class=nav-title data-astro-cid-gbhzkc2y>Longhorn æµ…æ</span></a></nav><footer class=page-footer data-astro-cid-gbhzkc2y><a href=/ class=back-link data-astro-cid-gbhzkc2y>â† è¿”å›é¦–é¡µ</a></footer><section class=comments-section data-astro-cid-gbhzkc2y><div class=comments-container data-astro-cid-te6ksoa6 data-giscus-config="{&#34;slug&#34;:&#34;kernel-rwlock&#34;,&#34;title&#34;:&#34;ä» Linux å†…æ ¸çœ‹è¯»å†™é”è®¾è®¡&#34;,&#34;config&#34;:{&#34;repo&#34;:&#34;xxxuuu/xxxuuu.github.io&#34;,&#34;repoId&#34;:&#34;MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg&#34;,&#34;category&#34;:&#34;Announcements&#34;,&#34;categoryId&#34;:&#34;DIC_kwDOCwLAgM4ChgWc&#34;,&#34;mapping&#34;:&#34;title&#34;,&#34;strict&#34;:&#34;0&#34;,&#34;reactionsEnabled&#34;:&#34;1&#34;,&#34;emitMetadata&#34;:&#34;0&#34;,&#34;inputPosition&#34;:&#34;bottom&#34;,&#34;lang&#34;:&#34;zh-CN&#34;,&#34;lazy&#34;:true}}" data-provider=giscus id=comments><div class=comments-loading data-astro-cid-te6ksoa6>åŠ è½½è¯„è®ºä¸­...</div></div></section></div><aside class=toc-container data-astro-cid-gbhzkc2y><div class=toc-wrapper data-astro-cid-gbhzkc2y><div class=toc-title data-astro-cid-gbhzkc2y>ç›®å½•</div><nav class=toc-nav data-astro-cid-gbhzkc2y></nav></div></aside></div></div></article></main><footer data-astro-cid-aoh3bln3><div class=container data-astro-cid-aoh3bln3><div class=footer-content data-astro-cid-aoh3bln3><div class=copyright data-astro-cid-aoh3bln3><p data-astro-cid-aoh3bln3>&copy; 2026 xÂ³uÂ³. All rights reserved.</p><p data-astro-cid-aoh3bln3 class=powered-by>Powered by <a href=https://github.com/xxxuuu/nopress rel="noopener noreferrer" target=_blank data-astro-cid-aoh3bln3>Nopress</a></p></div><div class=social-links data-astro-cid-aoh3bln3><a href=https://github.com/xxxuuu class=social-icon aria-label=github data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></span></a><a href=https://x.com/xxuuu0 class=social-icon aria-label=twitter data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span></a><a href=mailto:xxuuu0@outlook.com class=social-icon aria-label=email data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg></span></a><a href=/rss/feed.xml class="social-icon rss" aria-label=RSSè®¢é˜… data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></span></a></div></div></div></footer></body></html>