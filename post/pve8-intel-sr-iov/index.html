<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>PVE8 ä¸Šå¯ç”¨ 12 ä»£ Intel CPU æ ¸æ˜¾ SR-IOV | xÂ³uÂ³</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="shortcut icon" href="https://xxxuuu.me/favicon.ico?v=1723216798723">
<link rel="stylesheet" href="https://xxxuuu.me/styles/main.css">



<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<style>
:root {
  --animate-duration: 800ms;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.9/dist/vue.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-T8WGT1LJ6G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T8WGT1LJ6G');
</script>


    <meta name="description" content="æ‹¯æ•‘æˆ‘çš„ Galgame å’Œè¿½ç•ªä½“éªŒï½

èƒŒæ™¯
å‰æ®µæ—¶é—´ä¹°äº†å° MiniPC è£… PVE ä½œä¸º Homelabï¼Œæ‰“ç®—ä½œä¸ºåª’ä½“æœåŠ¡å™¨ + NAS + å­¦ä¹ ä½¿ç”¨ ï¼ˆè™½ç„¶æœ€åä¸»è¦æ˜¯ç”¨æ¥è£… Windows è™šæ‹Ÿæœºç© Galgameï¼‰
æœºå­çš„ U æ˜¯..." />
    <meta name="keywords" content="æŠ˜è…¾" />
    
      <link href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="app" class="main">

      <header class="header">
  <div class="banner animate__animated animate__fadeIn">
    <div class="top-container">
      <div class="site-title-container">
        <img src="https://xxxuuu.me/images/avatar.png?v=1723216798723" class="site-logo">
        <div class="site-text">
          <h1 class="site-title">
            xÂ³uÂ³
          </h1>
          <div class="site-description-social">
            <div class="site-description">
              ğŸ—’ ç¢ç¢å¿µ
            </div>
            <div class="site-social">
              
                
                  <a class="social-link" href="https://github.com/xxxuuu" target="_blank">
                    <i class="fa fa-github"></i>
                  </a>
                
              
                
              
                
              
                
              
                
              
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="links">
      
        
            <a href="/" class="site-nav">
              ğŸ  é¦–é¡µ
            </a>
          
        
        
            <a href="/archives" class="site-nav">
              ğŸ“ƒ å½’æ¡£
            </a>
          
        
        
            <a href="/tags" class="site-nav">
              ğŸ· æ ‡ç­¾
            </a>
          
        
        
            <a href="/post/about" class="site-nav">
              ğŸ‘¤ å…³äº
            </a>
          
        
        
            <a href="/post/friend-links/" class="site-nav">
              ğŸ‘¬ å‹é“¾
            </a>
          
        
    </div>
  </div>
</header>

      <div class="main-container">
        <div class="content-container animate__animated animate__fadeInUp">
          <div class="post-detail">
            <h2 class="post-title">PVE8 ä¸Šå¯ç”¨ 12 ä»£ Intel CPU æ ¸æ˜¾ SR-IOV</h2>
            <div class="post-date">2023-08-06&emsp;&emsp;1174 å­— &emsp;é˜…è¯»æ—¶é—´ 6 åˆ†é’Ÿ</div>
            
            <div class="post-content" v-pre>
              <p>æ‹¯æ•‘æˆ‘çš„ Galgame å’Œè¿½ç•ªä½“éªŒï½</p>
<!-- more -->
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>å‰æ®µæ—¶é—´ä¹°äº†å° MiniPC è£… PVE ä½œä¸º Homelabï¼Œæ‰“ç®—ä½œä¸ºåª’ä½“æœåŠ¡å™¨ + NAS + å­¦ä¹ ä½¿ç”¨ <s>ï¼ˆè™½ç„¶æœ€åä¸»è¦æ˜¯ç”¨æ¥è£… Windows è™šæ‹Ÿæœºç© Galgameï¼‰</s></p>
<p>æœºå­çš„ U æ˜¯ 12 ä»£çš„ i3-N305ï¼Œä¹°çš„æ—¶å€™ PVE8 è¿˜æ²¡å‘å¸ƒï¼Œè£…çš„æ˜¯ PVE7ï¼Œ5.x çš„å†…æ ¸ï¼Œå¯¹ 12 ä»£ U è¿˜æ²¡æœ‰å¾ˆå®Œå–„çš„æ”¯æŒï¼Œæ ¸æ˜¾æ— æ³•ä½¿ç”¨ã€‚è¿™å°±å¯¼è‡´åœ¨ Jellyfin çœ‹ç•ªåªèƒ½è½¯è§£ï¼Œä»¥åŠç© Galgame æ—¶å‹åŠ›éƒ½åœ¨ CPU ä¸Šï¼Œå…¨ç¨‹ CPU 100%ï¼Œä½“éªŒè¯´ä¸ä¸Šå¥½</p>
<p>æœ€è¿‘å‘ç° PVE8 å‘å¸ƒäº†ï¼Œå‡çº§åˆ°äº† 6.2 çš„å†…æ ¸ï¼Œäºæ˜¯èµ¶ç´§æŠ˜è…¾ä¸€ä¸‹ã€‚å‡çº§è¿‡ç¨‹ç½‘ä¸Šå¾ˆå¤šæ–‡ç« ï¼Œè¿™é‡Œç•¥ï¼Œæ— éå°±æ˜¯é…ç½®ä¸‹é•œåƒæºç„¶å <code>apt update &amp; apt dist-upgrade</code></p>
<h2 id="å¼€å¯æ ¸æ˜¾-sr-iov">å¼€å¯æ ¸æ˜¾ SR-IOV</h2>
<p>SR-IOV æ˜¯ä¸€ç§ç¡¬ä»¶è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç®€å•æ¥è¯´ï¼Œèƒ½å°†ç‰©ç† PCIe è®¾å¤‡è™šæ‹Ÿæˆå¤šä¸ªè™šæ‹Ÿè®¾å¤‡ï¼Œåœ¨ç½‘å¡ä¸Šè¢«å¹¿æ³›ä½¿ç”¨ã€‚Intel Core CPU åœ¨ 11 ä»£åæ”¯æŒäº†è¯¥æŠ€æœ¯ç”¨äº GPU è™šæ‹ŸåŒ–ï¼Œæ›¿æ¢äº†è¿‡å»çš„ GVT-gï¼ˆ<a href="https://www.intel.cn/content/www/cn/zh/support/articles/000093216/graphics.html">Intel äº§å“ GPU è™šæ‹ŸåŒ–æŠ€æœ¯åˆ—è¡¨</a>ï¼‰</p>
<p>å¼€å¯ SR-IOV ä¸»è¦ç”¨åˆ°è¿™ä¸ªé©±åŠ¨ç¨‹åºï¼š<a href="https://github.com/strongtz/i915-sriov-dkms">i915-sriov-dkms</a>ï¼Œèƒ½å¤Ÿåˆ›å»ºæœ€å¤š 7 ä¸ª VFï¼ˆå¯ä»¥ç®€å•ç†è§£ä¸º vGPUï¼‰</p>
<p>æŒ‰ç€æ–‡æ¡£é‡Œã€ŒPVE Host Installation Steps (Tested Kernel 6.1 and 6.2)ã€è¿™æ­¥åšå³å¯ã€‚åœ¨ <code>update-grub</code> å’Œ <code>update-initramfs -u</code> åå¤šæ‰§è¡Œä¸€å¥ <code>pve-efiboot-tool refresh</code></p>
<p>ä½†æˆ‘è¿™é‡Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œé‡å¯åæŸ¥çœ‹ <code>dmesg | grep i915</code> æœ‰è¿™æ ·ä¸¤æ¡æ—¥å¿—</p>
<pre><code>i915: unknown parameter 'max_vfs' ignored
....
i915 0000:00:02.0: driver does not support SR-IOV configuration via sysfs
</code></pre>
<p>çœ‹äº†<a href="https://github.com/strongtz/i915-sriov-dkms/issues/53">è¿™ä¸ª issue </a>åï¼Œå°è¯•é‡è£…ã€‚åˆ é™¤äº†åŸæ¥çš„ dkms æ¨¡å—ï¼Œä¿®æ”¹ <code>dkms.conf</code> é‡Œçš„ <code>PACKAGE_NAME</code> ä¸º 6.2ï¼ˆåŸæ¥æ˜¯ 6.1ï¼Œä¸è¿‡è¿™æ­¥æ„Ÿè§‰åº”è¯¥æ²¡å½±å“ï¼‰ï¼Œç„¶å install æ—¶åŠ ä¸Š <code>--force</code> é‡æ–°èµ°éå®‰è£…æµç¨‹</p>
<p>è¿™å›æ­£å¸¸äº†ï¼Œä¸Šé¢ä¸¤æ¡æ—¥å¿—æ²¡æœ‰äº†ï¼Œä¹Ÿæ˜¾ç¤ºæˆåŠŸå¯ç”¨ VFï¼Œ<code>lspci | grep VGA</code> èƒ½çœ‹åˆ°å¤šå‡ºæ¥ 7 ä¸ª GPU è®¾å¤‡ï¼Œå¯ä»¥å°†å…¶æŒ‚è½½åˆ° LXC æˆ–è™šæ‹Ÿæœºä¸­ï¼ˆ00.02.0 é‚£ä¸ªç‰©ç† GPU / PF ä¸åº”è¯¥è¢«ä½¿ç”¨ï¼‰<br>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/20230806170352.png" alt="lspci-output" width=800 /></p>
<h2 id="windows-è™šæ‹ŸæœºæŒ‚è½½">Windows è™šæ‹ŸæœºæŒ‚è½½</h2>
<p>Windows è™šæ‹Ÿæœºè¦å…ˆé…ç½®å¥½è¿œç¨‹æ¡Œé¢ï¼Œèƒ½è¿çš„ä¸Šã€‚è™šæ‹Ÿæœºé…ç½®é‡Œã€Œæ˜¾ç¤ºã€é€‰ã€Œæ— ã€ï¼ˆé€‰ã€Œæ— ã€åå°±æ— æ³• VNC è¿æ¥äº†ï¼Œæ‰€ä»¥è¦å…ˆé…å¥½è¿œç¨‹æ¡Œé¢ï¼‰</p>
<p>æ·»åŠ  PCI è®¾å¤‡ï¼Œé€‰æ‹© vGPUï¼Œå‹¾ä¸Šä¸» GPU<br>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/20230806170517.png" alt="win-vm-config" width=800 /></p>
<p>è¿›å…¥ Windows <a href="https://www.intel.cn/content/www/cn/zh/support/intel-driver-support-assistant.html">å®‰è£…é©±åŠ¨</a>ï¼ŒBingo<br>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/20230806170548.png" alt="win-gpu" width=800 /></p>
<h2 id="lxc-å®¹å™¨æŒ‚è½½">LXC å®¹å™¨æŒ‚è½½</h2>
<p>æ–°å»º LXC å®¹å™¨è¦é€‰æ‹©ã€ŒåµŒå¥—ã€+ã€Œç‰¹æƒã€ï¼ˆå»æ‰æ— ç‰¹æƒå®¹å™¨çš„ âœ…ï¼‰</p>
<p>æŒ‚è½½è®¾å¤‡åˆ° LXC å®¹å™¨é‡Œï¼Œåœ¨ PVE é‡Œæ‰¾ä¸‹å¯¹åº”è®¾å¤‡é©±åŠ¨ï¼Œé€‰ä¸€ä¸ªæœªä½¿ç”¨çš„ vGPU è®°ä¸‹ç¬¬ 5 ã€ 6 åˆ—çš„ video id å’Œ render idï¼ˆä¸è¦é€‰äº† 0 çš„ç‰©ç† GPU / PFï¼‰ï¼Œæˆ‘è¿™é‡Œé€‰æ‹© card2 å’Œ renderD130</p>
<pre><code class="language-bash">$ ls -l /dev/dri
total 0
drwxr-xr-x 2 root root        320 Aug  6 00:38 by-path
crw-rw---- 1 root video  226,   0 Aug  6 00:30 card0
crw-rw---- 1 root video  226,   2 Aug  6 00:30 card2
crw-rw---- 1 root video  226,   3 Aug  6 00:30 card3
crw-rw---- 1 root video  226,   4 Aug  6 00:30 card4
crw-rw---- 1 root video  226,   5 Aug  6 00:30 card5
crw-rw---- 1 root video  226,   6 Aug  6 00:30 card6
crw-rw---- 1 root video  226,   7 Aug  6 00:30 card7
crw-rw---- 1 root render 226, 128 Aug  6 00:30 renderD128
crw-rw---- 1 root render 226, 130 Aug  6 00:30 renderD130
crw-rw---- 1 root render 226, 131 Aug  6 00:30 renderD131
crw-rw---- 1 root render 226, 132 Aug  6 00:30 renderD132
crw-rw---- 1 root render 226, 133 Aug  6 00:30 renderD133
crw-rw---- 1 root render 226, 134 Aug  6 00:30 renderD134
crw-rw---- 1 root render 226, 135 Aug  6 00:30 renderD135
</code></pre>
<p>å…³é—­ LXC å®¹å™¨ï¼Œç„¶åä¿®æ”¹å¯¹åº” LXC å®¹å™¨é…ç½®æ–‡ä»¶</p>
<pre><code class="language-bash">$ vim /etc/pve/lxc/&lt;LXC_ID&gt;.conf
</code></pre>
<p>æ·»åŠ ä»¥ä¸‹å†…å®¹æŠŠè®¾å¤‡æŒ‚è½½åˆ° LXC å†…ï¼ˆåˆ†åˆ«å¡«å…¥ video id å’Œ render idï¼Œä»¥åŠæ˜ å°„å¯¹åº” card å’Œ renderï¼‰</p>
<pre><code>lxc.cgroup2.devices.allow: c 226:2 rwm
lxc.cgroup2.devices.allow: c 226:130 rwm
lxc.mount.entry: /dev/dri/card2 dev/dri/card0 none bind,optional,create=file
lxc.mount.entry: /dev/dri/renderD130 dev/dri/renderD128 none bind,optional,create=file
</code></pre>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/20230806170700.png" alt="lxc-gpu-config" width=800>
<p>è¿›å…¥ LXC å®¹å™¨å®‰è£…é©±åŠ¨</p>
<pre><code class="language-bash">$ apt update &amp;&amp; apt install intel-media-va-driver-non-free vainfo
</code></pre>
<p>å¦‚æœ LXC å†…ä¹Ÿä½¿ç”¨äº†å®¹å™¨ï¼Œä¾‹å¦‚æˆ‘åœ¨ LXC å†…è£…äº† Docker éƒ¨ç½² Jellyfinï¼Œåˆ™å®¹å™¨å†…ä¹Ÿè¦æœ‰é©±åŠ¨ï¼Œå¹¶æŠŠè®¾å¤‡æŒ‚è½½è¿›å»</p>
<pre><code class="language-bash">$ docker run ... \
    ... \
    --device /dev/dri:/dev/dri \
    ...
</code></pre>
<p>ç„¶å Jellyfin å®¹å™¨å†…å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”è®¾å¤‡ï¼Œå¯ç”¨ç¡¬ä»¶åŠ é€Ÿå³å¯<br>
<img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/20230806173300.png" alt="jellyfin-vaapi" width=800></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ ¸å¿ƒå°±ä¸¤æ­¥ï¼š</p>
<ol>
<li>åœ¨ hostï¼ˆPVEï¼‰ä¸Šå®‰è£…é©±åŠ¨æ¨¡å—ï¼Œå¼€å¯ SR-IOV</li>
<li>é…ç½®è™šæ‹Ÿæœº or LXC æŒ‚è½½ vGPUï¼Œå¹¶åœ¨é‡Œé¢å®‰è£…é©±åŠ¨</li>
</ol>
<p>æœ‰äº† GPU åä½“éªŒå¥½äº†å¾ˆå¤šï¼Œæ— è®ºæ˜¯ Windows ç© Galgame è¿˜æ˜¯ Jellyfin è¿½ç•ªç¡¬è§£ï¼ŒCPU å‹åŠ›åŸºæœ¬ä¸è¶… 5%ï¼Œååˆ†æµç•…ï¼Œé‡Šæ”¾äº†æœ¬å°±ä¸å¼ºçš„ CPU ç®—åŠ›ã€‚è€Œä¸”ç›¸æ¯”ç‹¬å çš„ç›´é€šç‰©ç† GPUï¼ŒSR-IOV è™šæ‹Ÿå‡ºæ¥çš„å¤šä¸ª vGPU èƒ½åˆ†ç»™å¤šå°è™šæ‹Ÿæœºä½¿ç”¨ï¼Œæ‰“é€ å®Œç¾ Homelab</p>

            </div>

            <div class="not-by-ai">
              <img src="/media/images/not-by-ai-cn.svg"/>
              <img src="/media/images/not-by-ai-jp.svg"/>
              <img src="/media/images/not-by-ai-en.svg"/>
            </div>

            
              <div class="tag-container">
                
                  <a href="https://xxxuuu.me/tag/8Is6uGP83/" class="tag">
                    æŠ˜è…¾
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://xxxuuu.me/post/container-spec-ecosystem/">
                  <h3 class="post-title">
                    å®¹å™¨æ ‡å‡†å’Œç”Ÿæ€
                  </h3>
                </a>
              </div>
            

            
            
              <div id="giscus" class="giscus">
                <script src="https://giscus.app/client.js" data-repo="xxxuuu/xxxuuu.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg=" data-category="Announcements"  data-category-id="DIC_kwDOCwLAgM4ChgWc" data-mapping="title"  data-strict="0"  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script>
              </div>
            
          </div>

          

<div class="post-toc animate__animated animate__fadeInUp">
  <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E8%83%8C%E6%99%AF">èƒŒæ™¯</a></li>
<li><a href="#%E5%BC%80%E5%90%AF%E6%A0%B8%E6%98%BE-sr-iov">å¼€å¯æ ¸æ˜¾ SR-IOV</a></li>
<li><a href="#windows-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%82%E8%BD%BD">Windows è™šæ‹ŸæœºæŒ‚è½½</a></li>
<li><a href="#lxc-%E5%AE%B9%E5%99%A8%E6%8C%82%E8%BD%BD">LXC å®¹å™¨æŒ‚è½½</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></li>
</ul>
</li>
</ul>

</div>


<script>
  let lastTop = 0, linkList = [], headList = [], postBody, lastIndex = -1;
  let activeClass = 'active-toc';
  let tocContent;

  function addActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.remove(activeClass);
    }
  }

  function getElementTop (el) {
    let actualTop = el.offsetTop
    let current = el.offsetParent
    while (current !== null) {
      actualTop += current.offsetTop
      current = current.offsetParent
    }
    return actualTop
  }

  function syncActiveClass() {
    if (linkList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop;
    let eps = window.innerHeight;

    let current = 0, closestOffset = 0x3f3f3f3f, hasFind = false;
    for (let i = 0; i < headList.length; i++) {
      let offset = Math.abs(getElementTop(headList[i]) - scrollTop);
      if (offset > eps) {
        continue;
      }
      if (offset < closestOffset) {
        current = i;
        closestOffset = offset;
        hasFind = true;
      }
    }
    if(!hasFind) {
      return;
    }

    removeActiveClass(lastIndex)
    addActiveClass(current);
    lastIndex = current;
  }

  document.addEventListener('scroll', syncActiveClass);
  window.addEventListener('load', function () {
    tocContent = document.querySelector('.markdownIt-TOC');
    if (!tocContent) return;

    postBody = document.querySelector('.post-content');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        headList.push(postBody.children[i]);
      }
    }
    linkList = document.querySelectorAll('.post-toc a');

    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })
</script>

        </div>
      </div>

      <footer class="footer animate__animated animate__flipInX">
  <div class="site-footer">
    <p></p>
    <p>Â© xÂ³uÂ³ Â· Powered by <a href="https://gridea.dev/">Gridea</a> & <a href="https://github.com/xxxuuu/gridea-theme-autumn">Autumn</a> | <a class="rss" href="https://xxxuuu.me/atom.xml" target="_blank">RSS</a></p>
  </div>
</footer>


    </div>

    <script type="application/javascript">

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
  <script>
    window.onload = () => {
        hljs.highlightAll()
    }
  </script>


<script>
  const images = document.querySelectorAll('.post-content img');

  for (let i = 0; i < images.length; i++) {
    const img = images[i];

    const link = document.createElement('a');
    link.href = img.src;
    link.setAttribute("data-fancybox", "gallery");

    img.parentNode.insertBefore(link, img);
    link.appendChild(img);
  }
</script>




  </body>
</html>
