<!DOCTYPE html><html data-astro-cid-pjvcz6dw lang=zh-CN><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F49b4570c-b2f0-457b-81b7-b68e2693a471%2Favatar.png?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" rel=icon><link href=https://xxxuuu.me/post/deterministic-simulator/ rel=canonical><link href=/rss/feed.xml rel=alternate title=x³u³ type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap><title>确定性模拟器 | x³u³</title><meta content="最初接触到确定性模拟的概念是在 2022 年 Rust China Conf 上听的一场演讲，后续一直持续关注着这个领域，也在腾讯组内分享过相关议题" name=description><meta content=website property=og:type><meta content=https://xxxuuu.me/post/deterministic-simulator/ property=og:url><meta content="确定性模拟器 | x³u³" property=og:title><meta content="最初接触到确定性模拟的概念是在 2022 年 Rust China Conf 上听的一场演讲，后续一直持续关注着这个领域，也在腾讯组内分享过相关议题" property=og:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" property=og:image><meta content=summary_large_image name=twitter:card><meta content=@xxuuu0 name=twitter:site><meta content="确定性模拟器 | x³u³" name=twitter:title><meta content="最初接触到确定性模拟的概念是在 2022 年 Rust China Conf 上听的一场演讲，后续一直持续关注着这个领域，也在腾讯组内分享过相关议题" name=twitter:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" name=twitter:image><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=stylesheet></noscript><script>!function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.add(e)}()</script><link href=/_astro/katex.CVb4srxQ.css rel=stylesheet><link href=/_astro/_slug_.CMbZ2cJ_.css rel=stylesheet><link href=/_astro/_slug_.BzJEnS8p.css rel=stylesheet><link href=/_astro/_slug_.DOIB7y8p.css rel=stylesheet><script src=/_astro/hoisted.B871fABB.js type=module></script></head><body data-astro-cid-pjvcz6dw><header class=notion-header data-astro-cid-4f4rmh32><div class=header-container data-astro-cid-4f4rmh32><div class=header-content data-astro-cid-4f4rmh32><div class=logo data-astro-cid-4f4rmh32><a href=/ class=logo-link data-astro-cid-4f4rmh32>x³u³</a></div><div class=header-actions data-astro-cid-4f4rmh32><nav class=nav data-astro-cid-4f4rmh32><a href=/ class=nav-link data-astro-cid-4f4rmh32>🏠 首页 </a><a href=/archive class=nav-link data-astro-cid-4f4rmh32>📃 归档 </a><a href=/links class=nav-link data-astro-cid-4f4rmh32>👬 友链 </a><a href=https://p.xxxuuu.me rel="noopener noreferrer" target=_blank class=nav-link data-astro-cid-4f4rmh32>📷 摄影 <span class=external-icon data-astro-cid-4f4rmh32>↗</span> </a><a href=/about class=nav-link data-astro-cid-4f4rmh32>👤 关于</a></nav><button aria-label="Toggle theme" title=切换主题 data-astro-cid-44mn2ykx id=theme-toggle><svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=sun-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 data-astro-cid-44mn2ykx r=5></circle><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=1 y2=3></line><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=21 y2=23></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line data-astro-cid-44mn2ykx x1=1 x2=3 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=21 x2=23 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg> <svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=moon-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-44mn2ykx></path></svg></button></div></div></div></header><main class=notion-main data-astro-cid-pjvcz6dw><article class=content data-astro-cid-gbhzkc2y><div class=notion-page data-astro-cid-gbhzkc2y><div class=page-container data-astro-cid-gbhzkc2y><div class=page-main data-astro-cid-gbhzkc2y><header class=page-header data-astro-cid-gbhzkc2y><h1 class=page-title data-astro-cid-gbhzkc2y>确定性模拟器</h1></header><div class=page-meta data-astro-cid-gbhzkc2y><div class=meta-info data-astro-cid-gbhzkc2y><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>📅</span> <time data-astro-cid-gbhzkc2y datetime=2024-12-21>2024年12月21日</time> </span><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>⏱️</span> <span data-astro-cid-gbhzkc2y>19 分钟阅读</span></span></div><div class=meta-tags data-astro-cid-gbhzkc2y><span class=tags-icon data-astro-cid-gbhzkc2y>🏷️</span> <a href=/tag/分布式系统 class=tag-pill data-astro-cid-gbhzkc2y>分布式系统</a></div><div class=meta-description data-astro-cid-gbhzkc2y>最初接触到确定性模拟的概念是在 2022 年 Rust China Conf 上听的一场演讲，后续一直持续关注着这个领域，也在腾讯组内分享过相关议题</div></div><hr class=page-divider data-astro-cid-gbhzkc2y><div class=notion-content data-astro-cid-gbhzkc2y><p>最初接触到确定性模拟的概念是在 2022 年 Rust China Conf 上听的一场演讲，后续一直持续关注着这个领域，也在腾讯组内分享过相关议题</p><p><br></p><h2 id="">背景</h2><p>分布式系统面临的问题：</p><ol><li>通信不可靠：丢包，超时，乱序，重复<figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F2f213fe1-0bc3-44f8-b28d-487ee51299bb%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466WZNOIXEA%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIB237dqjVxzxC%252FhUhXMIjqYFFgbJLoOSOVGo3fWJxmPqAiEAkQGn33MZcTSoqOqdG9VZTsT4hjiSFaenFYBHjGl2hocq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDG2iRB6JBqTBpGN7qyrcAwkoWZ6%252B11J91yqQ3z90COqpQmWTnem0VtdR3K6b%252BwIBwO1rq1viRe2KgCovb8dgx%252F7dwn6ACmGrEqD5JCq1AWklFW4GikY7oLXFb%252BQozV7%252B4wp9Rqvl6nRANKuuN9e7Z2V4BWqJpR89pBz4ySqk2E5xIX5hav13k9x2xyNUN%252FLAEKVuYYCRK2QA3i1kzBslwJUVlv7Bh1Vquyap%252FctXaQwsMMhwLoYR68hz%252B4AKFNGrahJGCaWKztI0HWdnaLMC51nzrJTnmd21LLF%252FgPwZgtsXsJt9L9tblAgnWFPRSRS9G8MV7sL30eAEheYX2RIKWXZLnOdQpyN%252F9tC1Hv%252F1Y4KqUaoRK9tTBVjze3c4kk1fboSQEKbzKyTKnTVrMAYqi%252B4cezNii07Uzy6IxrghTR6D0sl8eO%252FYuWhLEjFRZwvvJwHA4BzG5Rl0OC5NAuNdkQ9znUnhEI5niFjkNQC%252F%252B9JlZrdqU%252Bi8kTrlDqWwffrkucfFraf4nudSckx5pydMthaKxqMwc4V0tHe8hnWqkcAto9dX3Y8Nca7Mmori%252BCMoApzu3q7%252FJip3hDplIYFd%252FkP5j8t3O8M691ahHP1iOuy9cnftY0YRt3T39ibFTSapdxvSUzEytt7v2gtbMJL3jMwGOqUBuZm%252FC5aegv5%252Be7QFcDipUS9XvvFe1kSobjR5Zj0HNN4OuBG6IVV%252BEhVPwupZTLgORkFj%252F1u0MHVXBosjQyCplWF0yr5wWrtHcpOjZILv7b7yoFqEU52a1FPEtI9FdnxrHUBoeESWnGOd4dlw12XVLY0nUEoKXRpRfSjL0sIAfUN8lezPQpcyWMqClXRaM8Kp6htd9Gm6diOy05NRJuOFFuRooHCR%26X-Amz-Signature%3Dbb4fbc0c5c4cf98feb3af81bba0139332c14ed94e914efe50b8e006d630c6fa3%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=49688360-6eeb-480f-9284-f81070003083" class=glightbox data-aspect-ratio=3.000000 data-description=无法区分通信失败的原因 data-gallery=article-images data-title=无法区分通信失败的原因 style=aspect-ratio:3.000000><img alt=无法区分通信失败的原因 loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F2f213fe1-0bc3-44f8-b28d-487ee51299bb%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466WZNOIXEA%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIB237dqjVxzxC%252FhUhXMIjqYFFgbJLoOSOVGo3fWJxmPqAiEAkQGn33MZcTSoqOqdG9VZTsT4hjiSFaenFYBHjGl2hocq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDG2iRB6JBqTBpGN7qyrcAwkoWZ6%252B11J91yqQ3z90COqpQmWTnem0VtdR3K6b%252BwIBwO1rq1viRe2KgCovb8dgx%252F7dwn6ACmGrEqD5JCq1AWklFW4GikY7oLXFb%252BQozV7%252B4wp9Rqvl6nRANKuuN9e7Z2V4BWqJpR89pBz4ySqk2E5xIX5hav13k9x2xyNUN%252FLAEKVuYYCRK2QA3i1kzBslwJUVlv7Bh1Vquyap%252FctXaQwsMMhwLoYR68hz%252B4AKFNGrahJGCaWKztI0HWdnaLMC51nzrJTnmd21LLF%252FgPwZgtsXsJt9L9tblAgnWFPRSRS9G8MV7sL30eAEheYX2RIKWXZLnOdQpyN%252F9tC1Hv%252F1Y4KqUaoRK9tTBVjze3c4kk1fboSQEKbzKyTKnTVrMAYqi%252B4cezNii07Uzy6IxrghTR6D0sl8eO%252FYuWhLEjFRZwvvJwHA4BzG5Rl0OC5NAuNdkQ9znUnhEI5niFjkNQC%252F%252B9JlZrdqU%252Bi8kTrlDqWwffrkucfFraf4nudSckx5pydMthaKxqMwc4V0tHe8hnWqkcAto9dX3Y8Nca7Mmori%252BCMoApzu3q7%252FJip3hDplIYFd%252FkP5j8t3O8M691ahHP1iOuy9cnftY0YRt3T39ibFTSapdxvSUzEytt7v2gtbMJL3jMwGOqUBuZm%252FC5aegv5%252Be7QFcDipUS9XvvFe1kSobjR5Zj0HNN4OuBG6IVV%252BEhVPwupZTLgORkFj%252F1u0MHVXBosjQyCplWF0yr5wWrtHcpOjZILv7b7yoFqEU52a1FPEtI9FdnxrHUBoeESWnGOd4dlw12XVLY0nUEoKXRpRfSjL0sIAfUN8lezPQpcyWMqClXRaM8Kp6htd9Gm6diOy05NRJuOFFuRooHCR%26X-Amz-Signature%3Dbb4fbc0c5c4cf98feb3af81bba0139332c14ed94e914efe50b8e006d630c6fa3%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=49688360-6eeb-480f-9284-f81070003083" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>无法区分通信失败的原因</figcaption></figure></li><li>时钟不可靠：时钟漂移，拖尾，回退<figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F8674fe3b-771b-43f4-860a-10847162d1f5%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZFIQW5GI%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIFeIBpcg3Qxhy6O1RgVd9P%252FyhXc0XrYLS9%252F%252Fct7JUaaDAiArQLe1%252F2zwYyhUZePJSz2ANxAjrR1meV6hy7bV696jryr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMAZnMPELNqQ%252BvvzkkKtwDUaRPskZdLdpgrm1AcLKUgOmjfuG9uef5wJRMdXPVGAFBnowSdhwVshqtBi15fZxS9kaveLPGTyUpGhDnREWws7hsq5o7ggcTdNLT2okF9EGVIjyunghvg421oYdgtkpFI8PnnTVH6IfZjjRpjb6jPErWdZkO2ZIbJaVfyvVsDUHKTvLnHTZp2VAOc%252B%252BBV5pb3E04IFVzd4%252Bs4Y9ipsH7MkEYdG5pbqp8%252FwJ5ioYmWv0V5PKIJzReLvMgQFQONbc9GiGpRj9OLbuNJrxFMB1vi7xvUHrDm85RmMv8fzDUsVzZDfsQES%252BR4yUe7g1sV065H6TchvF21YQONJRMyeJtTcCXrhy0KQ1C%252F3rHHu5L0MYa31qRGXvPOsJr%252B9EF8tp53BVFd3qxWaDyAjZ8WilNS5z25ZZmDXLg%252BaPNuTBH0SAnAjtOUU%252Bx0%252BZUUY5f2nz10pu66BMRWCOcwnidaQDjnIkQcCxvNujI4fqvuhADtaRMZ8gETteZIx2OdgqTdZUt10lgNW9%252F6mWDaxYY06eARiY2D30sh5WqKMNfWx4DdK2eIdtKa0%252FC84Tl87ffjFcDtDaFHxJx9eI2vdT0C4OgMcxlZ55N%252BsMQBVhxPqn1D5HtuZcapqe7vZr%252B6IEwiveMzAY6pgFebWmN1iegKJXLCv%252BPSyEyXj4TcV2FJmg0R%252FjcijEhYh1uXbCF3ENuKqhNRmqKaOW7cRfdDd5iCIWQjukHBYCHPm9uzxP9YpArCeRh5dfUU8ZRqjzHXF37A4VEKtXEyBqjFqh1wY9UXfX0nxT1Z9%252BaK3I7E2XzWj2oTjjJJ3Kf5GOq0w0u7nr7a0McZ7ftaTfh77JSW8HnqxtIjS8MbZ23USRm8eV%252F%26X-Amz-Signature%3D6c93b845814fb81a0fc8e282cef6507d1d093efb50180e80566004106ea64d39%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7f92640c-e8eb-42cf-a384-8d18a5089a04" class=glightbox data-aspect-ratio=1.594896 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.594896><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F8674fe3b-771b-43f4-860a-10847162d1f5%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZFIQW5GI%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIFeIBpcg3Qxhy6O1RgVd9P%252FyhXc0XrYLS9%252F%252Fct7JUaaDAiArQLe1%252F2zwYyhUZePJSz2ANxAjrR1meV6hy7bV696jryr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMAZnMPELNqQ%252BvvzkkKtwDUaRPskZdLdpgrm1AcLKUgOmjfuG9uef5wJRMdXPVGAFBnowSdhwVshqtBi15fZxS9kaveLPGTyUpGhDnREWws7hsq5o7ggcTdNLT2okF9EGVIjyunghvg421oYdgtkpFI8PnnTVH6IfZjjRpjb6jPErWdZkO2ZIbJaVfyvVsDUHKTvLnHTZp2VAOc%252B%252BBV5pb3E04IFVzd4%252Bs4Y9ipsH7MkEYdG5pbqp8%252FwJ5ioYmWv0V5PKIJzReLvMgQFQONbc9GiGpRj9OLbuNJrxFMB1vi7xvUHrDm85RmMv8fzDUsVzZDfsQES%252BR4yUe7g1sV065H6TchvF21YQONJRMyeJtTcCXrhy0KQ1C%252F3rHHu5L0MYa31qRGXvPOsJr%252B9EF8tp53BVFd3qxWaDyAjZ8WilNS5z25ZZmDXLg%252BaPNuTBH0SAnAjtOUU%252Bx0%252BZUUY5f2nz10pu66BMRWCOcwnidaQDjnIkQcCxvNujI4fqvuhADtaRMZ8gETteZIx2OdgqTdZUt10lgNW9%252F6mWDaxYY06eARiY2D30sh5WqKMNfWx4DdK2eIdtKa0%252FC84Tl87ffjFcDtDaFHxJx9eI2vdT0C4OgMcxlZ55N%252BsMQBVhxPqn1D5HtuZcapqe7vZr%252B6IEwiveMzAY6pgFebWmN1iegKJXLCv%252BPSyEyXj4TcV2FJmg0R%252FjcijEhYh1uXbCF3ENuKqhNRmqKaOW7cRfdDd5iCIWQjukHBYCHPm9uzxP9YpArCeRh5dfUU8ZRqjzHXF37A4VEKtXEyBqjFqh1wY9UXfX0nxT1Z9%252BaK3I7E2XzWj2oTjjJJ3Kf5GOq0w0u7nr7a0McZ7ftaTfh77JSW8HnqxtIjS8MbZ23USRm8eV%252F%26X-Amz-Signature%3D6c93b845814fb81a0fc8e282cef6507d1d093efb50180e80566004106ea64d39%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=7f92640c-e8eb-42cf-a384-8d18a5089a04" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F03aedc4e-a2cf-4b3a-b645-d32d76a5b468%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZFIQW5GI%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIFeIBpcg3Qxhy6O1RgVd9P%252FyhXc0XrYLS9%252F%252Fct7JUaaDAiArQLe1%252F2zwYyhUZePJSz2ANxAjrR1meV6hy7bV696jryr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMAZnMPELNqQ%252BvvzkkKtwDUaRPskZdLdpgrm1AcLKUgOmjfuG9uef5wJRMdXPVGAFBnowSdhwVshqtBi15fZxS9kaveLPGTyUpGhDnREWws7hsq5o7ggcTdNLT2okF9EGVIjyunghvg421oYdgtkpFI8PnnTVH6IfZjjRpjb6jPErWdZkO2ZIbJaVfyvVsDUHKTvLnHTZp2VAOc%252B%252BBV5pb3E04IFVzd4%252Bs4Y9ipsH7MkEYdG5pbqp8%252FwJ5ioYmWv0V5PKIJzReLvMgQFQONbc9GiGpRj9OLbuNJrxFMB1vi7xvUHrDm85RmMv8fzDUsVzZDfsQES%252BR4yUe7g1sV065H6TchvF21YQONJRMyeJtTcCXrhy0KQ1C%252F3rHHu5L0MYa31qRGXvPOsJr%252B9EF8tp53BVFd3qxWaDyAjZ8WilNS5z25ZZmDXLg%252BaPNuTBH0SAnAjtOUU%252Bx0%252BZUUY5f2nz10pu66BMRWCOcwnidaQDjnIkQcCxvNujI4fqvuhADtaRMZ8gETteZIx2OdgqTdZUt10lgNW9%252F6mWDaxYY06eARiY2D30sh5WqKMNfWx4DdK2eIdtKa0%252FC84Tl87ffjFcDtDaFHxJx9eI2vdT0C4OgMcxlZ55N%252BsMQBVhxPqn1D5HtuZcapqe7vZr%252B6IEwiveMzAY6pgFebWmN1iegKJXLCv%252BPSyEyXj4TcV2FJmg0R%252FjcijEhYh1uXbCF3ENuKqhNRmqKaOW7cRfdDd5iCIWQjukHBYCHPm9uzxP9YpArCeRh5dfUU8ZRqjzHXF37A4VEKtXEyBqjFqh1wY9UXfX0nxT1Z9%252BaK3I7E2XzWj2oTjjJJ3Kf5GOq0w0u7nr7a0McZ7ftaTfh77JSW8HnqxtIjS8MbZ23USRm8eV%252F%26X-Amz-Signature%3Da041d138d52be62273ac8a95735c9c2cbda9137b841bd0c762416aa6222277f4%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=84ea3146-11e8-488a-93cc-61dfd64e986d" class=glightbox data-aspect-ratio=2.104869 data-description=时钟使得事件排序不可靠 data-gallery=article-images data-title=时钟使得事件排序不可靠 style=aspect-ratio:2.104869><img alt=时钟使得事件排序不可靠 loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F03aedc4e-a2cf-4b3a-b645-d32d76a5b468%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZFIQW5GI%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIFeIBpcg3Qxhy6O1RgVd9P%252FyhXc0XrYLS9%252F%252Fct7JUaaDAiArQLe1%252F2zwYyhUZePJSz2ANxAjrR1meV6hy7bV696jryr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMAZnMPELNqQ%252BvvzkkKtwDUaRPskZdLdpgrm1AcLKUgOmjfuG9uef5wJRMdXPVGAFBnowSdhwVshqtBi15fZxS9kaveLPGTyUpGhDnREWws7hsq5o7ggcTdNLT2okF9EGVIjyunghvg421oYdgtkpFI8PnnTVH6IfZjjRpjb6jPErWdZkO2ZIbJaVfyvVsDUHKTvLnHTZp2VAOc%252B%252BBV5pb3E04IFVzd4%252Bs4Y9ipsH7MkEYdG5pbqp8%252FwJ5ioYmWv0V5PKIJzReLvMgQFQONbc9GiGpRj9OLbuNJrxFMB1vi7xvUHrDm85RmMv8fzDUsVzZDfsQES%252BR4yUe7g1sV065H6TchvF21YQONJRMyeJtTcCXrhy0KQ1C%252F3rHHu5L0MYa31qRGXvPOsJr%252B9EF8tp53BVFd3qxWaDyAjZ8WilNS5z25ZZmDXLg%252BaPNuTBH0SAnAjtOUU%252Bx0%252BZUUY5f2nz10pu66BMRWCOcwnidaQDjnIkQcCxvNujI4fqvuhADtaRMZ8gETteZIx2OdgqTdZUt10lgNW9%252F6mWDaxYY06eARiY2D30sh5WqKMNfWx4DdK2eIdtKa0%252FC84Tl87ffjFcDtDaFHxJx9eI2vdT0C4OgMcxlZ55N%252BsMQBVhxPqn1D5HtuZcapqe7vZr%252B6IEwiveMzAY6pgFebWmN1iegKJXLCv%252BPSyEyXj4TcV2FJmg0R%252FjcijEhYh1uXbCF3ENuKqhNRmqKaOW7cRfdDd5iCIWQjukHBYCHPm9uzxP9YpArCeRh5dfUU8ZRqjzHXF37A4VEKtXEyBqjFqh1wY9UXfX0nxT1Z9%252BaK3I7E2XzWj2oTjjJJ3Kf5GOq0w0u7nr7a0McZ7ftaTfh77JSW8HnqxtIjS8MbZ23USRm8eV%252F%26X-Amz-Signature%3Da041d138d52be62273ac8a95735c9c2cbda9137b841bd0c762416aa6222277f4%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=84ea3146-11e8-488a-93cc-61dfd64e986d" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>时钟使得事件排序不可靠</figcaption></figure></li><li>节点不可靠：阻塞，宕机，掉线，停顿<figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe0b2eeac-ad50-478a-857f-36ceec223c72%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46623Z57GCP%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQDOfGzh7BX8GPCUfZwK6u0%252Bkoq9LafeCXxGhpsRvLw%252FrAIhAJaE%252BxKsAhAxkERrrrvXm92U%252BnUKCUf%252B0fJGaC4%252BHp6yKv8DCBYQABoMNjM3NDIzMTgzODA1IgwcdF27%252FAtTctSj1Skq3APQOTxpcJpazqrKh8kin2df8asJcITd%252BkRCt3Uui%252BPYCa3C5b%252FV9FlTghs0SjxjLJ5OGZ8vmM4JCfho6QYHVb8fUsRxxqRb33RJyfuJYe%252By%252FkFGT%252F30l9avzDH66louA0bXnUhqX0Y1XQgVEoFH4mSbzRglhaymywGPiiCfNWkql6Ciyz01brCUkUv%252Fr3qQmPDlP%252BwRXSfF4V5ksqc%252FQhNJxRObAKvJoterQte4REHh40Z%252FEb7zU6YBH2vE7gW%252BR7S7vlIwnsewqkUQ0OJ4NYKZduG4Lk371qfi485KIGZTEorf65BhI3zqCA3COg3cWIwhrTV%252BwvfT%252BMMLbQrSB%252FIUAUwNCeG7xt69yqg15ZUNbxGOoop06JnnZ8Tpppo%252FKTt60FcrrmaSirnQa3fD6fHCclA5ONFtDjA18iCOnjByCyisdmlufxJjKJ%252Bwil3CpZ0C8azH2F0hsLL0tEaR2uxP%252BoGEPKmJGxn0S4dVqJkBIBPCN15MwZIwDsd%252BMD5ZHFsas7GfANEJhYX72jm4ATTs3JEM5K1GSyiV1zXsFrA8XMBEA3jRfnSI8zKGSly6trJpa1q6yfA2cxUHSHjhg%252BNl8B6ocSDNzUUfdNjL%252BksUe4K8yTAx7Pe%252FL%252FNtgTDt94zMBjqkASlX%252FRAwyrxi0NZ%252B7nO44bacdmQC60Z2hi6fHCwP8Z5Kq1D9C9Jc9FHur1B%252BthF3%252F%252BI7ClQuHO3Jb89ONbOx3ASsuaaRjewzxRnEMC6CYmiG8B4GDyzjAxuJljgCyklh5PqcJqjzHsuPp6qrzRAK%252B3qsYF8buv9qd76SBJ1GEbqwgA6TilNuaKwvbXyi%252Bv169K8NYrYXPPoTgYKTtE00mCiOMy5C%26X-Amz-Signature%3De5478493da1cda4abc1116311e6eb3b75cab4b2ef1669b01ead9fbc594873ade%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=d7e394de-d11c-48cb-8e0c-460e69085362" class=glightbox data-aspect-ratio=2.577982 data-description="GC 停顿期间，世界已经变天了" data-gallery=article-images data-title="GC 停顿期间，世界已经变天了" style=aspect-ratio:2.577982><img alt="GC 停顿期间，世界已经变天了" loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe0b2eeac-ad50-478a-857f-36ceec223c72%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB46623Z57GCP%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQDOfGzh7BX8GPCUfZwK6u0%252Bkoq9LafeCXxGhpsRvLw%252FrAIhAJaE%252BxKsAhAxkERrrrvXm92U%252BnUKCUf%252B0fJGaC4%252BHp6yKv8DCBYQABoMNjM3NDIzMTgzODA1IgwcdF27%252FAtTctSj1Skq3APQOTxpcJpazqrKh8kin2df8asJcITd%252BkRCt3Uui%252BPYCa3C5b%252FV9FlTghs0SjxjLJ5OGZ8vmM4JCfho6QYHVb8fUsRxxqRb33RJyfuJYe%252By%252FkFGT%252F30l9avzDH66louA0bXnUhqX0Y1XQgVEoFH4mSbzRglhaymywGPiiCfNWkql6Ciyz01brCUkUv%252Fr3qQmPDlP%252BwRXSfF4V5ksqc%252FQhNJxRObAKvJoterQte4REHh40Z%252FEb7zU6YBH2vE7gW%252BR7S7vlIwnsewqkUQ0OJ4NYKZduG4Lk371qfi485KIGZTEorf65BhI3zqCA3COg3cWIwhrTV%252BwvfT%252BMMLbQrSB%252FIUAUwNCeG7xt69yqg15ZUNbxGOoop06JnnZ8Tpppo%252FKTt60FcrrmaSirnQa3fD6fHCclA5ONFtDjA18iCOnjByCyisdmlufxJjKJ%252Bwil3CpZ0C8azH2F0hsLL0tEaR2uxP%252BoGEPKmJGxn0S4dVqJkBIBPCN15MwZIwDsd%252BMD5ZHFsas7GfANEJhYX72jm4ATTs3JEM5K1GSyiV1zXsFrA8XMBEA3jRfnSI8zKGSly6trJpa1q6yfA2cxUHSHjhg%252BNl8B6ocSDNzUUfdNjL%252BksUe4K8yTAx7Pe%252FL%252FNtgTDt94zMBjqkASlX%252FRAwyrxi0NZ%252B7nO44bacdmQC60Z2hi6fHCwP8Z5Kq1D9C9Jc9FHur1B%252BthF3%252F%252BI7ClQuHO3Jb89ONbOx3ASsuaaRjewzxRnEMC6CYmiG8B4GDyzjAxuJljgCyklh5PqcJqjzHsuPp6qrzRAK%252B3qsYF8buv9qd76SBJ1GEbqwgA6TilNuaKwvbXyi%252Bv169K8NYrYXPPoTgYKTtE00mCiOMy5C%26X-Amz-Signature%3De5478493da1cda4abc1116311e6eb3b75cab4b2ef1669b01ead9fbc594873ade%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=d7e394de-d11c-48cb-8e0c-460e69085362" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>GC 停顿期间，世界已经变天了</figcaption></figure></li></ol><p>分布式软件/算法的目标：容忍不可靠的环境，实现容错，同时保证安全性</p><p>节点不可能只依赖自身状态来对整个系统进行判断，需要达成共识：Paxos、ZAB、Raft….</p><figure class="notion-image notion-image-center" style=max-width:144px><a href=https://raft.github.io/logo/solo.svg class=glightbox data-aspect-ratio=0.450000 data-description="Raft logo" data-gallery=article-images data-title="Raft logo" style=aspect-ratio:0.450000><img alt="Raft logo" loading=lazy src=https://raft.github.io/logo/solo.svg onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>Raft logo</figcaption></figure><p>通常共识算法都是实现了全序广播，能够保证一系列消息以相同的顺序被应用到每个节点上，以此实现共识</p><p><br></p><p>共识算法的作者都声称他们的算法简单、易于理解，算法本身的正确性也通过形式化验证进行保证</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F93c5caed-f667-49b7-8ba3-8b3cf803c63d%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D254e6cb07c297a98143a4025bccaa6d6e2b59a2de0d3c35993ecad094e5cdd94%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8078-87c5-e2f310cf37a2" class=glightbox data-aspect-ratio=4.934343 data-description="Raft 论文的标题的定语就是 Understandable" data-gallery=article-images data-title="Raft 论文的标题的定语就是 Understandable" style=aspect-ratio:4.934343><img alt="Raft 论文的标题的定语就是 Understandable" loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F93c5caed-f667-49b7-8ba3-8b3cf803c63d%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D254e6cb07c297a98143a4025bccaa6d6e2b59a2de0d3c35993ecad094e5cdd94%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8078-87c5-e2f310cf37a2" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>Raft 论文的标题的定语就是 Understandable</figcaption></figure><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F765fda1c-1475-4ca9-ba0e-7b1b8870060c%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D05cfa8f269dacc7e673336c7292fb00e1be217749ee44098579a1c5fb4763281%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8086-b923-dfa7249c270a" class=glightbox data-aspect-ratio=5.720930 data-description="Lamport 的第二篇 " data-gallery=article-images data-title="Lamport 的第二篇 " style=aspect-ratio:5.720930><img alt="Lamport 的第二篇 " loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F765fda1c-1475-4ca9-ba0e-7b1b8870060c%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D05cfa8f269dacc7e673336c7292fb00e1be217749ee44098579a1c5fb4763281%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8086-b923-dfa7249c270a" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>Lamport 的第二篇</figcaption></figure><p>共识算法看起来没有那么复杂，但具体落地时，正确实现非常困难，分布式系统的环境非常复杂，不确定因素和扰动过多，要在任何一种情况下都能正常工作是一个很大的挑战</p><p>一些 bug 可能需要运行数千次，才会发生一次，且几乎无法复现</p><figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff9fa10f4-1198-4a2f-b546-aed8998940c7%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D75556db542e402ec8269f04a3e1d0e747e5f64d83db773e03e149bfec382a191%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8040-a39f-f7a4e9444f67" class=glightbox data-aspect-ratio=2.401662 data-description="MIT 6.824 指南通常打着「数千次都不出错」的 slogan，也进一步说明了测试的困难" data-gallery=article-images data-title="MIT 6.824 指南通常打着「数千次都不出错」的 slogan，也进一步说明了测试的困难" style=aspect-ratio:2.401662><img alt="MIT 6.824 指南通常打着「数千次都不出错」的 slogan，也进一步说明了测试的困难" loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff9fa10f4-1198-4a2f-b546-aed8998940c7%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D75556db542e402ec8269f04a3e1d0e747e5f64d83db773e03e149bfec382a191%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8040-a39f-f7a4e9444f67" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>MIT 6.824 指南通常打着「数千次都不出错」的 slogan，也进一步说明了测试的困难</figcaption></figure><p>如何解决在分布式系统上进行测试的问题？</p><p><br></p><h2 id=->确定性测试 &amp; 模拟</h2><p>安全性的一些业界方案：</p><ul><li>混沌测试：ChaosMesh<figure class="notion-image notion-image-center" style=max-width:576px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fce9ced73-aa89-44bf-aa5f-7bc067eeaf13%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466RL2Q2MI6%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQC5t49Jz%252B%252BlgMj9%252Bk%252FZLpztOVq0XZbwirzxOKuUx2%252FT1QIgGu2O0Y1upcUVz7hUZTO4J8ffOeX7MBEwmH%252FICnOFlmAq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIFa59r4iklzPWRpMSrcA9nXhH4bv3hUPWdfsGNnVbqlILMKlvuqsgXtgwm5lgn6XL9j4LFMnduPhoyD%252FgKTI1UKsW%252BM98TVlCjQMLgD%252F3BajgMOEFbcKxPetMHSpSfuKikGzVTeRgr3hWA6xdd6Dvs4A8zYnhwK4hptBYs1sls1D2hqZw5jeZgg5Fl7OH1dqKyQQwgTyJNbnG8CJN8L%252FxoYxQ6FmrweSSm1xkgcyKBUsQKpbL32wEfSQNseRJ8E%252B5PTW2bJUpgOSbrJ3ebBC8JpMiT81f4pMNoSkJXRgkHCXH6tv4mpoh43B7H3VrHzBLzUvUbYe8Ac6qiMjcEexCPhFYdmjZXUu73RXSd093hyTqCbk80iKOzhEh6V6QKZ4CNo4hxikKJKhjGu9h11%252B60kqNvhVn5vIJvo4xpkplc81bwxyy%252F7UGi1Pp%252B86FEKjSHVGyHDW4Jb5sCTOvYOLcmPDNDkl%252B%252BTQ0%252B3vM7iNbV%252F%252BZ97ehOzK4CEF3ID9%252B2269BenTIii1qpHnZN7k3oX9EmNJVrWfNIhjlKM31ZZoDRX4%252FSRl%252FkB%252Fmh16Px6%252BuxOwgAP%252FyLDZXukP5BfRJISsWHDYFRd2fJakmcKWbxoSW3ySaCzIl5lGb0m85oSB1Baq21PZ5CbbXNQi3UMIb3jMwGOqUBmtnqCa7rn91GhIc9kEU%252BaRKtlYDNi1ZpzkVHlSsFIQGDU63Oc7p0VZEfLzv3NgxiPiVEvWnMacq%252FOuv6BeR9HuUUP0TMFGx5uZROBuncmTq1NBZaa0zWQbuLiqK7eliXTM1JqLqxiYzvi1NemJYrQ6NdMQ2QfEV5tqpo9CxMS5YR%252B4zNNDIrd2JSGWmNVU630RtXJZsEnyb3AGTM2zlYcXsRio47%26X-Amz-Signature%3D4d1d2587733e560f365803475eac4e8cb598bee70e2cab5e01e33f44ff917d64%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8036-95ba-c8201bde96f0" class=glightbox data-aspect-ratio=1.926174 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.926174><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fce9ced73-aa89-44bf-aa5f-7bc067eeaf13%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466RL2Q2MI6%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQC5t49Jz%252B%252BlgMj9%252Bk%252FZLpztOVq0XZbwirzxOKuUx2%252FT1QIgGu2O0Y1upcUVz7hUZTO4J8ffOeX7MBEwmH%252FICnOFlmAq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIFa59r4iklzPWRpMSrcA9nXhH4bv3hUPWdfsGNnVbqlILMKlvuqsgXtgwm5lgn6XL9j4LFMnduPhoyD%252FgKTI1UKsW%252BM98TVlCjQMLgD%252F3BajgMOEFbcKxPetMHSpSfuKikGzVTeRgr3hWA6xdd6Dvs4A8zYnhwK4hptBYs1sls1D2hqZw5jeZgg5Fl7OH1dqKyQQwgTyJNbnG8CJN8L%252FxoYxQ6FmrweSSm1xkgcyKBUsQKpbL32wEfSQNseRJ8E%252B5PTW2bJUpgOSbrJ3ebBC8JpMiT81f4pMNoSkJXRgkHCXH6tv4mpoh43B7H3VrHzBLzUvUbYe8Ac6qiMjcEexCPhFYdmjZXUu73RXSd093hyTqCbk80iKOzhEh6V6QKZ4CNo4hxikKJKhjGu9h11%252B60kqNvhVn5vIJvo4xpkplc81bwxyy%252F7UGi1Pp%252B86FEKjSHVGyHDW4Jb5sCTOvYOLcmPDNDkl%252B%252BTQ0%252B3vM7iNbV%252F%252BZ97ehOzK4CEF3ID9%252B2269BenTIii1qpHnZN7k3oX9EmNJVrWfNIhjlKM31ZZoDRX4%252FSRl%252FkB%252Fmh16Px6%252BuxOwgAP%252FyLDZXukP5BfRJISsWHDYFRd2fJakmcKWbxoSW3ySaCzIl5lGb0m85oSB1Baq21PZ5CbbXNQi3UMIb3jMwGOqUBmtnqCa7rn91GhIc9kEU%252BaRKtlYDNi1ZpzkVHlSsFIQGDU63Oc7p0VZEfLzv3NgxiPiVEvWnMacq%252FOuv6BeR9HuUUP0TMFGx5uZROBuncmTq1NBZaa0zWQbuLiqK7eliXTM1JqLqxiYzvi1NemJYrQ6NdMQ2QfEV5tqpo9CxMS5YR%252B4zNNDIrd2JSGWmNVU630RtXJZsEnyb3AGTM2zlYcXsRio47%26X-Amz-Signature%3D4d1d2587733e560f365803475eac4e8cb598bee70e2cab5e01e33f44ff917d64%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14d88756-3979-8036-95ba-c8201bde96f0" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure></li><li>验证框架：Jepsen<figure class="notion-image notion-image-center" style=max-width:576px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdfc75047-5a34-4cc6-91a0-c2a82f4e4cf8%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4665PJOGY47%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQDn2eeEF08jU2nBfJ6esT8hDm4iudsNXDFvKvSATjFPVAIhAIVQyZ3Q71dTJd4imBGLlSbCTU%252BLSJ5m60K3O2tKqjz%252BKv8DCBYQABoMNjM3NDIzMTgzODA1IgyZ0fXXIsHFs0LSjLIq3APko5q9XLkiJoMjz6kU2dhY52EN%252B2Bic%252B6qBWH7gZ%252BkNFXcfTPQNt1I0AOyKpdX3veYu6iW30UmTVKBWiSxoIcnKNbNsnpO1kTIhsed4Vxug4dI6g1FIQzgKJ%252BLSJoMT4L6ADBuLX0FqwGr6YFYr4NrkbEywsJMPHKPwdR%252F7cQTSC5tZIWlce1tbmmatz0badsOo2cS1WMEVf%252F27O4PYgv5pPOyeL8oqCWU%252BN2J%252BcanOtlgAyObzRqYWtQ%252BSOECUQnSKWxSb0CctYVLCSqShNVP6wyabt6UEG8UTIO%252BFk2WJgaoHkmrvQdsHWmBtyB470GYPWd4280i4SLirPUjhmeJNke7qonU8BAnntV43i%252FlivYwZb%252BNOZXXbUSc30%252BTITU34S42PeU%252BNtxzXluYKsG3KUZbN5fFB3jwvN5dFZDzxRKb08LoDVQ81oTXPs54BULZC7U0932bQ8xZdm06DjGOeP6TCoDnX3hV8iDWYCcUNYeg4VskigmEK7dueoWVHBE91cFLePyg%252FM36T5x9cwm9JZZixUP80DF0H9JfQN3T1Y7nQ6qEFcplc8o0SzMTOvJBsp%252FeYELfjLHABa6fRNuXGL0RADFBA9JrQJvugVb4JIHPAvTM1GcIDTs0nzDn9ozMBjqkASyvAsDgXUa6gPhyQoGeDoeREJjRRjJy3WMaKtlHxLkdRCR8J%252BtexQDaiu1KknBZHVtWIpBJbWGifpkQ4TvstX0c5HgWGprIfoHEDrj8iTOm8HDBn1d0PM9EfZ7eOwozwI5rXbWCUgNueWUKUgguE7ILrdcs3uIsbGrqDsaWlmCSsoVMkFi8acN46QyguJr0IXReJ4idj8bTdJeykLF5A1snJzw5%26X-Amz-Signature%3D60bae872ecc879db1096e99bd726f39e99340b6b14c8bff7a3fe613386e8adda%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=87659099-a29a-423f-b646-11284eb2ffeb" class=glightbox data-aspect-ratio=2.970803 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.970803><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdfc75047-5a34-4cc6-91a0-c2a82f4e4cf8%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4665PJOGY47%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125730Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQDn2eeEF08jU2nBfJ6esT8hDm4iudsNXDFvKvSATjFPVAIhAIVQyZ3Q71dTJd4imBGLlSbCTU%252BLSJ5m60K3O2tKqjz%252BKv8DCBYQABoMNjM3NDIzMTgzODA1IgyZ0fXXIsHFs0LSjLIq3APko5q9XLkiJoMjz6kU2dhY52EN%252B2Bic%252B6qBWH7gZ%252BkNFXcfTPQNt1I0AOyKpdX3veYu6iW30UmTVKBWiSxoIcnKNbNsnpO1kTIhsed4Vxug4dI6g1FIQzgKJ%252BLSJoMT4L6ADBuLX0FqwGr6YFYr4NrkbEywsJMPHKPwdR%252F7cQTSC5tZIWlce1tbmmatz0badsOo2cS1WMEVf%252F27O4PYgv5pPOyeL8oqCWU%252BN2J%252BcanOtlgAyObzRqYWtQ%252BSOECUQnSKWxSb0CctYVLCSqShNVP6wyabt6UEG8UTIO%252BFk2WJgaoHkmrvQdsHWmBtyB470GYPWd4280i4SLirPUjhmeJNke7qonU8BAnntV43i%252FlivYwZb%252BNOZXXbUSc30%252BTITU34S42PeU%252BNtxzXluYKsG3KUZbN5fFB3jwvN5dFZDzxRKb08LoDVQ81oTXPs54BULZC7U0932bQ8xZdm06DjGOeP6TCoDnX3hV8iDWYCcUNYeg4VskigmEK7dueoWVHBE91cFLePyg%252FM36T5x9cwm9JZZixUP80DF0H9JfQN3T1Y7nQ6qEFcplc8o0SzMTOvJBsp%252FeYELfjLHABa6fRNuXGL0RADFBA9JrQJvugVb4JIHPAvTM1GcIDTs0nzDn9ozMBjqkASyvAsDgXUa6gPhyQoGeDoeREJjRRjJy3WMaKtlHxLkdRCR8J%252BtexQDaiu1KknBZHVtWIpBJbWGifpkQ4TvstX0c5HgWGprIfoHEDrj8iTOm8HDBn1d0PM9EfZ7eOwozwI5rXbWCUgNueWUKUgguE7ILrdcs3uIsbGrqDsaWlmCSsoVMkFi8acN46QyguJr0IXReJ4idj8bTdJeykLF5A1snJzw5%26X-Amz-Signature%3D60bae872ecc879db1096e99bd726f39e99340b6b14c8bff7a3fe613386e8adda%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=87659099-a29a-423f-b646-11284eb2ffeb" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure></li></ul><p>主动向系统注入故障并验证，这能提高错误发生概率，暴露问题。但无法复现的根本问题还是没有解决：</p><ul><li>修复后如何验证真的解决了？还是需要精确复现这个问题</li><li>更多时候还因为日志和信息不足无法定位，要给程序添加日志后等待再次复现</li></ul><p><br></p><p>可以发现，无法复现的原因是系统有很多因素每次运行时都是不确定的，bug 可能只有在程序的某些执行历史下才会复现。而网络延迟、进程调度的波动，最终都会导致执行历史变化，使系统走向无法预测</p><p>甚至有可能因为「修复」行为导致问题更难复现，例如为了复现问题，在性能敏感区域加了一长串日志输出，结果因为输出的开销导致的蝴蝶效应更难踩中 bug 触发的时间窗口</p><p><br></p><p>如果系统像纯函数一样是确定性的，测试就能简单得多。那能不能将不确定性的事件，通过某种参数关联为确定性的事件？典型例子是伪随机数生成器，看起来是不确定性的，实际上是与 seed 关联，结果是确定的。是否可能通过一个 seed，去 hook 系统中的不确定性因素？</p><p><br></p><p>Sled（一个类似 RocksDB 的嵌入式存储引擎） 的作者在<a href=https://sled.rs/simulation.html rel="noopener noreferrer" target=_blank>一篇文章</a>中提到他是如何在系统中进行测试的：</p><figure class="notion-image notion-image-center" style=max-width:624px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff0ceda69-c45c-4992-bc66-37c150805e04%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Dc93ce7961cc0d75771e4f76f1f03e8a0b1c0c36c6808a112ca77d490818cb740%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8004-b4bf-eb00d0243e23" class=glightbox data-aspect-ratio=5.612903 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:5.612903><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff0ceda69-c45c-4992-bc66-37c150805e04%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Dc93ce7961cc0d75771e4f76f1f03e8a0b1c0c36c6808a112ca77d490818cb740%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8004-b4bf-eb00d0243e23" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><blockquote class=notion-quote>Jepsen 的出现成功击溃了几乎所有它测试的分布式系统，这表明我们在根本上以一种错误的方式构建分布式系统，这种方式无法避免 bug 的出现</blockquote><p><br></p><p>那我们要怎么做才是正确的？</p><figure class="notion-image notion-image-center" style=max-width:672px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F973a1bbf-337b-4131-91f6-446e7fe51205%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D0ad91c4e48c5ac4839a49c43a691bfb9fbe5883e3c68060c298138496c8c0f66%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8016-b156-d447217c8c99" class=glightbox data-aspect-ratio=1.646724 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.646724><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F973a1bbf-337b-4131-91f6-446e7fe51205%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D0ad91c4e48c5ac4839a49c43a691bfb9fbe5883e3c68060c298138496c8c0f66%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-8016-b156-d447217c8c99" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><blockquote class=notion-quote>1. 将代码写成能在模拟器上被确定性运行的形式<br>2. 写一个模拟器去模拟真实世界的行为</blockquote><p><br></p><p>这就是确定性模拟器</p><p><br></p><h2 id="">业界实现和落地</h2><h3 id=foundationdb>FoundationDB</h3><p>FoundationDB 是 Apple 开源的分布式 KV 数据库，FoundationDB 在开发之初花了两年实现模拟器，在后期取得了非常大的回报，是业界最早全面落地确定性测试的工程之一，也是为数不多能够通过 Jepsen 的系统</p><figure class="notion-image notion-image-center" style=max-width:381.9957275390625px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F976d433c-4a1f-4a57-8512-3d3a96b455f1%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D4f2b62875b82dd22b7b5c8dd8212995e9d56964415c9d0abd3ad595f44291034%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-807f-b5ed-f38e8d6f9f4e" class=glightbox data-aspect-ratio=8.681818 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:8.681818><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F976d433c-4a1f-4a57-8512-3d3a96b455f1%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D4f2b62875b82dd22b7b5c8dd8212995e9d56964415c9d0abd3ad595f44291034%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-807f-b5ed-f38e8d6f9f4e" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>FoundationDB 基于 C++ 扩展出了一个名为 Flow 的语言（与其说是语言，更像一种扩展的宏功能，只进行了预编译处理）</p><p>Flow 采用 Actor 单线程异步模型（async/await），由 runtime 负责所有调度，以此控制执行顺序，确保不会因为内核的线程调度导致不确定性。再通过接口接管了网络、存储、时间等其他外部调用，实现所有不确定性事件的受控</p><p><br></p><p>在这些改造后，Flow 看起来也和 C++ 没什么区别，使用 <code>ACTOR</code> 即可定义一个异步任务：</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>C++</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-c++>ACTOR Future&lt;float&gt; asyncAdd(Futur&lt;float&gt; f, float offset) {
    float value = wait(f);
    return value + offset;
}</code></pre></div><p>模拟器中每个测试由一段配置文件定义，这里包括了测试的行为，以及注入的故障，例如向网络注入延迟、关闭连接、杀死节点、变更配置等。只要用相同的配置文件作为输入，模拟器就会产生相同的执行历史，问题就能被复现</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Plain text</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class="language-plain text">testTitle=SwizzledCycleTest
    testName=Cycle
    transactionsPerSecond=1000.0
    testDuration=30.0
    expectedRate=0.01

    testName=RandomClogging
    testDuration=30.0
    swizzle = 1

    testName=Attrition
    machinesToKill=10
    machinesToLeave=3
    reboot=true
    testDuration=30.0
    
    testName=ChangeConfig
    maxDelayBeforeChange=30.0
    coordinators=auto</code></pre></div><p>FoundationDB 本身是开源的，但可惜模拟器部分没有开源，论文和演讲中也只进行了简单介绍</p><figure class=notion-video><div class=notion-video-wrapper><iframe allowfullscreen frameborder=0 src=https://www.youtube.com/embed/4fFDFbi3toc></iframe></div><figcaption>“Don’t debug your system, debug a simulation instead.”</figcaption></figure><p><br></p><p>最终，他们声称确定性模拟让他们发现了数据库<strong>所有</strong> bug：</p><blockquote class=notion-quote>Anyway, we did this for a while and found all of the bugs in the database. I know, I know, that’s an insane thing to say. It’s kind of true though. In the entire history of the company, I think we only ever had one or two bugs reported by a customer. <em>Ever</em>. Kyle Kingsbury aka “aphyr” didn’t even bother testing it with Jepsen, because he didn’t think he’d find anything.</blockquote><figure class="notion-image notion-image-center" style=max-width:480px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ffb249a39-9fb3-4972-8d23-40a0631b0304%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D6020b49a632d26f1a38cebc885439b7fb054f85498149511d87a6c36b3ece73b%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-809a-a586-f2403bc1a49b" class=glightbox data-aspect-ratio=1.653521 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.653521><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ffb249a39-9fb3-4972-8d23-40a0631b0304%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D6020b49a632d26f1a38cebc885439b7fb054f85498149511d87a6c36b3ece73b%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-809a-a586-f2403bc1a49b" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>无论如何，FoundationDB 开创了确定性模拟的先河。所有后来者都无法绕过 FoundationDB 的影响</p><p><br></p><h3 id=risingwave-madsim>RisingWave &amp; MadSim</h3><p><a href=https://github.com/risingwavelabs/risingwave rel="noopener noreferrer" target=_blank>RisingWave</a> 是一个分布式流数据库，受到 FoundationDB 的启发，他们开发了一个名为 <a href=https://github.com/madsim-rs/madsim rel="noopener noreferrer" target=_blank>MadSim</a> 的确定性测试框架，两者都是开源项目</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F683e1fa8-10b4-46f1-8e56-dc5a6fe7630a%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Da9b2899c10587e2db6f653837aece734ebede0eb68a6a27ec9fa37b3ccd3c4ce%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80d5-a9c9-d84116744b96" class=glightbox data-aspect-ratio=1.746032 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.746032><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F683e1fa8-10b4-46f1-8e56-dc5a6fe7630a%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Da9b2899c10587e2db6f653837aece734ebede0eb68a6a27ec9fa37b3ccd3c4ce%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80d5-a9c9-d84116744b96" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p><br></p><p>RisingWave 和 MadSim 都基于 Rust 开发。Rust 原生支持异步，但特殊的是，Rust 只提供了异步需要的语言特性、关键字和相关类型等；如异步任务如何执行、管理和调度等具体实现则不在语言内提供，因此社区有各种不同的 runtime</p><p>在这种设计下，MadSim 就可以作为一个异步 runtime 呈现，使用单线程运行异步任务，不需要对语言做侵入性改动即可轻松控制调度，并且能和工具链（如调试器）结合得更好</p><p><br></p><p>MadSim 的基本架构如下，这里也参考了 FoundationDB，包括一个全局的随机数生成器，以及基于这之上的定时器，任务调度器和环境模拟（网络、存储）</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fee0cf179-f3de-4b34-aed2-fe0ce16b7108%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D60bad99adaa4c4781b76264d4ffa19e888e836b41468392f63ffa592cb92dfd9%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-8060-9138-d8bae2d3e272" class=glightbox data-aspect-ratio=2.139037 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.139037><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fee0cf179-f3de-4b34-aed2-fe0ce16b7108%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D60bad99adaa4c4781b76264d4ffa19e888e836b41468392f63ffa592cb92dfd9%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-8060-9138-d8bae2d3e272" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>除此之外，MadSim 还提供了对 Rust 异步 runtime 事实标准 tokio 的 API 兼容，这使得使用 tokio 的项目无需修改一行代码，就可以无缝接入 MadSim</p><p>还有一些异步 API 之外的部分，例如获取系统时间和配置等（<code>gettimeofday</code>,<code>get_random</code>,<code>sysconf</code> 等 API），可能会被部分标准库和依赖库不知不觉地调用而破坏确定性，Madsim 通过重载 libc 函数完成 hook</p><p>最后一些常见的外部系统网络交互的 client 库，也提供了有确定性模拟的包装实现</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F7cd5f1fb-c836-4b1a-bace-c3f094b8e3cb%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Db43e891b82b5bb97712a05df828745a3268038e570c8c8e45ccb1d052587aa75%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80e9-a241-c485214a3f3a" class=glightbox data-aspect-ratio=1.985740 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.985740><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F7cd5f1fb-c836-4b1a-bace-c3f094b8e3cb%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125726Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3Db43e891b82b5bb97712a05df828745a3268038e570c8c8e45ccb1d052587aa75%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80e9-a241-c485214a3f3a" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p><br></p><p>MadSim 中，系统中每一个节点被抽象成状态机。输入会触发节点的状态转移，输入通常有两类：消息和定时器。而节点的输出就是对另一个节点发送的消息，定时器通常是节点自身在某一时刻做的一件事情</p><p>在系统的一开始，存在一个初始状态，接着一些节点的定时器可能被激活（例如心跳或注册等），触发状态转移，发送消息给其它节点，进一步触发其它节点的转移</p><figure class="notion-image notion-image-center" style=max-width:672px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd758bf6b-a683-4d6d-af43-3d498791c1e7%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125727Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D182993b69c92b03508631e4bf73b21c71acf352158f12f7e1fe086105ee091f1%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=93733ab2-0e61-4462-b5bf-01440b2c8d59" class=glightbox data-aspect-ratio=2.422701 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.422701><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd758bf6b-a683-4d6d-af43-3d498791c1e7%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125727Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D182993b69c92b03508631e4bf73b21c71acf352158f12f7e1fe086105ee091f1%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=93733ab2-0e61-4462-b5bf-01440b2c8d59" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>从更高的维度将「整个系统」看作一个大的状态机，唯一的外部输入就只有时间，整个系统就是一个随着时间不断变化状态的状态机，可以看作只有状态转移的时候，时间才被推进了</p><p>将这些状态的转移在时间轴上排列，状态转移之间的时间对状态机是没意义的，模拟器就可以通过离散事件模拟的方式在一个转移结束后直接跳到下一个转移的时间节点，实现时间加速</p><div class=notion-children><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F71dc8c92-485e-4049-ac85-ed203598b1ce%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4662BXMONMV%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125731Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQCGbR%252BUFr74sNHc7%252FeQZeSm%252FEKv%252FfYc1idDUYSD7pbEQAIgKUaZMliFRZr9VmLxF7vTzoknMS7zgpqpH5JFobtf69Qq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDD2LoXsPpKJiIG57UyrcA%252B%252BB7etI%252BurYby9FYWr3IiC3oc0%252FOO58NhiBgL%252F6Zao9HI1yovKMUExAUxiyAzGrVlt4SqdA5anXuCATpA%252F4Hg1dyhBZ6SWZOk8bqMyyRMRmHpUn6yX0EHmxA5nk%252BKbh3VT1AUbMoaCKzFXdJZSyhzdaa19dR7jzuU9USmtX206rS98tvOV5CjJ7lHbhhii9SYuaMzen6uJ2mcKcms1LGUiaPjsraqO1dZ0JapKzTa5p7a5jA2NE%252FgJVSKKmzmlVDxkPjBSOsmQHz2SpGjft4A2Qf10x%252BOsm6g%252BUrIi1KHGee18%252Blz9tt4YW7v%252BI8DmdwnOUbgJwyrV0ZE3JkL3xtc%252BRykDAYWhgxcn%252FClYhFa4OAcX3eCvDvTGifCk5GBIKkkSm3VfnXZaV0Xav9atVaBLOGMBUmjSVlo%252FDVdsEDGnBzdaxfVd3d7Lqwp6xZFuVUzzp1Nr0s%252FPHXYEDddvPRfDluJZX0VO8d0I3Dfs5MdH7Xc5K7OqJsadvvQS4r90uDwHRoyWzjZMW2g68yCnO7OF5W1TWZAu9d62LoXaBNPw0kbL8J5W3SR98Gltc6oGxfR9WrQw4vvweWJ9UKwiIBKUD16tXCJRYG9kffGkiYDhAg0E5QtAyRxUIyEhXMNj3jMwGOqUBzOh3c91wHw1mPf1ppoeJtlBkKLj42ZR1D1A3Qlr1BLulplqykMEAJohpr9rAqOPW3NMcK5nnZY5DTyxHWTONUwEe4wtlVclgHQWOvmTh%252FA%252FmyC5bTSOmVMUOb5wnFopeOZvj%252FSFG4lfYJY%252FuKPHlf%252Be%252BeuBS2noDRy2ui%252BRQrH9%252Fo%252FqiKTpKvN76nFnWkfKNM5Yj9CmAl8EYUxdqZVRgz1GfzCRN%26X-Amz-Signature%3De4ee322394738e72375285f89434b935a1b75ce270e765e2f2b3638a62d18b10%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=f4b66a13-e0af-4e59-b631-8320d65ea25b" class=glightbox data-aspect-ratio=2.707424 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.707424><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F71dc8c92-485e-4049-ac85-ed203598b1ce%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4662BXMONMV%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125731Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQCGbR%252BUFr74sNHc7%252FeQZeSm%252FEKv%252FfYc1idDUYSD7pbEQAIgKUaZMliFRZr9VmLxF7vTzoknMS7zgpqpH5JFobtf69Qq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDD2LoXsPpKJiIG57UyrcA%252B%252BB7etI%252BurYby9FYWr3IiC3oc0%252FOO58NhiBgL%252F6Zao9HI1yovKMUExAUxiyAzGrVlt4SqdA5anXuCATpA%252F4Hg1dyhBZ6SWZOk8bqMyyRMRmHpUn6yX0EHmxA5nk%252BKbh3VT1AUbMoaCKzFXdJZSyhzdaa19dR7jzuU9USmtX206rS98tvOV5CjJ7lHbhhii9SYuaMzen6uJ2mcKcms1LGUiaPjsraqO1dZ0JapKzTa5p7a5jA2NE%252FgJVSKKmzmlVDxkPjBSOsmQHz2SpGjft4A2Qf10x%252BOsm6g%252BUrIi1KHGee18%252Blz9tt4YW7v%252BI8DmdwnOUbgJwyrV0ZE3JkL3xtc%252BRykDAYWhgxcn%252FClYhFa4OAcX3eCvDvTGifCk5GBIKkkSm3VfnXZaV0Xav9atVaBLOGMBUmjSVlo%252FDVdsEDGnBzdaxfVd3d7Lqwp6xZFuVUzzp1Nr0s%252FPHXYEDddvPRfDluJZX0VO8d0I3Dfs5MdH7Xc5K7OqJsadvvQS4r90uDwHRoyWzjZMW2g68yCnO7OF5W1TWZAu9d62LoXaBNPw0kbL8J5W3SR98Gltc6oGxfR9WrQw4vvweWJ9UKwiIBKUD16tXCJRYG9kffGkiYDhAg0E5QtAyRxUIyEhXMNj3jMwGOqUBzOh3c91wHw1mPf1ppoeJtlBkKLj42ZR1D1A3Qlr1BLulplqykMEAJohpr9rAqOPW3NMcK5nnZY5DTyxHWTONUwEe4wtlVclgHQWOvmTh%252FA%252FmyC5bTSOmVMUOb5wnFopeOZvj%252FSFG4lfYJY%252FuKPHlf%252Be%252BeuBS2noDRy2ui%252BRQrH9%252Fo%252FqiKTpKvN76nFnWkfKNM5Yj9CmAl8EYUxdqZVRgz1GfzCRN%26X-Amz-Signature%3De4ee322394738e72375285f89434b935a1b75ce270e765e2f2b3638a62d18b10%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=f4b66a13-e0af-4e59-b631-8320d65ea25b" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure></div><p>这也是 FoundationDB 中提过的模拟器的另一个好处</p><p><br></p><p>既然是开源的，简单看一下关键实现</p><ul><li>runtime 初始化时，使用传入的 seed 构造随机数生成器，之后所有事件的模拟都能被这个 seed 确定<div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Rust</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-rust>/// Create a new runtime instance with given seed and config.
pub fn with_seed_and_config(seed: u64, config: Config) -&gt; Self {
    let rand = rand::GlobalRng::new_with_seed(seed);
    let sims = Arc::new(Mutex::new(HashMap::new()));
    let task = task::Executor::new(rand.clone(), sims.clone());
    let handle = Handle {
        rand: rand.clone(),
        time: task.time_handle().clone(),
        task: task.handle().clone(),
        sims,
        config,
        allow_system_thread: false,
    };
    let rt = Runtime { rand, task, handle };
    rt.add_simulator::&lt;fs::FsSim&gt;();
    rt.add_simulator::&lt;net::NetSim&gt;();
    rt
}</code></pre><div class=notion-code-caption>madsim/src/sim/runtime/mod.rs</div></div></li><li>定时器，实质上是在时间堆中加入了一个带定时器回调的输入<div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Rust</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-rust>pub(crate) fn add_timer_at(
    &amp;self,
    deadline: Instant,
    callback: impl FnOnce() + Send + Sync + &#039;static,
) {
    let mut timer = self.timer.lock();
    timer.add(deadline - self.clock.base_instant(), |_| callback());
}

pub(crate) fn add_timer(&amp;self, dur: Duration, callback: impl FnOnce() + Send + Sync + &#039;static) {
    self.add_timer_at(self.clock.now_instant() + dur, callback);
}</code></pre><div class=notion-code-caption>madsim/src/sim/time/mod.rs</div></div></li><li>调度器：通过 event-loop 来进行调度，从就绪队列里随机取任务执行，这里的「随机」也是基于全局的随机数生成器，调度顺序都是被 seed 确定的。然后直接跳转到下一个事件的时间点<div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Rust</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-rust>pub fn block_on&lt;F: Future&gt;(&amp;self, future: F) -&gt; F::Output {
    // ...
    
    loop {
        self.run_all_ready();
        if task.is_finished() {
            return task.now_or_never().unwrap();
        }
        let going = self.time.advance_to_next_event();
        
        // ...
    }
}

/// Drain all tasks from ready queue and run them.
fn run_all_ready(&amp;self) {
    while let Ok(runnable) = self.queue.try_recv_random(&amp;self.rand) {
        // ...
        
        // run the task
        let res = {
            let _guard = crate::context::enter_task(info.clone());
            std::panic::catch_unwind(move || work(runnable))
        };
        if let Err(e) = res {
            // ...
        }

        // advance time: 50-100ns
        let dur = Duration::from_nanos(self.rand.with(|rng| rng.gen_range(50..100)));
        self.time.handle().advance(dur);
    }
}</code></pre><div class=notion-code-caption>madsim/src/sim/task/mod.rs</div></div></li><li>网络接口的语义比较复杂，这部分有不小工作量，最底下是维护链接的实现，这里存储了所有节点的信息，使用 channel 进行通信，并且可以根据配置的丢包率和延迟来注入故障。再往上提供 socket 语义的接口，感觉都是体力活<div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Rust</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-rust>/// Opens a new connection to destination.
pub(crate) async fn connect1(
    self: &amp;Arc&lt;Self&gt;,
    node: NodeId,
    port: u16,
    mut dst: SocketAddr,
    protocol: IpProtocol,
) -&gt; io::Result&lt;(PayloadSender, PayloadReceiver, SocketAddr)&gt; {
    self.rand_delay().await?;
    if let Some(addr) = self
        .ipvs
        .get_server(ServiceAddr::from_addr_proto(dst, protocol))
    {
        dst = addr.parse().expect(&quot;invalid socket address&quot;);
    }
    let (ip, dst_node, socket, latency) = (self.network.lock().try_send(node, dst, protocol))
        .ok_or_else(|| {
        io::Error::new(io::ErrorKind::ConnectionRefused, &quot;connection refused&quot;)
    })?;
    let src = (ip, port).into();
    let (tx1, rx1) = self.channel(node, dst, protocol);
    let (tx2, rx2) = self.channel(dst_node, src, protocol);
    trace!(?latency, &quot;delay&quot;);
    // FIXME: delay
    // self.time.add_timer(latency, move || {
    socket.new_connection(src, dst, tx2, rx1);
    // });
    Ok((tx1, rx2, src))
}

/// Try sending a message to the destination.
///
/// If destination is not found or packet loss, returns `None`.
/// Otherwise returns the source IP, socket and latency.
pub fn try_send(
    &amp;mut self,
    node: NodeId,
    dst: SocketAddr,
    protocol: IpProtocol,
) -&gt; Option&lt;(IpAddr, NodeId, Arc&lt;dyn Socket&gt;, Duration)&gt; {
    let dst_node = self.resolve_dest_node(node, dst, protocol)?;
    let latency = self.test_link(node, dst_node)?;
    let sockets = &amp;self.nodes.get(&amp;dst_node)?.sockets;
    let ep = (sockets.get(&amp;(dst, protocol)))
        .or_else(|| sockets.get(&amp;((Ipv4Addr::UNSPECIFIED, dst.port()).into(), protocol)))?;
    let src_ip = if dst.ip().is_loopback() {
        IpAddr::V4(Ipv4Addr::LOCALHOST)
    } else {
        self.nodes.get(&amp;node).expect(&quot;node not found&quot;).ip.unwrap()
    };
    Some((src_ip, dst_node, ep.clone(), latency))
}

/// Returns the latency of sending a packet. If packet loss, returns `None`.
fn test_link(&amp;mut self, src: NodeId, dst: NodeId) -&gt; Option&lt;Duration&gt; {
    if self.link_clogged(src, dst) || self.rand.gen_bool(self.config.packet_loss_rate) {
        None
    } else {
        self.stat.msg_count += 1;
        // TODO: special value for loopback
        Some(self.rand.gen_range(self.config.send_latency.clone()))
    }
}</code></pre><div class=notion-code-caption>madsim/src/sim/net/mod.rs & madsim/src/sim/net/network.rs</div></div></li></ul><p><br></p><p>作者提供了一个基于 MadSim 的 MIT 6.824 课程 Raft 实验的重写版 <a href=https://github.com/madsim-rs/madraft rel="noopener noreferrer" target=_blank>MadRaft</a>，这里模拟器中的 Raft 测试比真实运行快上近百倍：</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F20011529-118d-4555-a03e-fa8e8c527556%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125727Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D96704730061f0f4530708d989e702e692df26638f19e163dcae9b9ce0c2c8139%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-805d-aab6-ee285a94362b" class=glightbox data-aspect-ratio=1.681055 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.681055><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F20011529-118d-4555-a03e-fa8e8c527556%2FUntitled.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466ZNEFWNPJ%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125727Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCICjc4kaNfsk96WMJ8zqRQeIqh0ELU7ImmwJpXNI5Q14AAiEAhLNkAMzYGh39ntVx5H6uiEEjsatriBaGFygLDSs3HZMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDIUyt18vNT318LnNhyrcA%252Ff%252FgMwleC%252FrEcmT147kUxeh6Y6NEp0Nppp19JTzDcFCWxrk%252Fi4p3kpp70sKvCV00FeFOYZsKGkT12FHxqbIQ%252FXoaUFReSCyIMTm3kWPuXgPuakUWrW9pssl8OepK56HnkBUJph0rWLpdP7ues5zwaPLD45QkRRGUDXyCSRlRCEHgtWHxv31pJppYt%252FiKUL4%252Ff5cOBTY5rYG8hAELbtMQkgvGXh87bGGrJ%252B4C%252Br2BHJUoSrUll3b8NbdfHqJ753faMUCVnpQKN5occEPEonq4nPw4RpU9A3LNHWlu6Nj6dw9FpeAmdKAQXZdqIrMeTc3XB59dopxg%252F3ZquarXI5l7qokT1Pz9tdhrNuTttzi222gURbhe7mG2SS4Qg1%252BbB9BXWvos1eSBRsRHJhJGkSUVno3moqkGKy4P%252Bb4CzMEevURIfsOcTCtpmf%252FKffjdaTVq4tb9KoKqFwVJp4LsiFCSrdG8vijiHGpVmphYKH0M1y4bLLPTmTkpikQ58aMW3RR4QEqOQYO%252BJDyafKVdue7XmEz8E1TZSC1Ogtid2irrgGxMcxiacHaiDyGQBwvlXeRvMlQmwFf1OqSnDmQFNE1cepN97r35S%252FBmR2v1OBFgYjJ0hmJ5IQZNrwq6%252FPKMPv3jMwGOqUBJrMLHCUnUk0Dv8aQCu8cl3rBB%252FuodzdmWyPOm4FBRPY3tVJLjtisPpYm5uHlMPMXyttVLZGG8RPV%252B2Z%252Bb%252BwQeF6bt5oQ7AJOkLd4Ev2Zj2wt4jGs8ekYmEaBZhWzi2SK82HMLVU5deEvhWRA9iKmUT3Uic%252B6APsxwJfeqth4qlWUcZqixLaSOtKoarH7bPOzjvbxaFT1Tp5euSiKk3f3F4McwLOq%26X-Amz-Signature%3D96704730061f0f4530708d989e702e692df26638f19e163dcae9b9ce0c2c8139%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=14688756-3979-805d-aab6-ee285a94362b" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>对于未通过的测试，模拟器返回一个 seed，下次使用同样的 seed 运行，就能得到相同的结果</p><p><br></p><p>在 RisingWave 中，Madsim 被应用在四种不同的测试中：</p><ol><li>单元测试：单元测试关注面比较小，难以发现复杂的问题，所以不是确定性测试主要作用的目标，但确定性模拟器在这里还是起了不少作用，比如测试有关超时的逻辑能瞬间完成。另外单元测试也能反过来验证一些外部系统包装（如 etcd 模拟器）的实现正确与否</li><li>E2E 测试：E2E 测试中涵盖了系统的各个模块，更容易出现错误。RisingWave 架构复杂，涉及各种服务<figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff109c7a4-9022-4d0b-b944-41c93e5d7180%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QLG4EJEC%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQDCbsuz%252B7vsZcXGL6xC5Mqvna07aMKx0RRVJsih%252FtYalQIgGljJWsAwyOWtsoxV9G9gbUMlTDjHKxoEr22onfiYd%252FMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDL6zxKWsj%252BciYASWUyrcA3R25UqLwNLZBvVq5Veu8uaG1TzK0ltXRSs94B0LWszt%252BeP1mOmIcfpw2eVlfCcH%252BWMRN7inAMID5h4pyhoRf7gAYkwu51ktzG7XF9akAxv3TP2Pe0mAsItjWcgF6sRBu1CgjJ%252Bgq0TJa%252FVxU1FaarCGjrpuhnXAythkoQkJ2xQqMrbh9S1nD9FhwRKc4iE9l9%252BtoJlpieXMtH3oasc6tJxQEzttMqF9sxZm0vZUSDbqita%252F0Pp1JuJFMQlhoT9GroD%252FBdbC45x4a6I%252FuJ%252FZnd7%252B7Du93%252Fli7NfP1icvGDL23aNQpHQ0pcrrwQTxRQu04qBQx0EfHT%252BAK9hXUay9VqMPUnt63D3jioWRsHEfTxi3Omz3Ownpx%252F8HPMSlDrKCAnALqN4wqYwFM8Xn%252BkVkoLmHGmBF51EvmM6BsabHeM7aHKI%252F2esXie9KC0Oz3yFkQtrG6k8U2bilWVlB4RO5ESxlM2oGwNyIsAm3wBQrxTWbzpoMIkh3uk5N2k9xvtDF7nmuzQi%252FPUHHnd7gf4m%252FXWd1vOglc4oD8ZRoXhg1Qxq10r19wvKeUAG%252FyfJoeUb53uJ5QKGRNES%252BXRmt2FGF5IWIrk5QAp0dovaGOln8Jjcqng0S%252FE%252BkF2vpQ4NlMPD2jMwGOqUBNvGfglGpsxEwfzfINqRRPmrAn37LWE1WWGZzkwi2QkUjcoNEvVEnSxrynQA4ggqHuDPJHxZxuHOAxx2p4GgPdnLGxVNbTT3xEyEMdvV0qth6REk7rB6KntQLHv4oX83D9sC4uEwoduNt2%252FvzaMK%252FzCRrKZtSuxp%252FWSDLAivX25Btxm9ay872up18SoqWMFgkDNeTp8zi9qBqZR0vhqdl8s%252FwSbpY%26X-Amz-Signature%3Dbd25d745cadca7e57e82837905296810033bd4c6f74d7d44754501299b2bac73%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80e9-b9b3-d1a2b78dfed3" class=glightbox data-aspect-ratio=2.361624 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.361624><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff109c7a4-9022-4d0b-b944-41c93e5d7180%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QLG4EJEC%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQDCbsuz%252B7vsZcXGL6xC5Mqvna07aMKx0RRVJsih%252FtYalQIgGljJWsAwyOWtsoxV9G9gbUMlTDjHKxoEr22onfiYd%252FMq%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDL6zxKWsj%252BciYASWUyrcA3R25UqLwNLZBvVq5Veu8uaG1TzK0ltXRSs94B0LWszt%252BeP1mOmIcfpw2eVlfCcH%252BWMRN7inAMID5h4pyhoRf7gAYkwu51ktzG7XF9akAxv3TP2Pe0mAsItjWcgF6sRBu1CgjJ%252Bgq0TJa%252FVxU1FaarCGjrpuhnXAythkoQkJ2xQqMrbh9S1nD9FhwRKc4iE9l9%252BtoJlpieXMtH3oasc6tJxQEzttMqF9sxZm0vZUSDbqita%252F0Pp1JuJFMQlhoT9GroD%252FBdbC45x4a6I%252FuJ%252FZnd7%252B7Du93%252Fli7NfP1icvGDL23aNQpHQ0pcrrwQTxRQu04qBQx0EfHT%252BAK9hXUay9VqMPUnt63D3jioWRsHEfTxi3Omz3Ownpx%252F8HPMSlDrKCAnALqN4wqYwFM8Xn%252BkVkoLmHGmBF51EvmM6BsabHeM7aHKI%252F2esXie9KC0Oz3yFkQtrG6k8U2bilWVlB4RO5ESxlM2oGwNyIsAm3wBQrxTWbzpoMIkh3uk5N2k9xvtDF7nmuzQi%252FPUHHnd7gf4m%252FXWd1vOglc4oD8ZRoXhg1Qxq10r19wvKeUAG%252FyfJoeUb53uJ5QKGRNES%252BXRmt2FGF5IWIrk5QAp0dovaGOln8Jjcqng0S%252FE%252BkF2vpQ4NlMPD2jMwGOqUBNvGfglGpsxEwfzfINqRRPmrAn37LWE1WWGZzkwi2QkUjcoNEvVEnSxrynQA4ggqHuDPJHxZxuHOAxx2p4GgPdnLGxVNbTT3xEyEMdvV0qth6REk7rB6KntQLHv4oX83D9sC4uEwoduNt2%252FvzaMK%252FzCRrKZtSuxp%252FWSDLAivX25Btxm9ay872up18SoqWMFgkDNeTp8zi9qBqZR0vhqdl8s%252FwSbpY%26X-Amz-Signature%3Dbd25d745cadca7e57e82837905296810033bd4c6f74d7d44754501299b2bac73%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80e9-b9b3-d1a2b78dfed3" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>通过 MadSim，可以将上述所有服务运行在模拟器的单线程环境中，使环境构建简单得多，并且基于模拟器时间加速的特性，一轮完整测试只用耗时两分钟，是原先的四分之一</p><p>并且能轻松地并行执行测试，如果发生了错误，使用同样的 seed 就可以轻易复现结果，包括修改代码添加日志，也不会影响可复现性</p></li><li>异常测试：E2E 测试主要还是在测试正常情况下的行为，没法完全发挥 MadSim 的作用。在异常测试中，会刻意构造各种故障并验证系统是否仍然能保持正确。在这个过程中发现了很多 bug，得益于模拟器的可复现性，这些问题都能被很快定位和修复<figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F68419cd1-0ecb-4e97-99dd-1a2adbb04406%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466WXIAFMRA%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQDRxeSC8uBRFPKWhds5rfT9T9VciSkZF5yKY%252BLnE8dL9AIgMgSLHYAmhK8U05hSbq6qNyP38opwrk54PjLFIzYSeE4q%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDGEkjBZpx3Tzvp9%252B7CrcAy8LwZbwOEkiKo8wGTN54sdFlAaw7Eq6h4kp19%252FYlvQoU%252F0%252FzjstMNKUrOQNsMKJjQHLmSOGRy33ldzDN9%252B96LM1D0NICI0FG0upHh%252B38Ur6mjcLMzd4YHUZ%252BMxrCS7zAdQhbPS9mtA8BXiVShg8dg2pOXq289JixcyGEFsU5jd9SIlUFa16DE2EC253wlkbMAJeziSo%252F5b457znM9dPt30Xu4WcKTyH8fJGuimRgUEhWxjMJmtBKYLVTGSI2JhRd81iptP1m%252FLVIKesT5XrO4oQr8pxhUrpHkYHJ2vlg77%252BJbC2iJVpLBt8yaEKhIDMVs3kXOea3EvXeeGSxF4Al%252BE5gGvx73jK%252BU0H8P7cXgLjQGp9o1O7RPElW5Sl2rVXfoRevzf%252BYvUzVuyhgXmSnSBG31pqd7d8wgdXnR5X8ko5nnb9WT9m70aIFOqoC%252B4Rqot1tmw6hhTZyGVkfdLY12MmwMPQbTP1hNx0RlBCVkniH2Rdr9TeJPBTj3cAljcX2OU101JTOe0YhotbWHr3ol5tg2Q7kYtXcugTA7mKWRRF9hFnT01oMIhDR32sbL8TwABXl1dEwAG7xd8KPNRRXVEH%252B5ZgpQ5BuwIGFT902F3%252Bxw2AXMCoKpe%252B8YaTMPP2jMwGOqUBQ8o4Vd6fEiJkTKYlVCkeblZQ6eKNi%252Fdnvku%252Bb5PHoasfj4%252F70F%252FPf9GuWQ1CCzaUTooRUIx3d9pnEPnzexx0MKn%252BcDesCbWQCv6kmPkObuglp1zz2LnCxjzOa%252Fdu4a1I6Y8U8rI7p6JL7h%252BvI7AIj6NleZwnkpQ70kKCRaeOJAY2HZbu34q7RlLH1XPRrcDk3un2OXiOup2rnUZywvXrMEC2pM2T%26X-Amz-Signature%3D5c6d7eaa76d5ce10a7e7487a6154ace15a203ccf7f8923f37b9da824bf6c5fec%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80c2-a428-e4466ebf8748" class=glightbox data-aspect-ratio=2.356753 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.356753><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F68419cd1-0ecb-4e97-99dd-1a2adbb04406%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466WXIAFMRA%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJHMEUCIQDRxeSC8uBRFPKWhds5rfT9T9VciSkZF5yKY%252BLnE8dL9AIgMgSLHYAmhK8U05hSbq6qNyP38opwrk54PjLFIzYSeE4q%252FwMIFhAAGgw2Mzc0MjMxODM4MDUiDGEkjBZpx3Tzvp9%252B7CrcAy8LwZbwOEkiKo8wGTN54sdFlAaw7Eq6h4kp19%252FYlvQoU%252F0%252FzjstMNKUrOQNsMKJjQHLmSOGRy33ldzDN9%252B96LM1D0NICI0FG0upHh%252B38Ur6mjcLMzd4YHUZ%252BMxrCS7zAdQhbPS9mtA8BXiVShg8dg2pOXq289JixcyGEFsU5jd9SIlUFa16DE2EC253wlkbMAJeziSo%252F5b457znM9dPt30Xu4WcKTyH8fJGuimRgUEhWxjMJmtBKYLVTGSI2JhRd81iptP1m%252FLVIKesT5XrO4oQr8pxhUrpHkYHJ2vlg77%252BJbC2iJVpLBt8yaEKhIDMVs3kXOea3EvXeeGSxF4Al%252BE5gGvx73jK%252BU0H8P7cXgLjQGp9o1O7RPElW5Sl2rVXfoRevzf%252BYvUzVuyhgXmSnSBG31pqd7d8wgdXnR5X8ko5nnb9WT9m70aIFOqoC%252B4Rqot1tmw6hhTZyGVkfdLY12MmwMPQbTP1hNx0RlBCVkniH2Rdr9TeJPBTj3cAljcX2OU101JTOe0YhotbWHr3ol5tg2Q7kYtXcugTA7mKWRRF9hFnT01oMIhDR32sbL8TwABXl1dEwAG7xd8KPNRRXVEH%252B5ZgpQ5BuwIGFT902F3%252Bxw2AXMCoKpe%252B8YaTMPP2jMwGOqUBQ8o4Vd6fEiJkTKYlVCkeblZQ6eKNi%252Fdnvku%252Bb5PHoasfj4%252F70F%252FPf9GuWQ1CCzaUTooRUIx3d9pnEPnzexx0MKn%252BcDesCbWQCv6kmPkObuglp1zz2LnCxjzOa%252Fdu4a1I6Y8U8rI7p6JL7h%252BvI7AIj6NleZwnkpQ70kKCRaeOJAY2HZbu34q7RlLH1XPRrcDk3un2OXiOup2rnUZywvXrMEC2pM2T%26X-Amz-Signature%3D5c6d7eaa76d5ce10a7e7487a6154ace15a203ccf7f8923f37b9da824bf6c5fec%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-80c2-a428-e4466ebf8748" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure></li><li>扩容测试：集群配置发生变化时，需要进行重平衡，这个过程也很容易发生错误，特别是叠加异常情况时<figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdb6930a8-b915-4f9f-833c-16b133ea15f6%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466V45NWBJ5%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIHdTMDxPjxhdTxg0CtS7nfk6RLUNjABKgDIbzVcmpugMAiA2Kz6IamfAbHJalAhPYr9XXCBteAMc2KCK%252B6kG2gPMVyr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMYLKtccnu4INKCSWAKtwDtquB1UROP%252F9ydKIEx89ePhctQG8KJt6%252BZgkdn%252FkKTLHOS66mTgu9UJOL2qkeb3XEYXMnl%252Fob7yL1v4Oe080w4Leb2fXsNk1kI0CKwQLUc4hW76jW5E85Q4%252FZtl74clJdP0d8p0Ow4vXBBKGdmDlwuk8hMFUOL6Vf9hyl9BWdJsQq9tO6sRqGhcL0yi2wZAHpAtU%252FsCnO1MeGENZTYiZaAR5rvzsTCKVUnFHgpL8jHlPGsStvftfpg7l1QcjMwZKEYH2M5UobaAnK8LbrqTbetX1Fp5EAOjNyPpYXWOXtYJJTNH7%252FzpwZgtHIcZEXY1mmi7%252F2XLG8zJz%252BEwhQ6qDBJZHLDuL%252FnN8oIaFRpeujEc8%252BC5hx75Azlr1ByXxqJZBw%252FwM4JtwxSttsPQQVG1qJsDs%252FcYwnkQ7BDwRd%252BCmyy9o1dQ0RS3wWwFNakWHQucl8rFEjCiqWX6FE3cc%252FJTlw7N7EYUDBplKwCVPAGoieVHLkFDtcqDnRk1yIw0uP7S9THgZLf9fEfNYtHBH99Kd3k6FDMP%252BnBt%252FYpcEyHwX%252Fz08aTHL0GWUAw1Vk48GJEbPGEohf%252FEApgnC2gIvKq9%252BAjS4N3tXOEJLJBvn2JqR6syWlFRJyvd9VfIY49f4wjveMzAY6pgGld4%252FsXrCgr3E5TtQ4MxL44THsbwCz3DQrxCEDUEA1zez1woCoCjsK36LikC%252Fb7I%252FBYbcAIuXqPTlDzP%252BsHo6dYm78Qbp12l2hTUL62NEvWjLLXB%252FZqhOv%252FymviCh2qWHBhf4r6vVgJaKJSCSrBwmiW1s7rICwz9NlJMJQ4O4yabFu6LyLQJZQRkvgKXy7usDbBjtA9x5j1AlCb4bGNiMLQYF1yLov%26X-Amz-Signature%3D3a7a217556eee5dac8325c177669bd253d39b1dfcd7091e2407cef4b1e633626%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-803c-a4eb-fa1b93eb2234" class=glightbox data-aspect-ratio=2.434722 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.434722><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdb6930a8-b915-4f9f-833c-16b133ea15f6%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466V45NWBJ5%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125735Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJGMEQCIHdTMDxPjxhdTxg0CtS7nfk6RLUNjABKgDIbzVcmpugMAiA2Kz6IamfAbHJalAhPYr9XXCBteAMc2KCK%252B6kG2gPMVyr%252FAwgWEAAaDDYzNzQyMzE4MzgwNSIMYLKtccnu4INKCSWAKtwDtquB1UROP%252F9ydKIEx89ePhctQG8KJt6%252BZgkdn%252FkKTLHOS66mTgu9UJOL2qkeb3XEYXMnl%252Fob7yL1v4Oe080w4Leb2fXsNk1kI0CKwQLUc4hW76jW5E85Q4%252FZtl74clJdP0d8p0Ow4vXBBKGdmDlwuk8hMFUOL6Vf9hyl9BWdJsQq9tO6sRqGhcL0yi2wZAHpAtU%252FsCnO1MeGENZTYiZaAR5rvzsTCKVUnFHgpL8jHlPGsStvftfpg7l1QcjMwZKEYH2M5UobaAnK8LbrqTbetX1Fp5EAOjNyPpYXWOXtYJJTNH7%252FzpwZgtHIcZEXY1mmi7%252F2XLG8zJz%252BEwhQ6qDBJZHLDuL%252FnN8oIaFRpeujEc8%252BC5hx75Azlr1ByXxqJZBw%252FwM4JtwxSttsPQQVG1qJsDs%252FcYwnkQ7BDwRd%252BCmyy9o1dQ0RS3wWwFNakWHQucl8rFEjCiqWX6FE3cc%252FJTlw7N7EYUDBplKwCVPAGoieVHLkFDtcqDnRk1yIw0uP7S9THgZLf9fEfNYtHBH99Kd3k6FDMP%252BnBt%252FYpcEyHwX%252Fz08aTHL0GWUAw1Vk48GJEbPGEohf%252FEApgnC2gIvKq9%252BAjS4N3tXOEJLJBvn2JqR6syWlFRJyvd9VfIY49f4wjveMzAY6pgGld4%252FsXrCgr3E5TtQ4MxL44THsbwCz3DQrxCEDUEA1zez1woCoCjsK36LikC%252Fb7I%252FBYbcAIuXqPTlDzP%252BsHo6dYm78Qbp12l2hTUL62NEvWjLLXB%252FZqhOv%252FymviCh2qWHBhf4r6vVgJaKJSCSrBwmiW1s7rICwz9NlJMJQ4O4yabFu6LyLQJZQRkvgKXy7usDbBjtA9x5j1AlCb4bGNiMLQYF1yLov%26X-Amz-Signature%3D3a7a217556eee5dac8325c177669bd253d39b1dfcd7091e2407cef4b1e633626%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15588756-3979-803c-a4eb-fa1b93eb2234" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>在正常测试中，受限于集群和数据规模的问题，测试覆盖面不足。但在模拟器中可以轻松构造较大规模和极端情况下的 case，帮助发现并修复了大量问题</p></li></ol><p>在 CI 中，每一项确定性测试都会用不同的 seed 并行执行 16 次（16 核 CI 机器），以尽可能提高覆盖率</p><p><br></p><h3 id=dropbox-trinity>Dropbox <strong>Trinity</strong></h3><p>Dropbox 中 Sync Engine 是一个核心功能，负责在客户端和服务器之间进行文件同步</p><p>2016 年，Dropbox 开始使用 Rust 重写它们的 Sync Engine，并引入了确定性模拟技术来测试，该部分称为 Trinity</p><p>动机就像我们一开始提到的那样，问题复现困难，也没有足够日志定位：</p><figure class="notion-image notion-image-center" style=max-width:624px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F70b000f9-def1-4452-ba16-29d7a0af0188%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3De3f38711641eb04f733d70afcbb62755b78ecb6093d46467eac9ff55914a7126%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8002-812b-c1bfb8bb916e" class=glightbox data-aspect-ratio=2.470405 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:2.470405><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F70b000f9-def1-4452-ba16-29d7a0af0188%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3De3f38711641eb04f733d70afcbb62755b78ecb6093d46467eac9ff55914a7126%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8002-812b-c1bfb8bb916e" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>整个测试流程也是类似的，通过 seed 构造全局随机数生成器来生成之后的所有随机决策，如果测试失败则输出 seed</p><figure class="notion-image notion-image-center" style=max-width:576px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F5cf0904e-be75-4d15-a553-96685049fef7%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D0d5158755f0acdd80f8e66d6fba810c753f9f6e426ab0401d167deb269c698a0%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8098-ad64-f1f378d9ea14" class=glightbox data-aspect-ratio=1.440000 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.440000><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F5cf0904e-be75-4d15-a553-96685049fef7%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D0d5158755f0acdd80f8e66d6fba810c753f9f6e426ab0401d167deb269c698a0%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8098-ad64-f1f378d9ea14" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>由于也是 Rust 开发，Trinity 也是作为一个异步 runtime 执行，其他方面也都类似，包括文件系统、网络和时间模拟</p><p>Rust 生态中异步 runtime 的事实标准 tokio 也宣布了其官方的确定性测试项目 <a href=https://github.com/tokio-rs/turmoil rel="noopener noreferrer" target=_blank>turmoil</a>，在这方面 Rust 还是走在了前列</p><p><br></p><h3 id=tigerbeetle-vopr>TigerBeetle &amp; VOPR</h3><p><a href=https://github.com/tigerbeetle/tigerbeetle rel="noopener noreferrer" target=_blank>TigerBeetle</a> 是一个专为金融事务场景设计的数据库，使用 Zig 开发，在首页就着重强调了它们使用确定性模拟来构建数据库以体现可靠性</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F8f427043-fb74-48df-9093-53384be92349%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D0f6c0b7074244d832b3c4eaa4382771cdd3f42bf14ecec9c3dbbd3551ecc34a5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8099-8ab3-d69c8b466640" class=glightbox data-aspect-ratio=2.426199 data-description=「历经数个世纪的测试」 data-gallery=article-images data-title=「历经数个世纪的测试」 style=aspect-ratio:2.426199><img alt=「历经数个世纪的测试」 loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F8f427043-fb74-48df-9093-53384be92349%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D0f6c0b7074244d832b3c4eaa4382771cdd3f42bf14ecec9c3dbbd3551ecc34a5%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8099-8ab3-d69c8b466640" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a><figcaption>「历经数个世纪的测试」</figcaption></figure><p>并且这个模拟版本 <a href=https://sim.tigerbeetle.com/ rel="noopener noreferrer" target=_blank>SimTigerBeetle</a> 是可以运行在浏览器中的，还包装成了一个游戏的形式，能够折磨这些 beetle（注入故障）</p><figure class="notion-image notion-image-center" style=max-width:624px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff577125b-a82f-4bc4-9273-af63ba3158d2%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D4af457684bcd3869af57f7ffa48cf5366d014ce13bc4ac7364baa553d2c94782%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8040-9b67-fbf1dc7c01f3" class=glightbox data-aspect-ratio=1.389457 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.389457><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff577125b-a82f-4bc4-9273-af63ba3158d2%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D4af457684bcd3869af57f7ffa48cf5366d014ce13bc4ac7364baa553d2c94782%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=15688756-3979-8040-9b67-fbf1dc7c01f3" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>他们开发了称为 Viewstamped Operation Replicator (VOPR) 的模拟器，并将系统编译为 WebAssembly 运行，和前面的模拟器一样，这里也都包含网络、存储、时钟的模拟，并支持故障注入</p><p><br></p><p>Zig 不像 Rust 那样可以自定义异步 runtime，那这里是如何控制调度的呢？一开始认为这里编译为 WASM 的目的除了支持浏览器外，也是为了能在模拟器上单线程执行。但看了文档才发现，TigerBeetle 从一开始就是单线程的设计，那也不需要什么控制调度一说了：</p><ul><li><a href=https://docs.tigerbeetle.com/about/performance#single-core-by-design rel="noopener noreferrer" target=_blank>https://docs.tigerbeetle.com/about/performance#single-core-by-design</a></li></ul><p>但并发是必须的，不利用多线程或其他语言的异步机制，如何实现并发？</p><p>从<a href=https://github.com/tigerbeetle/tigerbeetle/blob/main/src/vopr.zig rel="noopener noreferrer" target=_blank>代码</a>上来看，模拟器会每次通过一个 <code>tick</code> 推进进度，下面每一层，节点、网络、存储和时间都有对应的 <code>tick</code> 实现</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Plain text</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class="language-plain text">pub fn main() !void {
    // ...

    while (tick &lt; cli_args.ticks_max_convergence) : (tick += 1) {
        simulator.tick();
        tick_total += 1;
        if (simulator.pending() == null) {
            break;
        }
    }

    // ...
}

pub fn tick(simulator: *Simulator) void {
    simulator.cluster.context = simulator;

    simulator.cluster.tick();
    simulator.tick_requests();
    simulator.tick_crash();
}</code></pre><div class=notion-code-caption>tigerbeetle/src/vopr.zig</div></div><p>真实运行的部分，也是通过 <code>tick</code> 不停推进。相当于手动在代码结构上设计了任务的时间片切分，每 <code>tick</code> 一次就执行这个任务的一个时间片，调度顺序就是代码中 <code>tick</code> 调用的顺序，本身就是被确定的。这是完全贯彻了把系统作为状态机实现的想法，从一开始就是为确定性模拟而设计的：</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Plain text</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class="language-plain text">while (true) {
    replica.tick();
    if (multiversion != null) multiversion.?.tick();
    try command.io.run_for_ns(constants.tick_ms * std.time.ns_per_ms);
}</code></pre><div class=notion-code-caption>tigerbeetle/src/tigerbeetle/main.zig</div></div><p>这对代码设计要求会比较高，在很多场景是反范式的，例如 TigerBeetle 内 LSM-Tree 的实现，有点难想象如何通过一堆 tick 来推进整个 LSM-Tree 的 Compaction 流程：</p><ul><li><a href=https://docs.tigerbeetle.com/about/internals/lsm rel="noopener noreferrer" target=_blank>https://docs.tigerbeetle.com/about/internals/lsm</a></li></ul><p>以及他们如何设计这样的 I/O 库：</p><ul><li><a href=https://tigerbeetle.com/blog/a-friendly-abstraction-over-iouring-and-kqueue rel="noopener noreferrer" target=_blank>A Programmer-Friendly I/O Abstraction Over io_uring and kqueue</a></li></ul><p>除此之外，TigerBeetle 还有些很独特的设计哲学，例如 0 依赖、0 动态内存分配。包括确定性模拟，这些思想都很前卫，值得一看：</p><ul><li><a href=https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/TIGER_STYLE.md rel="noopener noreferrer" target=_blank>Tiger Style</a></li></ul><p><br></p><h3 id=frostdb-resonate>FrostDB &amp; Resonate</h3><p>从前面的方案中可以发现，大部分外部调用都可以通过接口 mock 的方式来实现确定性，最麻烦的是如何让整个分布式系统运行在一个节点的一个线程上，消除调度的不确定性</p><p>上文提到的系统中除了 Rust 能比较好地实现外，其他语言都有些限制，但从头自己造一套任务和调度机制，还是能做到的</p><p>而另外一些语言在设计之处就是完全透明多线程的，在这些语言上会困难得多。例如 Go，很难去避免使用 goroutine，而一旦有多个 goroutine，调度就完全不可控了</p><p><br></p><p>虽然可以将 Go 程序编译为 WASM 来单线程执行并禁用抢占（<code>GOMAXPROCS=1</code> 是不行的，碰到阻塞调用时还是会创建线程），但 runtime 仍然会<a href=https://github.com/golang/go/blob/35ef4a9f330fdff870ff637558ec2fd03a93fd9c/src/runtime/proc.go#L6655 rel="noopener noreferrer" target=_blank>故意随机调度 goroutine</a>，以及 Go 的 map 遍历顺序也是故意随机的，还有<a href=https://blog.merovius.de/posts/2018-01-15-generating_entropy_without_imports_in_go/ rel="noopener noreferrer" target=_blank>其他很多不确定性来源</a></p><p>不过 Go runtime 中这些不确定性来源都是通过启动时的一个 seed 来确定的（就像确定性模拟器做的那样），如果能自定义这个 seed 那就能解决这些问题。但只差这一步，Go 的 runtime 开放和自定义程度很低。要想突破这最后一个限制，只能 fork 一份 runtime 来修改。这几乎就是 <a href=https://github.com/polarsignals/frostdb rel="noopener noreferrer" target=_blank>FrostDB</a> 所做的事，他们 fork 了 Go runtime <a href=https://github.com/polarsignals/go/commit/ea083ca4892a62eb229c1886517e1cdb575ee19a#diff-99a8f74dc3dbef74ab6a6792a8e36e17d2196486ef16e9b8199ce9a9e7512183R44-R52 rel="noopener noreferrer" target=_blank>修改了几行代码</a> 来实现这一切：</p><figure class=notion-bookmark><a href=https://github.com/polarsignals/go/commit/ea083ca4892a62eb229c1886517e1cdb575ee19a#diff-99a8f74dc3dbef74ab6a6792a8e36e17d2196486ef16e9b8199ce9a9e7512183R44-R52 rel="noopener noreferrer" target=_blank><div class=notion-bookmark-cover><img alt="" loading=lazy src=https://opengraph.githubassets.com/87e8c262666f4289280b098950624d382352a13bc2ff2d18524c0bc9859b943b/polarsignals/go/commit/ea083ca4892a62eb229c1886517e1cdb575ee19a /></div><div class=notion-bookmark-info><div class=notion-bookmark-title>runtime: add GORANDSEED to seed go runtime’s randomness · polarsignals/go@ea083ca</div><div class=notion-bookmark-description>This helps with deterministic execution. This commit additionally enables randomized scheduling. The runtime needs to be run with GOOS=wasip1 GOARCH=wasm for deterministic executions given an initi…</div><div class=notion-bookmark-url>github.com</div></div></a></figure><p><br></p><p>另一条路线是 <a href=https://github.com/resonatehq/resonate rel="noopener noreferrer" target=_blank>Resonate</a>，他们则是确实避免使用 goroutine，自己造了一套 coroutine：</p><figure class=notion-bookmark><a href=https://github.com/resonatehq/resonate/blob/268c588e302f13187309e4b37636d19595d42fa1/internal/kernel/scheduler/coroutine.go rel="noopener noreferrer" target=_blank><div class=notion-bookmark-cover><img alt="" loading=lazy src=https://opengraph.githubassets.com/d662fba724126b4f2684d66a086bafc978121f0f19b5b1eb873c313c93aac056/resonatehq/resonate /></div><div class=notion-bookmark-info><div class=notion-bookmark-title>resonate/internal/kernel/scheduler/coroutine.go at 268c588e302f13187309e4b37636d19595d42fa1 · resonatehq/resonate</div><div class=notion-bookmark-description>Distributed Async Await — Durable Executions, Dead Simple - resonatehq/resonate</div><div class=notion-bookmark-url>github.com</div></div></a></figure><p>Resonate 给出了一个使用模拟器发现 bug 的例子，包括 seed，用这个 seed 我们也能在本地复现出一样的结果：</p><ul><li><a href=https://blog.resonatehq.io/dst-finds-a-bug rel="noopener noreferrer" target=_blank>The One Where DST Finds a Real Bug | Resonate</a></li></ul><p><br></p><p>总得来说，在 Rust 这样比较开放的语言上实现确定性模拟是比较简单且兼容程度较高的。其次是其他相对底层的语言，虽然大多数时候需要实现一套自己的机制导致代码不具备普适性，但至少它们不会偷偷做额外的事把一切变得更糟。最麻烦的是 Go 这样隐藏了很多细节且不可控的语言，各种层面上限制都太大</p><p>恰好最近 <a href=https://tip.golang.org/doc/go1.24 rel="noopener noreferrer" target=_blank>Go 1.24 发布</a>，新增了 <code>synctest</code> 包，可以在测试代码中实现作用域内的模拟时钟：</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=复制代码 title=复制代码 class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>import (
	&quot;testing&quot;
	&quot;testing/synctest&quot;
	&quot;time&quot;
)

func Test(t *testing.T) {
	synctest.Run(func() {
		before := time.Now()
		time.Sleep(time.Second)
		after := time.Now()
		if d := after.Sub(before); d != time.Second {
			t.Fatalf(&quot;took %v&quot;, d)
		}
	})
}</code></pre></div><p>这也是确定性模拟中所需的一个重要机制，希望随着 Go 自身的进一步开发，未来能有更 native 的方式在 Go 上实现确定性模拟</p><p><br></p><h3 id=antithesis>Antithesis</h3><p>模拟器都是单线程运行的，是因为我们默认无法干涉内核层面的调度，才有这样的限制。但真的不能吗？如果将模拟器实现在更底层的级别中呢？</p><p><br></p><p><a href=https://antithesis.com/ rel="noopener noreferrer" target=_blank>Antithesis</a> 是 FoundationDB 前成员（CEO 就是前面 FoundationDB 的演讲者）创立的一家公司，他们的平台能为任意系统提供确定性模拟：</p><blockquote class=notion-quote>Antithesis is a <strong>continuous reliability platform</strong> that <strong>autonomously searches</strong> for problems in your software within a <strong>simulated environment</strong>. Every problem we find can be <strong>perfectly reproduced</strong>, allowing for <strong>efficient debugging</strong> of even the most complex problems.</blockquote><p>作为商业化解决方案，面对各种客户的不同系统。不可能要求客户对系统做大量修改和适配甚至重新设计，确定性模拟必须是透明的</p><p>因此，Antithesis 开发了一个<strong>确定性模拟计算机</strong>的 hypervisor。这很疯狂，但确实可行，只要整个虚拟机都是确定性的，那对被测试的软件就是完全透明的</p><figure class="notion-image notion-image-center" style=max-width:528px><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F9b66cf7a-d962-4958-83cf-d796d9aa08ad%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D996f05dbebf5049ab08ca73aa8414b204efc6ccffdcbcb4a7b067724ab2d3b0c%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-8053-89c7-c17c592b3b22" class=glightbox data-aspect-ratio=3.138996 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:3.138996><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F9b66cf7a-d962-4958-83cf-d796d9aa08ad%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D996f05dbebf5049ab08ca73aa8414b204efc6ccffdcbcb4a7b067724ab2d3b0c%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-8053-89c7-c17c592b3b22" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>脱离语言的另一个好处是，可以真正运行「整个系统」。例如 FoundationDB 没法在模拟器中使用 RocksDB，因为它有后台线程。RisingWave 也给 etcd 和 Kafka 编写了单独的模拟器。但在 Antithesis 中都不需要为这些依赖的库和组件操心</p><p><br></p><p>实现一个确定性的 hypervisor，这会比想象中更难，因为 CPU 也不是所有的情况都能保证确定性，而它非常复杂</p><p>为了模拟时间流逝，Antithesis 根据执行指令数来推进模拟时钟。但 PMC 中记录的执行指令数并不总是正确，这会破坏确定性。只有对 CPU 的细节足够了解，才可能解决这些问题</p><p>在并发上，虽然被测系统是多线程的，但还是必须让它们运行在一个物理核上。因为有时间加速，这并不会对被测系统的性能造成多大影响。反而从 Antithesis 的角度来说，可以不需要关注核间同步，在不同核上运行更多单独的虚拟机实例提高效率。并且由于工作在更底层的级别上，使得 Antithesis 还能构造像线程饥饿这样的问题</p><figure class=notion-video><div class=notion-video-wrapper><iframe allowfullscreen frameborder=0 src=https://www.youtube.com/embed/0E6GBg13P60></iframe></div></figure><p><br></p><p>Antithesis 还实现了一些很奇妙的技术，例如能智能判断系统执行历史、探索分支路径和状态空间，并且能保存状态。这意味着 Antithesis 的测试是完全自主的，你不需要编写任何测试用例，系统会自动生成用例挖掘可能的分支，进行比人工更可靠的测试，类似于一种更加智能的 fuzzing</p><p>Antithesis 可以提供每个 checkpoint 的快照，并且和走向其他分支的执行历史进行对比，他们称为 Multiverse（多重宇宙），你能在这些不同宇宙中进行「时间旅行」式的调试。随时回退到过去和继续走向未来看看发生了什么，甚至可以在时间旅行中执行命令或者使用调试器调试进程，捕获网络数据包，跑火焰图… 当你改变了过去之后，一个新的宇宙就会诞生</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F39ec0609-297d-47f6-85d4-65c2c1b801c6%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D590bf4f5f9efd58e71519965c5d458e862d65420db7b4f0148677fafec6136b6%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-80a7-8de2-ea3d83691037" class=glightbox data-aspect-ratio=3.240000 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:3.240000><img alt=Image loading=lazy src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F39ec0609-297d-47f6-85d4-65c2c1b801c6%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB4667YOOTUSK%252F20260204%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260204T125729Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEE0aCXVzLXdlc3QtMiJIMEYCIQC1T0%252FWGltRtSYE%252BjWYRT6Q2Duds9bFqeZM8WAodNnlnwIhAM1wZw0GVdAgHJNF9MFo1wQYGm73kLswdF4uDozjpdy1Kv8DCBYQABoMNjM3NDIzMTgzODA1Igx2aZ0qyXzR%252FutVS4gq3AN7EtLlDPio2mJXg3ksloHHA5KPWlolAAQYhlNk%252BDpebCmFrrPL%252FvAizphR5nSnN4bXBQsEtBY1k1WmSMvul3HEqoUHHNosow3I4YIFFTVTZRqXItjagECDYevZZDr%252Fmsa4dzyXYXhM%252Bgr6Qm%252BQYkM1UIfupmzvVJU2gshr210gs3DccD5z7Gb3Y3Il5Yolg294Fe5eX2AyzEtqKFMplk9zSqL2JFHCvmx%252BtdwaSxb7BhPx9rhqZFZeSDp%252FScROn5zoB7%252F3HOi1XuXtCKfhcn7JBg5522Or2wPHaP%252FcLQuELHHFY4tU2KvU2R%252FI%252FKzCsatCwtpka0q%252BSeBXVJAYn7IAHMCe%252BPh2gpUvFrjLSjGMa1H2%252FqZNdSnPnP9ZQd%252Fw266bYZaBh5yClkiA3DxFsAxEfB7oSam4oDYPVSXYP77UHagzFhDEJ5ZW3iLAFGmxA1hVMKrlS6Kp62QLiBkRDR9%252BmTCpxgMKcoNP%252FmOjP%252BEbgTkfKkrnYDYgO650xR1%252BWzx2uWPR44pYgsvqc4rUUNN7ueDxRpjuajouXMQr0CCt0f69%252FgGEfPipAKmDjrzoyozE%252FL7nIgXoc7C0rIRDrBIOzkb%252Bq5IO7AxhTCiUjuGCreVLIHYG3XdWAd%252FwnDCG94zMBjqkAVleZfsdjlj1exd5oOn1gSVNLXr90nmjVL1pgd%252FBe9bayh27eShLJK8sXUdlLAjUrI7EGna6JFTsoTxJrrJp34GZ%252FuqivS2HjeFVnzpq0757rCVF3drFq5sECbIJKoubtt%252FAgjrVSiqKg9EyHRk0TZmGEtSDYOGPg%252FIbDqf12ixQWSmnuDd1RvXi8cNQenCFPdMc2%252FmfJKL7VWEUBJf7hN08neOg%26X-Amz-Signature%3D590bf4f5f9efd58e71519965c5d458e862d65420db7b4f0148677fafec6136b6%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=16388756-3979-80a7-8de2-ea3d83691037" onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)"/></a></figure><p>这一切都非常黑魔法，更多内容可以浏览他们的 Blog，都很有趣。也许 Antithesis 真的能定义未来的测试方法</p><ul><li><a href=https://antithesis.com/blog/ rel="noopener noreferrer" target=_blank>https://antithesis.com/blog/</a></li></ul><p><br></p><p>Antithesis 的定价不便宜，但在客户侧都有不错的评价，包括一些知名基础设施系统：</p><ul><li>MongoDB 使用 Antithesis 测试存储引擎，核心服务器，同步和升降级功能。发现了一个严重的数据丢失问题：<ul><li><a href=https://antithesis.com/case_studies/mongodb_productivity/ rel="noopener noreferrer" target=_blank>Accelerating developers at MongoDB</a></li><li><a href=https://antithesis.com/blog/mongo_bug/ rel="noopener noreferrer" target=_blank>Working with Antithesis at MongoDB</a></li></ul></li><li>Ethereum 在从 PoW（工作量证明）转向 PoS（权益证明）时使用 Antithesis 进行测试<ul><li><a href=https://antithesis.com/case_studies/ethereum_merge/ rel="noopener noreferrer" target=_blank>Testing the Ethereum merge</a></li></ul></li><li>WarpStream 端到端测试了整个 SaaS 系统，而不是局限在单个组件或进程<ul><li><a href=https://www.warpstream.com/blog/deterministic-simulation-testing-for-our-entire-saas rel="noopener noreferrer" target=_blank>Deterministic Simulation Testing for Our Entire SaaS</a></li></ul></li><li>CockroachDB 在 Antithesis 上重现并定位了之前被搁置数年的事务并行提交 bug<ul><li><a href=https://www.cockroachlabs.com/blog/demonic-nondeterminism/ rel="noopener noreferrer" target=_blank>Antithesis of a One-in-a-Million Bug: Taming Demonic Nondeterminism</a></li></ul></li></ul><p><br></p><p>除了 Antithesis 之外，还有一些项目也试图在更底层的级别上进行确定性探索。例如 <a href=https://rr-project.org/ rel="noopener noreferrer" target=_blank>rr</a> 和 <a href=https://github.com/dettrace/dettrace rel="noopener noreferrer" target=_blank>dettrace</a> 都是通过 ptrace 替换系统调用的想法来实现的确定性调试器，它们都诞生得更早一些。Facebook 也曾发起过 <a href=https://github.com/facebookexperimental/hermit rel="noopener noreferrer" target=_blank>hermit</a> 项目，虽然现在已经没有在积极开发</p><ul><li><a href=https://developers.facebook.com/blog/post/2022/11/22/hermit-deterministic-linux-testing/ rel="noopener noreferrer" target=_blank>Hermit: Deterministic Linux for Controlled Testing and Software Bug-finding</a></li></ul><p><br></p><h2 id="">总结</h2><p>确定性模拟器提供了一个非常美好的、仿佛触手可及的设想。这里调试不再困难，系统更加可靠</p><p>但软件工程没有银弹，确定性模拟器仍然有很多问题。既然是模拟，前提是我们了解被模拟物的所有行为，但这是不可能的。所有模拟疏漏或失真的细节，最终也会在真实系统中遇见，例如错误理解的网络协议，意想不到的 system call 行为，依赖外部系统本身的 bug。都可能让系统再次在真实环境中故障</p><p>更重要的是不确定性的消除十分困难，模拟器本身来说，很难 cover 各种场景，而任何一点遗漏，都会把不确定性引入系统，最终走向混沌</p><p>另一种情况是被测程序的修改会破坏可复现性，被测程序本身就是模拟器输入的一部分，如果修改被测程序，虽然不会破坏「确定性」，但可能会无法复现期望的问题。例如在程序启动时新运行一个线程，那模拟器的调度序列可能会因为这个新的输入而改变，它仍然是确定性的（相同的输入有相同的输出），只是没能再触发之前的问题。这实际上某种程度违背了模拟器提供的承诺，确定性和可复现性并不总是能完全划等号</p><p><br></p><p>从工程角度来说，语言上实现的模拟器大多会有比较强的侵入性，会限制并发模型和依赖库。除了新项目以外难以引入。而 Antithesis 方案技术壁垒过高，大部分人没有能力实现，如果没有开源方案共建，无法广泛普及</p><p>不过这也只是模拟器实现中的困难，从方向上来说，高度的可复现性和极高的测试效率就足以成为任何追求可靠性的系统尝试和探索它的理由。我始终相信这项技术的巨大潜力，一定会是未来的方向</p><p><br></p><h2 id=ref>Ref</h2><ol><li><a href=https://notes.eatonphil.com/2024-08-20-deterministic-simulation-testing.html rel="noopener noreferrer" target=_blank>What&#039;s the big deal about Deterministic Simulation Testing?</a></li><li><a href=https://sled.rs/simulation.html rel="noopener noreferrer" target=_blank>sled simulation guide (jepsen-proof engineering)</a></li><li><a href=https://risingwave.com/blog/deterministic-simulation-a-new-era-of-distributed-system-testing/ rel="noopener noreferrer" target=_blank>Deterministic Simulation: A New Era of Distributed System Testing (Part 1 of 2)</a></li><li><a href=https://risingwave.com/blog/applying-deterministic-simulation-the-risingwave-story-part-2-of-2/ rel="noopener noreferrer" target=_blank>Applying Deterministic Simulation: The RisingWave Story (Part 2 of 2)</a></li><li><a href=https://juejin.cn/post/7262172937511518267 rel="noopener noreferrer" target=_blank>确定性模拟的背景、原理、框架及应用实例 - RisingWave中文开源社区</a></li><li><a href=https://dropbox.tech/infrastructure/-testing-our-new-sync-engine rel="noopener noreferrer" target=_blank>Testing sync at Dropbox</a></li><li><a href=https://tigerbeetle.com/blog/2023-07-11-we-put-a-distributed-database-in-the-browser rel="noopener noreferrer" target=_blank>We Put a Distributed Database In the Browser – And Made a Game of It!</a></li><li><a href=https://tigerbeetle.com/blog/a-friendly-abstraction-over-iouring-and-kqueue rel="noopener noreferrer" target=_blank>A Programmer-Friendly I/O Abstraction Over io_uring and kqueue</a></li><li><a href=https://www.polarsignals.com/blog/posts/2024/05/28/mostly-dst-in-go rel="noopener noreferrer" target=_blank>(Mostly) Deterministic Simulation Testing in Go</a></li><li><a href=https://blog.resonatehq.io/deterministic-simulation-testing rel="noopener noreferrer" target=_blank>Deterministic Simulation Testing | Resonate</a></li><li><a href=https://antithesis.com/blog/is_something_bugging_you/ rel="noopener noreferrer" target=_blank>Is something bugging you? | Antithesis</a></li><li><a href=https://antithesis.com/blog/deterministic_hypervisor/ rel="noopener noreferrer" target=_blank>So you think you want to write a deterministic hypervisor? | Antithesis</a></li><li><a href=https://antithesis.com/blog/autonomous_testing/ rel="noopener noreferrer" target=_blank>Your computer can test better than you (and that&#039;s a good thing) | Antithesis</a></li><li><a href=https://antithesis.com/blog/multiverse_debugging/ rel="noopener noreferrer" target=_blank>Debugging in the Multiverse | Ahtithesis</a></li><li><a href=https://antithesis.com/case_studies/mongodb_productivity/ rel="noopener noreferrer" target=_blank>Accelerating developers at MongoDB</a></li><li><a href=https://antithesis.com/blog/mongo_bug/ rel="noopener noreferrer" target=_blank>Working with Antithesis at MongoDB</a></li><li><a href=https://www.warpstream.com/blog/deterministic-simulation-testing-for-our-entire-saas rel="noopener noreferrer" target=_blank>Deterministic Simulation Testing for Our Entire SaaS</a></li><li><a href=https://www.cockroachlabs.com/blog/demonic-nondeterminism/ rel="noopener noreferrer" target=_blank>Antithesis of a One-in-a-Million Bug: Taming Demonic Nondeterminism</a></li><li><a href=https://developers.facebook.com/blog/post/2022/11/22/hermit-deterministic-linux-testing/ rel="noopener noreferrer" target=_blank>Hermit: Deterministic Linux for Controlled Testing and Software Bug-finding</a></li></ol><p><br></p><p><br></p></div><nav class=post-navigation data-astro-cid-gbhzkc2y><a href=/post/coroutine class="nav-link nav-prev" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>← 上一篇</span> <span class=nav-title data-astro-cid-gbhzkc2y>浅谈协程</span> </a><a href=/post/2024summary class="nav-link nav-next" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>下一篇 →</span> <span class=nav-title data-astro-cid-gbhzkc2y>2024 年度总结</span></a></nav><footer class=page-footer data-astro-cid-gbhzkc2y><a href=/ class=back-link data-astro-cid-gbhzkc2y>← 返回首页</a></footer><section class=comments-section data-astro-cid-gbhzkc2y><div class=comments-container data-astro-cid-te6ksoa6 data-giscus-config={&#34;slug&#34;:&#34;deterministic-simulator&#34;,&#34;title&#34;:&#34;确定性模拟器&#34;,&#34;config&#34;:{&#34;repo&#34;:&#34;xxxuuu/xxxuuu.github.io&#34;,&#34;repoId&#34;:&#34;MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg&#34;,&#34;category&#34;:&#34;Announcements&#34;,&#34;categoryId&#34;:&#34;DIC_kwDOCwLAgM4ChgWc&#34;,&#34;mapping&#34;:&#34;title&#34;,&#34;strict&#34;:&#34;0&#34;,&#34;reactionsEnabled&#34;:&#34;1&#34;,&#34;emitMetadata&#34;:&#34;0&#34;,&#34;inputPosition&#34;:&#34;bottom&#34;,&#34;lang&#34;:&#34;zh-CN&#34;,&#34;lazy&#34;:true}} data-provider=giscus id=comments><div class=comments-loading data-astro-cid-te6ksoa6>加载评论中...</div></div></section></div><aside class=toc-container data-astro-cid-gbhzkc2y><div class=toc-wrapper data-astro-cid-gbhzkc2y><div class=toc-title data-astro-cid-gbhzkc2y>目录</div><nav class=toc-nav data-astro-cid-gbhzkc2y></nav></div></aside></div></div></article></main><footer data-astro-cid-aoh3bln3><div class=container data-astro-cid-aoh3bln3><div class=footer-content data-astro-cid-aoh3bln3><div class=copyright data-astro-cid-aoh3bln3><p data-astro-cid-aoh3bln3>&copy; 2026 x³u³. All rights reserved.</p><p data-astro-cid-aoh3bln3 class=powered-by>Powered by <a href=https://github.com/xxxuuu/nopress rel="noopener noreferrer" target=_blank data-astro-cid-aoh3bln3>Nopress</a></p></div><div class=social-links data-astro-cid-aoh3bln3><a href=https://github.com/xxxuuu rel="noopener noreferrer" target=_blank class=social-icon aria-label=github data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></span></a><a href=https://x.com/xxuuu0 rel="noopener noreferrer" target=_blank class=social-icon aria-label=twitter data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span></a><a href=mailto:xxuuu0@outlook.com rel="noopener noreferrer" target=_blank class=social-icon aria-label=email data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg></span></a><a href=/rss/feed.xml class="social-icon rss" aria-label=RSS订阅 data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></span></a></div></div></div></footer></body></html>