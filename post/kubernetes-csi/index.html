<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Kubernetes CSI | xÂ³uÂ³</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="shortcut icon" href="https://xxxuuu.me/favicon.ico?v=1723216798723">
<link rel="stylesheet" href="https://xxxuuu.me/styles/main.css">



<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<style>
:root {
  --animate-duration: 800ms;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.9/dist/vue.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-T8WGT1LJ6G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T8WGT1LJ6G');
</script>


    <meta name="description" content="åŸºæœ¬æ¦‚å¿µ
K8s çš„å­˜å‚¨æ’ä»¶ç”¨äºå¯¹æ¥å®¹å™¨å¹³å°å’Œåº•å±‚å­˜å‚¨èµ„æºï¼Œä¾‹å¦‚æŒ‚è½½ Volume æ—¶å¯ä»¥é…ç½®çš„ nfs æˆ– gitRepo ç­‰ï¼›ç¬¬ä¸‰æ–¹å¹³å°ï¼Œå¦‚ AWSã€Google Cloud ä¹Ÿéƒ½ä¼šæä¾›å­˜å‚¨æ’ä»¶ç”¨äºæ¥å…¥å®ƒä»¬çš„å­˜å‚¨æœåŠ¡
å­˜å‚¨æ’ä»¶åˆ†ä¸º In..." />
    <meta name="keywords" content="Cloud Native,Kubernetes" />
    
      <link href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="app" class="main">

      <header class="header">
  <div class="banner animate__animated animate__fadeIn">
    <div class="top-container">
      <div class="site-title-container">
        <img src="https://xxxuuu.me/images/avatar.png?v=1723216798723" class="site-logo">
        <div class="site-text">
          <h1 class="site-title">
            xÂ³uÂ³
          </h1>
          <div class="site-description-social">
            <div class="site-description">
              ğŸ—’ ç¢ç¢å¿µ
            </div>
            <div class="site-social">
              
                
                  <a class="social-link" href="https://github.com/xxxuuu" target="_blank">
                    <i class="fa fa-github"></i>
                  </a>
                
              
                
              
                
              
                
              
                
              
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="links">
      
        
            <a href="/" class="site-nav">
              ğŸ  é¦–é¡µ
            </a>
          
        
        
            <a href="/archives" class="site-nav">
              ğŸ“ƒ å½’æ¡£
            </a>
          
        
        
            <a href="/tags" class="site-nav">
              ğŸ· æ ‡ç­¾
            </a>
          
        
        
            <a href="/post/about" class="site-nav">
              ğŸ‘¤ å…³äº
            </a>
          
        
        
            <a href="/post/friend-links/" class="site-nav">
              ğŸ‘¬ å‹é“¾
            </a>
          
        
    </div>
  </div>
</header>

      <div class="main-container">
        <div class="content-container animate__animated animate__fadeInUp">
          <div class="post-detail">
            <h2 class="post-title">Kubernetes CSI</h2>
            <div class="post-date">2023-06-17&emsp;&emsp;1348 å­— &emsp;é˜…è¯»æ—¶é—´ 6 åˆ†é’Ÿ</div>
            
            <div class="post-content" v-pre>
              <h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h2>
<p>K8s çš„å­˜å‚¨æ’ä»¶ç”¨äºå¯¹æ¥å®¹å™¨å¹³å°å’Œåº•å±‚å­˜å‚¨èµ„æºï¼Œä¾‹å¦‚æŒ‚è½½ Volume æ—¶å¯ä»¥é…ç½®çš„ nfs æˆ– gitRepo ç­‰ï¼›ç¬¬ä¸‰æ–¹å¹³å°ï¼Œå¦‚ AWSã€Google Cloud ä¹Ÿéƒ½ä¼šæä¾›å­˜å‚¨æ’ä»¶ç”¨äºæ¥å…¥å®ƒä»¬çš„å­˜å‚¨æœåŠ¡</p>
<p>å­˜å‚¨æ’ä»¶åˆ†ä¸º In-Tree å’Œ Out-of-Tree ä¸¤ç±»ï¼š</p>
<ol>
<li>In-Tree çš„å­˜å‚¨æ’ä»¶æ˜¯åŒ…å«åœ¨ K8s å†…éƒ¨çš„ï¼Œå› æ­¤æ„å»ºã€ç¼–è¯‘ã€äº¤ä»˜éƒ½ä¸ Kuberentes æœ¬èº«ç»‘å®šï¼Œå‰é¢çš„ nfs å’Œ gitRepo éƒ½æ˜¯ In-Tree çš„æ’ä»¶</li>
<li>Out-of-Tree æ’ä»¶åˆ™æ˜¯ç‹¬ç«‹çš„ï¼Œå¯ä»¥å•ç‹¬éƒ¨ç½²ã€‚Out-of-Tree æ’ä»¶ä¸»è¦åˆ†ä¸º FlexVolume å’Œ CSIï¼ˆContainer Storage Interfaceï¼‰ä¸¤ç±»æ–¹å¼ï¼Œå…¶ä¸­å‰è€…åœ¨ 1.23 ç‰ˆæœ¬å·²ç»åºŸå¼ƒ</li>
</ol>
<p>ä» 1.17 ç‰ˆæœ¬å¼€å§‹ï¼ŒK8s å¼€å§‹æµ‹è¯• CSI Migrationï¼Œç”¨äºå°† In-Tree å†…çš„å­˜å‚¨æ’ä»¶è¿ç§»åˆ° Out-of-Tree çš„ CSI ä¸Šï¼Œå¹¶<a href="https://kubernetes.io/blog/2022/09/26/storage-in-tree-to-csi-migration-status-update-1.25/">åœ¨ 1.25 ä¸­æ­£å¼å‘å¸ƒ</a>è¯¥åŠŸèƒ½</p>
<p>å› æ­¤ï¼Œå­˜å‚¨æ’ä»¶çš„å¼€å‘ç›®å‰åŸºæœ¬åªå‰©ä¸‹ CSI ä¸€ç§é€‰æ‹©ï¼Œå…¶ä¸ä»…ä»…å±€é™äº K8sï¼Œæ›´æ˜¯ç›®å‰å®¹å™¨å­˜å‚¨çš„å·¥ä¸šæ ‡å‡†</p>
<h2 id="csi-æ¶æ„-è§„èŒƒ">CSI æ¶æ„ &amp; è§„èŒƒ</h2>
<p>CSI Driver åœ¨ K8s ä¸­çš„æ¶æ„å¦‚ä¸‹æ‰€ç¤º<br>
<img alt="CSI Architecture" src="https://global.discourse-cdn.com/business6/uploads/kubernetes/original/2X/1/11e56624b12ec6f3c181a59fbd34e492ad9ae342.png"></p>
<p>CSI Driver ä¼šä½œä¸º Pod è¿è¡Œåœ¨ K8s ä¸­ï¼Œé€šè¿‡ç›‘å¬èµ„æºï¼ˆPVCã€PV ç­‰ï¼‰äº‹ä»¶è§¦å‘å¯¹åº•å±‚å­˜å‚¨èµ„æºçš„æ“ä½œï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œæ˜¯ kubelet é€šè¿‡ UDSï¼ˆUnix Domain Socketï¼‰è°ƒç”¨ CSI Driver è¿›è¡Œ</p>
<p>ç›‘å¬èµ„æºå˜æ›´è¿™éƒ¨åˆ†éƒ½æ˜¯é€šç”¨é€»è¾‘ï¼Œå®ç°é‡å¤åº¦æ¯”è¾ƒé«˜ï¼Œå› æ­¤ Kubernetes Team æä¾›äº†ä¸€ç³»åˆ— Sidecar æ¥å®Œæˆï¼ˆä¸Šå›¾ç²‰è‰²éƒ¨åˆ†ï¼‰ï¼Œä»¥ç®€åŒ–å¼€å‘ï¼ŒåŒæ—¶è§£è€¦ä¸ K8s API çš„äº¤äº’å®ç°ï¼š<a href="https://kubernetes-csi.github.io/docs/sidecar-containers.html">CSI Sidecar Containers</a></p>
<p>é‚£ä¹ˆæˆ‘ä»¬è¦å®ç°çš„ CSI Driver æœ€åå¯ä»¥åˆ†ä¸ºä¸‰ä¸ª gRPC æœåŠ¡ï¼ˆä¸Šå›¾ç»¿è‰²éƒ¨åˆ†ï¼‰ï¼š</p>
<ol>
<li>Identity Serviceï¼šç”¨äºæš´éœ²æ’ä»¶æœ¬èº«çš„ä¿¡æ¯å’Œè¿›è¡Œå¥åº·æ£€æŸ¥</li>
<li>Controller Serviceï¼šæ“ä½œåº•å±‚å­˜å‚¨èµ„æºï¼Œå¯¹å­˜å‚¨å·è¿›è¡Œç®¡ç†</li>
<li>Node Serviceï¼šæ‰§è¡Œå’Œå®¿ä¸»æœºç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚ mount ç­‰</li>
</ol>
<p>CSI è§„èŒƒæ–‡æ¡£ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç‚¹ï¼š</p>
<ol>
<li>é¦–å…ˆï¼ŒCSI æ¥å£<strong>å¿…é¡»ä¿è¯å¹‚ç­‰æ€§</strong>ã€‚è™½ç„¶ K8s ä¿è¯åœ¨åœ¨ç»™å®šæ—¶é—´å†…å¯¹æ¯ä¸ªå·ã€Œæ­£åœ¨è¿›è¡Œã€çš„è°ƒç”¨ä¸è¶…è¿‡ä¸€ä¸ªï¼Œä½†å½“å‘ç”Ÿ failover æ—¶ï¼Œè¿™ä¸ªä¿è¯å¯èƒ½å°±ä¼šå¤±æ•ˆï¼Œå¯¼è‡´è¯¸å¦‚é‡å¤åˆ›å»ºåŒä¸€ä¸ªå·çš„æƒ…å†µå‘ç”Ÿï¼Œå› æ­¤ CSI ä¾§å¿…é¡»å®ç°å¹‚ç­‰æ€§ï¼Œä»¥é˜²æ­¢å­˜å‚¨å·æ³„éœ²</li>
<li>è§„èŒƒè¿”å›å€¼ï¼ŒCSI çš„ gRPC æ¥å£<strong>å¿…é¡»è¿”å›æ ‡å‡†é”™è¯¯ç </strong>ï¼Œä»¥ä¾¿ K8s æ­£ç¡®å“åº”ï¼Œè¿™éƒ¨åˆ†åœ¨<a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">æ ‡å‡†æ–‡æ¡£</a>çš„ Error Scheme éƒ¨åˆ†å¯ä»¥çœ‹åˆ°</li>
</ol>
<p>æœ€åéƒ¨ç½²æ—¶ä¸€èˆ¬åˆ†ä¸º Node Plugin å’Œ Controller Plugin è¿›è¡Œéƒ¨ç½²ï¼š</p>
<ol>
<li>å‰è€…éœ€è¦å®ç° Identity Service å’Œ Node Serviceï¼Œä»¥ DaemonSet æ–¹å¼è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Š</li>
<li>åè€…éœ€è¦å®ç° Identity Service å’Œ Controller Serviceï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œï¼Œé€šå¸¸æ˜¯ä¸ª Deployment æˆ– StatefulSet</li>
</ol>
<p>ä¸€ä¸ªå·çš„ç”Ÿå‘½å‘¨æœŸå¦‚ä¸‹æ‰€ç¤º</p>
<pre><code>   CreateVolume +------------+ DeleteVolume
 +-------------&gt;|  CREATED   +--------------+
 |              +---+----^---+              |
 |       Controller |    | Controller       v
+++         Publish |    | Unpublish       +++
|X|          Volume |    | Volume          | |
+-+             +---v----+---+             +-+
                | NODE_READY |
                +---+----^---+
               Node |    | Node
              Stage |    | Unstage
             Volume |    | Volume
                +---v----+---+
                |  VOL_READY |
                +---+----^---+
               Node |    | Node
            Publish |    | Unpublish
             Volume |    | Volume
                +---v----+---+
                | PUBLISHED  |
                +------------+
</code></pre>
<p>ä¾‹å¦‚ï¼Œå½“åˆ›å»ºä¸€ä¸ªä½¿ç”¨ PVC çš„ Pod æ—¶ï¼š</p>
<ol>
<li>Volume Controller ç›‘å¬åˆ° PVC åˆ›å»ºï¼Œä½†å…¶åªè´Ÿè´£ In-Tree æ¨¡å¼çš„ç®¡ç†ï¼Œè·³è¿‡æ‰§è¡Œ</li>
<li>Sidecar ç›‘å¬åˆ° PVC åˆ›å»ºï¼Œ<strong>è°ƒç”¨ CSI Controller Service çš„ <code>CreateVolume</code></strong>ï¼ŒCSI Driver è¿™æ—¶ä¼šåˆ›å»ºåº•å±‚å­˜å‚¨èµ„æºã€‚ä¹‹åå·å¤„äº CREATED çŠ¶æ€ï¼ŒPV è¢«åˆ›å»ºï¼Œå¹¶ç»‘å®šåˆ° PVC ä¸Š</li>
<li>Volume Controller åˆ›å»º VolumeAttachment èµ„æºï¼Œè¡¨ç¤ºéœ€è¦å°† PV æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Š</li>
<li>Sidecar ç›‘å¬åˆ° VolumeAttachment åˆ›å»ºï¼Œ<strong>è°ƒç”¨ CSI Controller Service çš„ <code>ControllerPublishVolume</code></strong>ã€‚CSI Driver è¿™æ—¶ä¸€èˆ¬ä¼šå°†åº•å±‚å­˜å‚¨èµ„æºä¸ç›®æ ‡èŠ‚ç‚¹å…³è”èµ·æ¥ï¼Œä¹‹åå·å¤„äº NODE_READY çŠ¶æ€ï¼Œå¯¹äº Node å¯è§</li>
<li>kubelet æ„ŸçŸ¥åˆ°å·çš„å­˜åœ¨ï¼Œæ‰§è¡Œ MountDevice æ“ä½œï¼Œ<strong>è°ƒç”¨ CSI Node Service çš„ <code>NodeStageVolume</code></strong>ã€‚CSI Driver æ­¤æ—¶ä¼šåˆå§‹åŒ–å·ï¼Œä¾‹å¦‚è¿›è¡Œåˆ†åŒºå’Œæ ¼å¼åŒ–ã€åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿç­‰ï¼Œä¹‹åå·å¤„äº VOL_READY çŠ¶æ€</li>
<li>æœ€å kubelet æ‰§è¡Œ Setup æ“ä½œï¼Œ<strong>è°ƒç”¨ CSI Node Service çš„ <code>NodePublishVolume</code></strong>ã€‚CSI Driver å°†å·æŒ‚è½½åˆ°å®¹å™¨ï¼ˆkubelet æŒ‡å®šçš„ Volume ç›®å½•ï¼‰å†…ï¼Œå·è¿›å…¥ PUBLISHED çŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨</li>
</ol>
<h2 id="éƒ¨ç½²">éƒ¨ç½²</h2>
<p>å‰é¢æåˆ°ï¼ŒCSI Driver æ˜¯ä»¥ Pod è¿è¡Œåœ¨ K8s å†…çš„ï¼Œå› æ­¤æœ¬è´¨ä¸Šå°±æ˜¯æ‹‰ Pod è¿è¡Œå³å¯ã€‚ä½† CSI éƒ¨ç½²æ—¶ä¹Ÿåˆ†ä¸º Controller Plugin å’Œ Node Pluginï¼Œä¸”å¯èƒ½æ¶‰åŠç›¸å…³å­˜å‚¨åº•å±‚é…ç½®ï¼Œè¦å‡çº§æ—¶ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤ä¸€èˆ¬ä¼šé€šè¿‡ Helm è¿›è¡Œéƒ¨ç½²ï¼š<br>
<a href="https://helm.sh/zh/docs/topics/charts/">Chart Development Guide</a></p>
<h2 id="æµ‹è¯•">æµ‹è¯•</h2>
<p>kubernetes-csi/csi-test ä»“åº“ä¸‹æä¾›äº†ä¸€äº›æµ‹è¯•å·¥å…·<br>
<a href="https://github.com/kubernetes-csi/csi-test">kubernetes-csi/csi-test: CSI test frameworks</a></p>
<p>é¦–å…ˆ csi-test é‡Œçš„ <code>pkg/sanity</code> åŒ…å¯ä»¥å¸®åŠ©è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå…¶è¿˜æä¾›äº†ä¸€ä¸ª CLI ç¨‹åº csi-sanity å¯ä»¥ç”¨äºæ£€æµ‹ API æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œä½†å…¶æ²¡æ³•å¾ˆå¥½çš„è¿›è¡Œ API å’Œ E2Eï¼ˆEnd-to-Endï¼Œç«¯åˆ°ç«¯ï¼‰ æµ‹è¯•</p>
<p>API æµ‹è¯•è¦æ‰‹åŠ¨è¿›è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼ŒCSI Driver åªæ˜¯æä¾›å‡ ä¸ª gRPC æ¥å£ï¼Œæ‰€ä»¥æ¥å£æµ‹è¯•æ—¶ä½¿ç”¨ grpcurl ç­‰ gRPC è°ƒè¯•å·¥å…·å³å¯ï¼Œä½† cscï¼ˆContainer Storage Clientï¼‰ç­‰å·¥å…·ä¹Ÿæä¾›äº†æ›´ä¾¿åˆ©çš„åŒ…è£…ï¼š</p>
<ul>
<li><a href="https://github.com/rexray/gocsi/tree/master/csc">gocsi/csc at master Â· rexray/gocsi</a></li>
<li><a href="https://github.com/kubernetes/cloud-provider-openstack/blob/master/docs/cinder-csi-plugin/csc-tool.md#list-volumes">cloud-provider-openstack/docs/cinder-csi-plugin/csc-tool.md at master Â· kubernetes/cloud-provider-openstack</a></li>
</ul>
<p>E2E æµ‹è¯•å¯ä»¥é€šè¿‡ kubectl æ‰‹åŠ¨è¿›è¡Œï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº›å¥—ä»¶ç”¨äºè¿›è¡Œè‡ªåŠ¨åŒ–çš„ E2E æµ‹è¯•ï¼š<br>
<a href="https://github.com/kubernetes/kubernetes/tree/master/test/e2e/storage/external">kubernetes/test/e2e/storage/external at master Â· kubernetes/kubernetes</a></p>
<p>E2E æµ‹è¯•è¿™éƒ¨åˆ†ï¼Œä¹‹åæœ‰ç©ºæ‰“ç®—å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è®²ä¸€ä¸‹</p>
<h2 id="ç›¸å…³èµ„æ–™">ç›¸å…³èµ„æ–™</h2>
<ul>
<li><a href="https://kubernetes-csi.github.io/docs/introduction.html">Kubernetes CSI Developer Documentation</a></li>
<li><a href="https://github.com/kubernetes/design-proposals-archive/blob/main/storage/container-storage-interface.md">Container Storage Interface Proposal</a></li>
<li><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">Container Storage Interface Specification</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/51757577">åŸºäº CSI çš„ Kubernetes å­˜å‚¨æ’ä»¶å¼€å‘å®è·µ ï½œ QingCloud</a></li>
<li><a href="https://cloudnative.to/blog/develop-a-csi-driver/">CSI é©±åŠ¨å¼€å‘æŒ‡å— ï½œäº‘åŸç”Ÿç¤¾åŒºï¼ˆä¸­å›½ï¼‰</a></li>
</ul>

            </div>

            <div class="not-by-ai">
              <img src="/media/images/not-by-ai-cn.svg"/>
              <img src="/media/images/not-by-ai-jp.svg"/>
              <img src="/media/images/not-by-ai-en.svg"/>
            </div>

            
              <div class="tag-container">
                
                  <a href="https://xxxuuu.me/tag/7-RPfhUxG/" class="tag">
                    Cloud Native
                  </a>
                
                  <a href="https://xxxuuu.me/tag/p_N_ZYPje/" class="tag">
                    Kubernetes
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://xxxuuu.me/post/2022summary/">
                  <h3 class="post-title">
                    2022 å¹´åº¦æ€»ç»“
                  </h3>
                </a>
              </div>
            

            
            
              <div id="giscus" class="giscus">
                <script src="https://giscus.app/client.js" data-repo="xxxuuu/xxxuuu.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg=" data-category="Announcements"  data-category-id="DIC_kwDOCwLAgM4ChgWc" data-mapping="title"  data-strict="0"  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script>
              </div>
            
          </div>

          

<div class="post-toc animate__animated animate__fadeInUp">
  <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">åŸºæœ¬æ¦‚å¿µ</a></li>
<li><a href="#csi-%E6%9E%B6%E6%9E%84-%E8%A7%84%E8%8C%83">CSI æ¶æ„ &amp; è§„èŒƒ</a></li>
<li><a href="#%E9%83%A8%E7%BD%B2">éƒ¨ç½²</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">æµ‹è¯•</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99">ç›¸å…³èµ„æ–™</a></li>
</ul>
</li>
</ul>

</div>


<script>
  let lastTop = 0, linkList = [], headList = [], postBody, lastIndex = -1;
  let activeClass = 'active-toc';
  let tocContent;

  function addActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.remove(activeClass);
    }
  }

  function getElementTop (el) {
    let actualTop = el.offsetTop
    let current = el.offsetParent
    while (current !== null) {
      actualTop += current.offsetTop
      current = current.offsetParent
    }
    return actualTop
  }

  function syncActiveClass() {
    if (linkList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop;
    let eps = window.innerHeight;

    let current = 0, closestOffset = 0x3f3f3f3f, hasFind = false;
    for (let i = 0; i < headList.length; i++) {
      let offset = Math.abs(getElementTop(headList[i]) - scrollTop);
      if (offset > eps) {
        continue;
      }
      if (offset < closestOffset) {
        current = i;
        closestOffset = offset;
        hasFind = true;
      }
    }
    if(!hasFind) {
      return;
    }

    removeActiveClass(lastIndex)
    addActiveClass(current);
    lastIndex = current;
  }

  document.addEventListener('scroll', syncActiveClass);
  window.addEventListener('load', function () {
    tocContent = document.querySelector('.markdownIt-TOC');
    if (!tocContent) return;

    postBody = document.querySelector('.post-content');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        headList.push(postBody.children[i]);
      }
    }
    linkList = document.querySelectorAll('.post-toc a');

    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })
</script>

        </div>
      </div>

      <footer class="footer animate__animated animate__flipInX">
  <div class="site-footer">
    <p></p>
    <p>Â© xÂ³uÂ³ Â· Powered by <a href="https://gridea.dev/">Gridea</a> & <a href="https://github.com/xxxuuu/gridea-theme-autumn">Autumn</a> | <a class="rss" href="https://xxxuuu.me/atom.xml" target="_blank">RSS</a></p>
  </div>
</footer>


    </div>

    <script type="application/javascript">

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
  <script>
    window.onload = () => {
        hljs.highlightAll()
    }
  </script>


<script>
  const images = document.querySelectorAll('.post-content img');

  for (let i = 0; i < images.length; i++) {
    const img = images[i];

    const link = document.createElement('a');
    link.href = img.src;
    link.setAttribute("data-fancybox", "gallery");

    img.parentNode.insertBefore(link, img);
    link.appendChild(img);
  }
</script>




  </body>
</html>
