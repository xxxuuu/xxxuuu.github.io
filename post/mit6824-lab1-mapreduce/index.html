<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>MIT6.824 Lab1 MapReduce | xÂ³uÂ³</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<link rel="shortcut icon" href="https://xxxuuu.me/favicon.ico?v=1723216798723">
<link rel="stylesheet" href="https://xxxuuu.me/styles/main.css">



<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">
<style>
:root {
  --animate-duration: 800ms;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.9/dist/vue.min.js"></script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-T8WGT1LJ6G"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T8WGT1LJ6G');
</script>


    <meta name="description" content="Lab åœ°å€ï¼š6.824 Lab 1: MapReduce
è®ºæ–‡ï¼šMapReduce: Simplified Data Processing on Large Clusters
ä¸€ä¸ªä¸­æ–‡ç¿»è¯‘ï¼šMapReduceï¼šåœ¨å¤§å‹é›†ç¾¤ä¸Šç®€åŒ–æ•°æ®å¤„ç†

..." />
    <meta name="keywords" content="åˆ†å¸ƒå¼ç³»ç»Ÿ" />
    
      <link href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="app" class="main">

      <header class="header">
  <div class="banner animate__animated animate__fadeIn">
    <div class="top-container">
      <div class="site-title-container">
        <img src="https://xxxuuu.me/images/avatar.png?v=1723216798723" class="site-logo">
        <div class="site-text">
          <h1 class="site-title">
            xÂ³uÂ³
          </h1>
          <div class="site-description-social">
            <div class="site-description">
              ğŸ—’ ç¢ç¢å¿µ
            </div>
            <div class="site-social">
              
                
                  <a class="social-link" href="https://github.com/xxxuuu" target="_blank">
                    <i class="fa fa-github"></i>
                  </a>
                
              
                
              
                
              
                
              
                
              
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="links">
      
        
            <a href="/" class="site-nav">
              ğŸ  é¦–é¡µ
            </a>
          
        
        
            <a href="/archives" class="site-nav">
              ğŸ“ƒ å½’æ¡£
            </a>
          
        
        
            <a href="/tags" class="site-nav">
              ğŸ· æ ‡ç­¾
            </a>
          
        
        
            <a href="/post/about" class="site-nav">
              ğŸ‘¤ å…³äº
            </a>
          
        
        
            <a href="/post/friend-links/" class="site-nav">
              ğŸ‘¬ å‹é“¾
            </a>
          
        
    </div>
  </div>
</header>

      <div class="main-container">
        <div class="content-container animate__animated animate__fadeInUp">
          <div class="post-detail">
            <h2 class="post-title">MIT6.824 Lab1 MapReduce</h2>
            <div class="post-date">2022-02-12&emsp;&emsp;3842 å­— &emsp;é˜…è¯»æ—¶é—´ 18 åˆ†é’Ÿ</div>
            
            <div class="post-content" v-pre>
              <p>Lab åœ°å€ï¼š<a href="http://nil.csail.mit.edu/6.824/2020/labs/lab-mr.html">6.824 Lab 1: MapReduce</a></p>
<p>è®ºæ–‡ï¼š<a href="http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf">MapReduce: Simplified Data Processing on Large Clusters</a></p>
<p>ä¸€ä¸ªä¸­æ–‡ç¿»è¯‘ï¼š<a href="https://zhuanlan.zhihu.com/p/122571315">MapReduceï¼šåœ¨å¤§å‹é›†ç¾¤ä¸Šç®€åŒ–æ•°æ®å¤„ç†</a></p>
<br/>
<br/>
<p>MIT6.824 çš„ç¬¬ä¸€èŠ‚è¯¾è¦åšçš„ Lab å°±æ˜¯å¤§åé¼é¼çš„ Google åˆ†å¸ƒå¼ç³»ç»Ÿä¸‰é©¾é©¬è½¦ä¹‹ä¸€çš„ MapReduceï¼ˆå¦å¤–ä¸¤ä¸ªæ˜¯ GFS å’Œ BigTableï¼‰ï¼Œè¯¾ç¨‹éœ€è¦æˆ‘ä»¬é˜…è¯» MapReduce çš„è®ºæ–‡åå®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ MapReduce Framework</p>
<br/>
<br/>
<p>é¦–å…ˆåº”è¯¥å…ˆçœ‹è®ºæ–‡ï¼Œå† <code>clone</code> é¡¹ç›®ï¼Œçœ‹çœ‹æ¶‰åŠ Lab1 éƒ¨åˆ†çš„ç»“æ„ï¼Œå¼„æ¸…æ¥šè¦åŸºäºä»€ä¹ˆå»å®Œæˆå®éªŒ</p>
<p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œåº”è¯¥çœ‹æˆ‘ä»¬å°†è¦å®ç°çš„ä¸œè¥¿èƒ½ç»™ Client æä¾›æ€æ ·çš„æŠ½è±¡ã€‚é¦–å…ˆ <code>/mrapps</code> ä¸­çš„å°±æ˜¯ä½¿ç”¨ MapReduce åº“çš„ Clientsï¼Œä¾‹å¦‚ Getting started ä¸­çš„ <code>/mrapps/wc.go</code> æ˜¯è¿›è¡Œè¯é¢‘ç»Ÿè®¡çš„ï¼ŒMapReduce åº“éœ€è¦ç”¨æˆ·å®ç° Map å’Œ Reduce ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<pre><code class="language-go">func Map(filename string, contents string) []mr.KeyValue {}
func Reduce(key string, values []string) string {}
</code></pre>
<p>å®ƒä»¬çš„è¯­ä¹‰å’Œè®ºæ–‡ä¸­çš„ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œåœ¨ <code>Map</code> ä¸­æ²¡æœ‰è®ºæ–‡ä¸­çš„ <code>Emit</code> æ“ä½œï¼Œè€Œæ˜¯è¦æ±‚ç”¨æˆ·è¿”å›ä¸€ä¸ª key-value åˆ—è¡¨ï¼Œåˆ—è¡¨çš„æ¯ä¸€é¡¹å°±ç›¸å½“äºä¸€ä¸ª <code>Emit</code> çš„ key-value å¯¹</p>
<p>æœ€åå°† Client é€šè¿‡ <code>go build -buildmode=plugin xxx.go</code>  ç¼–è¯‘ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼Œå¯åŠ¨ä¸€ä¸ª MapReduce Job æ—¶å’Œè¾“å…¥æ–‡ä»¶ä¸€èµ·ä½œä¸ºå‚æ•°ä¼ å…¥</p>
<br/>
<p>å®éªŒæä¾›äº†ä¸€ä¸ªç®€å•çš„é¡ºåºå•æœº MapReduce å®ç°åœ¨ <code>mrsequential.go</code> å†…ï¼Œå¯ä»¥çœ‹ä¸‹å®ƒçš„å®ç°ï¼Œæœ‰åŠ©äºç†è§£æ‰§è¡Œè¿‡ç¨‹ã€‚å…¶é¦–å…ˆåŠ è½½äº†è¢«ç¼–è¯‘ä¸ºåŠ¨æ€é“¾æ¥åº“çš„ç”¨æˆ·ä»£ç ï¼š</p>
<pre><code class="language-go">func loadPlugin(filename string) (func(string, string) []mr.KeyValue, func(string, []string) string) {
	p, err := plugin.Open(filename)
	if err != nil {
		log.Fatalf(&quot;cannot load plugin %v&quot;, filename)
	}
	xmapf, err := p.Lookup(&quot;Map&quot;)
	if err != nil {
		log.Fatalf(&quot;cannot find Map in %v&quot;, filename)
	}
	mapf := xmapf.(func(string, string) []mr.KeyValue)
	xreducef, err := p.Lookup(&quot;Reduce&quot;)
	if err != nil {
		log.Fatalf(&quot;cannot find Reduce in %v&quot;, filename)
	}
	reducef := xreducef.(func(string, []string) string)

	return mapf, reducef
}
</code></pre>
<p>ç„¶ååŠ è½½è¾“å…¥æ–‡ä»¶ä¼ é€’ç»™ç”¨æˆ·ä»£ç çš„ <code>Map</code> æ‰§è¡Œï¼Œå°†æ‰§è¡Œçš„ä¸­é—´ç»“æœå­˜å‚¨èµ·æ¥</p>
<pre><code class="language-go">intermediate := []mr.KeyValue{}
for _, filename := range os.Args[2:] {
	file, err := os.Open(filename)
	if err != nil {
		log.Fatalf(&quot;cannot open %v&quot;, filename)
	}
	content, err := ioutil.ReadAll(file)
	if err != nil {
		log.Fatalf(&quot;cannot read %v&quot;, filename)
	}
	file.Close()
	kva := mapf(filename, string(content))
	intermediate = append(intermediate, kva...)
}
</code></pre>
<p><code>Map</code> æ‰§è¡Œå®Œåå¯¹ä¸­é—´ç»“æœæ’åº</p>
<pre><code class="language-go">sort.Sort(ByKey(intermediate))
</code></pre>
<p>æœ€åè°ƒç”¨ <code>Reduce</code> å¹¶å†™å…¥ç»“æœæ–‡ä»¶</p>
<pre><code class="language-go">i := 0
for i &lt; len(intermediate) {
	j := i + 1
	for j &lt; len(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key {
		j++
	}
	values := []string{}
	for k := i; k &lt; j; k++ {
		values = append(values, intermediate[k].Value)
	}
	output := reducef(intermediate[i].Key, values)

	// this is the correct format for each line of Reduce output.
	fmt.Fprintf(ofile, &quot;%v %v\n&quot;, intermediate[i].Key, output)

	i = j
}
</code></pre>
<p>æ€»ä½“æµç¨‹åŸºæœ¬å¯¹åº”è®ºæ–‡çš„å›¾ 1 çš„å„ä¸ªé˜¶æ®µï¼Œåªä¸è¿‡æ˜¯å•æœºé¡ºåºå®ç°ï¼Œæ²¡æœ‰è°ƒåº¦å’Œç½‘ç»œéƒ¨åˆ†</p>
<figure data-type="image" tabindex="1"><img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/mr-1.png" alt="mr-1" loading="lazy"></figure>
<br/>
<p>ç„¶åæˆ‘ä»¬éœ€è¦å®ç°è‡ªå·±çš„ MapReduce åº“åœ¨ <code>mr/master.go</code>ï¼Œ<code>mr/worker.go</code>ï¼Œ<code>mr/rpc.go</code>  ä¸‰ä¸ªæ–‡ä»¶ä¸­ï¼Œé‡Œé¢å·²ç»æœ‰ä¸€äº›å®šä¹‰å¥½çš„æ–¹æ³•ã€‚è¦å®ç°ä¸€äº›ç»†èŠ‚å’Œè¦æ³¨æ„çš„ç‚¹åŒ…æ‹¬ï¼š</p>
<ol>
<li>
<p>ä¸€ä¸ª Masterï¼Œä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼Œé€šè¿‡ RPC é€šä¿¡ã€‚åœ¨å¼€å§‹ä¸€ä¸ª MapReduce Job æ—¶ï¼Œé€šå¸¸å…ˆå¯åŠ¨ Masterï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼ˆé€šè¿‡ <code>main/mrmaster.go</code> å’Œ <code>main/mrworker.go</code>ï¼‰</p>
</li>
<li>
<p>å®¹é”™æœºåˆ¶ï¼ŒåŒ…æ‹¬ Workerã€Master å®•æœºçš„å¤„ç†</p>
<p>Master çš„å®•æœºå¯ä»¥å’Œè®ºæ–‡ä¸€æ ·ï¼Œäº¤ç»™å®¢æˆ·ç«¯é‡è¯•ï¼Œä¸åŒä¹‹å¤„æ˜¯è®ºæ–‡ä¸­æŒä¹…åŒ–äº† checkpoint ä½¿å¾— Master åœ¨å®•æœºæ¢å¤åå¯ä»¥æ¢å¤ä»»åŠ¡è¿›åº¦ï¼Œä½† Lab ä¸­æ²¡æœ‰è¦æ±‚æˆ‘ä»¬å®ç°ï¼›å¯¹äº Workerï¼Œå¦‚æœæ‰§è¡Œä»»åŠ¡è¶…æ—¶ï¼Œåˆ™ Master å°†è®¤ä¸ºå®ƒå®•æœºæˆ–æ‰§è¡Œç¼“æ…¢ï¼Œæ­¤æ—¶é‡æ–°åˆ†é…ä»»åŠ¡åˆ°å¦ä¸€ä¸ª Worker</p>
<p>å¦ä¸€æ–¹é¢ï¼Œåº”è¯¥ç¡®ä¿å®•æœºæ—¶ä¸ä¼šå‡ºç°æ–‡ä»¶éƒ¨åˆ†å†™å…¥çš„æƒ…å†µï¼Œä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨æ–‡ä»¶å†™å…¥åé‡å‘½åï¼ˆå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå®ç°ä¸­ï¼Œé‡å‘½åæ˜¯åŸå­æ“ä½œï¼‰</p>
</li>
<li>
<p>åŒè®ºæ–‡ä¸€æ ·ï¼Œ<code>Map</code> çš„è¾“å‡ºï¼ˆä¸­é—´ç»“æœï¼‰ä¹Ÿåº”è¯¥å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååˆ’åˆ†æˆå¤šä¸ª bucketï¼Œè¿™ä¿è¯ç›¸åŒ key éƒ½åœ¨åŒä¸€æ–‡ä»¶ä¸­ï¼Œèƒ½åœ¨åŒä¸€ Worker é‡Œè¢«æ‰“åŒ…åˆ° <code>Reduce</code> æ‰§è¡Œï¼Œè¿™ä¸ªåˆ†åŒºæ•°é‡å¯ä»¥é€šè¿‡å¯åŠ¨ Master æ—¶çš„å‚æ•°æŒ‡å®š</p>
</li>
<li>
<p>æ¯ä¸ª <code>Reduce</code> çš„ç»“æœè¾“å‡ºåˆ°å•ç‹¬çš„æ–‡ä»¶ä¸Š</p>
</li>
<li>
<p>Master åº”è¯¥å®ç° <code>Done</code> ä»¥æ˜ç¡®åœ°å‘ŠçŸ¥å®¢æˆ·ç«¯ MapReduce æ˜¯å¦æ‰§è¡Œå®Œæ¯•</p>
</li>
<li>
<p>ç»“æŸååº”è¯¥æ­£ç¡®åœ°å›æ”¶æ¯ä¸ª Worker è¿›ç¨‹</p>
</li>
</ol>
<br/>
<p>å‚è€ƒè®ºæ–‡ç¬¬ 3 èŠ‚ï¼Œæ‹ä¸€ä¸‹æˆ‘ä»¬çš„æµç¨‹ï¼š</p>
<ol>
<li>é¦–å…ˆå¯åŠ¨ Masterï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼ŒWorker å¯åŠ¨æ—¶å‘ Master è·å–ä»»åŠ¡</li>
<li>Master ä¸º Worker åˆ†é…ä»»åŠ¡åï¼Œè¦ç›‘è§†å…¶æ˜¯å¦å®Œæˆæˆ–è¶…æ—¶ï¼Œè¶…æ—¶åå°†ä»»åŠ¡åˆ†é…ç»™å…¶ä»– Workerã€‚ä»»åŠ¡ä¸€å¼€å§‹åªåº”è¯¥åˆ†é… <code>Map</code> ï¼Œæ‰€æœ‰ <code>Map</code> æ‰§è¡Œå®Œæˆåæ‰åˆ†é… <code>Reduce</code></li>
<li>å½“ Worker å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œç»§ç»­è·å–ä»»åŠ¡</li>
<li><code>Map</code> ä¸­ï¼ŒMaster éœ€è¦ä¼ é€’ç»™ Worker è¾“å…¥æ–‡ä»¶çš„ä½ç½®ï¼ŒWorker æ‰§è¡Œ <code>Map</code> å®Œåå†™å…¥ä¸­é—´ç»“æœåˆ°æœ¬åœ°å¹¶è¿›è¡Œåˆ†åŒºï¼Œç„¶åè¿”å›ä½ç½®ç»™ Master</li>
<li>Master éœ€è¦ç­‰å¾… <code>Map</code> éƒ½æ‰§è¡Œå®Œæ¯•æ‰åˆ†é… <code>Reduce</code>ï¼Œä¸º Worker åˆ†é… <code>Reduce</code> æ—¶è¦ä¼ é€’åŒä¸€åˆ†åŒºçš„ä¸­é—´ç»“æœæ–‡ä»¶çš„ä½ç½®ï¼ŒWorker è¯»å–æ–‡ä»¶å¹¶è¿›è¡Œæ’åºä»¥å°†ç›¸åŒçš„ key æ’åˆ°ä¸€èµ·ï¼Œç„¶åå°†ç›¸åŒçš„ key å¯¹åº”çš„ value é›†åˆä¼ å…¥ <code>Reduce</code> å‡½æ•°ä¸­</li>
<li>æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œåï¼ŒMaster å‘ŠçŸ¥å®¢æˆ·ç«¯ä»¥ç»“æŸå¯¹ MapReduce çš„è°ƒç”¨</li>
</ol>
<p><br/><br/></p>
<p>é€»è¾‘éƒ½æ¸…æ¥šåå°±å¯ä»¥å¼€å§‹å®ç°äº†ï¼ŒMaster ä½œä¸ºæœ€é‡è¦çš„èŠ‚ç‚¹ï¼Œå…¶å­˜å‚¨äº†å¤§å¤šæ•°å¿…è¦çš„æ•°æ®ï¼Œå¦‚è®ºæ–‡ 3.2 èŠ‚æ‰€ç¤ºï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/mr-2.png" alt="mr-2" loading="lazy"></figure>
<p>å¤§è‡´åˆ†ä¸ºï¼š</p>
<ol>
<li><code>Map</code> å’Œ <code>Reduce</code> ä»»åŠ¡çš„çŠ¶æ€</li>
<li>Worker èŠ‚ç‚¹ä¿¡æ¯</li>
<li>è¾“å…¥å’Œä¸­é—´æ–‡ä»¶çš„ä½ç½®</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å­˜å‚¨ Worker èŠ‚ç‚¹ä¿¡æ¯ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ Worker å‘ Master æ‹‰ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ Master æ¨ä»»åŠ¡ç»™ Workerï¼ŒMaster å¯ä»¥ä¸ç”¨çŸ¥é“ Worker çš„å…·ä½“æƒ…å†µã€‚åªå­˜å‚¨ä»»åŠ¡çŠ¶æ€å’Œæ–‡ä»¶ä½ç½®å³å¯ï¼ŒMaster çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">// taskState ä»»åŠ¡çŠ¶æ€
type taskState int

const (
	// IDLE ç©ºé—²
	IDLE taskState = iota
	// IN_PROGRESS è¿è¡Œä¸­
	IN_PROGRESS
	// COMPLETED å®Œæˆ
	COMPLETED
)

type Master struct {
	// æ¯ä¸ªä»»åŠ¡çš„è¾“å…¥æ–‡ä»¶åˆ—è¡¨
	files map[TaskType][][]string
	// ä»»åŠ¡çŠ¶æ€
	tasks map[TaskType]map[int]taskState
	// ç©ºé—²ä»»åŠ¡
	idleTasks map[TaskType]map[int]struct{}
	// å®Œæˆçš„ä»»åŠ¡æ•°é‡
	cnt map[TaskType]int
	// reduceåˆ†åŒºæ•°
	nReduce int
	// ä¿®æ”¹ä»»åŠ¡çŠ¶æ€çš„äº’æ–¥é”
	lock sync.Mutex
	// å“åº”å®¢æˆ·ç«¯æ˜¯å¦å®Œæˆ
	finish chan struct{}
}
</code></pre>
<p><code>TaskType</code> è¦åœ¨ RPC ä¸­ä¼ è¾“ï¼Œå®šä¹‰åœ¨ <code>mr/rpc.go</code> ä¸­ï¼Œå¤šäº†ä¸€ä¸ª <code>None</code> ç”¨ä»¥è¡¨ç¤ºå½“å‰æ— ä»»åŠ¡å¯åˆ†é…çš„æƒ…å†µï¼š</p>
<pre><code class="language-go">type TaskType int

const (
	None TaskType = iota
	Map
	Reduce
)
</code></pre>
<p>å®¢æˆ·ç«¯ï¼ˆ<code>main/mrmaster.go</code>ï¼‰ä¼šè°ƒç”¨ <code>MakeMaster</code> åˆå§‹åŒ– Master å¹¶å¯åŠ¨ Master çš„ RPC æœåŠ¡å™¨ï¼Œåˆå§‹åŒ–æ—¶æŠŠè¾“å…¥æ–‡ä»¶åˆ—è¡¨æ·»åŠ åˆ° <code>Map</code> ä»»åŠ¡ä¸­å¹¶æ ‡è®°ä¸ºç©ºé—²ï¼š</p>
<pre><code class="language-go">func MakeMaster(files []string, nReduce int) *Master {
	t1 := map[TaskType]map[int]taskState{
		Map:    {},
		Reduce: {},
	}
	t2 := map[TaskType]map[int]struct{}{
		Map:    {},
		Reduce: {},
	}

	f := map[TaskType][][]string{
		Map:    {},
		Reduce: make([][]string, nReduce),
	}
	for i := range files {
		t1[Map][i] = IDLE
		t2[Map][i] = struct{}{}
		f[Map] = append(f[Map], []string{files[i]})
	}

	m := Master{
		f,
		t1,
		t2,
		make(map[TaskType]int),
		nReduce,
		sync.Mutex{},
		make(chan struct{}),
	}

	m.server()
	return &amp;m
}
</code></pre>
<br/>
<p>Master ä¸­åº”è¯¥ç»™ Worker æä¾›ä¸‰ç§ RPC æ¥å£ï¼š</p>
<ul>
<li>å¿ƒè·³æ¥å£ï¼Œä¾› Worker åˆ¤æ–­ Master æ˜¯å¦æ´»ç€</li>
<li>è·å–ä»»åŠ¡æ¥å£ï¼ŒWorker ä»è¿™ä¸ªæ¥å£è·å–æ–°ä»»åŠ¡ä»¥æ‰§è¡Œ</li>
<li>é€šçŸ¥ä»»åŠ¡å®Œæˆæ¥å£ï¼ŒWorker å®Œæˆä»»åŠ¡åé€šè¿‡è¯¥æ¥å£é€šçŸ¥ Master</li>
</ul>
<p>RPC è¿™é‡Œç”¨çš„æ˜¯ Go å†…ç½®çš„ <code>net/rpc</code>ï¼Œä¸€äº› RPC è¿‡ç¨‹ä¸­çš„æ•°æ®ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-go">type EmptyArgs struct{}

type Task struct {
	ID       int
	NReduce  int
	TaskType TaskType
	Files    []string
}

type FinishNotify struct {
	Err       error
	Task      Task
	Filenames []string
}
</code></pre>
<p><code>net/rpc</code> ä½¿ç”¨çš„ gob æ¥åºåˆ—åŒ–ï¼Œå®ƒä¸æ”¯æŒä¼ é€’ç©ºå€¼ï¼Œæ‰€ä»¥å®šä¹‰ä¸€ä¸ª <code>EmptyArgs</code> ç©ºç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œç©ºç»“æ„ä½“ä¸å ç”¨å®é™…å†…å­˜ï¼Œåœ¨ Master ä¸­çš„ç©ºé—²ä»»åŠ¡é˜Ÿåˆ—ä¸­ä¹Ÿä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•<br>
<code>Task</code> æ˜¯ Master è¿”å›ä»»åŠ¡ç»™ Worker æ—¶ä¼ é€’çš„ç±»å‹ï¼ŒåŒ…æ‹¬ä»»åŠ¡ IDï¼ŒReduce åˆ†åŒºæ•°ï¼Œä»»åŠ¡ç±»å‹ï¼ˆMap æˆ– Reduceï¼‰å’Œè¾“å…¥æ–‡ä»¶åˆ—è¡¨<br>
<code>FinishNotify</code> æ˜¯ Worker å®Œæˆä»»åŠ¡æ—¶å‘ Master é€šçŸ¥ä¼ é€’çš„ç±»å‹ï¼ŒåŒ…æ‹¬é”™è¯¯ä¿¡æ¯ï¼Œå®Œæˆçš„ä»»åŠ¡å†…å®¹æœ¬èº«ï¼Œè¾“å‡ºçš„æ–‡ä»¶åˆ—è¡¨</p>
<br/>
<p>ç„¶åæ˜¯ Master çš„ä¸‰ä¸ª RPC æ¥å£å®ç°ï¼š</p>
<p>å¿ƒè·³æ¥å£å®é™…ä¸Šä¸éœ€è¦è¿”å›ä»»ä½•æ•°æ®ï¼ŒRPC è°ƒç”¨åº•å±‚ä¼šçŸ¥é“æ˜¯å¦è°ƒç”¨æˆåŠŸï¼Œè¿™å°±å¤Ÿäº†</p>
<pre><code class="language-go">func (m *Master) Ping(args EmptyArgs, reply *EmptyArgs) error {
    return nil
}
</code></pre>
<p>è·å–ä»»åŠ¡æ¥å£ï¼Œå› ä¸ºéœ€è¦å¹¶å‘ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ï¼Œå¾—åŠ é”ã€‚ç„¶åç¡®å®šå¾…åˆ†é…çš„ä»»åŠ¡ç±»å‹ï¼Œ<code>Map</code> å…¨éƒ¨æ‰§è¡Œå®Œåæ‰æ‰§è¡Œ <code>Reduce</code>ï¼Œä»ç©ºé—²é˜Ÿåˆ—ä¸­å–å‡ºåï¼Œè¿”å›å³å¯ã€‚æœ€åæ–°å»ºäº†ä¸ª goroutine æ¥æ£€æŸ¥ä»»åŠ¡æƒ…å†µï¼Œå¦‚æœ 10 ç§’å†…æœªæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥è®¤ä¸º Worker å®•æœºæˆ–æ‰§è¡Œç¼“æ…¢ï¼Œé‡ç½®ä»»åŠ¡è¿›åº¦ç­‰å¾…ä¸‹æ¬¡åˆ†é…</p>
<pre><code class="language-go">func (m *Master) PullTask(args EmptyArgs, reply *Task) error {
    m.lock.Lock()
    defer m.lock.Unlock()

    taskType := Map
    // mapå…¨éƒ¨å®Œæˆæ‰åˆ†é…reduce
    if len(m.tasks[Map]) == m.cnt[Map] {
        taskType = Reduce
    }

    // æ— ç©ºé—²ä»»åŠ¡
    if len(m.idleTasks[taskType]) == 0 {
        reply.TaskType = None
        return nil
    }

    // ä»ç©ºé—²åŒºé‡Œé€‰ä¸€ä¸ª åˆ†é…ä»»åŠ¡
    var idx int
    for k := range m.idleTasks[taskType] {
        idx = k
        break
    }
    reply.TaskType = taskType
    reply.Files = m.files[taskType][idx]
    reply.ID = idx
    reply.NReduce = m.nReduce

    delete(m.idleTasks[taskType], idx)
    m.tasks[taskType][idx] = IN_PROGRESS

    // åˆ†é…åæ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    go func() {
        time.Sleep(time.Second * 10)
        m.lock.Lock()
        if m.tasks[taskType][idx] == IN_PROGRESS {
            m.tasks[taskType][idx] = IDLE
            m.idleTasks[taskType][idx] = struct{}{}
        }
        m.lock.Unlock()
    }()

    return nil
}
</code></pre>
<p>æœ€åä¸€ä¸ªé€šçŸ¥ä»»åŠ¡å®Œæˆæ¥å£ï¼Œå¦‚æœæˆåŠŸå®Œæˆï¼Œå°±è¿›è¡Œè®°å½•ï¼ŒåŒæ—¶å¦‚æœå®Œæˆçš„ä»»åŠ¡æ˜¯ <code>Map</code> çš„è¯ï¼Œè¦å°†å…¶è¾“å‡ºçš„ä¸­é—´ç»“æœä½œä¸º <code>Reduce</code> ä»»åŠ¡æ·»åŠ è¿›ä»»åŠ¡é˜Ÿåˆ—é‡Œã€‚æœ€åæ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ</p>
<pre><code class="language-go">func (m *Master) FinishTask(data FinishNotify, reply *EmptyArgs) error {
    m.lock.Lock()
    defer m.lock.Unlock()
    id := data.Task.ID

    // å·²ç»å®Œæˆ å¿½ç•¥
    if data.Task.TaskType == None || m.tasks[data.Task.TaskType][id] == COMPLETED {
        return nil
    }

    // å‘ç”Ÿé”™è¯¯ é‡ç½®ä»»åŠ¡çŠ¶æ€ ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦
    if data.Err != nil {
        log.Printf(&quot;%v\n&quot;, data.Err)
        m.tasks[data.Task.TaskType][id] = IDLE
        m.idleTasks[data.Task.TaskType][id] = struct{}{}
        return nil
    }

    // è®°å½•å®Œæˆ
    m.tasks[data.Task.TaskType][id] = COMPLETED
    m.cnt[data.Task.TaskType]++

    // Map ç»“æœåŠ åˆ°å¾…æ‰§è¡Œ Reduce é‡Œï¼ŒæŒ‰åˆ†åŒºåˆ’åˆ†
    if data.Task.TaskType == Map {
        for i := range data.Filenames {
            m.files[Reduce][i] = append(m.files[Reduce][i], data.Filenames[i])
            m.tasks[Reduce][i] = IDLE
            m.idleTasks[Reduce][i] = struct{}{}
        }
    }

    // å…¨éƒ¨å®Œæˆ Done() å¯ä»¥è¿”å›äº†
    if len(m.tasks[Map]) == m.cnt[Map] &amp;&amp;
        len(m.tasks[Reduce]) == m.cnt[Reduce] {
        log.Println(&quot;MapReduce ç»“æŸ&quot;)
        m.finish &lt;- struct{}{}
    }

    return nil
}
</code></pre>
<p>æœ€åå®Œæˆè¿™é‡Œæœ‰ä¸ª <code>finish</code> ï¼Œå®ƒçš„ä½œç”¨æ˜¯é€šçŸ¥ <code>Done</code> å¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯ä»»åŠ¡å·²å®Œæˆ</p>
<pre><code class="language-go">func (m *Master) Done() bool {
    &lt;-m.finish
    return true
}
</code></pre>
<p><br/><br/></p>
<p>Master çš„å®ç°åŸºæœ¬å®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯ Workerï¼ŒWorker ä¿¡æ¯çš„å®šä¹‰å¦‚ä¸‹ï¼Œå­˜å‚¨ <code>Map</code> å‡½æ•°ï¼Œ<code>Reduce</code> å‡½æ•°ï¼Œæ˜¯å¦å¯ä»¥é€€å‡ºå’Œæ¥æ”¶çš„ä»»åŠ¡é˜Ÿåˆ—ï¼š</p>
<pre><code class="language-go">type WorkerInfo struct {
	mapf    func(string, string) []KeyValue
	reducef func(string, []string) string
	exit    chan struct{}
	tasks   chan Task
}
</code></pre>
<p>å®¢æˆ·ç«¯ï¼ˆ<code>main/mrworker.go</code>ï¼‰ä¼šè°ƒç”¨ <code>Worker()</code> æ¥å¯åŠ¨ Workerï¼Œåœ¨å…¶ä¸­è¿›è¡Œæˆ‘ä»¬çš„åˆå§‹åŒ–</p>
<ul>
<li>é¦–å…ˆæ–°å»ºä¸€ä¸ª goroutine åœ¨åå°å¯¹ Master è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œè®¾å®šä¸­å½“ Master 10s å†…æœªå“åº”æ—¶ï¼ŒWorker å¯ä»¥è®¤ä¸º Master å·²ç»å…³é—­ï¼Œè‡ªèº«ä¾¿å¯ä»¥å…³é—­ã€‚Worker é€€å‡ºçš„å¦ä¸€ä¸ªè®¾è®¡æ€è·¯æ˜¯å¯ä»¥æ·»åŠ ä¸€ä¸ª <code>TaskType</code> è¡¨ç¤ºã€Œè¯·å…³é—­ã€ï¼ŒWorker æ¥æ”¶åˆ°è¯¥ä»»åŠ¡åå°±å¯ä»¥è‡ªè¡Œå…³é—­</li>
<li>ç„¶åæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­ä» Master å¤„è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå½“æ”¶åˆ°é€€å‡ºä¿¡å·æ—¶å°±é€€å‡º</li>
</ul>
<pre><code class="language-go">func Worker(mapf func(string, string) []KeyValue,
	reducef func(string, []string) string) {

	w := WorkerInfo{
		mapf,
		reducef,
		make(chan struct{}),
		make(chan Task, 1),
	}

	// Master 10ç§’æ²¡å“åº”å°±è®¤ä¸ºå®ƒå·²ç»å…³é—­ï¼Œ Workerå¯ä»¥é€€å‡º
	go func() {
		before := time.Now().UnixNano()
		TIMEOUT := time.Second.Nanoseconds() * 10
		for {
			if w.healthCheck() {
				before = time.Now().UnixNano()
			} else if time.Now().UnixNano()-before &gt;= TIMEOUT {
				log.Println(&quot;Master æ— å“åº”ï¼Œå¯ä»¥é€€å‡º&quot;)
				w.exit &lt;- struct{}{}
				return
			}
			time.Sleep(time.Second)
		}
	}()

	// è¶…æ—¶é€€å‡ºæˆ–ç­‰å¾…åˆ†é…æ–°ä»»åŠ¡
	for {
		select {
		case &lt;-w.exit:
			close(w.tasks)
			close(w.exit)
			return
		case t := &lt;-w.tasks:
			w.execTask(t)
		default:
			if ok, t := w.pullTask(); !ok {
				time.Sleep(time.Second)
			} else {
				w.tasks &lt;- t
			}
		}
	}
}
</code></pre>
<p>å…¶ä¸­ <code>healthCheck</code> å’Œ <code>pullTask</code> å®ç°å¦‚ä¸‹ï¼Œ<code>call</code> æ˜¯ Lab æœ¬èº«å·²ç»å®ç°å¥½çš„å¯¹ RPC è°ƒç”¨çš„å°è£…ï¼š</p>
<pre><code class="language-go">// å¥åº·æ£€æŸ¥
func (w *WorkerInfo) healthCheck() bool {
	return call(&quot;Master.Ping&quot;, EmptyArgs{}, &amp;EmptyArgs{})
}

// ä»Masterå¤„è·å–ä»»åŠ¡
func (w *WorkerInfo) pullTask() (bool, Task) {
	t := Task{}
	ok := call(&quot;Master.PullTask&quot;, EmptyArgs{}, &amp;t)
	if !ok || t.TaskType == None {
		return false, Task{}
	}
	return true, t
}
</code></pre>
<p>å½“æ¥æ”¶åˆ°ä»»åŠ¡æ—¶ï¼Œå°±è°ƒç”¨ <code>execTask</code> æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒæ ¹æ®ä»»åŠ¡ç±»å‹è°ƒç”¨ <code>execMap</code> æˆ– <code>execReduce</code> æ¥æ‰§è¡Œï¼Œæœ€åå¤„ç†æ‰§è¡Œç»“æœï¼Œé€šçŸ¥å› Master</p>
<pre><code class="language-go">func (w *WorkerInfo) execTask(t Task) {
	var notifyData FinishNotify
	notifyData.Task = t
	defer func() {
		err := recover()
		if err != nil {
			notifyData.Err = fmt.Errorf(&quot;%v&quot;, err)
		}

		// å‘ Master æŠ¥å‘Šæ‰§è¡Œå®Œæ¯•
		call(&quot;Master.FinishTask&quot;, notifyData, &amp;EmptyArgs{})
	}()

	log.Printf(&quot;æ‰§è¡Œä»»åŠ¡ %v\n&quot;, t)

	var fun func(task Task) ([]string, error)
	if t.TaskType == Map {
		fun = w.execMap
	} else if t.TaskType == Reduce {
		fun = w.execReduce
	} else {
		return
	}

	if outfile, err := fun(t); err != nil {
		notifyData.Err = err
	} else {
		notifyData.Filenames = outfile
	}
}
</code></pre>
<p><code>execMap</code> å†…é¦–å…ˆå¾ªç¯è¯»å…¥æ¯ä¸ªæ–‡ä»¶ï¼Œå°†å®ƒä»¬çš„å†…å®¹ä¼ é€’ç»™ç”¨æˆ·çš„ <code>Map</code> å‡½æ•°æ‰§è¡Œï¼Œç»“æœè¿½åŠ åˆ° key-value åˆ—è¡¨ä¸­ï¼Œç„¶ååˆ›å»ºæŒ‡å®šåˆ†åŒºæ•°é‡ï¼ˆ<code>NReduce</code>ï¼‰çš„ä¸´æ—¶æ–‡ä»¶ï¼Œé€šè¿‡ <code>ihash</code> æ¥ç¡®å®šæ¯ä¸ª key æ˜ å°„åˆ°å“ªä¸ªåˆ†åŒºä¸­ï¼Œåºåˆ—åŒ–æ•°æ®å†™å…¥åˆ°è¯¥åˆ†åŒºçš„ä¸´æ—¶æ–‡ä»¶ä¸Šã€‚æœ€åé€šè¿‡åŸå­é‡å‘½åæ¥ä¿è¯ä¸ä¼šå‡ºç°æ–‡ä»¶çš„éƒ¨åˆ†å†™å…¥</p>
<pre><code class="language-go">func (w *WorkerInfo) execMap(t Task) ([]string, error) {
	kva := []KeyValue{}
	for i := range t.Files {
		file, _ := os.Open(t.Files[i])
		defer file.Close()
		content, _ := ioutil.ReadAll(file)

		tmpKva := w.mapf(t.Files[i], string(content))
		kva = append(kva, tmpKva...)
	}

	// æ ¹æ® key åˆ†åˆ«å†™å…¥ä¸åŒæ–‡ä»¶
	tmpfiles := make([]*os.File, t.NReduce)

	for i := range tmpfiles {
		tmpfiles[i], _ = ioutil.TempFile(&quot;&quot;, &quot;*.tmp&quot;)
		defer tmpfiles[i].Close()
	}
	tmpData := make([][]KeyValue, t.NReduce)
	for i := range kva {
		idx := ihash(kva[i].Key) % t.NReduce
		tmpData[idx] = append(tmpData[idx], kva[i])
	}
	for i := range tmpData {
		buf := &amp;bytes.Buffer{}
		enc := gob.NewEncoder(buf)
		if err := enc.Encode(&amp;tmpData[i]); err != nil {
			os.Remove(tmpfiles[i].Name())
			return []string{}, errors.New(&quot;cannot serialize&quot;)
		}
		tmpfiles[i].Write(buf.Bytes())
	}

	// é€šè¿‡å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ å†é‡å‘½åæ¥ä¿è¯åŸå­æ€§
	// æ ¼å¼ mr-X-Y Xæ˜¯Mapä»»åŠ¡å· Yæ˜¯Reduceä»»åŠ¡å· å³ihash(X)
	res := make([]string, 0, t.NReduce)
	for i := range tmpfiles {
		name := fmt.Sprintf(&quot;./mr-%d-%d&quot;, t.ID, i)
		os.Rename(tmpfiles[i].Name(), name)
		res = append(res, name)
	}
	return res, nil
}

func ihash(key string) int {
	h := fnv.New32a()
	h.Write([]byte(key))
	return int(h.Sum32() &amp; 0x7fffffff)
}
</code></pre>
<p><code>execReduce</code> ç±»ä¼¼ï¼Œè¯»å…¥æ–‡ä»¶ï¼Œååºåˆ—åŒ–åŠ è½½åˆ° key-value åˆ—è¡¨ä¸­ï¼Œç„¶åæ’åºä»¥è®©ç›¸åŒ key æ’åœ¨ä¸€èµ·ï¼Œæ–‡ä»¶å¤§åˆ°ä¸è¶³ä»¥æ”¾å…¥å†…å­˜æ—¶åº”è¯¥é‡‡ç”¨å¤–éƒ¨æ’åºï¼Œä¸è¿‡ Lab ä¸­å¯ä»¥å‡å®šä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚ç„¶åå¯¹äºç›¸åŒçš„ keyï¼Œå°†å…¶ value çš„é›†åˆæ‰“åŒ…è°ƒç”¨ç”¨æˆ·çš„ <code>Reduce</code> å‡½æ•°ã€‚ç»“æœä¹Ÿæ˜¯ä¸€æ ·å†™å…¥ä¸´æ—¶æ–‡ä»¶å†åŸå­é‡å‘½å</p>
<pre><code class="language-go">func (w *WorkerInfo) execReduce(t Task) ([]string, error) {
	kva := []KeyValue{}
	for i := range t.Files {
		file, _ := os.Open(t.Files[i])
		defer file.Close()
		content, _ := ioutil.ReadAll(file)

		dec := gob.NewDecoder(bytes.NewBuffer(content))
		var tmpKva []KeyValue
		dec.Decode(&amp;tmpKva)
		kva = append(kva, tmpKva...)
	}

	// æ’åºkey æ‰“åŒ…è°ƒç”¨reduce
	sort.Slice(kva, func(i, j int) bool {
		return kva[i].Key &lt; kva[j].Key
	})

	ofile, _ := ioutil.TempFile(&quot;&quot;, &quot;*.tmp&quot;)
	defer ofile.Close()
	for i := 0; i &lt; len(kva); {
		j := i + 1
		for j &lt; len(kva) &amp;&amp; kva[j].Key == kva[i].Key {
			j++
		}
		values := []string{}
		for k := i; k &lt; j; k++ {
			values = append(values, kva[k].Value)
		}
		output := w.reducef(kva[i].Key, values)

		fmt.Fprintf(ofile, &quot;%v %v\n&quot;, kva[i].Key, output)

		i = j
	}
	oname := fmt.Sprintf(&quot;mr-out-%d&quot;, t.ID)
	os.Rename(ofile.Name(), oname)
	return []string{oname}, nil
}
</code></pre>
<p>Worker ä¹Ÿæå®šï¼Œæœ€åè°ƒç”¨ <code>main/test-mr.sh</code> è¿›è¡Œæµ‹è¯•ï¼Œå…¶ä¼šè¿è¡Œäº”ä¸ªæµ‹è¯•</p>
<ol>
<li>wc-testï¼šè¯é¢‘ç»Ÿè®¡åº”ç”¨æµ‹è¯•</li>
<li>indexer-testï¼šç´¢å¼•æ„å»ºåº”ç”¨æµ‹è¯•</li>
<li>map-parallelism-testï¼š <code>Map</code> å¹¶è¡Œæµ‹è¯•</li>
<li>reduce-parallelism-testï¼š <code>Reduce</code> å¹¶è¡Œæµ‹è¯•</li>
<li>crash-testï¼š å®•æœºæµ‹è¯•</li>
</ol>
<figure data-type="image" tabindex="3"><img src="https://gridea-blog.oss-cn-shenzhen.aliyuncs.com/post-resource/mr-3.png" alt="mr-3" loading="lazy"></figure>
<p>bingo</p>

            </div>

            <div class="not-by-ai">
              <img src="/media/images/not-by-ai-cn.svg"/>
              <img src="/media/images/not-by-ai-jp.svg"/>
              <img src="/media/images/not-by-ai-en.svg"/>
            </div>

            
              <div class="tag-container">
                
                  <a href="https://xxxuuu.me/tag/YnvyCKwsP/" class="tag">
                    åˆ†å¸ƒå¼ç³»ç»Ÿ
                  </a>
                
              </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://xxxuuu.me/post/2021summary/">
                  <h3 class="post-title">
                    è’Ÿè’»çš„2021å¹´åº¦æ€»ç»“
                  </h3>
                </a>
              </div>
            

            
            
              <div id="giscus" class="giscus">
                <script src="https://giscus.app/client.js" data-repo="xxxuuu/xxxuuu.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg=" data-category="Announcements"  data-category-id="DIC_kwDOCwLAgM4ChgWc" data-mapping="title"  data-strict="0"  data-reactions-enabled="1" data-emit-metadata="0" data-input-position="bottom" data-theme="preferred_color_scheme" data-lang="zh-CN" data-loading="lazy" crossorigin="anonymous" async></script>
              </div>
            
          </div>

          


<script>
  let lastTop = 0, linkList = [], headList = [], postBody, lastIndex = -1;
  let activeClass = 'active-toc';
  let tocContent;

  function addActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.add(activeClass);
    }
  }

  function removeActiveClass(index) {
    if (index >= 0 && index < linkList.length) {
      linkList[index].parentElement.classList.remove(activeClass);
    }
  }

  function getElementTop (el) {
    let actualTop = el.offsetTop
    let current = el.offsetParent
    while (current !== null) {
      actualTop += current.offsetTop
      current = current.offsetParent
    }
    return actualTop
  }

  function syncActiveClass() {
    if (linkList.length <= 0) {
      return;
    }
    let scrollTop = document.scrollingElement.scrollTop;
    let eps = window.innerHeight;

    let current = 0, closestOffset = 0x3f3f3f3f, hasFind = false;
    for (let i = 0; i < headList.length; i++) {
      let offset = Math.abs(getElementTop(headList[i]) - scrollTop);
      if (offset > eps) {
        continue;
      }
      if (offset < closestOffset) {
        current = i;
        closestOffset = offset;
        hasFind = true;
      }
    }
    if(!hasFind) {
      return;
    }

    removeActiveClass(lastIndex)
    addActiveClass(current);
    lastIndex = current;
  }

  document.addEventListener('scroll', syncActiveClass);
  window.addEventListener('load', function () {
    tocContent = document.querySelector('.markdownIt-TOC');
    if (!tocContent) return;

    postBody = document.querySelector('.post-content');
    for (let i = 0; i < postBody.children.length; i++) {
      if (postBody.children[i].__proto__ === HTMLHeadingElement.prototype) {
        headList.push(postBody.children[i]);
      }
    }
    linkList = document.querySelectorAll('.post-toc a');

    setTimeout(function () {
      if ("createEvent" in document) {
        let evt = document.createEvent("HTMLEvents");
        evt.initEvent("scroll", false, true);
        document.dispatchEvent(evt);
      }
      else {
        document.fireEvent("scroll");
      }
    }, 500)
  })
</script>

        </div>
      </div>

      <footer class="footer animate__animated animate__flipInX">
  <div class="site-footer">
    <p></p>
    <p>Â© xÂ³uÂ³ Â· Powered by <a href="https://gridea.dev/">Gridea</a> & <a href="https://github.com/xxxuuu/gridea-theme-autumn">Autumn</a> | <a class="rss" href="https://xxxuuu.me/atom.xml" target="_blank">RSS</a></p>
  </div>
</footer>


    </div>

    <script type="application/javascript">

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.4.0/build/highlight.min.js"></script>
  <script>
    window.onload = () => {
        hljs.highlightAll()
    }
  </script>


<script>
  const images = document.querySelectorAll('.post-content img');

  for (let i = 0; i < images.length; i++) {
    const img = images[i];

    const link = document.createElement('a');
    link.href = img.src;
    link.setAttribute("data-fancybox", "gallery");

    img.parentNode.insertBefore(link, img);
    link.appendChild(img);
  }
</script>




  </body>
</html>
