<!DOCTYPE html><html data-astro-cid-pjvcz6dw lang=zh-CN><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F49b4570c-b2f0-457b-81b7-b68e2693a471%2Favatar.png?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" rel=icon><link href=https://xxxuuu.me/post/mit6824-lab1-mapreduce/ rel=canonical><link href=/rss/feed.xml rel=alternate title=xÂ³uÂ³ type=application/rss+xml><link href=/sitemap-index.xml rel=sitemap><title>MIT6.824 Lab1 MapReduce | xÂ³uÂ³</title><meta content="ğŸ—’ ç¢ç¢å¿µ" name=description><meta content=website property=og:type><meta content=https://xxxuuu.me/post/mit6824-lab1-mapreduce/ property=og:url><meta content="MIT6.824 Lab1 MapReduce | xÂ³uÂ³" property=og:title><meta content="ğŸ—’ ç¢ç¢å¿µ" property=og:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" property=og:image><meta content=summary_large_image name=twitter:card><meta content=@xxuuu0 name=twitter:site><meta content="MIT6.824 Lab1 MapReduce | xÂ³uÂ³" name=twitter:title><meta content="ğŸ—’ ç¢ç¢å¿µ" name=twitter:description><meta content="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fa9af1d6b-f284-4734-ba06-990353cf3f84%2FElaina.jpg?table=collection&id=0bb2e606-8d0c-4f7c-aca9-70986e90c055" name=twitter:image><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href=https://cdn.jsdelivr.net/npm/photoswipe@5.4.3/dist/photoswipe.css rel=stylesheet></noscript><script>!function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");document.documentElement.classList.add(e)}()</script><link href=/_astro/katex.CVb4srxQ.css rel=stylesheet><link href=/_astro/_slug_.DXL8v6Xi.css rel=stylesheet><link href=/_astro/_slug_.BzJEnS8p.css rel=stylesheet><link href=/_astro/_slug_.DOIB7y8p.css rel=stylesheet><script src=/_astro/hoisted.B871fABB.js type=module></script></head><body data-astro-cid-pjvcz6dw><header class=notion-header data-astro-cid-4f4rmh32><div class=header-container data-astro-cid-4f4rmh32><div class=header-content data-astro-cid-4f4rmh32><div class=logo data-astro-cid-4f4rmh32><a href=/ class=logo-link data-astro-cid-4f4rmh32>xÂ³uÂ³</a></div><div class=header-actions data-astro-cid-4f4rmh32><nav class=nav data-astro-cid-4f4rmh32><a href=/ class=nav-link data-astro-cid-4f4rmh32>ğŸ  é¦–é¡µ </a><a href=/archive class=nav-link data-astro-cid-4f4rmh32>ğŸ“ƒ å½’æ¡£ </a><a href=/links class=nav-link data-astro-cid-4f4rmh32>ğŸ‘¬ å‹é“¾ </a><a href=https://p.xxxuuu.me class=nav-link data-astro-cid-4f4rmh32 rel="noopener noreferrer" target=_blank>ğŸ“· æ‘„å½± <span class=external-icon data-astro-cid-4f4rmh32>â†—</span> </a><a href=/about class=nav-link data-astro-cid-4f4rmh32>ğŸ‘¤ å…³äº</a></nav><button aria-label="Toggle theme" title=åˆ‡æ¢ä¸»é¢˜ data-astro-cid-44mn2ykx id=theme-toggle><svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=sun-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 data-astro-cid-44mn2ykx r=5></circle><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=1 y2=3></line><line data-astro-cid-44mn2ykx x1=12 x2=12 y1=21 y2=23></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line data-astro-cid-44mn2ykx x1=1 x2=3 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=21 x2=23 y1=12 y2=12></line><line data-astro-cid-44mn2ykx x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line data-astro-cid-44mn2ykx x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg> <svg fill=none viewBox="0 0 24 24" height=20 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=20 class=moon-icon data-astro-cid-44mn2ykx xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-44mn2ykx></path></svg></button></div></div></div></header><main class=notion-main data-astro-cid-pjvcz6dw><article class=content data-astro-cid-gbhzkc2y><div class=notion-page data-astro-cid-gbhzkc2y><div class=page-container data-astro-cid-gbhzkc2y><div class=page-main data-astro-cid-gbhzkc2y><header class=page-header data-astro-cid-gbhzkc2y><h1 class=page-title data-astro-cid-gbhzkc2y>MIT6.824 Lab1 MapReduce</h1></header><div class=page-meta data-astro-cid-gbhzkc2y><div class=meta-info data-astro-cid-gbhzkc2y><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>ğŸ“…</span> <time data-astro-cid-gbhzkc2y datetime=2022-02-12>2022å¹´02æœˆ12æ—¥</time> </span><span class=meta-item data-astro-cid-gbhzkc2y><span class=meta-icon data-astro-cid-gbhzkc2y>â±ï¸</span> <span data-astro-cid-gbhzkc2y>12 åˆ†é’Ÿé˜…è¯»</span></span></div><div class=meta-tags data-astro-cid-gbhzkc2y><span class=tags-icon data-astro-cid-gbhzkc2y>ğŸ·ï¸</span> <a href=/tag/åˆ†å¸ƒå¼ç³»ç»Ÿ class=tag-pill data-astro-cid-gbhzkc2y>åˆ†å¸ƒå¼ç³»ç»Ÿ</a></div></div><hr class=page-divider data-astro-cid-gbhzkc2y><div class=notion-content data-astro-cid-gbhzkc2y><p>Lab åœ°å€ï¼š<a href=http://nil.csail.mit.edu/6.824/2020/labs/lab-mr.html rel="noopener noreferrer" target=_blank>6.824 Lab 1: MapReduce</a></p><p>è®ºæ–‡ï¼š<a href=http://static.googleusercontent.com/media/research.google.com/zh-CN//archive/mapreduce-osdi04.pdf rel="noopener noreferrer" target=_blank>MapReduce: Simplified Data Processing on Large Clusters</a></p><p>ä¸€ä¸ªä¸­æ–‡ç¿»è¯‘ï¼š<a href=https://zhuanlan.zhihu.com/p/122571315 rel="noopener noreferrer" target=_blank>MapReduceï¼šåœ¨å¤§å‹é›†ç¾¤ä¸Šç®€åŒ–æ•°æ®å¤„ç†</a></p><p><br></p><p>MIT6.824 çš„ç¬¬ä¸€èŠ‚è¯¾è¦åšçš„ Lab å°±æ˜¯å¤§åé¼é¼çš„ Google åˆ†å¸ƒå¼ç³»ç»Ÿä¸‰é©¾é©¬è½¦ä¹‹ä¸€çš„ MapReduceï¼ˆå¦å¤–ä¸¤ä¸ªæ˜¯ GFS å’Œ BigTableï¼‰ï¼Œè¯¾ç¨‹éœ€è¦æˆ‘ä»¬é˜…è¯» MapReduce çš„è®ºæ–‡åå®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ MapReduce Framework</p><p><br></p><h2 id="">æ¦‚è§ˆ</h2><p>é¦–å…ˆåº”è¯¥å…ˆçœ‹è®ºæ–‡ï¼Œå†Â <code>clone</code>Â é¡¹ç›®ï¼Œçœ‹çœ‹æ¶‰åŠ Lab1 éƒ¨åˆ†çš„ç»“æ„ï¼Œå¼„æ¸…æ¥šè¦åŸºäºä»€ä¹ˆå»å®Œæˆå®éªŒ</p><p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œåº”è¯¥çœ‹æˆ‘ä»¬å°†è¦å®ç°çš„ä¸œè¥¿èƒ½ç»™ Client æä¾›æ€æ ·çš„æŠ½è±¡ã€‚é¦–å…ˆÂ <code>/mrapps</code>Â ä¸­çš„å°±æ˜¯ä½¿ç”¨ MapReduce åº“çš„ Clientsï¼Œä¾‹å¦‚ Getting started ä¸­çš„Â <code>/mrapps/wc.go</code>Â æ˜¯è¿›è¡Œè¯é¢‘ç»Ÿè®¡çš„ï¼ŒMapReduce åº“éœ€è¦ç”¨æˆ·å®ç° Map å’Œ Reduce ä¸¤ä¸ªå‡½æ•°ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func Map(filename string, contents string) []mr.KeyValue {}
func Reduce(key string, values []string) string {}</code></pre></div><p>å®ƒä»¬çš„è¯­ä¹‰å’Œè®ºæ–‡ä¸­çš„ä¸€è‡´ï¼Œä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œåœ¨Â <code>Map</code>Â ä¸­æ²¡æœ‰è®ºæ–‡ä¸­çš„Â <code>Emit</code>Â æ“ä½œï¼Œè€Œæ˜¯è¦æ±‚ç”¨æˆ·è¿”å›ä¸€ä¸ª key-value åˆ—è¡¨ï¼Œåˆ—è¡¨çš„æ¯ä¸€é¡¹å°±ç›¸å½“äºä¸€ä¸ªÂ <code>Emit</code>Â çš„ key-value å¯¹</p><p>æœ€åå°† Client é€šè¿‡Â <code>go build -buildmode=plugin xxx.go</code>Â ç¼–è¯‘ä¸ºåŠ¨æ€é“¾æ¥åº“ï¼Œå¯åŠ¨ä¸€ä¸ª MapReduce Job æ—¶å’Œè¾“å…¥æ–‡ä»¶ä¸€èµ·ä½œä¸ºå‚æ•°ä¼ å…¥</p><p><br></p><p>å®éªŒæä¾›äº†ä¸€ä¸ªç®€å•çš„é¡ºåºå•æœº MapReduce å®ç°åœ¨Â <code>mrsequential.go</code>Â å†…ï¼Œå¯ä»¥çœ‹ä¸‹å®ƒçš„å®ç°ï¼Œæœ‰åŠ©äºç†è§£æ‰§è¡Œè¿‡ç¨‹ã€‚å…¶é¦–å…ˆåŠ è½½äº†è¢«ç¼–è¯‘ä¸ºåŠ¨æ€é“¾æ¥åº“çš„ç”¨æˆ·ä»£ç ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func loadPlugin(filename string) (func(string, string) []mr.KeyValue, func(string, []string) string) {
	p, err := plugin.Open(filename)
	if err != nil {
		log.Fatalf(&quot;cannot load plugin %v&quot;, filename)
	}
	xmapf, err := p.Lookup(&quot;Map&quot;)
	if err != nil {
		log.Fatalf(&quot;cannot find Map in %v&quot;, filename)
	}
	mapf := xmapf.(func(string, string) []mr.KeyValue)
	xreducef, err := p.Lookup(&quot;Reduce&quot;)
	if err != nil {
		log.Fatalf(&quot;cannot find Reduce in %v&quot;, filename)
	}
	reducef := xreducef.(func(string, []string) string)

	return mapf, reducef
}</code></pre></div><p>ç„¶ååŠ è½½è¾“å…¥æ–‡ä»¶ä¼ é€’ç»™ç”¨æˆ·ä»£ç çš„Â <code>Map</code>Â æ‰§è¡Œï¼Œå°†æ‰§è¡Œçš„ä¸­é—´ç»“æœå­˜å‚¨èµ·æ¥</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>intermediate := []mr.KeyValue{}
for _, filename := range os.Args[2:] {
	file, err := os.Open(filename)
	if err != nil {
		log.Fatalf(&quot;cannot open %v&quot;, filename)
	}
	content, err := ioutil.ReadAll(file)
	if err != nil {
		log.Fatalf(&quot;cannot read %v&quot;, filename)
	}
	file.Close()
	kva := mapf(filename, string(content))
	intermediate = append(intermediate, kva...)
}</code></pre></div><p><code>Map</code>Â æ‰§è¡Œå®Œåå¯¹ä¸­é—´ç»“æœæ’åº</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>sort.Sort(ByKey(intermediate))</code></pre></div><p>æœ€åè°ƒç”¨Â <code>Reduce</code>Â å¹¶å†™å…¥ç»“æœæ–‡ä»¶</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>i := 0
for i &lt; len(intermediate) {
	j := i + 1
	for j &lt; len(intermediate) &amp;&amp; intermediate[j].Key == intermediate[i].Key {
		j++
	}
	values := []string{}
	for k := i; k &lt; j; k++ {
		values = append(values, intermediate[k].Value)
	}
	output := reducef(intermediate[i].Key, values)

	// this is the correct format for each line of Reduce output.
	fmt.Fprintf(ofile, &quot;%v %v\n&quot;, intermediate[i].Key, output)

	i = j
}</code></pre></div><p>æ€»ä½“æµç¨‹åŸºæœ¬å¯¹åº”è®ºæ–‡çš„å›¾ 1 çš„å„ä¸ªé˜¶æ®µï¼Œåªä¸è¿‡æ˜¯å•æœºé¡ºåºå®ç°ï¼Œæ²¡æœ‰è°ƒåº¦å’Œç½‘ç»œéƒ¨åˆ†</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F7a021825-09e3-46e4-9457-4d2b1d15cc2d%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045751Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3Da6e16bd3d0ef3ed19fd272861b8fd91ceafe21fc4d34c004bc7d0daeb25be6e0%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=2565347d-bb73-4d2c-99c1-d70328ce40a7" class=glightbox data-aspect-ratio=1.401198 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.401198><img alt=Image loading=lazy onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F7a021825-09e3-46e4-9457-4d2b1d15cc2d%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045751Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3Da6e16bd3d0ef3ed19fd272861b8fd91ceafe21fc4d34c004bc7d0daeb25be6e0%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=2565347d-bb73-4d2c-99c1-d70328ce40a7"/></a></figure><p><br></p><p>ç„¶åæˆ‘ä»¬éœ€è¦å®ç°è‡ªå·±çš„ MapReduce åº“åœ¨Â <code>mr/master.go</code>ï¼Œ<code>mr/worker.go</code>ï¼Œ<code>mr/rpc.go</code>Â ä¸‰ä¸ªæ–‡ä»¶ä¸­ï¼Œé‡Œé¢å·²ç»æœ‰ä¸€äº›å®šä¹‰å¥½çš„æ–¹æ³•ã€‚è¦å®ç°ä¸€äº›ç»†èŠ‚å’Œè¦æ³¨æ„çš„ç‚¹åŒ…æ‹¬ï¼š</p><ol><li>ä¸€ä¸ª Masterï¼Œä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼Œé€šè¿‡ RPC é€šä¿¡ã€‚åœ¨å¼€å§‹ä¸€ä¸ª MapReduce Job æ—¶ï¼Œé€šå¸¸å…ˆå¯åŠ¨ Masterï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼ˆé€šè¿‡Â <code>main/mrmaster.go</code>Â å’ŒÂ <code>main/mrworker.go</code>ï¼‰</li><li>å®¹é”™æœºåˆ¶ï¼ŒåŒ…æ‹¬ Workerã€Master å®•æœºçš„å¤„ç†<p>Master çš„å®•æœºå¯ä»¥å’Œè®ºæ–‡ä¸€æ ·ï¼Œäº¤ç»™å®¢æˆ·ç«¯é‡è¯•ï¼Œä¸åŒä¹‹å¤„æ˜¯è®ºæ–‡ä¸­æŒä¹…åŒ–äº† checkpoint ä½¿å¾— Master åœ¨å®•æœºæ¢å¤åå¯ä»¥æ¢å¤ä»»åŠ¡è¿›åº¦ï¼Œä½† Lab ä¸­æ²¡æœ‰è¦æ±‚æˆ‘ä»¬å®ç°ï¼›å¯¹äº Workerï¼Œå¦‚æœæ‰§è¡Œä»»åŠ¡è¶…æ—¶ï¼Œåˆ™ Master å°†è®¤ä¸ºå®ƒå®•æœºæˆ–æ‰§è¡Œç¼“æ…¢ï¼Œæ­¤æ—¶é‡æ–°åˆ†é…ä»»åŠ¡åˆ°å¦ä¸€ä¸ª Worker</p><p>å¦ä¸€æ–¹é¢ï¼Œåº”è¯¥ç¡®ä¿å®•æœºæ—¶ä¸ä¼šå‡ºç°æ–‡ä»¶éƒ¨åˆ†å†™å…¥çš„æƒ…å†µï¼Œä¸€ä¸ªæ–¹æ³•æ˜¯åœ¨æ–‡ä»¶å†™å…¥åé‡å‘½åï¼ˆå¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿå®ç°ä¸­ï¼Œé‡å‘½åæ˜¯åŸå­æ“ä½œï¼‰</p></li><li>åŒè®ºæ–‡ä¸€æ ·ï¼Œ<code>Map</code>Â çš„è¾“å‡ºï¼ˆä¸­é—´ç»“æœï¼‰ä¹Ÿåº”è¯¥å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œç„¶ååˆ’åˆ†æˆå¤šä¸ª bucketï¼Œè¿™ä¿è¯ç›¸åŒ key éƒ½åœ¨åŒä¸€æ–‡ä»¶ä¸­ï¼Œèƒ½åœ¨åŒä¸€ Worker é‡Œè¢«æ‰“åŒ…åˆ°Â <code>Reduce</code>Â æ‰§è¡Œï¼Œè¿™ä¸ªåˆ†åŒºæ•°é‡å¯ä»¥é€šè¿‡å¯åŠ¨ Master æ—¶çš„å‚æ•°æŒ‡å®š</li><li>æ¯ä¸ªÂ <code>Reduce</code>Â çš„ç»“æœè¾“å‡ºåˆ°å•ç‹¬çš„æ–‡ä»¶ä¸Š</li><li>Master åº”è¯¥å®ç°Â <code>Done</code>Â ä»¥æ˜ç¡®åœ°å‘ŠçŸ¥å®¢æˆ·ç«¯ MapReduce æ˜¯å¦æ‰§è¡Œå®Œæ¯•</li><li>ç»“æŸååº”è¯¥æ­£ç¡®åœ°å›æ”¶æ¯ä¸ª Worker è¿›ç¨‹</li></ol><p><br></p><p>å‚è€ƒè®ºæ–‡ç¬¬ 3 èŠ‚ï¼Œæ‹ä¸€ä¸‹æˆ‘ä»¬çš„æµç¨‹ï¼š</p><ol><li>é¦–å…ˆå¯åŠ¨ Masterï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªæˆ–å¤šä¸ª Workerï¼ŒWorker å¯åŠ¨æ—¶å‘ Master è·å–ä»»åŠ¡</li><li>Master ä¸º Worker åˆ†é…ä»»åŠ¡åï¼Œè¦ç›‘è§†å…¶æ˜¯å¦å®Œæˆæˆ–è¶…æ—¶ï¼Œè¶…æ—¶åå°†ä»»åŠ¡åˆ†é…ç»™å…¶ä»– Workerã€‚ä»»åŠ¡ä¸€å¼€å§‹åªåº”è¯¥åˆ†é…Â <code>Map</code>Â ï¼Œæ‰€æœ‰Â <code>Map</code>Â æ‰§è¡Œå®Œæˆåæ‰åˆ†é…Â <code>Reduce</code></li><li>å½“ Worker å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œç»§ç»­è·å–ä»»åŠ¡</li><li><code>Map</code>Â ä¸­ï¼ŒMaster éœ€è¦ä¼ é€’ç»™ Worker è¾“å…¥æ–‡ä»¶çš„ä½ç½®ï¼ŒWorker æ‰§è¡ŒÂ <code>Map</code>Â å®Œåå†™å…¥ä¸­é—´ç»“æœåˆ°æœ¬åœ°å¹¶è¿›è¡Œåˆ†åŒºï¼Œç„¶åè¿”å›ä½ç½®ç»™ Master</li><li>Master éœ€è¦ç­‰å¾…Â <code>Map</code>Â éƒ½æ‰§è¡Œå®Œæ¯•æ‰åˆ†é…Â <code>Reduce</code>ï¼Œä¸º Worker åˆ†é…Â <code>Reduce</code>Â æ—¶è¦ä¼ é€’åŒä¸€åˆ†åŒºçš„ä¸­é—´ç»“æœæ–‡ä»¶çš„ä½ç½®ï¼ŒWorker è¯»å–æ–‡ä»¶å¹¶è¿›è¡Œæ’åºä»¥å°†ç›¸åŒçš„ key æ’åˆ°ä¸€èµ·ï¼Œç„¶åå°†ç›¸åŒçš„ key å¯¹åº”çš„ value é›†åˆä¼ å…¥Â <code>Reduce</code>Â å‡½æ•°ä¸­</li><li>æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œåï¼ŒMaster å‘ŠçŸ¥å®¢æˆ·ç«¯ä»¥ç»“æŸå¯¹ MapReduce çš„è°ƒç”¨</li></ol><p><br></p><h2 id="">æ•°æ®ç»“æ„</h2><p>é€»è¾‘éƒ½æ¸…æ¥šåå°±å¯ä»¥å¼€å§‹å®ç°äº†ï¼ŒMaster ä½œä¸ºæœ€é‡è¦çš„èŠ‚ç‚¹ï¼Œå…¶å­˜å‚¨äº†å¤§å¤šæ•°å¿…è¦çš„æ•°æ®ï¼Œå¦‚è®ºæ–‡ 3.2 èŠ‚æ‰€ç¤ºï¼š</p><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F6f81b6ca-ec49-42b7-b22b-b6671ced1a54%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045752Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3D92f14e58a6e98d9aca2483abaa6017c1bb3bf592e2c2ed59683eec13ef417024%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=21c028d7-9092-41b9-9f1a-2c11f56c5076" class=glightbox data-aspect-ratio=1.341549 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.341549><img alt=Image loading=lazy onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F6f81b6ca-ec49-42b7-b22b-b6671ced1a54%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045752Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3D92f14e58a6e98d9aca2483abaa6017c1bb3bf592e2c2ed59683eec13ef417024%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=21c028d7-9092-41b9-9f1a-2c11f56c5076"/></a></figure><p>å¤§è‡´åˆ†ä¸ºï¼š</p><ol><li><code>Map</code>Â å’ŒÂ <code>Reduce</code>Â ä»»åŠ¡çš„çŠ¶æ€</li><li>Worker èŠ‚ç‚¹ä¿¡æ¯</li><li>è¾“å…¥å’Œä¸­é—´æ–‡ä»¶çš„ä½ç½®</li></ol><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸éœ€è¦å­˜å‚¨ Worker èŠ‚ç‚¹ä¿¡æ¯ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ Worker å‘ Master æ‹‰ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ Master æ¨ä»»åŠ¡ç»™ Workerï¼ŒMaster å¯ä»¥ä¸ç”¨çŸ¥é“ Worker çš„å…·ä½“æƒ…å†µã€‚åªå­˜å‚¨ä»»åŠ¡çŠ¶æ€å’Œæ–‡ä»¶ä½ç½®å³å¯ï¼ŒMaster çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>// taskState ä»»åŠ¡çŠ¶æ€
type taskState int

const (
	// IDLE ç©ºé—²
	IDLE taskState = iota
	// IN_PROGRESS è¿è¡Œä¸­
	IN_PROGRESS
	// COMPLETED å®Œæˆ
	COMPLETED
)

type Master struct {
	// æ¯ä¸ªä»»åŠ¡çš„è¾“å…¥æ–‡ä»¶åˆ—è¡¨
	files map[TaskType][][]string
	// ä»»åŠ¡çŠ¶æ€
	tasks map[TaskType]map[int]taskState
	// ç©ºé—²ä»»åŠ¡
	idleTasks map[TaskType]map[int]struct{}
	// å®Œæˆçš„ä»»åŠ¡æ•°é‡
	cnt map[TaskType]int
	// reduceåˆ†åŒºæ•°
	nReduce int
	// ä¿®æ”¹ä»»åŠ¡çŠ¶æ€çš„äº’æ–¥é”
	lock sync.Mutex
	// å“åº”å®¢æˆ·ç«¯æ˜¯å¦å®Œæˆ
	finish chan struct{}
}</code></pre></div><p><code>TaskType</code>Â è¦åœ¨ RPC ä¸­ä¼ è¾“ï¼Œå®šä¹‰åœ¨Â <code>mr/rpc.go</code>Â ä¸­ï¼Œå¤šäº†ä¸€ä¸ªÂ <code>None</code>Â ç”¨ä»¥è¡¨ç¤ºå½“å‰æ— ä»»åŠ¡å¯åˆ†é…çš„æƒ…å†µï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>type TaskType int

const (
	None TaskType = iota
	Map
	Reduce
)</code></pre></div><p>å®¢æˆ·ç«¯ï¼ˆ<code>main/mrmaster.go</code>ï¼‰ä¼šè°ƒç”¨Â <code>MakeMaster</code>Â åˆå§‹åŒ– Master å¹¶å¯åŠ¨ Master çš„ RPC æœåŠ¡å™¨ï¼Œåˆå§‹åŒ–æ—¶æŠŠè¾“å…¥æ–‡ä»¶åˆ—è¡¨æ·»åŠ åˆ°Â <code>Map</code>Â ä»»åŠ¡ä¸­å¹¶æ ‡è®°ä¸ºç©ºé—²ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func MakeMaster(files []string, nReduce int) *Master {
	t1 := map[TaskType]map[int]taskState{
		Map:    {},
		Reduce: {},
	}
	t2 := map[TaskType]map[int]struct{}{
		Map:    {},
		Reduce: {},
	}

	f := map[TaskType][][]string{
		Map:    {},
		Reduce: make([][]string, nReduce),
	}
	for i := range files {
		t1[Map][i] = IDLE
		t2[Map][i] = struct{}{}
		f[Map] = append(f[Map], []string{files[i]})
	}

	m := Master{
		f,
		t1,
		t2,
		make(map[TaskType]int),
		nReduce,
		sync.Mutex{},
		make(chan struct{}),
	}

	m.server()
	return &amp;m
}</code></pre></div><p><br></p><p>Master ä¸­åº”è¯¥ç»™ Worker æä¾›ä¸‰ç§ RPC æ¥å£ï¼š</p><ul><li>å¿ƒè·³æ¥å£ï¼Œä¾› Worker åˆ¤æ–­ Master æ˜¯å¦æ´»ç€</li><li>è·å–ä»»åŠ¡æ¥å£ï¼ŒWorker ä»è¿™ä¸ªæ¥å£è·å–æ–°ä»»åŠ¡ä»¥æ‰§è¡Œ</li><li>é€šçŸ¥ä»»åŠ¡å®Œæˆæ¥å£ï¼ŒWorker å®Œæˆä»»åŠ¡åé€šè¿‡è¯¥æ¥å£é€šçŸ¥ Master</li></ul><p>RPC è¿™é‡Œç”¨çš„æ˜¯ Go å†…ç½®çš„Â <code>net/rpc</code>ï¼Œä¸€äº› RPC è¿‡ç¨‹ä¸­çš„æ•°æ®ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>type EmptyArgs struct{}

type Task struct {
	ID       int
	NReduce  int
	TaskType TaskType
	Files    []string
}

type FinishNotify struct {
	Err       error
	Task      Task
	Filenames []string
}</code></pre></div><p><code>net/rpc</code> ä½¿ç”¨çš„ gob æ¥åºåˆ—åŒ–ï¼Œå®ƒä¸æ”¯æŒä¼ é€’ç©ºå€¼ï¼Œæ‰€ä»¥å®šä¹‰ä¸€ä¸ª <code>EmptyArgs</code>ç©ºç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œç©ºç»“æ„ä½“ä¸å ç”¨å®é™…å†…å­˜ï¼Œåœ¨ Master ä¸­çš„ç©ºé—²ä»»åŠ¡é˜Ÿåˆ—ä¸­ä¹Ÿä½¿ç”¨äº†è¿™ä¸ªæ–¹æ³•</p><p><code>Task</code> æ˜¯ Master è¿”å›ä»»åŠ¡ç»™ Worker æ—¶ä¼ é€’çš„ç±»å‹ï¼ŒåŒ…æ‹¬ä»»åŠ¡ IDï¼ŒReduce åˆ†åŒºæ•°ï¼Œä»»åŠ¡ç±»å‹ï¼ˆMap æˆ– Reduceï¼‰å’Œè¾“å…¥æ–‡ä»¶åˆ—è¡¨ <code>FinishNotify</code> æ˜¯ Worker å®Œæˆä»»åŠ¡æ—¶å‘ Master é€šçŸ¥ä¼ é€’çš„ç±»å‹ï¼ŒåŒ…æ‹¬é”™è¯¯ä¿¡æ¯ï¼Œå®Œæˆçš„ä»»åŠ¡å†…å®¹æœ¬èº«ï¼Œè¾“å‡ºçš„æ–‡ä»¶åˆ—è¡¨</p><p><br></p><h2 id=master->Master å®ç°</h2><p>ç„¶åæ˜¯ Master çš„ä¸‰ä¸ª RPC æ¥å£å®ç°ï¼š</p><p>å¿ƒè·³æ¥å£å®é™…ä¸Šä¸éœ€è¦è¿”å›ä»»ä½•æ•°æ®ï¼ŒRPC è°ƒç”¨åº•å±‚ä¼šçŸ¥é“æ˜¯å¦è°ƒç”¨æˆåŠŸï¼Œè¿™å°±å¤Ÿäº†</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (m *Master) Ping(args EmptyArgs, reply *EmptyArgs) error {
    return nil
}</code></pre></div><p>è·å–ä»»åŠ¡æ¥å£ï¼Œå› ä¸ºéœ€è¦å¹¶å‘ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ï¼Œå¾—åŠ é”ã€‚ç„¶åç¡®å®šå¾…åˆ†é…çš„ä»»åŠ¡ç±»å‹ï¼Œ<code>Map</code>Â å…¨éƒ¨æ‰§è¡Œå®Œåæ‰æ‰§è¡ŒÂ <code>Reduce</code>ï¼Œä»ç©ºé—²é˜Ÿåˆ—ä¸­å–å‡ºåï¼Œè¿”å›å³å¯ã€‚æœ€åæ–°å»ºäº†ä¸ª goroutine æ¥æ£€æŸ¥ä»»åŠ¡æƒ…å†µï¼Œå¦‚æœ 10 ç§’å†…æœªæ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥è®¤ä¸º Worker å®•æœºæˆ–æ‰§è¡Œç¼“æ…¢ï¼Œé‡ç½®ä»»åŠ¡è¿›åº¦ç­‰å¾…ä¸‹æ¬¡åˆ†é…</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (m *Master) PullTask(args EmptyArgs, reply *Task) error {
    m.lock.Lock()
    defer m.lock.Unlock()

    taskType := Map
    // mapå…¨éƒ¨å®Œæˆæ‰åˆ†é…reduce
    if len(m.tasks[Map]) == m.cnt[Map] {
        taskType = Reduce
    }

    // æ— ç©ºé—²ä»»åŠ¡
    if len(m.idleTasks[taskType]) == 0 {
        reply.TaskType = None
        return nil
    }

    // ä»ç©ºé—²åŒºé‡Œé€‰ä¸€ä¸ª åˆ†é…ä»»åŠ¡
    var idx int
    for k := range m.idleTasks[taskType] {
        idx = k
        break
    }
    reply.TaskType = taskType
    reply.Files = m.files[taskType][idx]
    reply.ID = idx
    reply.NReduce = m.nReduce

    delete(m.idleTasks[taskType], idx)
    m.tasks[taskType][idx] = IN_PROGRESS

    // åˆ†é…åæ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    go func() {
        time.Sleep(time.Second * 10)
        m.lock.Lock()
        if m.tasks[taskType][idx] == IN_PROGRESS {
            m.tasks[taskType][idx] = IDLE
            m.idleTasks[taskType][idx] = struct{}{}
        }
        m.lock.Unlock()
    }()

    return nil
}</code></pre></div><p>æœ€åä¸€ä¸ªé€šçŸ¥ä»»åŠ¡å®Œæˆæ¥å£ï¼Œå¦‚æœæˆåŠŸå®Œæˆï¼Œå°±è¿›è¡Œè®°å½•ï¼ŒåŒæ—¶å¦‚æœå®Œæˆçš„ä»»åŠ¡æ˜¯Â <code>Map</code>Â çš„è¯ï¼Œè¦å°†å…¶è¾“å‡ºçš„ä¸­é—´ç»“æœä½œä¸ºÂ <code>Reduce</code>Â ä»»åŠ¡æ·»åŠ è¿›ä»»åŠ¡é˜Ÿåˆ—é‡Œã€‚æœ€åæ£€æŸ¥æ˜¯å¦æ‰€æœ‰ä»»åŠ¡éƒ½å·²å®Œæˆ</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (m *Master) FinishTask(data FinishNotify, reply *EmptyArgs) error {
    m.lock.Lock()
    defer m.lock.Unlock()
    id := data.Task.ID

    // å·²ç»å®Œæˆ å¿½ç•¥
    if data.Task.TaskType == None || m.tasks[data.Task.TaskType][id] == COMPLETED {
        return nil
    }

    // å‘ç”Ÿé”™è¯¯ é‡ç½®ä»»åŠ¡çŠ¶æ€ ç­‰å¾…ä¸‹æ¬¡è°ƒåº¦
    if data.Err != nil {
        log.Printf(&quot;%v\n&quot;, data.Err)
        m.tasks[data.Task.TaskType][id] = IDLE
        m.idleTasks[data.Task.TaskType][id] = struct{}{}
        return nil
    }

    // è®°å½•å®Œæˆ
    m.tasks[data.Task.TaskType][id] = COMPLETED
    m.cnt[data.Task.TaskType]++

    // Map ç»“æœåŠ åˆ°å¾…æ‰§è¡Œ Reduce é‡Œï¼ŒæŒ‰åˆ†åŒºåˆ’åˆ†
    if data.Task.TaskType == Map {
        for i := range data.Filenames {
            m.files[Reduce][i] = append(m.files[Reduce][i], data.Filenames[i])
            m.tasks[Reduce][i] = IDLE
            m.idleTasks[Reduce][i] = struct{}{}
        }
    }

    // å…¨éƒ¨å®Œæˆ Done() å¯ä»¥è¿”å›äº†
    if len(m.tasks[Map]) == m.cnt[Map] &amp;&amp;
        len(m.tasks[Reduce]) == m.cnt[Reduce] {
        log.Println(&quot;MapReduce ç»“æŸ&quot;)
        m.finish &lt;- struct{}{}
    }

    return nil
}</code></pre></div><p>æœ€åå®Œæˆè¿™é‡Œæœ‰ä¸ªÂ <code>finish</code>Â ï¼Œå®ƒçš„ä½œç”¨æ˜¯é€šçŸ¥Â <code>Done</code>Â å¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯ä»»åŠ¡å·²å®Œæˆ</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (m *Master) Done() bool {
    &lt;-m.finish
    return true
}</code></pre></div><p><br></p><h2 id=worker->Worker å®ç°</h2><p>Master çš„å®ç°åŸºæœ¬å®Œæˆï¼Œæ¥ä¸‹æ¥æ˜¯ Workerï¼ŒWorker ä¿¡æ¯çš„å®šä¹‰å¦‚ä¸‹ï¼Œå­˜å‚¨Â <code>Map</code>Â å‡½æ•°ï¼Œ<code>Reduce</code>Â å‡½æ•°ï¼Œæ˜¯å¦å¯ä»¥é€€å‡ºå’Œæ¥æ”¶çš„ä»»åŠ¡é˜Ÿåˆ—ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>type WorkerInfo struct {
	mapf    func(string, string) []KeyValue
	reducef func(string, []string) string
	exit    chan struct{}
	tasks   chan Task
}</code></pre></div><p>å®¢æˆ·ç«¯ï¼ˆ<code>main/mrworker.go</code>ï¼‰ä¼šè°ƒç”¨Â <code>Worker()</code>Â æ¥å¯åŠ¨ Workerï¼Œåœ¨å…¶ä¸­è¿›è¡Œæˆ‘ä»¬çš„åˆå§‹åŒ–</p><ul><li>é¦–å…ˆæ–°å»ºä¸€ä¸ª goroutine åœ¨åå°å¯¹ Master è¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œè®¾å®šä¸­å½“ Master 10s å†…æœªå“åº”æ—¶ï¼ŒWorker å¯ä»¥è®¤ä¸º Master å·²ç»å…³é—­ï¼Œè‡ªèº«ä¾¿å¯ä»¥å…³é—­ã€‚Worker é€€å‡ºçš„å¦ä¸€ä¸ªè®¾è®¡æ€è·¯æ˜¯å¯ä»¥æ·»åŠ ä¸€ä¸ªÂ <code>TaskType</code>Â è¡¨ç¤ºã€Œè¯·å…³é—­ã€ï¼ŒWorker æ¥æ”¶åˆ°è¯¥ä»»åŠ¡åå°±å¯ä»¥è‡ªè¡Œå…³é—­</li><li>ç„¶åæ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œä¸æ–­ä» Master å¤„è·å–ä»»åŠ¡å¹¶æ‰§è¡Œï¼Œå½“æ”¶åˆ°é€€å‡ºä¿¡å·æ—¶å°±é€€å‡º</li></ul><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func Worker(mapf func(string, string) []KeyValue,
	reducef func(string, []string) string) {

	w := WorkerInfo{
		mapf,
		reducef,
		make(chan struct{}),
		make(chan Task, 1),
	}

	// Master 10ç§’æ²¡å“åº”å°±è®¤ä¸ºå®ƒå·²ç»å…³é—­ï¼Œ Workerå¯ä»¥é€€å‡º
	go func() {
		before := time.Now().UnixNano()
		TIMEOUT := time.Second.Nanoseconds() * 10
		for {
			if w.healthCheck() {
				before = time.Now().UnixNano()
			} else if time.Now().UnixNano()-before &gt;= TIMEOUT {
				log.Println(&quot;Master æ— å“åº”ï¼Œå¯ä»¥é€€å‡º&quot;)
				w.exit &lt;- struct{}{}
				return
			}
			time.Sleep(time.Second)
		}
	}()

	// è¶…æ—¶é€€å‡ºæˆ–ç­‰å¾…åˆ†é…æ–°ä»»åŠ¡
	for {
		select {
		case &lt;-w.exit:
			close(w.tasks)
			close(w.exit)
			return
		case t := &lt;-w.tasks:
			w.execTask(t)
		default:
			if ok, t := w.pullTask(); !ok {
				time.Sleep(time.Second)
			} else {
				w.tasks &lt;- t
			}
		}
	}
}</code></pre></div><p>å…¶ä¸­Â <code>healthCheck</code>Â å’ŒÂ <code>pullTask</code>Â å®ç°å¦‚ä¸‹ï¼Œ<code>call</code>Â æ˜¯ Lab æœ¬èº«å·²ç»å®ç°å¥½çš„å¯¹ RPC è°ƒç”¨çš„å°è£…ï¼š</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>// å¥åº·æ£€æŸ¥
func (w *WorkerInfo) healthCheck() bool {
	return call(&quot;Master.Ping&quot;, EmptyArgs{}, &amp;EmptyArgs{})
}

// ä»Masterå¤„è·å–ä»»åŠ¡
func (w *WorkerInfo) pullTask() (bool, Task) {
	t := Task{}
	ok := call(&quot;Master.PullTask&quot;, EmptyArgs{}, &amp;t)
	if !ok || t.TaskType == None {
		return false, Task{}
	}
	return true, t
}</code></pre></div><p>å½“æ¥æ”¶åˆ°ä»»åŠ¡æ—¶ï¼Œå°±è°ƒç”¨Â <code>execTask</code>Â æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒæ ¹æ®ä»»åŠ¡ç±»å‹è°ƒç”¨Â <code>execMap</code>Â æˆ–Â <code>execReduce</code>Â æ¥æ‰§è¡Œï¼Œæœ€åå¤„ç†æ‰§è¡Œç»“æœï¼Œé€šçŸ¥å› Master</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (w *WorkerInfo) execTask(t Task) {
	var notifyData FinishNotify
	notifyData.Task = t
	defer func() {
		err := recover()
		if err != nil {
			notifyData.Err = fmt.Errorf(&quot;%v&quot;, err)
		}

		// å‘ Master æŠ¥å‘Šæ‰§è¡Œå®Œæ¯•
		call(&quot;Master.FinishTask&quot;, notifyData, &amp;EmptyArgs{})
	}()

	log.Printf(&quot;æ‰§è¡Œä»»åŠ¡ %v\n&quot;, t)

	var fun func(task Task) ([]string, error)
	if t.TaskType == Map {
		fun = w.execMap
	} else if t.TaskType == Reduce {
		fun = w.execReduce
	} else {
		return
	}

	if outfile, err := fun(t); err != nil {
		notifyData.Err = err
	} else {
		notifyData.Filenames = outfile
	}
}</code></pre></div><p><code>execMap</code>Â å†…é¦–å…ˆå¾ªç¯è¯»å…¥æ¯ä¸ªæ–‡ä»¶ï¼Œå°†å®ƒä»¬çš„å†…å®¹ä¼ é€’ç»™ç”¨æˆ·çš„Â <code>Map</code>Â å‡½æ•°æ‰§è¡Œï¼Œç»“æœè¿½åŠ åˆ° key-value åˆ—è¡¨ä¸­ï¼Œç„¶ååˆ›å»ºæŒ‡å®šåˆ†åŒºæ•°é‡ï¼ˆ<code>NReduce</code>ï¼‰çš„ä¸´æ—¶æ–‡ä»¶ï¼Œé€šè¿‡Â <code>ihash</code>Â æ¥ç¡®å®šæ¯ä¸ª key æ˜ å°„åˆ°å“ªä¸ªåˆ†åŒºä¸­ï¼Œåºåˆ—åŒ–æ•°æ®å†™å…¥åˆ°è¯¥åˆ†åŒºçš„ä¸´æ—¶æ–‡ä»¶ä¸Šã€‚æœ€åé€šè¿‡åŸå­é‡å‘½åæ¥ä¿è¯ä¸ä¼šå‡ºç°æ–‡ä»¶çš„éƒ¨åˆ†å†™å…¥</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (w *WorkerInfo) execMap(t Task) ([]string, error) {
	kva := []KeyValue{}
	for i := range t.Files {
		file, _ := os.Open(t.Files[i])
		defer file.Close()
		content, _ := ioutil.ReadAll(file)

		tmpKva := w.mapf(t.Files[i], string(content))
		kva = append(kva, tmpKva...)
	}

	// æ ¹æ® key åˆ†åˆ«å†™å…¥ä¸åŒæ–‡ä»¶
	tmpfiles := make([]*os.File, t.NReduce)

	for i := range tmpfiles {
		tmpfiles[i], _ = ioutil.TempFile(&quot;&quot;, &quot;*.tmp&quot;)
		defer tmpfiles[i].Close()
	}
	tmpData := make([][]KeyValue, t.NReduce)
	for i := range kva {
		idx := ihash(kva[i].Key) % t.NReduce
		tmpData[idx] = append(tmpData[idx], kva[i])
	}
	for i := range tmpData {
		buf := &amp;bytes.Buffer{}
		enc := gob.NewEncoder(buf)
		if err := enc.Encode(&amp;tmpData[i]); err != nil {
			os.Remove(tmpfiles[i].Name())
			return []string{}, errors.New(&quot;cannot serialize&quot;)
		}
		tmpfiles[i].Write(buf.Bytes())
	}

	// é€šè¿‡å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ å†é‡å‘½åæ¥ä¿è¯åŸå­æ€§
	// æ ¼å¼ mr-X-Y Xæ˜¯Mapä»»åŠ¡å· Yæ˜¯Reduceä»»åŠ¡å· å³ihash(X)
	res := make([]string, 0, t.NReduce)
	for i := range tmpfiles {
		name := fmt.Sprintf(&quot;./mr-%d-%d&quot;, t.ID, i)
		os.Rename(tmpfiles[i].Name(), name)
		res = append(res, name)
	}
	return res, nil
}

func ihash(key string) int {
	h := fnv.New32a()
	h.Write([]byte(key))
	return int(h.Sum32() &amp; 0x7fffffff)
}</code></pre></div><p><code>execReduce</code>Â ç±»ä¼¼ï¼Œè¯»å…¥æ–‡ä»¶ï¼Œååºåˆ—åŒ–åŠ è½½åˆ° key-value åˆ—è¡¨ä¸­ï¼Œç„¶åæ’åºä»¥è®©ç›¸åŒ key æ’åœ¨ä¸€èµ·ï¼Œæ–‡ä»¶å¤§åˆ°ä¸è¶³ä»¥æ”¾å…¥å†…å­˜æ—¶åº”è¯¥é‡‡ç”¨å¤–éƒ¨æ’åºï¼Œä¸è¿‡ Lab ä¸­å¯ä»¥å‡å®šä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚ç„¶åå¯¹äºç›¸åŒçš„ keyï¼Œå°†å…¶ value çš„é›†åˆæ‰“åŒ…è°ƒç”¨ç”¨æˆ·çš„Â <code>Reduce</code>Â å‡½æ•°ã€‚ç»“æœä¹Ÿæ˜¯ä¸€æ ·å†™å…¥ä¸´æ—¶æ–‡ä»¶å†åŸå­é‡å‘½å</p><div class=notion-code-block><div class=notion-code-header><span class=notion-code-language>Go</span> <button aria-label=å¤åˆ¶ä»£ç  title=å¤åˆ¶ä»£ç  class=notion-code-copy><svg fill=none viewBox="0 0 24 24" height=16 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=16><rect height=13 rx=2 ry=2 width=13 x=9 y=9></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> <span class=copy-text>COPY</span></button></div><pre class=notion-code><code class=language-go>func (w *WorkerInfo) execReduce(t Task) ([]string, error) {
	kva := []KeyValue{}
	for i := range t.Files {
		file, _ := os.Open(t.Files[i])
		defer file.Close()
		content, _ := ioutil.ReadAll(file)

		dec := gob.NewDecoder(bytes.NewBuffer(content))
		var tmpKva []KeyValue
		dec.Decode(&amp;tmpKva)
		kva = append(kva, tmpKva...)
	}

	// æ’åºkey æ‰“åŒ…è°ƒç”¨reduce
	sort.Slice(kva, func(i, j int) bool {
		return kva[i].Key &lt; kva[j].Key
	})

	ofile, _ := ioutil.TempFile(&quot;&quot;, &quot;*.tmp&quot;)
	defer ofile.Close()
	for i := 0; i &lt; len(kva); {
		j := i + 1
		for j &lt; len(kva) &amp;&amp; kva[j].Key == kva[i].Key {
			j++
		}
		values := []string{}
		for k := i; k &lt; j; k++ {
			values = append(values, kva[k].Value)
		}
		output := w.reducef(kva[i].Key, values)

		fmt.Fprintf(ofile, &quot;%v %v\n&quot;, kva[i].Key, output)

		i = j
	}
	oname := fmt.Sprintf(&quot;mr-out-%d&quot;, t.ID)
	os.Rename(ofile.Name(), oname)
	return []string{oname}, nil
}</code></pre></div><p><br></p><h2 id="">æµ‹è¯•</h2><p>Worker ä¹Ÿæå®šï¼Œæœ€åè°ƒç”¨Â <code>main/test-mr.sh</code>Â è¿›è¡Œæµ‹è¯•ï¼Œå…¶ä¼šè¿è¡Œäº”ä¸ªæµ‹è¯•</p><ol><li>wc-testï¼šè¯é¢‘ç»Ÿè®¡åº”ç”¨æµ‹è¯•</li><li>indexer-testï¼šç´¢å¼•æ„å»ºåº”ç”¨æµ‹è¯•</li><li>map-parallelism-testï¼šÂ <code>Map</code>Â å¹¶è¡Œæµ‹è¯•</li><li>reduce-parallelism-testï¼šÂ <code>Reduce</code>Â å¹¶è¡Œæµ‹è¯•</li><li>crash-testï¼š å®•æœºæµ‹è¯•</li></ol><figure class="notion-image notion-image-center notion-image-page-width"><a href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fb91d7944-eb3d-4261-873c-eae0b7276027%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045752Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3D8e7ce8129d4d0484a5b632f5609742f2c07a7eb7c291b94833f1654af53349ca%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=dd4af0b6-1713-4f84-b825-682c57676392" class=glightbox data-aspect-ratio=1.980392 data-description="" data-gallery=article-images data-title=Image style=aspect-ratio:1.980392><img alt=Image loading=lazy onload="const ratio=this.naturalWidth/this.naturalHeight;this.parentElement.style.aspectRatio=ratio.toFixed(6),this.parentElement.setAttribute(&#34;data-aspect-ratio&#34;,ratio.toFixed(6)),this.parentElement.classList.add(&#34;loaded&#34;)" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fb91d7944-eb3d-4261-873c-eae0b7276027%2Fimage.png%3FX-Amz-Algorithm%3DAWS4-HMAC-SHA256%26X-Amz-Content-Sha256%3DUNSIGNED-PAYLOAD%26X-Amz-Credential%3DASIAZI2LB466QPNOYWYG%252F20260127%252Fus-west-2%252Fs3%252Faws4_request%26X-Amz-Date%3D20260127T045752Z%26X-Amz-Expires%3D3600%26X-Amz-Security-Token%3DIQoJb3JpZ2luX2VjEIX%252F%252F%252F%252F%252F%252F%252F%252F%252F%252FwEaCXVzLXdlc3QtMiJHMEUCIQCrG40wiT5NwCyv7QTjoCyhL9ZcmCKr6f5RR61xP330sAIgVygotWoTf2KCWSirHtPqwYXPPrlglcNv3T%252FtfqaJCTUq%252FwMIThAAGgw2Mzc0MjMxODM4MDUiDC0bR4TijJlUzhLN7SrcA%252BFqwCY50Hw8m0YTvXhrvI59u5VtIQN2RJU8s%252BcQWbANfjVfrv4NUkdnvKVHabyLg6Sqt%252Fc8sFyMM1mLjzoq3TRI6bWXzEVqbqPM%252FwBZsvIhoFE5nCUXWIZAo7O1EQuw1h%252FI3bZbht4FW3WgAnqnbFhJNHoAiA0TVu3Qe5cOCvk1xsI5KoHI8pf0SOlXFt40lLxZtE18q5I3uI%252FIZ%252Bz%252F0GS9l3Mp0vQPVNPxoIjbyS320bIWvfZ1IyoKMTF8lF0R06Gm5cabuWz5E9Nb7nly0vTGpmR6%252B1eh%252B7RvJgu8K%252FjPxdstIFoxq%252BufhJAuBh1PhfWlHks%252BmDc4xRTz%252FzdmDEKxnxZ54RI0gg4zztGvJ9MlxpessoIhZMGn9vi4JI0ubbVRaLBsBuetdxPLN08Dbr0gAEY%252Bir6sEtHR%252BSAF1ySVi8r4toZbQNTMjqbKUBGLa15x2Uqw0K8QO9ZSgQ77QFLeS7MfuUewH2UUi6KVZ%252FCJV8Jn1J0DbaNST5vGiVpT4dcICOM9YDMjkYz2HSa11FoIXCxst2fYmyv1d%252BVqsZYYx6fOsO5aNGgb7N2NHwgVLA2uG3z4%252BkcJat02qVJZXl6D5JFajAiYXvJcEcLzZsgFeKePY%252BaNCtpen8xkMN6F4csGOqUB4S7YJsKDhWy4GV7NNwBRuno6X0ZtEUZK6bn2i1%252BzCLXq0kPZY7RMV3ygCDvA0HAnoE8836Ya46XJ8KMtpDW1WwIHKYY7ugBH4lFXQtiVlVkJ609a3nyOukfrs%252Fo3t60cs8NATRGbHupJk70G5ME9xRXaPEjV%252FXhMOsiXRvVAOinBwA5qpWU6Hw3HPoFPYSLB0DphqS%252FCgUHVrv%252B0Psj9cjXihd%252By%26X-Amz-Signature%3D8e7ce8129d4d0484a5b632f5609742f2c07a7eb7c291b94833f1654af53349ca%26X-Amz-SignedHeaders%3Dhost%26x-amz-checksum-mode%3DENABLED%26x-id%3DGetObject?table=block&amp;id=dd4af0b6-1713-4f84-b825-682c57676392"/></a></figure><p>bingo</p></div><nav class=post-navigation data-astro-cid-gbhzkc2y><a href=/post/2021summary class="nav-link nav-prev" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>â† ä¸Šä¸€ç¯‡</span> <span class=nav-title data-astro-cid-gbhzkc2y>è’Ÿè’»çš„ 2021 å¹´åº¦æ€»ç»“</span> </a><a href=/post/gfs-paper class="nav-link nav-next" data-astro-cid-gbhzkc2y><span class=nav-label data-astro-cid-gbhzkc2y>ä¸‹ä¸€ç¯‡ â†’</span> <span class=nav-title data-astro-cid-gbhzkc2y>The Google File System è®ºæ–‡æ¦‚è§ˆ</span></a></nav><footer class=page-footer data-astro-cid-gbhzkc2y><a href=/ class=back-link data-astro-cid-gbhzkc2y>â† è¿”å›é¦–é¡µ</a></footer><section class=comments-section data-astro-cid-gbhzkc2y><div class=comments-container data-astro-cid-te6ksoa6 data-giscus-config="{&#34;slug&#34;:&#34;mit6824-lab1-mapreduce&#34;,&#34;title&#34;:&#34;MIT6.824 Lab1 MapReduce&#34;,&#34;config&#34;:{&#34;repo&#34;:&#34;xxxuuu/xxxuuu.github.io&#34;,&#34;repoId&#34;:&#34;MDEwOlJlcG9zaXRvcnkxODQ3Mjk3Mjg&#34;,&#34;category&#34;:&#34;Announcements&#34;,&#34;categoryId&#34;:&#34;DIC_kwDOCwLAgM4ChgWc&#34;,&#34;mapping&#34;:&#34;title&#34;,&#34;strict&#34;:&#34;0&#34;,&#34;reactionsEnabled&#34;:&#34;1&#34;,&#34;emitMetadata&#34;:&#34;0&#34;,&#34;inputPosition&#34;:&#34;bottom&#34;,&#34;lang&#34;:&#34;zh-CN&#34;,&#34;lazy&#34;:true}}" data-provider=giscus id=comments><div class=comments-loading data-astro-cid-te6ksoa6>åŠ è½½è¯„è®ºä¸­...</div></div></section></div><aside class=toc-container data-astro-cid-gbhzkc2y><div class=toc-wrapper data-astro-cid-gbhzkc2y><div class=toc-title data-astro-cid-gbhzkc2y>ç›®å½•</div><nav class=toc-nav data-astro-cid-gbhzkc2y></nav></div></aside></div></div></article></main><footer data-astro-cid-aoh3bln3><div class=container data-astro-cid-aoh3bln3><div class=footer-content data-astro-cid-aoh3bln3><div class=copyright data-astro-cid-aoh3bln3><p data-astro-cid-aoh3bln3>&copy; 2026 xÂ³uÂ³. All rights reserved.</p><p data-astro-cid-aoh3bln3 class=powered-by>Powered by <a href=https://github.com/xxxuuu/nopress rel="noopener noreferrer" target=_blank data-astro-cid-aoh3bln3>Nopress</a></p></div><div class=social-links data-astro-cid-aoh3bln3><a href=https://github.com/xxxuuu class=social-icon aria-label=github data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></span></a><a href=https://x.com/xxuuu0 class=social-icon aria-label=twitter data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></span></a><a href=mailto:xxuuu0@outlook.com class=social-icon aria-label=email data-astro-cid-aoh3bln3 rel="noopener noreferrer" target=_blank><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg></span></a><a href=/rss/feed.xml class="social-icon rss" aria-label=RSSè®¢é˜… data-astro-cid-aoh3bln3><span class=icon-wrapper data-astro-cid-aoh3bln3><svg fill=currentColor viewBox="0 0 24 24" aria-hidden=true><path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/></svg></span></a></div></div></div></footer></body></html>