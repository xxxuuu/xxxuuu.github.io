<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id/>
    <title>x³u³</title>
    <updated>2024-09-25T16:04:13.714Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <author>
        <name>xxxuuu</name>
        <email>xxuuu0@outlook.com</email>
        <uri>https://xxxuuu.me</uri>
    </author>
    <link rel="alternate" href="https://xxxuuu.me/"/>
    <subtitle>🗒 碎碎念</subtitle>
    <icon>https://xxxuuu.me/favicon.png</icon>
    <rights>All rights reserved 2024, xxxuuu</rights>
    <entry>
        <title type="html"><![CDATA[PVE8 上启用 12 代 Intel CPU 核显 SR-IOV]]></title>
        <id>https://xxxuuu.me/post/pve8-intel-sr-iov</id>
        <link href="https://xxxuuu.me/post/pve8-intel-sr-iov"/>
        <updated>2023-08-06T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[拯救我的 Galgame 和追番体验～]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-d5fd419b4cb744c8a8d70c8ed44c1963"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-a4def888e15b410ab27d2cb9b772c9c1" data-id="a4def888e15b410ab27d2cb9b772c9c1"><span><div id="a4def888e15b410ab27d2cb9b772c9c1" class="notion-header-anchor"></div><a class="notion-hash-link" href="#a4def888e15b410ab27d2cb9b772c9c1" title="背景"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">背景</span></span></h3><div class="notion-text notion-block-c157d1fa6f33427a8c2a965e7ef8af6a">前段时间买了台 MiniPC 装 PVE 作为 Homelab，打算作为媒体服务器 + NAS + 学习使用 <s>（虽然最后主要是用来装 Windows 虚拟机玩 Galgame）</s></div><div class="notion-text notion-block-744db2538d14452e842509f338f5e6bb">机子的 U 是 12 代的 i3-N305，买的时候 PVE8 还没发布，装的是 PVE7，5.x 的内核，对 12 代 U 还没有很完善的支持，核显无法使用。这就导致在 Jellyfin 看番只能软解，以及玩 Galgame 时压力都在 CPU 上，全程 CPU 100%，体验说不上好</div><div class="notion-text notion-block-45c83008f3fa446cadb0882b651d5a9b">最近发现 PVE8 发布了，升级到了 6.2 的内核，于是赶紧折腾一下。升级过程网上很多文章，这里略，无非就是配置下镜像源然后 <code class="notion-inline-code">apt update &amp; apt dist-upgrade</code></div><div class="notion-blank notion-block-c76034461cd4474fa0014a39b35e602a"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-6ea6cb08761940a9b096153a75f6f9e5" data-id="6ea6cb08761940a9b096153a75f6f9e5"><span><div id="6ea6cb08761940a9b096153a75f6f9e5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#6ea6cb08761940a9b096153a75f6f9e5" title="开启核显 SR-IOV"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">开启核显 SR-IOV</span></span></h3><div class="notion-text notion-block-075c424861f7456eb186833b1fdb89e9">SR-IOV 是一种硬件虚拟化技术，简单来说，能将物理 PCIe 设备虚拟成多个虚拟设备，在网卡上被广泛使用。Intel Core CPU 在 11 代后支持了该技术用于 GPU 虚拟化，替换了过去的 GVT-g（<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://www.intel.cn/content/www/cn/zh/support/articles/000093216/graphics.html">Intel 产品 GPU 虚拟化技术列表</a>）</div><div class="notion-blank notion-block-d4d67141cd914e8ca144e09d6c23bbac"> </div><div class="notion-text notion-block-03b096ebedd64b3ebccd3642258e864b">开启 SR-IOV 主要用到这个驱动程序：<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/strongtz/i915-sriov-dkms">i915-sriov-dkms</a>，能够创建最多 7 个 VF（可以简单理解为 vGPU）</div><div class="notion-text notion-block-6584f604934d45dea9105a47cf429470">按着文档里「PVE Host Installation Steps (Tested Kernel 6.1 and 6.2)」这步做即可。在 <code class="notion-inline-code">update-grub</code> 和 <code class="notion-inline-code">update-initramfs -u</code> 后多执行一句 <code class="notion-inline-code">pve-efiboot-tool refresh</code></div><div class="notion-text notion-block-607dae71d44b49a6a5902a8254ac4b45">但我这里遇到一个问题，重启后查看 <code class="notion-inline-code">dmesg | grep i915</code> 有这样两条日志</div><div class="notion-text notion-block-0ad276d13a9944a3a36a2078250ec4e1">看了<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/strongtz/i915-sriov-dkms/issues/53">这个 issue </a>后，尝试重装。删除了原来的 dkms 模块，修改 <code class="notion-inline-code">dkms.conf</code> 里的 <code class="notion-inline-code">PACKAGE_NAME</code> 为 6.2（和内核版本匹配），然后 install 时加上 <code class="notion-inline-code">--force</code> 重新走遍安装流程</div><div class="notion-text notion-block-9eaf1ba422fc42169398054f917cea3e">这回正常了，上面两条日志没有了，也显示成功启用 VF，<code class="notion-inline-code">lspci | grep VGA</code> 能看到多出来 7 个 GPU 设备，可以将其挂载到 LXC 或虚拟机中（00.02.0 那个物理 GPU / PF 不应该被使用）</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-222e432ef4b34defaefc4853949c86e2"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fef8f7700-94bc-4e65-9461-9aa83c017b85%2Fimage.png?table=block&amp;id=222e432e-f4b3-4def-aefc-4853949c86e2&amp;t=222e432e-f4b3-4def-aefc-4853949c86e2&amp;width=1097.7271728515625&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-4a29bb6bfaa24eac978ccad8c921c82d"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-f27c6859dddf4d6a8ec08e05f18e7130" data-id="f27c6859dddf4d6a8ec08e05f18e7130"><span><div id="f27c6859dddf4d6a8ec08e05f18e7130" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f27c6859dddf4d6a8ec08e05f18e7130" title="Windows 虚拟机挂载"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Windows 虚拟机挂载</span></span></h3><div class="notion-text notion-block-d30c3106b90345ac99029bfdf6c085bb">Windows 虚拟机要先配置好远程桌面，能连的上。虚拟机配置里「显示」选「无」（选「无」后就无法 VNC 连接了，所以要先配好远程桌面）</div><div class="notion-text notion-block-daaf3ad6299b4669b8da88fe01c90117">添加 PCI 设备，选择 vGPU，勾上主 GPU</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-05d3d35bfdf84000aa33ba760fe27dbf"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fc2111f8c-f7f2-44ec-a8d6-24986d00dc11%2Fimage.png?table=block&amp;id=05d3d35b-fdf8-4000-aa33-ba760fe27dbf&amp;t=05d3d35b-fdf8-4000-aa33-ba760fe27dbf&amp;width=1097.7271728515625&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-aeb7f853d0c54d45b44f670682084e8b">进入 Windows <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://www.intel.cn/content/www/cn/zh/support/intel-driver-support-assistant.html">安装驱动</a>，Bingo</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-df182d378bf343aea97cc276aee8f9bd"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fb0cbf85d-dd3b-459e-9453-341b2ad1468c%2Fimage.png?table=block&amp;id=df182d37-8bf3-43ae-a97c-c276aee8f9bd&amp;t=df182d37-8bf3-43ae-a97c-c276aee8f9bd&amp;width=1097.7271728515625&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-5398f7701f24494faa31b6451c31e2cf"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1037ec71a7114ae2b1b9a8ce67fc246f" data-id="1037ec71a7114ae2b1b9a8ce67fc246f"><span><div id="1037ec71a7114ae2b1b9a8ce67fc246f" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1037ec71a7114ae2b1b9a8ce67fc246f" title="LXC 容器挂载"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">LXC 容器挂载</span></span></h3><div class="notion-text notion-block-a5c7ad47d9e64422a08932e7d7325dbb">新建 LXC 容器要选择「嵌套」+「特权」（去掉无特权容器的 ✅）</div><div class="notion-text notion-block-163b681b58624b6b870406b5bef66822">挂载设备到 LXC 容器里，在 PVE 里找下对应设备驱动，选一个未使用的 vGPU 记下第 5 、 6 列的 video id 和 render id（不要选了 0 的物理 GPU / PF），我这里选择 card2 和 renderD130</div><div class="notion-text notion-block-f65217aa65e04735845fcd29fc68dfbc">关闭 LXC 容器，然后修改对应 LXC 容器配置文件</div><div class="notion-text notion-block-1edda3863cf8446bb606d006aa6e0e03">添加以下内容把设备挂载到 LXC 内（分别填入 video id 和 render id，以及映射对应 card 和 render）</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-e5316e98dd724a9eaeadb26ff4fe384f"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F979bcf6a-86df-4926-8e08-00e6d10155df%2Fimage.png?table=block&amp;id=e5316e98-dd72-4a9e-aead-b26ff4fe384f&amp;t=e5316e98-dd72-4a9e-aead-b26ff4fe384f&amp;width=1415.866455078125&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-a8733cc24cba48d4ade24f56cc25c040"> </div><div class="notion-text notion-block-f01e49b09af7481f97fb46f0e4626126">进入 LXC 容器安装驱动</div><div class="notion-text notion-block-e2c0378ddee745ecb3dde4b9cf4f260c">如果 LXC 内也使用了容器，例如我在 LXC 内装了 Docker 部署 Jellyfin，则容器内也要有驱动，并把设备挂载进去</div><div class="notion-blank notion-block-da7e4449a72d4d5695e72e68daf6c471"> </div><div class="notion-text notion-block-513386bc931541b284bd906eaba6cb9d">然后 Jellyfin 容器内就可以找到对应设备，启用硬件加速即可</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-b62e5235a4374f54875f20e563dbc664"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fce80eb44-ab6d-4a2f-9c67-ea783ce5b77d%2Fimage.png?table=block&amp;id=b62e5235-a437-4f54-875f-20e563dbc664&amp;t=b62e5235-a437-4f54-875f-20e563dbc664&amp;width=1097.7271728515625&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-20e0b50e8268442bb393335c49bad030"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-733bfb3219734ec49f910696f3f693ce" data-id="733bfb3219734ec49f910696f3f693ce"><span><div id="733bfb3219734ec49f910696f3f693ce" class="notion-header-anchor"></div><a class="notion-hash-link" href="#733bfb3219734ec49f910696f3f693ce" title="总结"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">总结</span></span></h3><div class="notion-text notion-block-0c9eb253fabf4cf8807a559108824932">核心就两步：</div><ol start="1" class="notion-list notion-list-numbered notion-block-e50bbf3abfe84fba92992184c2baffc3"><li>在 host（PVE）上安装驱动模块，开启 SR-IOV</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-4debacc11c954fc99110183ac0a7c60c"><li>配置虚拟机 or LXC 挂载 vGPU，并在里面安装驱动</li></ol><div class="notion-blank notion-block-991b4f1f2e34413d82a920a0a44ba477"> </div><div class="notion-text notion-block-94dc616e1c744472b675bd0bd4469ab7">有了 GPU 后体验好了很多，无论是 Windows 玩 Galgame 还是 Jellyfin 追番硬解，CPU 压力基本不超 5%，十分流畅，释放了本就不强的 CPU 算力。而且相比独占的直通物理 GPU，SR-IOV 虚拟出来的多个 vGPU 能分给多台虚拟机使用，打造完美 Homelab</div><div class="notion-blank notion-block-10c887563979804d8516c7aada5f0bd5"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-10c88756397980c19e79dff1969ff14a" data-id="10c88756397980c19e79dff1969ff14a"><span><div id="10c88756397980c19e79dff1969ff14a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#10c88756397980c19e79dff1969ff14a" title="更新"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">更新</span></span></h3><div class="notion-text notion-block-10c88756397980f7ba49dc685d823ed3">2024/09/25 更新</div><div class="notion-text notion-block-10c88756397980789baec7bc455d68cc">我将 PVE 版本升级到了 8.2.7，内核版本为 6.8.12。升级后因为内核版本变更，原来的修改就会失效，这里更新一下如何处理</div><div class="notion-blank notion-block-10c88756397980889facdf5dcb4b08ad"> </div><div class="notion-text notion-block-10c887563979803e880ec6ecb81a1ca7">首先需要卸载掉旧的模块</div><div class="notion-text notion-block-10c88756397980b3ad8cc7b559d9abba">然后重新走一遍<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/strongtz/i915-sriov-dkms">仓库</a>中安装驱动流程，这里同样按照对应内核版本的指南（PVE Host Installation Steps (Tested Kernel 6.5 and 6.8)）操作即可</div><div class="notion-text notion-block-10c8875639798009928bf3cd66fa82d1">操作的时候注意替换相关命令为自己的内核版本，免得出现问题。例如 <code class="notion-inline-code">apt install proxmox-headers-6.8.8-2-pve proxmox-kernel-6.8.8-2-pve</code> 我这里改成 <code class="notion-inline-code">apt install proxmox-headers-6.8.12-2-pve proxmox-kernel-6.8.12-2-pve</code></div><div class="notion-text notion-block-10c88756397980a6ab03e01c7286ee05">之前已经修改过 GRUB 等配置，因此重新安装完驱动（<code class="notion-inline-code">dkms install ...</code>）后就可以直接重启系统生效，LXC 和 VM 也不必重新配置</div><div class="notion-blank notion-block-10c8875639798091b309eb9307db52ae"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[迁移博客到 Notion]]></title>
        <id>https://xxxuuu.me/post/migrate-blog-to-notion</id>
        <link href="https://xxxuuu.me/post/migrate-blog-to-notion"/>
        <updated>2024-08-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Make Notion Great Again！]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-a06c26b2594143eaa89ed0bebab47add"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-6639a3b133644b57bb5bb7b9e0f49207" data-id="6639a3b133644b57bb5bb7b9e0f49207"><span><div id="6639a3b133644b57bb5bb7b9e0f49207" class="notion-header-anchor"></div><a class="notion-hash-link" href="#6639a3b133644b57bb5bb7b9e0f49207" title="动机"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">动机</span></span></h2><div class="notion-text notion-block-5f7e418583154f49a69915fb7cd951a0">之前的 blog 方案一直是使用 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://open.gridea.dev/">Gridea</a> 生成静态页面搭配 Vercel 托管。Gridea 是一个很棒的工具，但作者已经很长时间没有更新了</div><div class="notion-blank notion-block-e30a537d045c4d328e5605e53f27ce4d"> </div><div class="notion-text notion-block-853c1e86203f4e3bb234f998109fe37c">另一方面，在写作的过程中还是感到 Markdown 的表达能力不足，很多时间都要靠插入 HTML 或使用外挂的插件才能实现预期排版or样式。</div><div class="notion-text notion-block-d207d8782537469caa470adc957de85f">最简单的例子就是空行，Markdown 是会忽略多行空行的，而现代电子设备屏幕上的文字排版非常依赖空行来做分段（相对应纸质时代是采用首行缩进的方式），但在 Markdown 中却还要通过 <code class="notion-inline-code">&lt;br/&gt;</code> 手动空行</div><div class="notion-text notion-block-d5ec957465944eaf9dd1f779dbbb0412">有时还想有个单独的页面记录自己的旅行地图或摄影作品，显然这些要在基于 Markdown 的方案中实现都十分困难，就连图片管理都不方便</div><div class="notion-text notion-block-92558a84dfc44aa2be76fc528412cc25">是时候摆脱 Markdown 的束缚了</div><div class="notion-blank notion-block-561e8854935b4abebe488492fe8ecc82"> </div><div class="notion-text notion-block-f458030cdbe4465eb134e0929c923bc4">还有一个原因是，我在个人的记录、信息整理中都重度使用了 Notion，保守估计在其中存放了上千个页面。与此同时，blog 却需要使用一个单独的工具来进行写作和管理，这也让我感到麻烦，很大程度上影响了写作的欲望<s>（终于找到不更新的理由了</s></div><div class="notion-blank notion-block-c478d4027dd64ddbb999ae7c11ba3b99"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-facf073bf2c64941a483936e1f1b7455" data-id="facf073bf2c64941a483936e1f1b7455"><span><div id="facf073bf2c64941a483936e1f1b7455" class="notion-header-anchor"></div><a class="notion-hash-link" href="#facf073bf2c64941a483936e1f1b7455" title="Notion-based blog"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Notion-based blog</span></span></h2><div class="notion-text notion-block-be788c0548ab4512b3c3215b4cecc4ca">Notion 有很强的表达能力，block 和 database 的设计都是很大的创新，这些设计和功能被各种云文档和笔记软件抄了一遍又一遍，足以见其影响</div><div class="notion-text notion-block-7ad757d2dfd2441e8297354ae3dc133c">现在又集成了 LLM，对写作更方便了。所以很早之前我就想，能否将 blog 也搬到让 Notion 上，让 all in one 更加彻底呢？</div><div class="notion-blank notion-block-4883101755dd4537a10d6be84e3f78ff"> </div><div class="notion-text notion-block-d028d734b76d4e9c96358410c1e12aef">不过 Notion 并不是一个建站工具，虽然有提供公开页面的站点功能，但充其量也只是公开页面/文章，离站点还差了点味道，只能说勉强能用，绑定自定义域名还需要额外 10 刀一个月</div><div class="notion-text notion-block-f4fd07c52c3d4d87b86d66724789c305">而且要进行比较好的管理，就肯定得用 Notion 的 database，这时候如果直接使用站点功能，用户进来看到的就是一个表格，这很奇怪（虽然有其他view，但那些玩意没好到哪去，说到底是 database 目的是管理数据而不是展示数据)</div><div class="notion-text notion-block-fb41e7bd4aff4629baf489a0f5df5ceb">如果将 Notion &amp; Database 的组合在这里看作一个 Backend/Database as a Service，提供的是数据，那么还缺的就是面向最终用户的前端页面，这就是 Notion-based 建站方案需要解决的问题</div><div class="notion-blank notion-block-a87c190a332d4c55b4ee16e532780934"> </div><div class="notion-text notion-block-a4ada0dbb44d40709685593120688b73">好在有这个想法的人并不少，有很多优秀的第三方 Notion-based 建站工具，例如 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://noto.so/">noto</a>, <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://potion.so/">potion</a>, <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://super.so/">super</a> 等，但这些大都是 SaaS 产品，免费计划对功能和页面量有严格限制</div><div class="notion-text notion-block-61fde7fa01bc43129c1828807ad3afd1">后来也考虑过基于 <a target="_blank" rel="noopener noreferrer" href="https://github.com/NotionX/react-notion-x" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">react-notion-x</div><div class="notion-external-subtitle"><span>NotionX</span><span> • </span><span>Updated <!-- -->Sep 24, 2024</span></div></div></a> 这个 Notion block 的渲染库自己实现，不过这只是个渲染库，离搭出一个能用的产品还差了很多上层功能，加上我实在不想写太多前端代码，只能作罢</div><div class="notion-text notion-block-bd4ca572a0f44af4a4ac6528ce4aea0b">直到最近偶然刷到了 <a target="_blank" rel="noopener noreferrer" href="https://github.com/tangly1024/NotionNext" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">NotionNext</div><div class="notion-external-subtitle"><span>tangly1024</span><span> • </span><span>Updated <!-- -->Sep 24, 2024</span></div></div></a>，在功能上基本满足了我的想象，可以自托管，也能直接生成静态页面，是开箱即用的。并且 MIT license 开源意味着可以自由定制修改甚至商业化<s>（或许未来可以整个自己的 Notion 建站 SaaS 产品）</s>，不需要额外成本<s>（除了折腾的时间）</s>，于是决定这次将 blog 迁移过来</div><div class="notion-blank notion-block-29d99c2365a64138b8a488fc75cf1e52"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-b3480c06287a4d819a7259291fe6e2f5" data-id="b3480c06287a4d819a7259291fe6e2f5"><span><div id="b3480c06287a4d819a7259291fe6e2f5" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b3480c06287a4d819a7259291fe6e2f5" title="实施"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">实施</span></span></h2><div class="notion-text notion-block-68828ab58aa04cf7a586bd8c656d7413">虽然 NotionNext 在功能性上满足我的要求，但还要进行一些小调整（例如去掉一些审美堪忧才会喜欢的花里胡哨鼠标特效，和有了 tag 却还要存在的意义不明的 category，以及乱加的与 Notion 相悖的样式），同时移植原先 blog 的主题 <a target="_blank" rel="noopener noreferrer" href="https://github.com/xxxuuu/gridea-theme-autumn" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">gridea-theme-autumn</div><div class="notion-external-subtitle"><span>xxxuuu</span><span> • </span><span>Updated <!-- -->Aug 9, 2024</span></div></div></a> 到 NotionNext 上</div><div class="notion-text notion-block-fd51a05ee13b4040b6f6c20207269d63">我 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/xxxuuu/NotionNext">fork 了 NotionNext</a>，花了一个周末来完成这些修改和移植（还是写了不少前端代码 真痛苦</div><div class="notion-blank notion-block-eb16e721b9f946d5b93ec0c1032a74d9"> </div><div class="notion-text notion-block-2377acf13cbf4bee88393daf16c9bf4d">NotionNext 改造完成后，还得把原先的文章搬到 Notion 中，Notion 能直接导入 Markdown，但有些样式（特别是代码块）会有奇怪的换行问题。所以最后还是手动 copy 并调整的，好在文章数量不多。在这个过程中看到自己以前写的东西，稍微有些感叹，原来当时那么<s>弱智</s>青涩，不过这就是记录的意义吧</div><div class="notion-blank notion-block-fbefe87d533144ad8ea200c3b737d836"> </div><div class="notion-text notion-block-a63a2dfc24dd4bb8b471e22f7eebd1fa">NotionNext 可以直接作为服务端运行，但我不想维护一个额外的服务器。Vercel 之类的服务对这种有动态 API 和网络请求的 project 也有严格的资源限制</div><div class="notion-text notion-block-aae0510034f545a0ab34ad8e920a590a">所以计划和之前一样生成静态页面推送到仓库，仓库更新就会触发 Vercel 部署。这样还能复用原来的仓库 <a target="_blank" rel="noopener noreferrer" href="https://github.com/xxxuuu/xxxuuu.github.io" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">xxxuuu.github.io</div><div class="notion-external-subtitle"><span>xxxuuu</span><span> • </span><span>Updated <!-- -->Sep 21, 2024</span></div></div></a> 和 Vercel project</div><div class="notion-blank notion-block-d54792d2bec14874868d8996f577060e"> </div><div class="notion-text notion-block-ea0260d1ce3f4d95a3bd76b09b7671d6">不过这样还需要解决的一个问题是，站点无法动态更新。每次编辑完后要重新生成一下静态页面。在之前 Gridea 中点击一下发布就会自动完成这些操作，在 NotionNext 中就得执行 <code class="notion-inline-code">yarn export</code> 再 <code class="notion-inline-code">git push</code>，显然有些麻烦。于是我将这个操作丢到了 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/xxxuuu/NotionNext/blob/customization/.github/workflows/build.yaml">Github Action</a> 中，定时或手动 run 一下就行</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-a95f30b81f68449bbcb3a71dfdd947e4"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd3c78d22-74dc-44af-acb4-d6955ef7dc63%2Fimage.png?table=block&amp;id=a95f30b8-1f68-449b-bcb3-a71dfdd947e4&amp;t=a95f30b8-1f68-449b-bcb3-a71dfdd947e4&amp;width=6444&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-1b079d37f6c14054aeed1da37932555a">其实也可以直接为 NotionNext 仓库创建一个新的 Vercel project，设置 build command 为 <code class="notion-inline-code">yarn export</code>。每次更新在 Vercel 中 redeploy 就可以了，但我绕一圈的目的主要是想将 NotionNext 的仓库和最终成品的静态页面仓库分离开来</div><div class="notion-blank notion-block-9cd50fdf62674d45a72c1ee4c7e2de32"> </div><div class="notion-text notion-block-69f39904507c4498b4d457a9e92a343d">最终效果：</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-e20c5c0ab88f4bada40c6a2ac7e96a15"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F480e2dc7-7444-4193-8258-1e2804ba6afe%2Fimage.png?table=block&amp;id=e20c5c0a-b88f-4bad-a40c-6a2ac7e96a15&amp;t=e20c5c0a-b88f-4bad-a40c-6a2ac7e96a15&amp;width=8852&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-712ab5e8be2c4e03b9aff87e7f4398a4">现在 blog 所有的编辑和管理都可以在 Notion 中完成</div><div class="notion-blank notion-block-12079fd3be8b45ccbdc640bd7b8fc890"> </div><div class="notion-blank notion-block-6006dc7f8e254eeca016bff12e414bac"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-f94b09ef651348f38a095bced9d473ab" data-id="f94b09ef651348f38a095bced9d473ab"><span><div id="f94b09ef651348f38a095bced9d473ab" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f94b09ef651348f38a095bced9d473ab" title="样式测试"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">样式测试</span></span></h2><div class="notion-callout notion-orange_background_co notion-block-876277217f0a49a399e42f96564afa3f"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💡">💡</span></div><div class="notion-callout-text">测试 Notion 各种元素能否正常显示，源自 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://react-notion-x-demo.transitivebullsh.it/">react-notion-x test suite</a>，与正文无关</div></div><div class="notion-blank notion-block-5a8bc62531c3475eb6c794fdf097e002"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-14b4eca0ffdb4791aae3d1fd8f00fefb" data-id="14b4eca0ffdb4791aae3d1fd8f00fefb"><span><div id="14b4eca0ffdb4791aae3d1fd8f00fefb" class="notion-header-anchor"></div><a class="notion-hash-link" href="#14b4eca0ffdb4791aae3d1fd8f00fefb" title="Text"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Text</span></span></h3><div class="notion-text notion-block-09b67e9bd5d544c591d1f85fbcf360f7"><em><span class="notion-orange"><b>All kinds</b></span></em> of <span class="notion-yellow_background"><b>text</b></span><span class="notion-yellow_background"> styling </span>options are supported. Basic <code class="notion-inline-code">text</code> blocks are akin to HTML <code class="notion-inline-code">&lt;p&gt;</code> tags. <span class="notion-yellow">Text </span><span class="notion-pink_background">blocks</span> <span class="notion-red">also</span> <span class="notion-inline-underscore">support</span> a <span class="notion-teal_background"><b>variety</b></span> of <s><em><b><span class="notion-inline-underscore">rich</span></b></em></s> text <span class="notion-blue">formatting</span> <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://twitter.com/transitive_bs">options</a>.</div><div class="notion-blank notion-block-b587b29733f543b992a0227513579931"> </div><div class="notion-text notion-block-cb4a070871314827833fec9f0549d9a1"><span class="notion-gray">gray </span><span class="notion-brown">brown </span><span class="notion-orange">orange </span><span class="notion-yellow">yellow </span><span class="notion-teal">green </span><span class="notion-blue">blue </span><span class="notion-purple">purple </span><span class="notion-pink">pink </span><span class="notion-red">red</span></div><div class="notion-blank notion-block-aa4c1bb5b6754df688e7dd8b96592193"> </div><div class="notion-text notion-block-2e9c6e1e8e3d48e3a313de21665d8969"><span class="notion-gray_background">gray bg</span></div><div class="notion-text notion-block-ba22a277cf024eb4999aef794d9d3e9a"><span class="notion-brown_background">brown bg</span></div><div class="notion-text notion-block-349ed429a76747129242661fd482393c"><span class="notion-orange_background">orange bg</span></div><div class="notion-text notion-block-31db5cd0f2d44f1ab176a9aa046311f2"><span class="notion-yellow_background">yellow bg</span></div><div class="notion-text notion-block-89d6364f74ad45b5984ea6a4aa58c476"><span class="notion-teal_background">green bg</span></div><div class="notion-text notion-block-ceb8dbde22e941eca1e182c2317b258d"><span class="notion-blue_background">blue bg</span></div><div class="notion-text notion-block-6a2decd3d28f407996772bdadf351e33"><span class="notion-purple_background">purple bg</span></div><div class="notion-text notion-block-008b07f409cb4de2a9044b75c95cea6c"><span class="notion-pink_background">pink bg</span></div><div class="notion-text notion-block-fce17a2ab2214876b86d4d156c0c6b7c"><span class="notion-red_background">red bg</span></div><div class="notion-blank notion-block-a951f7852fad467a8e83d19ca27741dd"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-d86bba67a50945c4832138bd1d3d76c1" data-id="d86bba67a50945c4832138bd1d3d76c1"><span><div id="d86bba67a50945c4832138bd1d3d76c1" class="notion-header-anchor"></div><a class="notion-hash-link" href="#d86bba67a50945c4832138bd1d3d76c1" title="Image"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Image</span></span></h3><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-09284d22babe4200adc99b47e08b5953"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd1b76bfd-f4cf-4e99-87d8-e7498d1f3da1%2Fimage.png?table=block&amp;id=09284d22-babe-4200-adc9-9b47e08b5953&amp;t=09284d22-babe-4200-adc9-9b47e08b5953&amp;width=1416&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-e7ff7f5ce22046e6bde608b2aa11b0d6"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-d0361d688fad4d828ddc7182db6ba536" data-id="d0361d688fad4d828ddc7182db6ba536"><span><div id="d0361d688fad4d828ddc7182db6ba536" class="notion-header-anchor"></div><a class="notion-hash-link" href="#d0361d688fad4d828ddc7182db6ba536" title="Quote"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Quote</span></span></h3><blockquote class="notion-quote notion-block-cc77c020e96f4a839c8d27359327e8df"><div>This is an example quote.</div></blockquote><div class="notion-blank notion-block-228d5807b25a4b338792e845cd0f95ff"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-da05fd5b40134abcb80af56cf2216c58" data-id="da05fd5b40134abcb80af56cf2216c58"><span><div id="da05fd5b40134abcb80af56cf2216c58" class="notion-header-anchor"></div><a class="notion-hash-link" href="#da05fd5b40134abcb80af56cf2216c58" title="Callout"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Callout</span></span></h3><div class="notion-callout notion-blue_background_co notion-block-363df4630aa045f69fbbef1eb9156bfd"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="💻">💻</span></div><div class="notion-callout-text">This is a basic callout. It can contain blocks and <em><span class="notion-red">rich text</span></em>. 💪</div></div><div class="notion-blank notion-block-ac59299552034e96b25eaac0d6ad499a"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-0aae7406c5df4f309ddd982e253882c0" data-id="0aae7406c5df4f309ddd982e253882c0"><span><div id="0aae7406c5df4f309ddd982e253882c0" class="notion-header-anchor"></div><a class="notion-hash-link" href="#0aae7406c5df4f309ddd982e253882c0" title="Divider"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Divider</span></span></h3><hr class="notion-hr notion-block-bcf2b919bdb54438b5fcf02c37e74190"/><div class="notion-blank notion-block-2a0931b1d7e044dd98c684ede0222b77"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-888730276f05440495bea2e8c5291437" data-id="888730276f05440495bea2e8c5291437"><span><div id="888730276f05440495bea2e8c5291437" class="notion-header-anchor"></div><a class="notion-hash-link" href="#888730276f05440495bea2e8c5291437" title="Linked Block"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Linked Block</span></span></h3><div class="notion-text notion-block-93e6efa40a944dd09e3b742716192580"><em>The following block is linked to the content of a global footer block.</em></div><div class="notion-sync-block notion-block-154ee1b6887d4408b198e88337a9aefe"><div class="notion-callout notion-gray_background_co notion-block-31360ce83dc344a0b40d9e215b6627bd"><div class="notion-page-icon-inline notion-page-icon-image"><img class="notion-page-icon" src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F0518746e-3b99-483b-a211-3356f047a770%2Flogo.png?table=block&amp;id=31360ce8-3dc3-44a0-b40d-9e215b6627bd&amp;t=31360ce8-3dc3-44a0-b40d-9e215b6627bd&amp;width=800&amp;cache=v2" alt="page icon" loading="lazy" decoding="async"/></div><div class="notion-callout-text"><div class="notion-text notion-block-00e4a733703f49358b6a95a6e5e5c6eb">Copyright 2022 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://transitivebullsh.it">Travis Fischer</a> • <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://choosealicense.com/licenses/cc0-1.0/">CC0 License</a>

<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://www.notion.so/saasifysh/Notion-X-Test-Suite-067dd719a912471ea9a3ac10710e7fdf">Home</a> • <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/saasify-sh/notion-kit">GitHub</a> • <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://twitter.com/transitive_bs">Twitter</a></div></div></div></div><div class="notion-blank notion-block-f95d8d7af97e4b349f2195a8e8ef6379"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-62e21a7f20544a6e8c8a12d49942a592" data-id="62e21a7f20544a6e8c8a12d49942a592"><span><div id="62e21a7f20544a6e8c8a12d49942a592" class="notion-header-anchor"></div><a class="notion-hash-link" href="#62e21a7f20544a6e8c8a12d49942a592" title="Lists"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Lists</span></span></h3><ul class="notion-list notion-list-disc notion-block-5d8f50ac95724b67be69b842b7d82c76"><li>Bulleted lists are supported</li></ul><ul class="notion-list notion-list-disc notion-block-3eb2de05baf5403d8118737e8e0e106b"><li>Second Items</li><ul class="notion-list notion-list-disc notion-block-3eb2de05baf5403d8118737e8e0e106b"><li>Nested 1</li><ul class="notion-list notion-list-disc notion-block-dcee2e29f67e4e8b847ef51459346bb2"><li>Nested 2</li></ul></ul></ul><ul class="notion-list notion-list-disc notion-block-ccd52ced345c48de84c6e6cc22383f4c"><li>Back at top level</li><ul class="notion-list notion-list-disc notion-block-ccd52ced345c48de84c6e6cc22383f4c"><li>Child 1</li><li>Child 2</li><div class="notion-blank notion-block-58f9c1dd497e452ab4dee8ac821ad23b"> </div></ul></ul><ol start="1" class="notion-list notion-list-numbered notion-block-590cc745d3d44c0dbbd7dfd4ae19aed0"><li>First Item</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-d88dbf370f7f4821ac9c375f2ff51e1e"><li>Second</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-7f0188a04e53488fa307d8a84f8cd7be"><li>Third</li><ol class="notion-list notion-list-numbered notion-block-7f0188a04e53488fa307d8a84f8cd7be"><li>First Nest</li><li>Second Nest</li><ol class="notion-list notion-list-numbered notion-block-fd2e76ac2996441bb808e62a1d9b867a"><li>Deeply nested</li></ol><li>Third Nest</li></ol></ol><ol start="4" class="notion-list notion-list-numbered notion-block-7ac540b150ac4374855eccd3de7084d2"><li>Last</li></ol><div class="notion-blank notion-block-703e2d5d02af4ce78943fa068f9fe55f"> </div><div class="notion-to-do notion-block-a79959006a564a64ac998e27bcd6dfe5"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-unchecked"></div></span><div class="notion-to-do-body">Pretty URLs</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-e04d9fa905574f2cabbc090ece41b57e"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><div class="notion-to-do-body notion-to-do-checked">Custom domains</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-a97105aa409c42f68c219eec4ef6840a"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><div class="notion-to-do-body notion-to-do-checked">Google Fonts</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-390c9365d1954b0288b050f2784d2696"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><div class="notion-to-do-body notion-to-do-checked">Page title/description for SEO</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-e0be8328bf914aaa8fb9c318a95e53e3"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><div class="notion-to-do-body notion-to-do-checked">Custom scripts</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-cf072f8848d44750bceffefce38943da"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><div class="notion-to-do-body notion-to-do-checked">A setup wizard to customize the script (instead of having to change the raw code)</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-afb937e5a1e54ccd9e19501a6866f0e8"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-unchecked"></div></span><div class="notion-to-do-body">Stop random pages from showing up under custom domain</div></div><div class="notion-to-do-children"></div></div><div class="notion-to-do notion-block-bea9cc57a19f4368a8c8e0bec9faea35"><div class="notion-to-do-item"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-unchecked"></div></span><div class="notion-to-do-body">Hide the What&#x27;s New banner</div></div><div class="notion-to-do-children"></div></div><div class="notion-blank notion-block-9303713917de44e49a9736bbcbe31ecf"> </div><details class="notion-toggle notion-block-292adcbc251a4ca484c486c755859b33"><summary>Normal Toggle</summary><div><div class="notion-text notion-block-7c81367be5d044788005ce7fb9477a1f">Content inside here.</div></div></details><div class="notion-blank notion-block-6fdbbc684bc044328e9d822af0567a70"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-8bcaafce36144e7693618421fdb473c1" data-id="8bcaafce36144e7693618421fdb473c1"><span><div id="8bcaafce36144e7693618421fdb473c1" class="notion-header-anchor"></div><a class="notion-hash-link" href="#8bcaafce36144e7693618421fdb473c1" title="Code Blocks"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Code Blocks</span></span></h3><div class="notion-text notion-block-ae46298bec1e4a549e207d2d632cf0af">basic code</div><div class="notion-blank notion-block-92dcfc691dc14f728726ed5e8b8d8d7f"> </div><div class="notion-text notion-block-2e065dafc30d40e694d308442d0f4543">mermaid</div><div class="notion-blank notion-block-a24500cea30942359e3282f3f8ccd1f5"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-16ad581130c44c3390c564a4fed7fceb" data-id="16ad581130c44c3390c564a4fed7fceb"><span><div id="16ad581130c44c3390c564a4fed7fceb" class="notion-header-anchor"></div><a class="notion-hash-link" href="#16ad581130c44c3390c564a4fed7fceb" title="Links"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Links</span></span></h3><div class="notion-text notion-block-b1c5bd111d4643a595de204de63ab175">bookmark</div><div class="notion-row"><a target="_blank" rel="noopener noreferrer" class="notion-bookmark notion-block-b50316d8ccf743ae8d2d60c7de9c8117" href="https://www.google.com.hk/"><div><div class="notion-bookmark-title">Google</div><div class="notion-bookmark-description">Search the world&#x27;s information, including webpages, images, videos and more. Google has many special features to help you find exactly what you&#x27;re looking for.</div><div class="notion-bookmark-link"><div class="notion-bookmark-link-icon"><img src="https://www.notion.so/image/https%3A%2F%2Fwww.google.com.hk%2Ffavicon.ico?table=block&amp;id=b50316d8-ccf7-43ae-8d2d-60c7de9c8117&amp;t=b50316d8-ccf7-43ae-8d2d-60c7de9c8117" alt="Google" loading="lazy" decoding="async"/></div><div class="notion-bookmark-link-text">https://www.google.com.hk/</div></div></div></a></div><div class="notion-blank notion-block-f5594bcf25e84cd0a9f75ce4545c3731"> </div><div class="notion-callout notion-orange_background_co notion-block-7a5f8b5ea7e142d4911c7472bb57440c"><div class="notion-page-icon-inline notion-page-icon-span"><span class="notion-page-icon" role="img" aria-label="❗">❗</span></div><div class="notion-callout-text">没有特殊处理的普通站点的 mention 会显示异常，比如 https://google.com</div></div><div class="notion-text notion-block-d7712371a88944c9be30bcea2631b5fa">mention：</div><ul class="notion-list notion-list-disc notion-block-e6eaf9c9f0f34106b02dadaa63c19882"><li>‣</li></ul><ul class="notion-list notion-list-disc notion-block-e64923fe456a440c91912d2026544306"><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/NotionX/react-notion-x" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">react-notion-x</div><div class="notion-external-subtitle"><span>NotionX</span><span> • </span><span>Updated <!-- -->Sep 24, 2024</span></div></div></a></li></ul><ul class="notion-list notion-list-disc notion-block-f83e951ec50d46469810910e177f6657"><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/transitive-bullshit/nextjs-notion-starter-kit" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">nextjs-notion-starter-kit</div><div class="notion-external-subtitle"><span>transitive-bullshit</span><span> • </span><span>Updated <!-- -->Aug 26, 2024</span></div></div></a></li></ul><div class="notion-text notion-block-42c46d3b76eb4e30befa1ab5652af5b7">Inline styled text <a target="_blank" rel="noopener noreferrer" href="https://github.com/NotionX/react-notion-x" class="notion-external notion-external-mention"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">react-notion-x</div><div class="notion-external-subtitle"><span>NotionX</span><span> • </span><span>Updated <!-- -->Aug 27, 2024</span></div></div></a> and more after</div><div class="notion-blank notion-block-a37ec47b1ae2423db0e3568a983cdcd0"> </div><div class="notion-text notion-block-9fe383db33a94cdbb31f412ef4ec91c6">block</div><a target="_blank" rel="noopener noreferrer" href="https://github.com/NotionX/react-notion-x" class="notion-external notion-external-block notion-row notion-block-5f9ba7eec8b94e1ab230feeed9bcca4b"><div class="notion-external-image"><svg viewBox="0 0 260 260"><g><path d="M128.00106,0 C57.3172926,0 0,57.3066942 0,128.00106 C0,184.555281 36.6761997,232.535542 87.534937,249.460899 C93.9320223,250.645779 96.280588,246.684165 96.280588,243.303333 C96.280588,240.251045 96.1618878,230.167899 96.106777,219.472176 C60.4967585,227.215235 52.9826207,204.369712 52.9826207,204.369712 C47.1599584,189.574598 38.770408,185.640538 38.770408,185.640538 C27.1568785,177.696113 39.6458206,177.859325 39.6458206,177.859325 C52.4993419,178.762293 59.267365,191.04987 59.267365,191.04987 C70.6837675,210.618423 89.2115753,204.961093 96.5158685,201.690482 C97.6647155,193.417512 100.981959,187.77078 104.642583,184.574357 C76.211799,181.33766 46.324819,170.362144 46.324819,121.315702 C46.324819,107.340889 51.3250588,95.9223682 59.5132437,86.9583937 C58.1842268,83.7344152 53.8029229,70.715562 60.7532354,53.0843636 C60.7532354,53.0843636 71.5019501,49.6441813 95.9626412,66.2049595 C106.172967,63.368876 117.123047,61.9465949 128.00106,61.8978432 C138.879073,61.9465949 149.837632,63.368876 160.067033,66.2049595 C184.49805,49.6441813 195.231926,53.0843636 195.231926,53.0843636 C202.199197,70.715562 197.815773,83.7344152 196.486756,86.9583937 C204.694018,95.9223682 209.660343,107.340889 209.660343,121.315702 C209.660343,170.478725 179.716133,181.303747 151.213281,184.472614 C155.80443,188.444828 159.895342,196.234518 159.895342,208.176593 C159.895342,225.303317 159.746968,239.087361 159.746968,243.303333 C159.746968,246.709601 162.05102,250.70089 168.53925,249.443941 C219.370432,232.499507 256,184.536204 256,128.00106 C256,57.3066942 198.691187,0 128.00106,0 Z M47.9405593,182.340212 C47.6586465,182.976105 46.6581745,183.166873 45.7467277,182.730227 C44.8183235,182.312656 44.2968914,181.445722 44.5978808,180.80771 C44.8734344,180.152739 45.876026,179.97045 46.8023103,180.409216 C47.7328342,180.826786 48.2627451,181.702199 47.9405593,182.340212 Z M54.2367892,187.958254 C53.6263318,188.524199 52.4329723,188.261363 51.6232682,187.366874 C50.7860088,186.474504 50.6291553,185.281144 51.2480912,184.70672 C51.8776254,184.140775 53.0349512,184.405731 53.8743302,185.298101 C54.7115892,186.201069 54.8748019,187.38595 54.2367892,187.958254 Z M58.5562413,195.146347 C57.7719732,195.691096 56.4895886,195.180261 55.6968417,194.042013 C54.9125733,192.903764 54.9125733,191.538713 55.713799,190.991845 C56.5086651,190.444977 57.7719732,190.936735 58.5753181,192.066505 C59.3574669,193.22383 59.3574669,194.58888 58.5562413,195.146347 Z M65.8613592,203.471174 C65.1597571,204.244846 63.6654083,204.03712 62.5716717,202.981538 C61.4524999,201.94927 61.1409122,200.484596 61.8446341,199.710926 C62.5547146,198.935137 64.0575422,199.15346 65.1597571,200.200564 C66.2704506,201.230712 66.6095936,202.705984 65.8613592,203.471174 Z M75.3025151,206.281542 C74.9930474,207.284134 73.553809,207.739857 72.1039724,207.313809 C70.6562556,206.875043 69.7087748,205.700761 70.0012857,204.687571 C70.302275,203.678621 71.7478721,203.20382 73.2083069,203.659543 C74.6539041,204.09619 75.6035048,205.261994 75.3025151,206.281542 Z M86.046947,207.473627 C86.0829806,208.529209 84.8535871,209.404622 83.3316829,209.4237 C81.8013,209.457614 80.563428,208.603398 80.5464708,207.564772 C80.5464708,206.498591 81.7483088,205.631657 83.2786917,205.606221 C84.8005962,205.576546 86.046947,206.424403 86.046947,207.473627 Z M96.6021471,207.069023 C96.7844366,208.099171 95.7267341,209.156872 94.215428,209.438785 C92.7295577,209.710099 91.3539086,209.074206 91.1652603,208.052538 C90.9808515,206.996955 92.0576306,205.939253 93.5413813,205.66582 C95.054807,205.402984 96.4092596,206.021919 96.6021471,207.069023 Z" fill="#161614"></path></g></svg></div><div class="notion-external-description"><div class="notion-external-title">react-notion-x</div><div class="notion-external-subtitle"><span>NotionX</span><span> • </span><span>Updated <!-- -->Aug 15, 2024</span></div></div></a><div class="notion-blank notion-block-c3262cdc5f1840079ac5bb5979250927"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-f3bf84d350344b11a15960ce6bb7bbd3" data-id="f3bf84d350344b11a15960ce6bb7bbd3"><span><div id="f3bf84d350344b11a15960ce6bb7bbd3" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f3bf84d350344b11a15960ce6bb7bbd3" title="Tables"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Tables</span></span></h3><table class="notion-simple-table notion-block-53d36a56faaa42d294b16e92b216fc20"><tbody><tr class="notion-simple-table-row notion-block-14f6a1f477884955a2b1242cf43f7b33"><td class="" style="width:120px"><div class="notion-simple-table-cell">1</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">2</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">3</div></td></tr><tr class="notion-simple-table-row notion-block-74b8cd5dd79a44a8bb668fb3bf253e2a"><td class="" style="width:120px"><div class="notion-simple-table-cell">4</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">5</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">6</div></td></tr><tr class="notion-simple-table-row notion-block-0d978ce33f674068864289329f39bd9b"><td class="" style="width:120px"><div class="notion-simple-table-cell">7</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">8</div></td><td class="" style="width:120px"><div class="notion-simple-table-cell">9</div></td></tr></tbody></table><div class="notion-blank notion-block-968a845da965427b847a6f3185c06496"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-b710ecdfd0c245d79259288b6cc8af77" data-id="b710ecdfd0c245d79259288b6cc8af77"><span><div id="b710ecdfd0c245d79259288b6cc8af77" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b710ecdfd0c245d79259288b6cc8af77" title="Column Layouts"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Column Layouts</span></span></h3><div class="notion-row notion-block-ad8c01bc9a584a0b88cae0b469a291f0"><div class="notion-column notion-block-4ce5f512a47443a4b273c7cb9e1ca256" style="width:calc((100% - (4 * min(32px, 4vw))) * 0.2)"><div class="notion-text notion-orange_background notion-block-5f5266b69a514bfdbb004c157379a5a0">one</div></div><div class="notion-spacer"></div><div class="notion-column notion-block-1b4771014bdb45b8b880c4095bf61c3e" style="width:calc((100% - (4 * min(32px, 4vw))) * 0.2)"><div class="notion-text notion-yellow_background notion-block-c97d6b65a12a4f3dbb6d250b4b2245fd">two</div></div><div class="notion-spacer"></div><div class="notion-column notion-block-5439b4238766477ab3dee15735206357" style="width:calc((100% - (4 * min(32px, 4vw))) * 0.2)"><div class="notion-text notion-teal_background notion-block-ffec09675e4b4b87a2b9fd86ea2b73ae">three</div></div><div class="notion-spacer"></div><div class="notion-column notion-block-62e530cb497c4578aedfcaf5476f7342" style="width:calc((100% - (4 * min(32px, 4vw))) * 0.2)"><div class="notion-text notion-blue_background notion-block-d2a952960bcb4934ac0ff78a46bece2a">four</div></div><div class="notion-spacer"></div><div class="notion-column notion-block-0a9abd2e897e4e50b9c8535f949a57dc" style="width:calc((100% - (4 * min(32px, 4vw))) * 0.2)"><div class="notion-text notion-purple_background notion-block-4b62267489d240ac9c2cab7e33475902">five</div></div><div class="notion-spacer"></div></div><div class="notion-row notion-block-215c7efa4bb44bb996760ea265769b7b"><div class="notion-column notion-block-13d0342fbffc422eaa5597915c7201aa" style="width:calc((100% - (1 * min(32px, 4vw))) * 0.5)"><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-9df2d734fbf24eb89373139e494cda2f"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:262.734375px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fadac4e1e-1a94-4306-b41f-57f80b45f90d%2Froger-bradshaw-7o3uFw2xrAk-unsplash.jpg?table=block&amp;id=9df2d734-fbf2-4eb8-9373-139e494cda2f&amp;t=9df2d734-fbf2-4eb8-9373-139e494cda2f&amp;width=525.46875&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-aeaa57fd8ca94653b1bc63f7f9ec8db8"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:262.7421875px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ffc4a23e4-7898-4afa-ac20-e7834097a605%2Fmarsumilae-Og4S8NW-p_I-unsplash.jpg?table=block&amp;id=aeaa57fd-8ca9-4653-b1bc-63f7f9ec8db8&amp;t=aeaa57fd-8ca9-4653-b1bc-63f7f9ec8db8&amp;width=525.484375&amp;cache=v2" alt="This is a caption" loading="lazy" decoding="async"/><figcaption class="notion-asset-caption">This is a caption</figcaption></div></figure></div><div class="notion-spacer"></div><div class="notion-column notion-block-909c9d79be4a497c8d985238d2ab8875" style="width:calc((100% - (1 * min(32px, 4vw))) * 0.5000000000000002)"><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-55201f81d8824ef786e735f9442c929d"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:262.7421875px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd4b5070d-5e28-40bf-a4a5-2200e147aa84%2Fricardo-gomez-angel-geBHIpvA6us-unsplash.jpg?table=block&amp;id=55201f81-d882-4ef7-86e7-35f9442c929d&amp;t=55201f81-d882-4ef7-86e7-35f9442c929d&amp;width=525.484375&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><h4 class="notion-h notion-h3 notion-block-eed5a99a3a0d41fca905a915fb926afa" data-id="eed5a99a3a0d41fca905a915fb926afa"><span><div id="eed5a99a3a0d41fca905a915fb926afa" class="notion-header-anchor"></div><a class="notion-hash-link" href="#eed5a99a3a0d41fca905a915fb926afa" title="Nesting works just fine."><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Nesting works just fine.</span></span></h4><div class="notion-text notion-block-62c2a365c96a4ef9b48606e9af93c8a9">It is also responsive.</div><div class="notion-blank notion-block-d1c8f8d423d848d68f577a1b165ada5d"> </div></div><div class="notion-spacer"></div></div><div class="notion-blank notion-block-b92cd0fd563d471992b82c86d6be3b42"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-90bd08b9b85e4862b98b748fd580a434" data-id="90bd08b9b85e4862b98b748fd580a434"><span><div id="90bd08b9b85e4862b98b748fd580a434" class="notion-header-anchor"></div><a class="notion-hash-link" href="#90bd08b9b85e4862b98b748fd580a434" title="Equations"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Equations</span></span></h3><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-c948dce63c3a45f3b0b4e853642eeecc" data-id="c948dce63c3a45f3b0b4e853642eeecc"><span><div id="c948dce63c3a45f3b0b4e853642eeecc" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c948dce63c3a45f3b0b4e853642eeecc" title="Block"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Block</span></span></h4><div class="notion-blank notion-block-3cae21877cea42d2998b03d7f926d7c7"> </div><h4 class="notion-h notion-h3 notion-h-indent-2 notion-block-d9783044ea6548469a92907c85212eac" data-id="d9783044ea6548469a92907c85212eac"><span><div id="d9783044ea6548469a92907c85212eac" class="notion-header-anchor"></div><a class="notion-hash-link" href="#d9783044ea6548469a92907c85212eac" title="Inline"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Inline</span></span></h4><div class="notion-text notion-block-a0d70fff02ea4242b7ec1a7c42631948">This is an example of an inline equation: </div><div class="notion-text notion-block-9a21d718c0da49ae9a88f5ac2d58536a"></div><div class="notion-text notion-block-5993270de3ad4638bc40a3bd1cca8d93">You can also add formatting:</div><div class="notion-text notion-block-0a5c7f3317a844c4bdd91981d62b8f8a"><span class="notion-blue"></span></div><div class="notion-blank notion-block-3d4f1945d7544d51bcfa7b0c30d0ee60"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-2f416adcd8d04afeb07652ded6841fea" data-id="2f416adcd8d04afeb07652ded6841fea"><span><div id="2f416adcd8d04afeb07652ded6841fea" class="notion-header-anchor"></div><a class="notion-hash-link" href="#2f416adcd8d04afeb07652ded6841fea" title="Databases"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Databases</span></span></h3><div><div><div class="notion-collection-view-tabs-row"><button class="notion-collection-view-tabs-content-item notion-collection-view-tabs-content-item-active"><div class="notion-collection-view-type"><svg viewBox="0 0 14 14" class="notion-collection-view-type-icon"><path d="M2 0h10a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zm3.75 5.67v2.66h6.75V5.67H5.75zm0 4.17v2.66h5.75a1 1 0 001-1V9.84H5.75zM1.5 5.67v2.66h2.75V5.67H1.5zm0 4.17v1.66a1 1 0 001 1h1.75V9.84H1.5zm1-8.34a1 1 0 00-1 1v1.66h2.75V1.5H2.5zm3.25 0v2.66h6.75V2.5a1 1 0 00-1-1H5.75z"></path></svg><span class="notion-collection-view-type-title">Table view</span></div></button><button class="notion-collection-view-tabs-content-item"><div class="notion-collection-view-type"><svg viewBox="0 0 14 14" class="notion-collection-view-type-icon"><path d="M12 1.5H2a.5.5 0 00-.5.5v10a.5.5 0 00.5.5h10a.5.5 0 00.5-.5V2a.5.5 0 00-.5-.5zM2 0h10a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zm1 3h6v1.5H3V3zm0 2.5h8V7H3V5.5zM3 8h4v1.5H3V8z"></path></svg><span class="notion-collection-view-type-title">List view</span></div></button><button class="notion-collection-view-tabs-content-item"><div class="notion-collection-view-type"><svg viewBox="0 0 14 14" class="notion-collection-view-type-icon"><path d="M12 1.5H2a.5.5 0 00-.5.5v10a.5.5 0 00.5.5h10a.5.5 0 00.5-.5V2a.5.5 0 00-.5-.5zM2 0h10a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zm1 3h2v6H3V3zm3 0h2v8H6V3zm3 0h2v4H9V3z"></path></svg><span class="notion-collection-view-type-title">Board view</span></div></button><button class="notion-collection-view-tabs-content-item"><div class="notion-collection-view-type"><svg viewBox="0 0 14 14" class="notion-collection-view-type-icon"><path d="M12 1.5H2a.5.5 0 00-.5.5v10a.5.5 0 00.5.5h10a.5.5 0 00.5-.5V2a.5.5 0 00-.5-.5zM2 0h10a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V2a2 2 0 012-2zm1 3h3.5v3.5H3V3zm4.5 0H11v3.5H7.5V3zM3 7.5h3.5V11H3V7.5zm4.5 0H11V11H7.5V7.5z"></path></svg><span class="notion-collection-view-type-title">Gallery view</span></div></button></div></div><div class="notion-collection-header"><div class="notion-collection-header-title">Test</div></div></div><div class="notion-collection notion-block-414970b6787e47419f654a97bf3752f8"><div class="notion-table" style="width:1024px;max-width:1024px"><div class="notion-table-view" style="padding-left:96px;padding-right:96px"><div class="notion-table-header"><div class="notion-table-header-inner"><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:158px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M7.74 8.697a.81.81 0 01.073.308.894.894 0 01-.9.888.867.867 0 01-.825-.592l-.333-.961H2.058l-.333.961a.882.882 0 01-.838.592A.884.884 0 010 9.005c0-.11.025-.222.062-.308l2.403-6.211c.222-.58.776-.986 1.442-.986.653 0 1.22.407 1.442.986l2.39 6.211zM2.6 6.824h2.613L3.907 3.102 2.6 6.824zm8.8-3.118c1.355 0 2.6.542 2.6 2.255V9.08a.8.8 0 01-.789.814.797.797 0 01-.788-.703c-.395.468-1.097.764-1.874.764-.949 0-2.07-.64-2.07-1.972 0-1.392 1.121-1.897 2.07-1.897.789 0 1.491.246 1.886.727v-.826c0-.604-.518-.998-1.306-.998-.469 0-.888.123-1.32.394a.64.64 0 01-.307.086.602.602 0 01-.592-.604c0-.221.123-.419.284-.517a3.963 3.963 0 012.206-.641zm-.222 5.188c.505 0 .998-.172 1.257-.517v-.74c-.259-.345-.752-.517-1.257-.517-.616 0-1.122.332-1.122.9 0 .554.506.874 1.122.874zM.656 11.125h12.688a.656.656 0 110 1.313H.656a.656.656 0 110-1.313z"></path></svg><div class="notion-collection-column-title-body">名称</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:145px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M7 4.568a.5.5 0 00-.5-.5h-6a.5.5 0 00-.5.5v1.046a.5.5 0 00.5.5h6a.5.5 0 00.5-.5V4.568zM.5 1a.5.5 0 00-.5.5v1.045a.5.5 0 00.5.5h12a.5.5 0 00.5-.5V1.5a.5.5 0 00-.5-.5H.5zM0 8.682a.5.5 0 00.5.5h11a.5.5 0 00.5-.5V7.636a.5.5 0 00-.5-.5H.5a.5.5 0 00-.5.5v1.046zm0 3.068a.5.5 0 00.5.5h9a.5.5 0 00.5-.5v-1.045a.5.5 0 00-.5-.5h-9a.5.5 0 00-.5.5v1.045z"></path></svg><div class="notion-collection-column-title-body">标签</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:143px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M4.462 0c-.595 0-1.078.482-1.078 1.078v2.306H1.078a1.078 1.078 0 100 2.155h2.306v2.922H1.078a1.078 1.078 0 100 2.155h2.306v2.306a1.078 1.078 0 002.155 0v-2.306H8.46v2.306a1.078 1.078 0 002.156 0v-2.306h2.306a1.078 1.078 0 100-2.155h-2.306V5.539h2.306a1.078 1.078 0 100-2.155h-2.306V1.078a1.078 1.078 0 00-2.156 0v2.306H5.54V1.078C5.54.482 5.056 0 4.461 0zm1.077 8.46V5.54H8.46v2.92H5.54z"></path></svg><div class="notion-collection-column-title-body">数字</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:200px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M7 13A6 6 0 107 1a6 6 0 000 12zM3.751 5.323A.2.2 0 013.909 5h6.182a.2.2 0 01.158.323L7.158 9.297a.2.2 0 01-.316 0L3.751 5.323z"></path></svg><div class="notion-collection-column-title-body">单选</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:200px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M4 3a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zm0 4a1 1 0 011-1h7a1 1 0 110 2H5a1 1 0 01-1-1zM2 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2zm0 4a1 1 0 110-2 1 1 0 010 2z"></path></svg><div class="notion-collection-column-title-body">多选</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:200px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M0 3a3 3 0 013-3h8a3 3 0 013 3v8a3 3 0 01-3 3H3a3 3 0 01-3-3V3zm3-1.5A1.5 1.5 0 001.5 3v8A1.5 1.5 0 003 12.5h8a1.5 1.5 0 001.5-1.5V3A1.5 1.5 0 0011 1.5H3zm-.167 5.316l.566-.542.177-.17.347-.332.346.334.176.17 1.139 1.098 3.699-3.563.177-.17.347-.335.347.334.177.17.563.543.177.171.372.36-.372.36-.177.17-4.786 4.615-.177.171-.347.334-.347-.334-.177-.17-2.23-2.15-.177-.172-.375-.361.376-.36.179-.17z"></path></svg><div class="notion-collection-column-title-body">复选框</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:200px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M10.889 5.5H3.11v1.556h7.778V5.5zm1.555-4.444h-.777V0H10.11v1.056H3.89V0H2.333v1.056h-.777c-.864 0-1.548.7-1.548 1.555L0 12.5c0 .856.692 1.5 1.556 1.5h10.888C13.3 14 14 13.356 14 12.5V2.611c0-.855-.7-1.555-1.556-1.555zm0 11.444H1.556V3.944h10.888V12.5zM8.556 8.611H3.11v1.556h5.445V8.61z"></path></svg><div class="notion-collection-column-title-body">日期</div></div></div></div></div><div class="notion-table-th"><div class="notion-table-view-header-cell" style="width:200px"><div class="notion-table-view-header-cell-inner"><div class="notion-collection-column-title"><svg viewBox="0 0 14 14" class="notion-collection-column-title-icon"><path d="M5.946 14a4.975 4.975 0 01-3.497-1.415A4.731 4.731 0 011 9.174c0-1.288.515-2.5 1.449-3.41L7.456.986c1.345-1.313 3.722-1.318 5.08.007a3.453 3.453 0 010 4.961L8.03 10.241c-.867.847-2.293.848-3.17-.006a2.158 2.158 0 010-3.102l1.744-1.701 1.272 1.24-1.744 1.701a.43.43 0 000 .621c.23.223.405.223.636 0l4.503-4.288a1.723 1.723 0 00-.007-2.473c-.68-.663-1.864-.663-2.543 0L3.713 7.011a3.006 3.006 0 00-.915 2.163c0 .82.328 1.591.922 2.17 1.19 1.162 3.262 1.162 4.451 0l2.248-2.192 1.272 1.24-2.248 2.193A4.978 4.978 0 015.946 14z"></path></svg><div class="notion-collection-column-title-body">文件和媒体</div></div></div></div></div></div></div><div class="notion-table-header-placeholder"></div><div class="notion-table-body"><div class="notion-table-row"><div class="notion-table-cell notion-table-cell-title" style="width:158px"><span class="notion-property notion-property-title"><a class="notion-page-link" href="/61d1f3e3b5b248f1832e87e3910c1342"><span class="notion-page-title"><div class="notion-page-icon-inline notion-page-icon-image"><svg class="notion-page-title-icon notion-page-icon" alt="AAA" viewBox="0 0 30 30" width="16"><path d="M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z"></path></svg></div><span class="notion-page-title-text">AAA</span></span></a></span></div><div class="notion-table-cell notion-table-cell-text" style="width:145px"><span class="notion-property notion-property-text">123</span></div><div class="notion-table-cell notion-table-cell-number" style="width:143px"><span class="notion-property notion-property-number">123</span></div><div class="notion-table-cell notion-table-cell-select" style="width:200px"><span class="notion-property notion-property-select"><div class="notion-property-select-item notion-item-blue">A</div></span></div><div class="notion-table-cell notion-table-cell-multi_select" style="width:200px"><span class="notion-property notion-property-multi_select"><div class="notion-property-multi_select-item notion-item-gray">A</div></span></div><div class="notion-table-cell notion-table-cell-checkbox" style="width:200px"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-container"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><span class="notion-property-checkbox-text">复选框</span></div></span></div><div class="notion-table-cell notion-table-cell-date" style="width:200px"><span class="notion-property notion-property-date">Aug 21, 2024</span></div><div class="notion-table-cell notion-table-cell-file" style="width:200px"><span class="notion-property notion-property-file"><a target="_blank" rel="noreferrer noopener" class="notion-property-file" href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F718b7100-2e64-4ee7-a111-72971307ed0d%2Fanime-landscape-beyond-the-clouds-sunlight-horizon-scenic-anime-37603-3840x2160.jpeg?table=block&amp;id=61d1f3e3-b5b2-48f1-832e-87e3910c1342&amp;t=61d1f3e3-b5b2-48f1-832e-87e3910c1342&amp;width=800&amp;cache=v2"><img alt="anime-landscape-beyond-the-clouds-sunlight-horizon-scenic-anime-37603-3840x2160.jpeg" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F718b7100-2e64-4ee7-a111-72971307ed0d%2Fanime-landscape-beyond-the-clouds-sunlight-horizon-scenic-anime-37603-3840x2160.jpeg?table=block&amp;id=61d1f3e3-b5b2-48f1-832e-87e3910c1342&amp;t=61d1f3e3-b5b2-48f1-832e-87e3910c1342&amp;width=800&amp;cache=v2" loading="lazy"/></a></span></div></div><div class="notion-table-row"><div class="notion-table-cell notion-table-cell-title" style="width:158px"><span class="notion-property notion-property-title"><a class="notion-page-link" href="/1cb521a952084d05967a872b6665cc88"><span class="notion-page-title"><div class="notion-page-icon-inline notion-page-icon-image"><svg class="notion-page-title-icon notion-page-icon" alt="BBB" viewBox="0 0 30 30" width="16"><path d="M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z"></path></svg></div><span class="notion-page-title-text">BBB</span></span></a></span></div><div class="notion-table-cell notion-table-cell-text" style="width:145px"><span class="notion-property notion-property-text">321</span></div><div class="notion-table-cell notion-table-cell-number" style="width:143px"><span class="notion-property notion-property-number">231.1321</span></div><div class="notion-table-cell notion-table-cell-select" style="width:200px"><span class="notion-property notion-property-select"></span></div><div class="notion-table-cell notion-table-cell-multi_select" style="width:200px"><span class="notion-property notion-property-multi_select"><div class="notion-property-multi_select-item notion-item-purple">B</div><div class="notion-property-multi_select-item notion-item-green">C</div></span></div><div class="notion-table-cell notion-table-cell-checkbox" style="width:200px"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-container"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-checked"><svg viewBox="0 0 14 14"><path d="M5.5 12L14 3.5 12.5 2l-7 7-4-4.003L0 6.499z"></path></svg></div></span><span class="notion-property-checkbox-text">复选框</span></div></span></div><div class="notion-table-cell notion-table-cell-date" style="width:200px"><span class="notion-property notion-property-date">‣</span></div><div class="notion-table-cell notion-table-cell-file" style="width:200px"><span class="notion-property notion-property-file"></span></div></div><div class="notion-table-row"><div class="notion-table-cell notion-table-cell-title" style="width:158px"><span class="notion-property notion-property-title"><a class="notion-page-link" href="/02e280b440844ca9bd32c73fc7b56916"><span class="notion-page-title"><div class="notion-page-icon-inline notion-page-icon-image"><svg class="notion-page-title-icon notion-page-icon" alt="CCC" viewBox="0 0 30 30" width="16"><path d="M16,1H4v28h22V11L16,1z M16,3.828L23.172,11H16V3.828z M24,27H6V3h8v10h10V27z M8,17h14v-2H8V17z M8,21h14v-2H8V21z M8,25h14v-2H8V25z"></path></svg></div><span class="notion-page-title-text">CCC</span></span></a></span></div><div class="notion-table-cell notion-table-cell-text" style="width:145px"><span class="notion-property notion-property-text">abc</span></div><div class="notion-table-cell notion-table-cell-number" style="width:143px"><span class="notion-property notion-property-number"></span></div><div class="notion-table-cell notion-table-cell-select" style="width:200px"><span class="notion-property notion-property-select"><div class="notion-property-select-item notion-item-default">C</div></span></div><div class="notion-table-cell notion-table-cell-multi_select" style="width:200px"><span class="notion-property notion-property-multi_select"></span></div><div class="notion-table-cell notion-table-cell-checkbox" style="width:200px"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-container"><span class="notion-property notion-property-checkbox"><div class="notion-property-checkbox-unchecked"></div></span><span class="notion-property-checkbox-text">复选框</span></div></span></div><div class="notion-table-cell notion-table-cell-date" style="width:200px"><span class="notion-property notion-property-date">Aug 7, 2024</span></div><div class="notion-table-cell notion-table-cell-file" style="width:200px"><span class="notion-property notion-property-file"><a target="_blank" rel="noreferrer noopener" class="notion-property-file" href="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F9212f86c-fdc6-4392-87a4-007372332a2c%2FIMG_6909.jpg?table=block&amp;id=02e280b4-4084-4ca9-bd32-c73fc7b56916&amp;t=02e280b4-4084-4ca9-bd32-c73fc7b56916&amp;width=800&amp;cache=v2"><img alt="IMG_6909.JPG" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F9212f86c-fdc6-4392-87a4-007372332a2c%2FIMG_6909.jpg?table=block&amp;id=02e280b4-4084-4ca9-bd32-c73fc7b56916&amp;t=02e280b4-4084-4ca9-bd32-c73fc7b56916&amp;width=800&amp;cache=v2" loading="lazy"/></a></span></div></div></div></div></div></div><div class="notion-blank notion-block-9a520d4cd0a447458ea00181139f8d36"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-00c5cbb2a2d74154bf2160172a553ac0" data-id="00c5cbb2a2d74154bf2160172a553ac0"><span><div id="00c5cbb2a2d74154bf2160172a553ac0" class="notion-header-anchor"></div><a class="notion-hash-link" href="#00c5cbb2a2d74154bf2160172a553ac0" title="Embed "><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Embed </span></span></h3><div class="notion-text notion-block-8837239a4b4d4c59b07e289fb0f99031">PDF</div><figure class="notion-asset-wrapper notion-asset-wrapper-pdf notion-block-a29b4207aacf4513b7fdb877a3b38e20"><div style="position:relative;display:block;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:312.9985656738281px;overflow:auto;background:rgb(226, 226, 226);padding:8px 16px"></div></figure><div class="notion-blank notion-block-6d35b39e28124a169312c5a955a0bea1"> </div><div class="notion-text notion-block-4a0eb4ef405a4bba999d50e979e0ebfe">YouTube</div><figure class="notion-asset-wrapper notion-asset-wrapper-video notion-block-90d091fdbfa64c2c94b3cf2968cc597a"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;padding-bottom:56.20608899297424%"><link rel="preload" href="https://i.ytimg.com/vi/_ngbuYanRh8/hqdefault.jpg" as="image"/><div class="notion-yt-lite notion-asset-object-fit" style="object-fit:contain"><img src="https://i.ytimg.com/vi/_ngbuYanRh8/hqdefault.jpg" class="notion-yt-thumbnail" alt="Video preview"/><div class="notion-yt-playbtn"></div></div></div><figcaption class="notion-asset-caption">This is a caption</figcaption></figure><div class="notion-blank notion-block-74c3e1bec2744ed1b7d53074324d1df6"> </div><div class="notion-text notion-block-264f39cbe3544afe84f23b2faaa3a291">twitter</div><figure class="notion-asset-wrapper notion-asset-wrapper-tweet notion-block-5d190277c138446c89ccfb7ee7ec5ce0"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column"><div style="max-width:420px;width:100%;margin-left:auto;margin-right:auto"></div></div></figure><div class="notion-blank notion-block-43f62ed572324b56a616aa156d16db96"> </div><div class="notion-text notion-block-74c42aebbdd44c64ba35e22dfd937ddb">Spotify Playlist</div><figure class="notion-asset-wrapper notion-asset-wrapper-embed notion-block-0284e0a2f6874c448c7c03d250fe5e9b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:380px"><iframe class="notion-asset-object-fit" src="https://open.spotify.com/embed/playlist/2MgkBl2rQnPdF3WZ6ciajc" title="iframe embed" frameBorder="0" allowfullscreen="" loading="lazy" scrolling="auto"></iframe></div></figure><div class="notion-blank notion-block-00d895ef487c4f2999294e38efafbf8f"> </div><div class="notion-text notion-block-a5607310881448e2954818c27c0fa8a3">Google Maps</div><figure class="notion-asset-wrapper notion-asset-wrapper-maps notion-block-c2763e580ad245ac8837587f612b8e84"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:303px"><iframe class="notion-asset-object-fit" src="https://www.google.com/maps/embed/v1/place?key=AIzaSyD9HrlRuI1Ani0-MTZ7pvzxwxi4pgW0BCY&amp;q=Manhattan" title="iframe maps" frameBorder="0" allowfullscreen="" loading="lazy" scrolling="auto"></iframe></div></figure><div class="notion-blank notion-block-610e25f54f0d4a169a188c54843de71a"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[译：使 Rust library 兼容 no_std]]></title>
        <id>https://xxxuuu.me/post/rust-no-std</id>
        <link href="https://xxxuuu.me/post/rust-no-std"/>
        <updated>2024-09-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Effective Rust Item 33]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-4e5d7fc068d54165ba12b2d8bfc7d92c"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><blockquote class="notion-quote notion-block-108887563979808caa6bd32d05329ea6"><div>原文为 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://www.lurklurk.org/effective-rust/no-std.html">Effective Rust 第 33 条</a>，笔者将其翻译后提交至 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_6/item33-no-std.html">Effective Rust 中文版</a>，同步转载至此处</div></blockquote><div class="notion-blank notion-block-1088875639798017a6c3c5b80c00724a"> </div><div class="notion-text notion-block-108887563979803a95d6c0eb4d744a6d">Rust 附带一个名为 <code class="notion-inline-code">std</code> 的标准库，其中包含了从标准数据结构到网络，从多线程支持到文件 I/O 等用于各种常见任务的代码。为了方便使用， <code class="notion-inline-code">std</code> 中的一些项目会通过 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/prelude/index.html">prelude</a> 自动导入到你的程序中，<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/prelude/index.html">prelude</a> 是一组 <code class="notion-inline-code">use</code> 语句，可以在不需要指定完整名称的情况下直接使用这些常见类型（例如使用 <code class="notion-inline-code">Vec</code> 而不是 <code class="notion-inline-code">std::vec::Vec</code>）。</div><div class="notion-text notion-block-108887563979806299abedac8cb6b1b0">Rust 还支持为无法提供完整标准库的环境构建代码，如引导加载程序、固件或一般的嵌入式平台。通过在 <code class="notion-inline-code">src/lib.rs</code> 文件顶部添加 <code class="notion-inline-code">#![no_std]</code> 属性，可以指示 crate 在这类受限环境中编译。</div><div class="notion-blank notion-block-cd96fc048c7043529bc4d8cc1613a8f4"> </div><div class="notion-text notion-block-1088875639798048afd4c60654c69072">本节将探讨在 <code class="notion-inline-code">no_std</code> 环境中编译时我们会失去哪些功能，以及仍然可用的库函数。我们会发现，即使在这种受限环境中，依然有相当多的功能可供使用。</div><div class="notion-text notion-block-1088875639798059ab85ebbbc08e0b75">不过，这里特别关注的是针对<em>库</em>代码的 <code class="notion-inline-code">no_std</code> 支持。构建 <code class="notion-inline-code">no_std</code> <em>可执行</em>文件的复杂性超出了本文的范围<!-- -->，因此本节重点是对那些不得不在如此极简环境中工作的可怜人来说，如何确保库代码是可用的。</div><div class="notion-blank notion-block-10888756397980dcb205e010b60dc6f4"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-10888756397980568453ee4b2f910e69" data-id="10888756397980568453ee4b2f910e69"><span><div id="10888756397980568453ee4b2f910e69" class="notion-header-anchor"></div><a class="notion-hash-link" href="#10888756397980568453ee4b2f910e69" title="core"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><code class="notion-inline-code">core</code></span></span></h3><div class="notion-text notion-block-10888756397980f4978dfe99a34d3dfd">即使在为最受限的平台构建时，标准库中的许多基本类型也仍然可用。例如 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/core/option/enum.Option.html">Option</a></code> 和 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/core/result/enum.Result.html">Result</a></code> 以及各种 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/core/iter/trait.Iterator.html">Iterator</a></code>，尽管它们名称不同。</div><div class="notion-text notion-block-10888756397980709d6dcc1b81595cc8">这些基本类型的不同名称以 <code class="notion-inline-code">core::</code> 开头，表明它们来自 <code class="notion-inline-code">core</code> 库，这是一个即使在大多数 <code class="notion-inline-code">no_std</code> 环境中也可用的标准库。这些 <code class="notion-inline-code">core::</code> 类型的行为与等效的 <code class="notion-inline-code">std::</code> 类型完全相同，因为它们实际上是同个类型 —— 对应的 <code class="notion-inline-code">std::</code> 版本都只是底层 <code class="notion-inline-code">core::</code> 类型的重新导出。</div><div class="notion-text notion-block-108887563979801383c5c66db1561c59">这意味着有一种快速而肮脏的方法来判断某个 <code class="notion-inline-code">std::</code> 项目在 <code class="notion-inline-code">no_std</code> 环境中是否可用： 访问 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/index.html">doc.rust-lang.org</a></code> 并找到感兴趣的 <code class="notion-inline-code">std</code> 项目，点击 “soure”（在右上角）<!-- -->，如果它跳转到了 <code class="notion-inline-code">src/core/...</code> 中，则说明该项可通过 <code class="notion-inline-code">core::</code> 在 <code class="notion-inline-code">no_std</code> 下使用。</div><div class="notion-text notion-block-1088875639798045bdb0c9efafb664ea">正常情况下 <code class="notion-inline-code">core</code> 中的类型可自动用于所有 Rust 程序。但在 <code class="notion-inline-code">no_std</code> 环境需要显式 <code class="notion-inline-code">use</code>，因为此时没有 <code class="notion-inline-code">std</code> <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/prelude/index.html">prelude</a> 帮忙导入。</div><div class="notion-blank notion-block-10888756397980eda2e2f4e3be071e1a"> </div><div class="notion-text notion-block-10888756397980b486abd025eb3480af">实际中，对于许多环境（甚至是 <code class="notion-inline-code">no_std</code>）来说，纯粹依赖 <code class="notion-inline-code">core</code> 会有很大的限制，因为 <code class="notion-inline-code">core</code> 的一个核心（双关语）约束是它不会进行堆分配。</div><div class="notion-text notion-block-72adfc34c8bc43df8b760eedd034a3b6">虽然 Rust 很擅长将数据放入栈中并安全地跟踪其相应的生命周期（<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_3/item14-lifetimes.html">第 14 条</a>），但 <code class="notion-inline-code">core</code> 的这种限制仍然意味着无法提供标准数据结构（vector, map, set），因为它们都需要分配堆空间来存放内部元素。所以这个限制也大大减少了在此环境中可用的 crate 数量。</div><div class="notion-blank notion-block-708cc73e18f24cd8ad23e5e7d7f3cfbe"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1088875639798062b41fd9d4aaaea292" data-id="1088875639798062b41fd9d4aaaea292"><span><div id="1088875639798062b41fd9d4aaaea292" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1088875639798062b41fd9d4aaaea292" title="alloc"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title"><code class="notion-inline-code">alloc</code></span></span></h3><div class="notion-text notion-block-1088875639798021991ade4a5f52027b">但如果所在的 <code class="notion-inline-code">no_std</code> 环境<em>的确</em>支持堆分配，则 <code class="notion-inline-code">std</code> 中的许多标准数据结构仍然可用。这些数据结构以及其他使用分配功能的部分被分组到 Rust 的 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/">alloc</a></code> 库中。</div><div class="notion-text notion-block-10888756397980ac8918fff831f2e55e">和 <code class="notion-inline-code">core</code> 一样，这些 <code class="notion-inline-code">alloc</code> 变体实际上在底层是相同的类型。例如 <code class="notion-inline-code">std::vec::Vec</code> 的真实名称是 <code class="notion-inline-code">alloc::vec::Vec</code>。</div><div class="notion-text notion-block-1088875639798007854ad13605b16c12">如果 <code class="notion-inline-code">no_std</code> 的 crate 要使用 <code class="notion-inline-code">alloc</code>，需要在 <code class="notion-inline-code">src/lib.rs</code> 额外显式声明 <code class="notion-inline-code">extern crate alloc;</code>：</div><div class="notion-text notion-block-10888756397980929453d80071d6020d">引入 <code class="notion-inline-code">alloc</code> 库可以启用许多我们熟悉的朋友，现在他们以真实的名称被称呼：</div><ul class="notion-list notion-list-disc notion-block-10888756397980a6928cc9fc25bf3308"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/boxed/struct.Box.html">alloc::boxed::Box&lt;T&gt;</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-1088875639798051ba76f7415fee5e77"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/rc/struct.Rc.html">alloc::rc::Rc&lt;T&gt;</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-108887563979805b8ad9cfcc858a919c"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/sync/struct.Arc.html">alloc::sync::Arc&lt;T&gt;</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980e4ad6bf61e73b82ba9"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/vec/struct.Vec.html">alloc::vec::Vec&lt;T&gt;</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-108887563979803e968bdb31ec5e9522"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/string/struct.String.html">alloc::string::String</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-00caf07629244a208180fffe6dce0b88"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/macro.format.html">alloc::format!</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980518c8edaa2a444efc1"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/collections/btree_map/struct.BTreeMap.html">alloc::collections::BTreeMap&lt;K, V&gt;</a></code></li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980488288ef53618b1812"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/alloc/collections/btree_set/struct.BTreeSet.html">alloc::collections::BTreeSet&lt;T&gt;</a></code></li></ul><div class="notion-text notion-block-1088875639798059b17fdef07f08f7ca">有了这些朋友，许多 crate 就可以兼容 <code class="notion-inline-code">no_std</code> —— 前提是不涉及 I/O 或网络。</div><div class="notion-blank notion-block-108887563979802ba753dd3b1416c1b5"> </div><div class="notion-text notion-block-10888756397980969b4ff738c318624c">但 <code class="notion-inline-code">alloc</code> 提供的数据结构显然还缺少了两个集合 —— <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/collections/struct.HashMap.html">HashMap</a></code> 和 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/collections/hash_set/struct.HashSet.html">HashSet</a></code>，它们特定于 <code class="notion-inline-code">std</code> 而不是 <code class="notion-inline-code">alloc</code>。这是因为这些基于 hash 的容器依靠随机种子来防止 hash 冲突攻击，但安全的随机数生成需要依赖操作系统的帮助，而 <code class="notion-inline-code">alloc</code> 不能假设操作系统存在。</div><div class="notion-text notion-block-10888756397980e5a55fd146d1a0e50b">另一个缺失的部分是同步功能，例如 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/sync/struct.Mutex.html">std::sync::Mutex</a></code>，这是多线程代码所必需的，但这些类型同样特定于 <code class="notion-inline-code">std</code>，它们依赖操作系统的同步原语，如果没有操作系统，这些同步原语也将不可用。在 <code class="notion-inline-code">no_std</code> 下编写多线程代码，第三方 crate 可能是唯一选择，例如 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://docs.rs/spin/">spin</a></code>。</div><div class="notion-blank notion-block-108887563979807d8f33c1c580350243"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-b136e054ee354a9898d49e7b10035bdd" data-id="b136e054ee354a9898d49e7b10035bdd"><span><div id="b136e054ee354a9898d49e7b10035bdd" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b136e054ee354a9898d49e7b10035bdd" title="为 no_std 编写代码"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">为 <code class="notion-inline-code">no_std</code> 编写代码</span></span></h3><div class="notion-text notion-block-523e6640cd514ad6be025ca8a9dc0bfc">前文已经指出，对于<em>某些</em> crate 库，要使代码兼容 <code class="notion-inline-code">no_std</code> 只需要以下修改：</div><ul class="notion-list notion-list-disc notion-block-1088875639798051b4fbf2367575a088"><li>用相同的 <code class="notion-inline-code">core::</code> 或 <code class="notion-inline-code">alloc::</code> crate 替换 <code class="notion-inline-code">std::</code> 类型（由于缺少 <code class="notion-inline-code">std</code> prelude，还需要 <code class="notion-inline-code">use</code> 完整的类型名称）</li></ul><ul class="notion-list notion-list-disc notion-block-108887563979803d8f16ee1cf9f6a4e9"><li>将 <code class="notion-inline-code">HashMap</code> / <code class="notion-inline-code">HashSet</code> 迁移为 <code class="notion-inline-code">BTreeMap</code> / <code class="notion-inline-code">BTreeSet</code></li></ul><div class="notion-text notion-block-1088875639798097b07cee83750742f5">但这些操作只有在依赖的所有 crate（<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_4/item25-dep-graph.html">第 25 条</a>）也兼容 <code class="notion-inline-code">no_std</code> 时才有意义 —— 如果使用您 crate 的用户被迫链接到任何 <code class="notion-inline-code">std</code> 中，与 <code class="notion-inline-code">no_std</code> 的兼容就会失去意义。</div><div class="notion-blank notion-block-1088875639798045b0adc8fbe058f20c"> </div><div class="notion-text notion-block-10888756397980778938e9aef4bc13f5">这里还有一个问题：Rust 编译器并不会告诉你一个 <code class="notion-inline-code">no_std</code> crate 中是否有引入使用了 <code class="notion-inline-code">std</code> 的依赖。这意味着只要添加或更新一个使用了 <code class="notion-inline-code">std</code> 的依赖，就能轻松破坏掉 <code class="notion-inline-code">no_std</code> crate 的兼容性。</div><div class="notion-text notion-block-108887563979807c80abf91e166edb8a">为了避免这个情况，<b>请为 </b><code class="notion-inline-code"><b>no_std</b></code><b> 构建添加 CI 检查</b>，以便 CI 系统（<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_5/item32-ci.html">第 32 条</a>）能在这种情况发生时发出警告。Rust 工具链支持开箱即用的交叉编译，因此只需为不支持 <code class="notion-inline-code">std</code> 的目标系统（例如 <code class="notion-inline-code">--target thumbv6m-none-eabi</code>）执行<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://www.reddit.com/r/rust/comments/ef8nd9/how_to_avoid_accidentally_breaking_no_std/fbyz6ix/">交叉编译</a>，任何无意中依赖 <code class="notion-inline-code">std</code> 的代码就会在此时编译失败。</div><div class="notion-blank notion-block-aa5cfbb4c6d143d5801c9850ee0cb3e4"> </div><div class="notion-text notion-block-108887563979806c9a57ce3a4ce30b88">所以，如果依赖项都支持，并且上面的简单修改就够了的话，不妨<b>考虑让库代码兼容 </b><code class="notion-inline-code"><b>no_std</b></code>。这不需要太多额外工作，却能让库有更广泛的适用性。</div><div class="notion-text notion-block-c93a6756928e4fbaba484854f00829a9">如果这些转换并<em>没有</em>覆盖 crate 中的所有代码，但未覆盖的只是代码中的一小部分或包装良好的部分，那么可以考虑向 crate 添加一个 feature （<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_4/item26-features.html">第 26 条</a>）以控制是否启用这部分代码。</div><div class="notion-text notion-block-10888756397980baad86c80095a09281">这种允许使用 <code class="notion-inline-code">std</code> 特定功能的 feature ，通常会将其命名为 <code class="notion-inline-code">std</code>：</div><div class="notion-text notion-block-10888756397980258db0c63f805799d6">或是将控制是否启用了 <code class="notion-inline-code">alloc</code> 派生功能的 feature 命名为 <code class="notion-inline-code">alloc</code>：</div><div class="notion-text notion-block-108887563979806cad61d689708df697">注意，设计这类 feature 时有个容易忽视的陷阱：不要设置一个 <code class="notion-inline-code">no_std</code> feature 来<em>禁用</em>需要 <code class="notion-inline-code">std</code> 的功能（或类似的 <code class="notion-inline-code">no_alloc</code> feature），正如<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_4/item26-features.html">第 26 条</a>中提到的，feature 应当是可累加的，这样做会导致无法将启用了 <code class="notion-inline-code">no_std</code> 和没有启用的两个 crate 用户组合在一起 —— 前者会删除后者所依赖的代码。</div><div class="notion-text notion-block-108887563979804e9194c3c8b549aaa4">和所有带有 feautre 门控的代码一样，确保你的 CI 系统（<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://rustx-labs.github.io/effective-rust-cn/chapter_5/item32-ci.html">第 32 条</a>）构建了所有相关的组合 —— 包括在 <code class="notion-inline-code">no_std</code> 平台上关闭 <code class="notion-inline-code">std</code> 特性的构建。</div><div class="notion-blank notion-block-108887563979807e9f5deb91cc862392"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-15b50c7db2944e88aadd48fa3ee8ddc6" data-id="15b50c7db2944e88aadd48fa3ee8ddc6"><span><div id="15b50c7db2944e88aadd48fa3ee8ddc6" class="notion-header-anchor"></div><a class="notion-hash-link" href="#15b50c7db2944e88aadd48fa3ee8ddc6" title="可错分配（Fallible Allocation）"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">可错分配（Fallible Allocation）</span></span></h3><div class="notion-text notion-block-5f5f0f497cc046a1b82c722743a16d83">前面考虑了两种不同的 <code class="notion-inline-code">no_std</code> 环境：不允许堆分配的完全嵌入式的环境（<code class="notion-inline-code">core</code>）和允许堆分配的更宽松的环境（<code class="notion-inline-code">core</code> + <code class="notion-inline-code">alloc</code>）。</div><div class="notion-text notion-block-10888756397980649d39ef55aca5e09c">然而，有一些重要的环境介于两者之间，特别是那些允许堆分配但可能会失败的环境，因为堆空间是有限的。</div><div class="notion-text notion-block-10888756397980aebf42c6f98bab8b63">不幸的是，Rust 的标准 <code class="notion-inline-code">alloc</code> 库假设堆分配不会失败，但这个假设并不总是成立。</div><div class="notion-text notion-block-10888756397980708731dfcd2a0be069">即使简单地使用 <code class="notion-inline-code">alloc::vec::Vec</code>，也可能在每一行代码中都触发分配：</div><div class="notion-text notion-block-1088875639798029be9bffa30a74fb6d">这些操作都不会返回 <code class="notion-inline-code">Result</code>，当这些分配失败了，会发生什么？</div><div class="notion-text notion-block-1088875639798031be64d0798fd0cd28">答案取决于工具链、目标平台和<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/alloc/fn.set_alloc_error_hook.html">配置</a>，但很可能会导致 <code class="notion-inline-code">panic!</code> 和程序终止。这里无法通过某种方式处理第 3 行的分配失败，并让程序继续执行第 4 行。</div><div class="notion-blank notion-block-1088875639798020b028c2e9eef507f5"> </div><div class="notion-text notion-block-108887563979807ba714c77b96412670">这种<em>可靠分配</em>（infallible allocation）的假设简化了在“正常”用户空间中运行的代码，因为在这些环境中，内存几乎是无限的 —— 或者内存耗尽意味着计算机本身出现了更严重的问题。</div><div class="notion-text notion-block-10888756397980fabd6ceda70c8bfc73">但可靠分配不适用于内存有限且程序必须应对内存不足的环境。这是一个在一些较老、内存安全性较差的语言中反而有更好支持的（罕见）领域：</div><ul class="notion-list notion-list-disc notion-block-b47475a0211a4c7b913bab48a624d3de"><li>C 的级别足够低，分配是手动的，因此可以检查 <code class="notion-inline-code">malloc</code> 的返回值是否为 <code class="notion-inline-code">NULL</code>。</li></ul><ul class="notion-list notion-list-disc notion-block-108887563979800093b1f02a344054be"><li>C++ 可以使用异常机制，捕获以 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://en.cppreference.com/w/cpp/memory/new/bad_alloc">std::bad_alloc</a></code> 异常形式出现的分配失败<!-- -->。</li></ul><div class="notion-text notion-block-10888756397980f5b85cc6609da423e6">历史上，Rust 标准库无法处理分配失败的问题在一些备受瞩目的场合（如 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://lkml.org/lkml/2021/4/14/1099">Linux 内核</a>、Android 和 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/hyperium/hyper/issues/2265#issuecomment-693194229">Curl 工具</a>）中被指出，因此修复这一缺陷的工作正在进行中。</div><div class="notion-blank notion-block-10888756397980639e32edc76ebac631"> </div><div class="notion-text notion-block-108887563979803c9d3af6e6dd0cc425">第一个尝试是<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/rust-lang/rfcs/pull/2116">添加“可错的集合分配”</a>，它为许多涉及分配的集合 API 添加了允许可错分配的替代实现，通常是添加一个会返回 <code class="notion-inline-code">Result&lt;_, AllocError&gt;</code> 的 <code class="notion-inline-code">try_&lt;operation&gt;</code> 操作，例如：</div><ul class="notion-list notion-list-disc notion-block-108887563979807a97b2c7ed9898a882"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.try_reserve">Vec::try_reserve</a></code> 作为 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.reserve">Vec::reserve</a></code> 的替代品</li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980b4b7b2fc3c049ec049"><li><code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.try_new">Box::try_new</a></code> 作为 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.new">Box::new</a></code> 的替代品（在 nightly toolchain 中可用）</li></ul><div class="notion-text notion-block-108887563979801da7b2cadad00076d9">但这些允许可错分配的 API 功能也仅限于此。例如，（目前为止）还没有与 <code class="notion-inline-code">Vec::push</code> 等效的可错分配版本，因此编写组装 vector 的代码时，可能需要进行精确计算，以确保不会发生内存分配错误。</div><div class="notion-text notion-block-108887563979806782dcf8e37d6344e9">除了增加允许可错分配的入口外，还可以通过关闭默认开启的 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/rust-lang/rust/pull/84266">no_global_oom_handling</a></code> 配置来禁用<em>可靠</em>分配操作。在堆内存有限的环境（如 Linux 内核）中，可以显式禁用此标志，以确保不会在代码中无意使用了可靠分配。</div><div class="notion-blank notion-block-10888756397980d9b77bce0283bfec0b"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-1088875639798083946ddccff431121f" data-id="1088875639798083946ddccff431121f"><span><div id="1088875639798083946ddccff431121f" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1088875639798083946ddccff431121f" title="要记住的事"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">要记住的事</span></span></h3><ul class="notion-list notion-list-disc notion-block-108887563979805b880ade0916d7e173"><li><code class="notion-inline-code">std</code> crate 中的许多项目实际上来自 <code class="notion-inline-code">core</code> 或 <code class="notion-inline-code">alloc</code>。</li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980e6ab6af5235bc11333"><li>因此，使库代码兼容 <code class="notion-inline-code">no_std</code> 可能比您想象的更简单。</li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980599fe6e67b1050ca53"><li>通过在 CI 中检查 <code class="notion-inline-code">no_std</code> 代码来确认 <code class="notion-inline-code">no_std</code> 代码保持 <code class="notion-inline-code">no_std</code> 兼容。</li></ul><ul class="notion-list notion-list-disc notion-block-10888756397980ad904fc4f8c94a097b"><li>注意，当前支持在有限堆环境中工作的库十分有限。</li></ul><div class="notion-blank notion-block-1088875639798015b7efc57b63666050"> </div><h4 class="notion-h notion-h3 notion-h-indent-1 notion-block-108887563979806d828aedb5b9c6954b" data-id="108887563979806d828aedb5b9c6954b"><span><div id="108887563979806d828aedb5b9c6954b" class="notion-header-anchor"></div><a class="notion-hash-link" href="#108887563979806d828aedb5b9c6954b" title="注释"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">注释</span></span></h4><ol start="1" class="notion-list notion-list-numbered notion-block-d4e691d2f9bb418d863177225b32915c"><li>有关创建 <code class="notion-inline-code">no_std</code> 可执行文件所涉及的内容，请参阅 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://docs.rust-embedded.org/embedonomicon/">The Embedonomicon</a> 或 Philipp Opperamann 的<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://os.phil-opp.com/freestanding-rust-binary/">早期博客文章</a>。</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-108887563979803c9107e1b9770c5cec"><li>注意，该方法不一定正确。例如在撰写本文时，<code class="notion-inline-code">Error</code> trait 在 <code class="notion-inline-code">[core::]</code> 中定义，但被标记为不稳定（unstable），只有 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/1.70.0/std/error/trait.Error.html">std::</a></code><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/1.70.0/std/error/trait.Error.html"> 版本</a>是稳定的（stable）</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-f89a9c50d1f04d88a86dc27e88b2abc0"><li>在 Rust 2018 之前，<code class="notion-inline-code">extern crate</code> 声明用来引入依赖项。现在这些依赖完全由 <code class="notion-inline-code">Cargo.toml</code> 处理，但仍使用 <code class="notion-inline-code">extern crate</code> 机制引入那些 <code class="notion-inline-code">no_std</code> 环境中 Rust 标准库的可选部分（即 <em><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://doc.rust-lang.org/edition-guide/rust-2018/path-changes.html#an-exception">sysroot crates</a></em>）。</li></ol><ol start="4" class="notion-list notion-list-numbered notion-block-dae2425cd32046c7b806ebd9742e4281"><li>还可以为 <code class="notion-inline-code">new</code> 调用添加 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://en.cppreference.com/w/cpp/memory/new/nothrow">std::nothrow</a></code> 重载，并检查是否返回 <code class="notion-inline-code">nullptr</code>。但一些容器方法比如 <code class="notion-inline-code"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://en.cppreference.com/w/cpp/container/vector/push_back">vector&lt;T&gt;::push_back</a></code>，在内部进行分配，因此只能通过抛出异常来表示分配失败。</li></ol><div class="notion-blank notion-block-f364c3fb680f4507981e817627f5600c"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Longhorn 浅析]]></title>
        <id>https://xxxuuu.me/post/longhorn</id>
        <link href="https://xxxuuu.me/post/longhorn"/>
        <updated>2024-08-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-bde25ba823814da6bb5e5787ace45def"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><div class="notion-blank notion-block-558e14006fe1422cbf7fc8b2f8deb43c"> </div><div class="notion-text notion-block-a27b268070864f4cbd2715352ef1ce82">Longhorn 是一个 Go 实现的 Cloud Native Storage，比较好奇作为一个提供块存储的分布式存储系统，使用 Go 实现，会面临哪些挑战，性能方面要又要如何优化</div><div class="notion-blank notion-block-301a3fb6101147f18b36213676033414"> </div><div class="notion-text notion-block-c05865d57daa4abb98d93927c381a6e5">从宏观视角来看，Longhorn 的数据流如下， Engine 是 volume 的 controller，每个 volume 都会有一个 engine 实例，replica 是卷的一个副本实例，负责具体的落盘，显然 Engine 就是数据面的核心</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-f09b7b63717c43f58e2d00daafae5408"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F74bdb399-f643-4c60-af08-0435670cf958%2FUntitled.png?table=block&amp;id=f09b7b63-717c-43f5-8e2d-00daafae5408&amp;t=f09b7b63-717c-43f5-8e2d-00daafae5408&amp;width=3012&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-2ac29b2fe2b04d3cb6887163a7b9475c">Longhorn 是控制面则是基于 K8s 的，所有资源都以 K8s CRD 提供，通过 Operator 管控，称为 Manager</div><div class="notion-blank notion-block-8b5b62ca50dd42c8bb35c986c2eeefa1"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-7bba19424d114d388f9393df77e91948" data-id="7bba19424d114d388f9393df77e91948"><span><div id="7bba19424d114d388f9393df77e91948" class="notion-header-anchor"></div><a class="notion-hash-link" href="#7bba19424d114d388f9393df77e91948" title="V1 Engine"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">V1 Engine</span></span></h2><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-b7063a8fa46a434181a452d52e494be3" data-id="b7063a8fa46a434181a452d52e494be3"><span><div id="b7063a8fa46a434181a452d52e494be3" class="notion-header-anchor"></div><a class="notion-hash-link" href="#b7063a8fa46a434181a452d52e494be3" title="Replica"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Replica</span></span></h3><div class="notion-text notion-block-ac953debb2294ea4955a3907f2d4c26e">Engine 有 V1 和 V2 两个版本，先从 V1 Engine 开始分析，自底向上看，最下面的是 replica。replica server 在启动时就会创建/打开对应的 replica，然后启动两个 grpc server，分别处理控制流和数据流</div><div class="notion-blank notion-block-948f2c7c876444488997463e10737272"> </div><div class="notion-text notion-block-dea92143e9cc4454ac8a47e67e6deff5">replica 在节点上对应一组 sparse file，代码中这个结构称为 <code class="notion-inline-code">diffDisk</code>，每个 file 有点类似于 LSM-Tree 中的 layer/level，这里称为 snapshot（除了最新一层叫 head/live data）：</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-c0ea8054fb6646609340c9e8e46a1185"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:576px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F09606cc3-8f19-4e2f-9a02-c9c0ace747f9%2FUntitled.png?table=block&amp;id=c0ea8054-fb66-4660-9340-c9e8e46a1185&amp;t=c0ea8054-fb66-4660-9340-c9e8e46a1185&amp;width=1152&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-84d974d484744992909a067236352d38">每个 <code class="notion-inline-code">diffDisk</code> 的元数据存在一个 <code class="notion-inline-code">volume.meta</code> 文件中，还会有一个 <code class="notion-inline-code">revision.counter</code> 文件记录写入的版本号。每一层 file 划分为多个 4K 大小的 sector，这是写入的最小单元，因为都是 sparse file，所以 Longhorn 的卷自然支持精简配置。file 之间从新到旧连接起来，索引表 <code class="notion-inline-code">location</code> 则存储 sector 位于哪一个 file 中</div><div class="notion-blank notion-block-01378c9a591b4f45943571fe10dd271f"> </div><div class="notion-text notion-block-fa074d7b3d934f53a68dd46949b39809">读写流程</div><ul class="notion-list notion-list-disc notion-block-e667a8553d764888b6c0c4180da37b75"><li>写入时先自增 revision，元数据中标为为 dirty，这里 revision 会落盘，但元数据不会。然后在 <code class="notion-inline-code">diffDisk</code> 只会写入最新的一层，即 live data 或 head，是原地写入的，同时更新索引。前面提到 sector 是写入最小单元，如果写入不够一个 sector，就会先读出原数据，修改后再写</li></ul><ul class="notion-list notion-list-disc notion-block-b43e47110e5a4c76ab01abd21773aa37"><li>读取时从索引中找到 sector 对应第几层的 file，如果找到就直接去读。否则从新到旧的 file 查找，对于每一个 file 使用 FIEMAP ioctl 查询指定范围内是否存在 extent，是则说明 sector 位于这个 file 中，更新索引后读取</li></ul><div class="notion-blank notion-block-d00ff36106d24fc2aec64382971c546f"> </div><div class="notion-text notion-block-3477863df7d647a29e30c35ff77d444a">快照&amp;扩容流程</div><ul class="notion-list notion-list-disc notion-block-31eec8634d574064839f5d742db75ef3"><li>快照：快照很简单，只是创建一个新的 head。删除就是将其内容覆盖到上一层 snapshot 中</li></ul><ul class="notion-list notion-list-disc notion-block-6761eac08c074bf6ac15bb5702cabd8a"><li>扩容：创建一个新的 head，相当于打了个快照，head 的大小被 truncate 为扩容后的大小，同时还需要修改元数据。由于 sector 变多了，<code class="notion-inline-code">diffDisk</code> 内的 <code class="notion-inline-code">location</code> 索引表也要扩容</li></ul><div class="notion-blank notion-block-e209bbbcc5a54a7ca6cb3196ca30f373"> </div><div class="notion-text notion-block-5561d5c90b2b4db6a6edf1b47e382aa1">一开始还以为 <code class="notion-inline-code">diffDisk</code> 会是类似 RocksDB 这种 LSM-Tree based 的存储引擎，但完全不是一回事。它没有存储引擎必须的各种功能，可以说只是一个能支持 snapshot 的数据格式</div><div class="notion-text notion-block-f9d9524df630451ba766cb16c3c63f75">首先接口语义上，<code class="notion-inline-code">diffDisk</code> 是为块存储设计的，并不是 key-value 的，或者说 key 就是 offset；也没有删除接口，只有读和写。不过这也问题不大，块存储本身也没有“删除”的概念，真要添加删除接口也可以通过写入墓碑标记实现</div><div class="notion-text notion-block-071e3692288c43178c67a3910049b00d"><code class="notion-inline-code">diffDisk</code> 中单个文件的数据布局和元数据维护是依赖文件系统的 extent 功能实现的，没有定义自己的格式。所以这套实现对文件系统有要求，需要支持 extent 功能，优点是文件很“干净“，这里如果没有 snapshot，实际上就是对单个文件的直接读写。但反之可以说没有任何优化，性能需要打个问号</div><div class="notion-text notion-block-d7a2c34e356e42d0a6983d2151404de8">同时它没有 WAL，无法保证崩溃一致性。这种情况需要 rebuild，更不用提快照（revision）读和事务之类的功能了。rebuild 这些操作都依赖上层控制面触发，后续会提到</div><div class="notion-blank notion-block-80f037a748eb4cdead71a0cad980a13e"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-68047b47005d4e7f8dc2ec22c348a0ce" data-id="68047b47005d4e7f8dc2ec22c348a0ce"><span><div id="68047b47005d4e7f8dc2ec22c348a0ce" class="notion-header-anchor"></div><a class="notion-hash-link" href="#68047b47005d4e7f8dc2ec22c348a0ce" title="Controller"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Controller</span></span></h3><div class="notion-text notion-block-5b30fff5ac8547668a0e4cc9e4e63060">Controller 负责整个 volume 视角的读写，它被调度在和最终 client 的 Pod 相同的节点上，从 frontend 中接受读写请求，往后连接到一个或多个 replica 上，将读写转发给这些 replica</div><div class="notion-text notion-block-b740d7c8ba6b4d0dbf4500769d6b8fa1">为了避免和 K8s 中的 Controller 混淆，后面都直接称这个 Controller 为 Engine</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-6080c1ce0625443ba0dcfc07904694e3"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fd7d422a8-aa34-4ff3-b059-b898eb14bf56%2FUntitled.png?table=block&amp;id=6080c1ce-0625-443b-a0dc-fc07904694e3&amp;t=6080c1ce-0625-443b-a0dc-fc07904694e3&amp;width=1056&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-b15c19b27cf1414e87710ef828778f27"> </div><div class="notion-text notion-block-845f783b6e76486380cba501c2ab288e">Engine 启动时会监听一个 UDS（<code class="notion-inline-code">/var/run/longhorn-{volume-name}.sock</code>），同时创建 frontend，frontend 实际上就是一个 iSCSI Target，通过<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/rancher/tgt">定制的 tgtd</a> 创建，这个定制 tgtd 做的工作不多，主要是能支持将 iSCSI 流量包装成 Longhorn 自己的一个简单协议转发到前面的 UDS 中</div><div class="notion-text notion-block-bfb2ab66dca24e3e963f0d9cdbe5db92">协议结构如下：</div><div class="notion-text notion-block-f58864b6b95c4ceb8dd8d8f6fea37fe8">有了 iSCSI Target 后，还需要启动 iSCSI Initator 连接这个 Target，这步的目的是需要创建出一个块设备，然后通过 mknod 指定相同的主次设备号再创建出 <code class="notion-inline-code">/dev/longhorn/{vol_name}</code>。这就是 client 最终直接操作的设备，对它的 I/O 会一路到 Initator → Target → UDS 上。到此 frontend 就算创建完成</div><div class="notion-blank notion-block-ec72c51e348449f69c3cafe735b4ec2c"> </div><div class="notion-text notion-block-8a914f1feca04c7eac4cfd909ab9f4b3">Engine 之后为 volume 的每一个 replica 创建对应的 backend(replicator)，并维持心跳。会从前面监听的 UDS 中解析协议并转发给 replica</div><div class="notion-text notion-block-f08581e62d684580b7892a44743bc72e">具体读写上 Engine 通过一个读写锁控制并发，read 只要任一一个 replica 成功即可，用的 round-robin 的策略做 balance。write 和 unmap 等操作是并发执行的，要求全部成功。IOPS 之类的监控和统计也在这个层级实现</div><div class="notion-text notion-block-2cb0b40891c0483aa64ef60bdccf5026">最后 Engine 会再启动一个 grpc server，处理控制流，例如卷扩容、快照等命令，也是通过 backend(replicator) 转发到 replica 上执行的。当然，这里调用的是处理控制流的 grpc server</div><div class="notion-blank notion-block-88d58d5b4d6f4a50b3ec76d208033133"> </div><div class="notion-text notion-block-dfa25c88d5f3451797c360a81e00e59a">这里有一个优化，如果 volume 只有一个 replica（单副本）且设置了 struct local 模式。Manager 会将 replica 调度到和 Engine 同一个节点上。Engine 在创建 backend 时就会通过 UDS 连接而不是 TCP 连接。这种本地化的策略能够有效提升 IOPS 和改善延迟，不过这里约束了只能用单副本，限制比较大</div><div class="notion-text notion-block-d1435b2bc5a744348d3615e683aebc70">虽然 Engine 自身是单点，但是它运行在和 client 相同的节点上，因此如果节点故障，一般 client 也会同时不可用，是个不错的策略</div><div class="notion-blank notion-block-9d5c6878fd1743ffbc06d9bf48d7ae83"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-1f5cc8783c964b378a81a49efab11384" data-id="1f5cc8783c964b378a81a49efab11384"><span><div id="1f5cc8783c964b378a81a49efab11384" class="notion-header-anchor"></div><a class="notion-hash-link" href="#1f5cc8783c964b378a81a49efab11384" title="Manager"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Manager</span></span></h2><div class="notion-text notion-block-a6622edd4b28456a82631d11a44b11d6">一开始提到，Longhorn 的控制面是作为 K8s Operator 实现的，称为 Manager。Longhorn 里所有元数据，包括 Engine 和 Replica 都以 CRD 呈现。</div><div class="notion-text notion-block-493cb66e845a4ecd852d50700e1ee1ac">这套方案的优点是很多东西都能依赖 K8s 的能力提供和管理，还能很好地融入生态。但同样很多元数据操作的链路都要通过 K8s，感觉还是会比较慢，也限制了规模和能力</div><div class="notion-blank notion-block-7ec3e975990b45568d8190e2e4baaba9"> </div><h3 class="notion-h notion-h2 notion-h-indent-1 notion-block-5302560a92db4fe1828ee3481a827c60" data-id="5302560a92db4fe1828ee3481a827c60"><span><div id="5302560a92db4fe1828ee3481a827c60" class="notion-header-anchor"></div><a class="notion-hash-link" href="#5302560a92db4fe1828ee3481a827c60" title="rebuild &amp; add replica"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">rebuild &amp; add replica</span></span></h3><div class="notion-text notion-block-fbd6f38ab64f4cc097720f73a67f3d07">如果 Engine 到某个 replica 心跳失败或读写或控制流命令错误，或发现 replica 的 revision 不是最新的，这个 replica 的 mode 就被设置为 ERR 不再读写</div><div class="notion-text notion-block-12a5cdc8ab434bb8b1f686b36052524b">Manager 中的 monitor 会定时请求 Engine 中处理控制流的 grpc server 获取其所有的 replica 信息，更新到 Engine CR 的 status 中。因此当在 Manager 中的 Engine Controller 对该 Engin CR 进行 reconcile 时就能检测到 replica 处于 ERR mode 或不存在，调用 Engine 触发 rebuild</div><div class="notion-blank notion-block-a729190e0c854c5dafebd900206f656c"> </div><div class="notion-text notion-block-a55f5c5f9ae54823bde01f309bb0d7d0">V1 Engine 的 rebuild 最终执行了 AddReplica Task，所以 rebuild 实际上流程和新增 replica 一致</div><ul class="notion-list notion-list-disc notion-block-5385dda74bc54d37a1fddff3b825b70e"><li>Engine 在创建新 replica 之前，会先对其他 replica 打一个快照，然后创建一个 WO（仅写入）模式的新 replica，因此它马上就可以接收写入</li></ul><ul class="notion-list notion-list-disc notion-block-badafa3bb61f439bb6af239a9545bd51"><li>然后从已有的 replica 中将 <code class="notion-inline-code">diffDisk</code> 的元数据和剩下 snapshot 给 sync 过去。在 sync 完成后，通知 Engine 重新检验合法性，此时 replica 正式可用，设置回 RW 模式，启动对新 replica 的心跳</li></ul><div class="notion-text notion-block-895459d5394d4433857a0b297e72f044">这里在打完快照后，新 replica 的写入就全都在 head/live data 上了，写入是安全的。snapshot 的 sync 在后台异步进行，利用了 <code class="notion-inline-code">diffDisk</code> 的特性和快照实现了在线 rebuild</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-aa4a49657412479ab0459d4061d971fe"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F4984c535-3b59-4ae9-b363-c56f764adf27%2FUntitled.png?table=block&amp;id=aa4a4965-7412-479a-b045-9d4061d971fe&amp;t=aa4a4965-7412-479a-b045-9d4061d971fe&amp;width=1056&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-e6a2ecb92ae64051801d13b4a3aa0ffc"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-f492b362aba24373bcfd1865eeda3ea6" data-id="f492b362aba24373bcfd1865eeda3ea6"><span><div id="f492b362aba24373bcfd1865eeda3ea6" class="notion-header-anchor"></div><a class="notion-hash-link" href="#f492b362aba24373bcfd1865eeda3ea6" title="File storage"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">File storage</span></span></h2><div class="notion-text notion-block-688603097b4a488a8c2c74cabaa7cfad">Longhorn 提供的 CSI 不支持 Block PVC 的 RWX 挂载，因为块层无法感知更高层（文件系统）的写入模式和内容，多个 client 写入就会把挂载的文件系统元数据写坏。为了支持 RWX 的 PVC，Longhorn 额外通过 Share Manager 组件提供了文件存储。这里有意思的是，它不叫 Filesystem Manager 而是叫 Share Manager，可以看出是完全以 K8s 视角考虑的</div><div class="notion-blank notion-block-fe2898a8b32542b0b198071835532d84"> </div><div class="notion-text notion-block-216da7e2fe814906b1222f304a5dfca4">当创建 RWX 的 volume （Longhorn 的 CR，非 PVC）时，Manager 中 volume controller 会创建对应的 share manager CR。share manager controller 再创建 share manager pod 并修改 volume 让其实际挂载在这个 share manager pod 的节点上</div><div class="notion-text notion-block-157938c8dd74469496dd340cfd82336e">controller 检测到 pod 启动之后，就会给其发起 RPC 请求将 <code class="notion-inline-code">/dev/longhorn/{vol_name}</code> 块设备格式化为指定文件系统挂载到 <code class="notion-inline-code">/export/{vol_name}</code> 中</div><div class="notion-text notion-block-5124f1f3028f4cc9a6a07ab9f3274d8e">share manager 内运行了一个 nfs ganesha，作为 NFS server。最后 share manager 更新 nfs ganesha 配置，将 <code class="notion-inline-code">/export/{vol_name}</code> 导出</div><div class="notion-text notion-block-8855c8717ddb4bbc9a853acae891457c">share manager 和 volume 的 status 在 controller reconcile 中被更新，设置 NFS 连接信息，现在 CSI 就可以获取到 NFS 连接配置，完成最终的用户 Pod 挂载流程</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-30cca0e43eeb464483e6a121dc1ec3a0"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:624px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F634f0ba3-651c-4cb3-ade9-b46c64d446bb%2FUntitled.png?table=block&amp;id=30cca0e4-3eeb-4644-83e6-a121dc1ec3a0&amp;t=30cca0e4-3eeb-4644-83e6-a121dc1ec3a0&amp;width=1248&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-1cef134c94214c29ac92dbc7771ddd4f"> </div><div class="notion-text notion-block-eb6f16d4ea0d4932b61ca1c85055695c">这里 NFS server 是一个单点的 gateway。为了故障恢复，Longhorn 修改 nfs ganesha 添加了一个新的 recovery backend 类型 longhorn，这个定制的 recovery backend 的作用是将 nfs ganesha 的内部状态信息存储到 K8s ConfigMap 中</div><div class="notion-text notion-block-ca9b37503b20433a85b5877a4f3e51ad">当发生故障，新的 share manager pod 被创建出来后，nfs ganesha 就能从 ConfigMap 中恢复状态，nfs client 可以配置一定宽限期，此时再重试请求就能成功，恢复运行</div><div class="notion-blank notion-block-b5e2e343a9a746b7a31bb5fa4b7a04ec"> </div><div class="notion-text notion-block-d376ba71b271424d8060d08d2e53d349">实际上 NFS server 可以配置 active/active（多活）和 active/passive（主备） 模式。这样恢复速度能比等待重建快得多，可以做到高可用，但目前看起来在这套架构上并不好实现</div><div class="notion-text notion-block-27e019a04b364049bf72944745e9ac6c">首先这里 NFS server 本身就是跑在 iSCSI 块设备上的，无法处理多 client 写入，这就回到一开始的情况了，因此无法做到 active/active。而 Engine 则限制了必须和 Pod 在同一节点上，目前不支持存在一个备用的 Engine 连接同样的 Replica，自然也无法做到 active/passive</div><div class="notion-blank notion-block-8dc4380a3dbf41d09ceab0af03074b40"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-c02bf5693f054580b098f52d09297f11" data-id="c02bf5693f054580b098f52d09297f11"><span><div id="c02bf5693f054580b098f52d09297f11" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c02bf5693f054580b098f52d09297f11" title="V2 Engine"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">V2 Engine</span></span></h2><div class="notion-text notion-block-0abfa26040794ca88d4602c04448568c">V2 Engine 使用了 SPDK，基本是复用了 SPDK 自带的功能，Go 只是调用来创建，不会再直接处理 I/O，性能应该能得到很大提高。V2 Engine 目前还是 preview feature，一些功能支持的不完善，例如扩容</div><div class="notion-blank notion-block-e8b93937f7b8427ab87bf8c4800bcd91"> </div><div class="notion-text notion-block-6b50d50962704f2e958767eb032c21d6">在 V2 Engine 上，总体设计也类似于 V1 Engine，Engine 连接多个 Replica。Replica 就是一个 SPDK 的 lvol bdev（逻辑卷），还包括一个 NVMf Target 将 bdev 暴露出去。剩下的例如精简配置、快照等功能都是 SPDK 自身已经支持的，直接通过 JSON-RPC 调用即可</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-44824160de3d43d5a6c9915fdffdaf24"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Facdac30c-0f7c-4d5d-a678-43c4dfb4897b%2FUntitled.png?table=block&amp;id=44824160-de3d-43d5-a6c9-915fdffdaf24&amp;t=44824160-de3d-43d5-a6c9-915fdffdaf24&amp;width=1440&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-text notion-block-dfc590a4a8c84edd898232d3a8e5c77b">Replica 已经暴露了 NVMf bdev，Engine 同样通过 SPDK 连接到每个 Replica 的 NVMf bdev，再组成 RAID1 bdev，这样又利用了 SPDK 直接实现了多副本，最后暴露出 NVMf Target 给 client 连接</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-6e079fd554fa4c0f8fd99c090bea781e"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:528px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fdcf8bbf2-409a-4d6c-bff0-bf9dc67fdcc1%2FUntitled.png?table=block&amp;id=6e079fd5-54fa-4c0f-8fd9-9c090bea781e&amp;t=6e079fd5-54fa-4c0f-8fd9-9c090bea781e&amp;width=1056&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-fb0a3e9fce5c4c3aaf83b31a9fe55903"> </div><div class="notion-text notion-block-f4b352ddcaba43ae9a316b09879a3ab0">由于并不插手 I/O 流程，这里的容错处理稍微被动些。健康检查不再是心跳，而是定期（3s）获取 replica 上的 SPDK bdev 列表，在这个过程中更新一些统计数据。当 bdev 不存在或信息不一致时，就会设置为 ERR mode 让其 rebuild</div><div class="notion-text notion-block-8800227d91f7445580535c8e5cceb673">V2 Engine 中 rebuild 和 add replica 流程和 V1 Engine 大体类似：</div><ol start="1" class="notion-list notion-list-numbered notion-block-2dbe78ddc4294bc69720ca89ee62ecf0"><li>首先打快照，然后让新的 replica 直接通过 NVMf 连接源 replica 的 bdev，作为 external snapshot 创建新的 lvol bdev</li></ol><ol start="2" class="notion-list notion-list-numbered notion-block-51eb40a690404a438505b0b2ab13876d"><li>回到 V2 Engine，现在新 replica 的 lvol bdev 已经存在了，可以连接并添加到 RAID1 bdev 中。虽然这时也给新 replica 设置了 WO mode，但 Engine 已经不在 I/O 流程中了 管不着，SPDK 仍然可能从新的 bdev 中读，SPDK 能正确处理，但会有一定性能下降</li></ol><ol start="3" class="notion-list notion-list-numbered notion-block-42b416728d6e4431aa2caf3e688887fd"><li>虽然新 replica 的 bdev 中已经有了完整数据（RAID1 bdev 会自动处理），但它上面并没有源 replica 上那些历史快照链，还需要一个恢复快照链的过程。这里会再创建一个新的 rebuilding lvol，使用 shallow copy 将源 replica 的快照一层层 copy 过去，每 copy 完一层就给 rebuilding lvol 打一次快照。这样从头给 rebuilding lvol 构建历史快照链</li></ol><ol start="4" class="notion-list notion-list-numbered notion-block-f43a75e3a93649ef96504ce452c81e7c"><li>最后再将第 1 步中的新 lvol 的 parent 从 external snapshot 改为 rebuilding lvol</li></ol><div class="notion-blank notion-block-912714e5daaa4647b3b17413e3f0da44"> </div><div class="notion-text notion-block-d32b007e23384eb7858b3d37620a8c83">V2 Engine 的模式让我想起了 Kafka，Kafka 虽然是 Java 实现，但实际上 Java 本身没有做太多 key path 上的数据处理，而是 offload 到 kernel 去做，避免了 Java 的性能劣势。从这个角度来说，Kafka 的数据面更像一个细粒度的对 kernel 的控制面。Longhorn 的 V2 Engine 也是如此，基本就是对 SPDK 的控制面</div><div class="notion-blank notion-block-39530a36f3764bb18113d7206968fa8d"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-87890865c79542519af29a263964d1bb" data-id="87890865c79542519af29a263964d1bb"><span><div id="87890865c79542519af29a263964d1bb" class="notion-header-anchor"></div><a class="notion-hash-link" href="#87890865c79542519af29a263964d1bb" title="Performance"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Performance</span></span></h2><div class="notion-text notion-block-9207b00ddbac48199deaf25292352e0d">看一下性能，benchmark 可以看到，V1 Engine 的性能比较差，也在预期之内。不过这里测试用的 SSD 比较一般，完全没发挥出 SPDK 的性能，但到了那种程度网络也是瓶颈了，Longhorn 目前还不支持 RDMA</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-7c84041259194a47bf3b2417b4e8b9a8"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F79cf5471-dca4-4a90-a6ee-9ec25beb9771%2FUntitled.png?table=block&amp;id=7c840412-5919-4a47-bf3b-2417b4e8b9a8&amp;t=7c840412-5919-4a47-bf3b-2417b4e8b9a8&amp;width=1416&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-9374f8ca0db046d68a44bd8f825d731e"> </div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-7c1c4ce94e1943d786b56207c665bbf9"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2F22ca52d1-17b5-4860-aa1b-4da95b25cc58%2FUntitled.png?table=block&amp;id=7c1c4ce9-4e19-43d7-86b5-6207c665bbf9&amp;t=7c1c4ce9-4e19-43d7-86b5-6207c665bbf9&amp;width=2304&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-0ecfb0baa0474a58ac8155cb200e0303"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:100%;max-width:100%;flex-direction:column;height:100%"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Fe9c48585-311b-4ce5-a5c7-3c73dabcbc57%2FUntitled.png?table=block&amp;id=0ecfb0ba-a047-4a58-ac81-55cb200e0303&amp;t=0ecfb0ba-a047-4a58-ac81-55cb200e0303&amp;width=2304&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-3061abd76d2b46b6b730aa48e3f77b10"> </div><h2 class="notion-h notion-h1 notion-h-indent-0 notion-block-686b62651ca14dfbb625582ee5e0884a" data-id="686b62651ca14dfbb625582ee5e0884a"><span><div id="686b62651ca14dfbb625582ee5e0884a" class="notion-header-anchor"></div><a class="notion-hash-link" href="#686b62651ca14dfbb625582ee5e0884a" title="Summary"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">Summary</span></span></h2><div class="notion-text notion-block-5f3918d4e456458aa4f31d9cae3ccefb">总的来说，Longhorn 架构简洁，基于简单朴素的想法构建，又很好地复用了已有的成熟组件，无论是基于 K8s 的控制面，还是 V1 Engine 中的 sparse file，tgtd，nfs ganesha，V2 Engine 的 SPDK，都是这种想法的体现。使用起来也很友好</div><div class="notion-text notion-block-6d3d53a8874b4d2a8fa421e088da8416">缺点是一旦有舒适区内无法满足的需求，就会比较麻烦。例如现在已经修改了 tgtd 和 nfs ganesha，但这种零碎的修改又很难维护，特别是 SPDK 不是简单包装一下就可以产品化的，这在未来可能会是一个挑战。另外，存算融合也可能会导致负载互相影响，进一步降低性能，控制面的调度收敛速度估计也受限于 K8s，万卷规模时各种 CR 可能就数十万个了，而 etcd 还是单 Raft Group 的，瓶颈明显</div><div class="notion-blank notion-block-9d6ff8c0b08d4ba59e8710d7409735b8"> </div><div class="notion-text notion-block-9ab0b35f84744bdaab456c0090f7e85a">后续可以考虑的优化点不少，首先存储层就不支持 chunk/block 之类的 partition，这直接限制了单个卷能提供的容量，而且没有细粒度的 partition，容错和调度都会不够灵活。现在 rebuild 都是全量的，不仅影响速度，在大卷时这样的流量对集群也有压力。最后是一些业务功能，例如 QoS 等比较刚需的还不支持</div><div class="notion-text notion-block-0c280a677c334976a0cf4f6c5163704c">Longhorn 的性能、扩展性和容错可以说都是很差的，但却仍然有着不少的应用，这不禁让我想起同事说过的一句话：「大部分客户和场景根本不在乎性能，只关注成本、易用性和稳定性」</div><div class="notion-text notion-block-c393f09a44db483dbcb2644c4df77ce0">值得一提的是 Longhorn 的文档写的很不错，大部分 feature 都有详细提案文档和需求来源追溯，这点非常好，还是很适合作为入门学习的分布式存储项目</div><div class="notion-blank notion-block-c069cf00c15644edab96a083efce6fd1"> </div><div class="notion-blank notion-block-2140495bb7044178900ada12d68daed7"> </div><div class="notion-text notion-block-c09c9fd4e8e94e6484bf861b297ba597">Ref：</div><ul class="notion-list notion-list-disc notion-block-1bed0ccdd9574d18aab844bde9182313"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://longhorn.io/docs/1.6.2/concepts/">Longhorn | Architecture and Concepts</a></li></ul><ul class="notion-list notion-list-disc notion-block-98e5ad318f3b4a14aa61430ea78f5412"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/wiki/Architecture-Overview-For-Developers">Architecture Overview For Developers</a></li></ul><ul class="notion-list notion-list-disc notion-block-dadebf59a65e4de4b0872c5d075b1ab5"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://peteryj.github.io/2020/10/11/longhorn-engine-code-analysis/">longhorn-engine 源码分析 - Peter Yang&#x27;s Blog</a></li></ul><ul class="notion-list notion-list-disc notion-block-56a447e1bf3b457bb5ca22cd6ffade12"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/blob/master/enhancements/20221123-local-volume.md">20221123-local-volume.md</a></li></ul><ul class="notion-list notion-list-disc notion-block-f68dbe3d33014bff8b823140ef4fa3e6"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://mp.weixin.qq.com/s/9eFYJ5OFRrShaKJezxV6Bg">Longhorn 的正确使用姿势：如何处理增量 replica 与其中的 snapshot/backup</a></li></ul><ul class="notion-list notion-list-disc notion-block-83198b20b262454698b62893f220808e"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://longhorn.io/docs/1.6.2/nodes-and-volumes/volumes/rwx-volumes/">Longhorn | ReadWriteMany (RWX) Volume</a></li></ul><ul class="notion-list notion-list-disc notion-block-e775ef1a31f542a49a95cef860c10fe3"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/blob/master/enhancements/20201220-rwx-volume-support.md">20201220-rwx-volume-support.md</a></li></ul><ul class="notion-list notion-list-disc notion-block-04a72dc6b4cd42a9b6797b9ed1c9727a"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/blob/d5e8a44104f5e03c310870b47da7c8ab55f671b3/enhancements/20220727-dedicated-recovery-backend-for-rwx-volume-nfs-server.md">20220727-dedicated-recovery-backend-for-rwx-volume-nfs-server.md</a></li></ul><ul class="notion-list notion-list-disc notion-block-e1d05407c2084f5c9af01c1621143b4d"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/blob/master/enhancements/20230619-spdk-engine.md">20230619-spdk-engine.md</a></li></ul><ul class="notion-list notion-list-disc notion-block-cd732eaa43e74483a122e424226f982d"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://spdk.io/doc/logical_volumes.html">SPDK: Logical Volumes</a></li></ul><ul class="notion-list notion-list-disc notion-block-e17fae7a31b64bbdb3255589cf7abcd3"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://spdk.io/doc/nvmf.html">SPDK: NVMe over Fabrics Target</a></li></ul><ul class="notion-list notion-list-disc notion-block-5f63c08e8e7c4c32ab83ecb2a9a3c6e1"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://spdk.io/doc/bdev.html">SPDK: Block Device User Guide</a></li></ul><ul class="notion-list notion-list-disc notion-block-cf49f8d438da47319a0ae82178d7bf33"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/issues/7199">v2 volume replica online rebuilding</a></li></ul><ul class="notion-list notion-list-disc notion-block-e45463e94b21457484b3b20328c00b1e"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://github.com/longhorn/longhorn/blob/b58a7a3849e12fa4674723c1ce0dfe708fd8423a/enhancements/20231030-spdk-raid-delta-copy.md">20231030-spdk-raid-delta-copy.md</a></li></ul><ul class="notion-list notion-list-disc notion-block-22612c4b1c3b468ba2c8af7dacb56a95"><li><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://longhorn.io/docs/1.6.2/v2-data-engine/performance/">Longhorn | Performance</a></li></ul><div class="notion-blank notion-block-5df8b1160c774e2daf6a52a44b086766"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Infra 窘境]]></title>
        <id>https://xxxuuu.me/post/infra-dilemma</id>
        <link href="https://xxxuuu.me/post/infra-dilemma"/>
        <updated>2024-09-03T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[前段时间秋招也陆续开始了，偶尔有师弟问我不想写业务，怎么才能做 infra，其实我是劝退的。算下来我毕业正式工作也一年多了，趁机从个人角度发表点暴论]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-5b4b2d8543c04edbad2d0f14d79b4c4b"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><div class="notion-text notion-block-819b6cb6cfd84ea59e645366b52e4e9b">前段时间秋招也陆续开始了，偶尔有师弟问我不想写业务，怎么才能做 infra，其实我是劝退的。算下来我毕业正式工作也一年多了，趁机从个人角度发表点暴论（这里的 infra 实际上特指数据库/存储）</div><div class="notion-blank notion-block-fc558d59e1a649e095cd261be111e956"> </div><div class="notion-text notion-block-6e3495364132471e967442c57f5d4710">毕业以来就一直在一家存储公司里打杂。这一年好像学了很多，但又感觉都是些细枝末节的无用知识，个人并没有什么实际性的提升</div><div class="notion-text notion-block-2aaa738ac1664e93806381fc454ce7d1">首先，infra 并没有想象中那么「酷」，对于成熟系统来说架构和功能都趋向稳定，需要自己设计的新地方已经很少，没有太多能发挥的空间，很多时候都是在修 bug，当客服，排查奇奇怪怪的问题或是优化某处实现。新人不可避免地要做很多 dirty work，比如数据库的 MySQL/Oracle 兼容，存储的协议语义等，这些工作都是枯燥无聊的</div><div class="notion-blank notion-block-88c8b690f5934065803105aec32b12cb"> </div><div class="notion-text notion-block-a6fb4ebd5b4644e1a8ed3e68507528de">而且新人也很难在短时间内能 own 一个模块，这主要有两个原因，一个是技术层面的，系统过于复杂，涉及的组件众多。很长一段时间里只能自底向上地看待系统，只关注部分细节，缺乏自顶向下的全局性的视角和思考，这却是在系统设计来说更重要的东西。最后就会变成：能知道系统「是这么做的」，但不知道「为什么要这么做」，所以也无法回答「应该怎么做」</div><div class="notion-text notion-block-97b7fe7aea184fe8aac3046637006f9f">但设计时必须全面地看待和考虑系统，各部分如何组合出最佳实践？就像最近刷到的一篇<a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://youjiali1995.github.io/essay/2021-summary/">文章</a>中提到的，没有工程经验，这导致我们并不清楚最佳实践是怎么样的。这种情况下，为产品添加的每一行代码都是「债务」而不是「产出」，久而久之就会腐化产品，这对 infra 项目来说是致命的</div><div class="notion-blank notion-block-89f06418aba947f8926edfe9892d7669"> </div><div class="notion-text notion-block-216c1d94409244369f0ca98f33945b58">另一个是产品层面，什么是用户真正需要的？举个例子，很多数据库内核的校招新人，即使对存储引擎、查询优化、事务管理等技术如数家珍，但实际上作为数据库用户还是小白，甚至并没有怎么实际用过数据库。这种情况下写出的很多东西是和需求脱节的，没有意义。而大部分 infra 工作由于技术门槛的存在，没有像互联网业务中那样正式的「产品经理」角色，大都是研发一人分饰两角，自己写 PRD，你能想象让几乎没有用过数据库的人去给用户设计数据库功能吗</div><div class="notion-text notion-block-d71f8bc393284299a55a1c9ea967c8bc">这种对「系统如何被使用」不够了解有时候还会反过来导致错误的设计，例如 OLTP 和 OLAP 场景的数据库需要专门优化的点肯定不一样，设计错误就会带来高昂的技术债</div><div class="notion-blank notion-block-fe609c14d16843e99e3f79b3dd20e5f9"> </div><div class="notion-text notion-block-6b64eb53ca0845ebb0d13f1d19a97e5a">很多东西不是看一遍 DDIA 或刷完 MIT6.824，CMU 15-445 就能做好的。需要对系统有足够的认知，接触足够多的系统，了解不同的设计场景和思路。这些都是很多新人包括我面临的问题，为了摆脱这种闭门造车的情况，自己之后也需要做更多的案例研究和论文阅读。看看别人是怎么做的，为什么要这么做，如何一步步演进，进行了哪些取舍。这部分也算是我今年的任务了，起码得再<s>水</s>输出四五篇文章</div><div class="notion-blank notion-block-cea0e58e3280408c91df1945263170e5"> </div><div class="notion-text notion-block-40fbe68c60954ceb83baaebf912d7115">最后，再谈谈行业。从钱来说，infra 并不代表更高的薪资水平，也不代表更高的稳定性。相反，在很多互联网公司里，infra 部门是无法赚钱的，只会被视为「成本」。这意味着当存在盈利压力时，infra 部门被裁员的风险只会更高，并不会有想象中技术护城河带来的稳定和不可替代性</div><div class="notion-text notion-block-041c0240a7f84064b1ba2fa2315644e3">infra 产品本身就是业务的公司，日子也不好过。国内这类公司大部分还是吃信创饭的，有信创需求的都是政府、国企、事业单位和学校，在这个连体制内都降本增效都经济环境下，旧系统能跑就行，新的采购、升级和维护都越来越少。不少公司寄希望于疫情结束后的收入回升，但疫情后反而进一步下降的收入也成了最后一根稻草</div><div class="notion-text notion-block-fda6bbe206fd43ba9ac24f634a8d122a">行业另一个特点是又难又卷，很多东西做到如今早已满足市场需求，再继续做下去已经没有太多意义，无法为用户创造更多价值，比如几个 benchmark 榜单上的数字。但各家仍然在不断消耗大量人力物力刷榜，让投入产出完全不成正比，某种程度上甚至把这变成了一个劳动密集行业。这也说明已经很难有创新了，没太多可做的东西，但这也不只是工业界的问题，VLDB，FAST 上的论文相比二十年前也并没有太多理论创新</div><div class="notion-text notion-block-5e9394ce5aee4e8cb5692a16c39d6a4e">前几年如日中天的 PingCAP 去年进行了大规模裁员，让业内哀鸿遍野。要是连 PingCAP 都不行的话，其他公司又该怎么办呢？我们公司也一样，虽然侥幸逃过去年的裁员，但那天办公室里死一般的寂静仍令人印象深刻（题外话，裁员当天友商 HR 就加上脉脉了，风声传得真快）</div><div class="notion-blank notion-block-7ef41dfa1aea429ba574f678ac1db56a"> </div><div class="notion-text notion-block-a76333bce75b4ca58d1850735d766a42">但纵使有这么多缺点，在如今看来不是一个「聪明」的选择，也仍然想做 infra 的话，只能有一个原因：Just for fun。就像 saka 老师在这张图里说的一样：</div><figure class="notion-asset-wrapper notion-asset-wrapper-image notion-block-2e2d110fab394244a1d3db33fab12b4b"><div style="position:relative;display:flex;justify-content:center;align-self:center;width:576px;max-width:100%;flex-direction:column"><img style="object-fit:cover" src="https://www.notion.so/image/https%3A%2F%2Fprod-files-secure.s3.us-west-2.amazonaws.com%2F4cc04375-345a-4a1e-bdf0-3a7c88ef0425%2Ff4b09812-f6f6-4838-8c70-349046b1faef%2Fimage.png?table=block&amp;id=2e2d110f-ab39-4244-a1d3-db33fab12b4b&amp;t=2e2d110f-ab39-4244-a1d3-db33fab12b4b&amp;width=1152&amp;cache=v2" alt="notion image" loading="lazy" decoding="async"/></div></figure><div class="notion-blank notion-block-94130dea86f541b98b5a534c0981e111"> </div></main></div>]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[从 Linux 内核看读写锁设计]]></title>
        <id>https://xxxuuu.me/post/kernel-rwlock</id>
        <link href="https://xxxuuu.me/post/kernel-rwlock"/>
        <updated>2024-01-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[前段时间看了《Linux内核设计与实现》，第 10 章「内核同步方法」中提到了几种内核中的读写锁。它们分别代表了几种比较典型的读写锁设计，非常值得学习，这里记录一下，讨论是基于 2.6 内核和 x86 体系结构的基础上进行的]]></summary>
        <content type="html"><![CDATA[<div id="notion-article" class="mx-auto overflow-hidden "><main class="notion light-mode notion-page notion-block-0e96a78edec94620b0e8a2b889017cb7"><div class="notion-viewport"></div><div class="notion-collection-page-properties"></div><div class="notion-text notion-block-2bb0e815dc844c369fe60a51dff19bc3">前段时间看了《Linux内核设计与实现》，第 10 章「内核同步方法」中提到了几种内核中的读写锁。它们分别代表了几种比较典型的读写锁设计，非常值得学习，这里记录一下，讨论是基于 2.6 内核和 x86 体系结构的基础上进行的</div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-647ee4a179d744bd809ebc915f053b47" data-id="647ee4a179d744bd809ebc915f053b47"><span><div id="647ee4a179d744bd809ebc915f053b47" class="notion-header-anchor"></div><a class="notion-hash-link" href="#647ee4a179d744bd809ebc915f053b47" title="读/写自旋锁"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">读/写自旋锁</span></span></h3><div class="notion-text notion-block-4b004ed92c304b2491f538a1bf165989">内核代码中，要定义读/写自旋锁，通过下面的宏进行初始化：</div><div class="notion-text notion-block-86cec0d34f304dabb46572a6d90f7d70">使用上读锁和写锁是分开加锁的</div><div class="notion-text notion-block-1dffa3a0d7754fd3a8408610c872efcc"><b>不能</b>像这样将一个读锁升级成写锁，这会导致死锁；并且写锁也是不可重入的：</div><div class="notion-blank notion-block-d7fa72a46a5e410bbadb6dc9fb0cf9ae"> </div><div class="notion-text notion-block-102b3b4241e84393a6ff53455f411da9">读/写自旋锁的汇编级别实现比较类似信号量，都是在寄存器上对值做增减，但为了区分读锁和写锁，读锁是固定减 1，写锁则是固定减去一个很大的 magic number，通过结果值比较就能判断锁持有情况</div><div class="notion-text notion-block-c3e8a162f3d24a4b82a8fd03688ddefa">代码分别位于 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/rwlock.h">include/asm-x86_64/rwlock.h</a> 和 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/spinlock.h">/include/asm-x86_64/spinlock.h</a> 中，这两块涉及的核心代码融合一下大致如下：</div><div class="notion-text notion-block-6f7e2be4462c428cb4c88412234fcea8">可以看出，读/写自旋锁是<b>读优先</b>的，会导致写饥饿。当有一个或多个读者持有读锁时，写操作无法获取锁，如果此时读锁被长时间占有，写锁将一直自旋等待，此时自旋会导致一个核心上的高昂开销</div><div class="notion-blank notion-block-b1d421c31168448ca86fe631622f546c"> </div><div class="notion-text notion-block-2c7c25c292784825b76d7ba231153a54">这里有一个处理上的细节，在真正开始自旋获取到写锁之前，就已经互斥了（减去 magic number），这时候新的读锁是无法获取的，这避免了写锁和读锁的争抢，能稍微缓解下写饥饿问题，例如这样的情况：</div><div class="notion-blank notion-block-8aa14d553d484a2d8e28614ac870aeb2"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-c2cf730048ea4931b18b4897a8af5cce" data-id="c2cf730048ea4931b18b4897a8af5cce"><span><div id="c2cf730048ea4931b18b4897a8af5cce" class="notion-header-anchor"></div><a class="notion-hash-link" href="#c2cf730048ea4931b18b4897a8af5cce" title="读/写信号量"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">读/写信号量</span></span></h3><div class="notion-text notion-block-ebdbc9bda7a04ddb9613f4dd61fda07c">读/写信号量的使用上和读/写自旋锁是类似的，但功能上要强大一些，分别支持静态和动态的初始化方法</div><div class="notion-text notion-block-013143f21be043ea9c9d64f6da3e886f">读/写信号量支持 trylock 操作和动态地将写锁降级为读锁</div><div class="notion-blank notion-block-5498661b8f52481eb32ebaeddb9ed4b7"> </div><div class="notion-text notion-block-879748e36969413782ab57c7def4e3a3"><a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://elixir.bootlin.com/linux/v2.6.0/source/include/asm-x86_64/rwsem.h#L99">include/asm-x86_64/rwsem.h</a> 中定义了汇编级别上的实现，和前面读/写自旋锁是类似的，但没有自旋，这里就不细说，内核源码这里也直接附带注释了：</div><div class="notion-blank notion-block-dc9da1ee7b0f407a965de94eef946f0c"> </div><div class="notion-text notion-block-b77e7413135e4ef09bb67ebe7a8d8689">信号量是睡眠锁，读锁和写锁在获取锁失败时最后都会进入到 <code class="notion-inline-code">rwsem_down_failed_common</code>（位于 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://elixir.bootlin.com/linux/v2.6.0/source/lib/rwsem.c#L123">lib/rwsem.c</a>） 中，这里会将进程加入等待队列中，然后重新调度进程</div><div class="notion-blank notion-block-ed8985cc2e1642c885f5f8f327348a46"> </div><div class="notion-text notion-block-c4aa4ccdcdc946308911870731a73f0d">值得一提的是 <code class="notion-inline-code">trylock</code> 和 <code class="notion-inline-code">downgrade_write</code> 操作，这两个操作是读/写自旋锁中没有的</div><div class="notion-text notion-block-dae97109d781472cb1d094851ac8120d">两个 <code class="notion-inline-code">trylock</code> 是类似的，都是用 <code class="notion-inline-code">cmpxchg</code> 指令来做 CAS（compare-and-swap） 操作。写锁的 <code class="notion-inline-code">trylock</code> 比较简单，因为是互斥的，所以只需要对初始值做 CAS 即可。而读锁可能被持有多个，所以它的 <code class="notion-inline-code">trylock</code> 需要先将 <code class="notion-inline-code">sem-&gt;count</code> 赋值给 <code class="notion-inline-code">tmp</code>，再自增 <code class="notion-inline-code">tmp</code> ，利用 <code class="notion-inline-code">tmp</code> 的值进行 CAS</div><div class="notion-text notion-block-df5219d69a7b4da68f3105ce4522a251">downgrade_write 的实现则类似写锁解锁，然后判断是否有必要唤醒等待队列中的项，这里其实和写锁解锁（<code class="notion-inline-code">up_write</code>）的主要差别就是给 <code class="notion-inline-code">sem-&gt;count</code> 加上的偏移量少了 1（可以回去看前面几个 <code class="notion-inline-code">RWSEM_</code> 开头的宏定义），而这个 1 就是读锁占的值</div><div class="notion-text notion-block-f12b26e9c32b4674bb18108035373cf4">总结一下，读/写信号量和读/写自旋锁类似，两者语义上是相同的，也都是读优先的，只不过信号量是睡眠锁，当有长时间获取不到锁的情况时，不会导致过多的 CPU 开销</div><div class="notion-blank notion-block-2c290ddc1e4f497fb028492ba05e539c"> </div><h3 class="notion-h notion-h2 notion-h-indent-0 notion-block-9c431ea8a9674ec9bbc62f1fc28400c8" data-id="9c431ea8a9674ec9bbc62f1fc28400c8"><span><div id="9c431ea8a9674ec9bbc62f1fc28400c8" class="notion-header-anchor"></div><a class="notion-hash-link" href="#9c431ea8a9674ec9bbc62f1fc28400c8" title="顺序锁"><svg viewBox="0 0 16 16" width="16" height="16"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a><span class="notion-h-title">顺序锁</span></span></h3><div class="notion-text notion-block-e0a16190e65d494083044360e1625439">顺序锁和前面两者有个重要的区别，顺序锁是<b>写优先</b>的，让我们来分析下它是如何实现的</div><div class="notion-text notion-block-54b51ac190e140798b178b1fc7b51361">首先还是使用方式上：</div><div class="notion-text notion-block-8e70c46377804396bfa10b65ffd519ec">一个使用例子是内核的 jiffies，它存储了机器启动到当前的时钟节拍，每次时钟中断时都会更新这个值，所以是一个高频写入的场景，<code class="notion-inline-code">get_jiffies_64()</code> 函数用来获取这个值，它的实现是这样的</div><div class="notion-text notion-block-963410a7643048b0af0650842568d3d8">顺序锁在读取时需要一个循环，这是为了判断在这个过程中是否有发生写入，如果没有，那么读取就是安全的，否则需要重试</div><div class="notion-text notion-block-fbb1a5463ea64df0a75af8e459aefd24">实现上，代码位于 <a target="_blank" rel="noopener noreferrer" class="notion-link" href="https://elixir.bootlin.com/linux/v2.6.0/source/include/linux/seqlock.h#L50">/include/linux/seqlock.h</a>，有比较清晰的注释：</div><div class="notion-text notion-block-e1ceebcbe6cf4f64a8fa180e805617b0">可以看到，顺序锁是基于一个自旋锁实现的。但额外依赖一个序列计数器，当获取写锁时，这个序列值会增加。读取数据时要先调用 <code class="notion-inline-code">read_seqbegin</code>，它会返回这个序列值，读取完成后通过 <code class="notion-inline-code">read_seqretry</code> 检查传入的值 <code class="notion-inline-code">iv</code>，满足以下两个条件则说明读是安全的：</div><ul class="notion-list notion-list-disc notion-block-fdec602b399c4734a4c472b535503bf0"><li>如果 <code class="notion-inline-code">iv</code> 是偶数（初始值为 0，写锁会加 1）则说明不是处在一个写操作进行的过程中</li></ul><ul class="notion-list notion-list-disc notion-block-399a4b9319bc41d5a5a92ff777f2c419"><li><code class="notion-inline-code">iv</code> 和序列值相同（相同值异或结果为 0）说明没有写操作发生过</li></ul><div class="notion-text notion-block-1b1540ef43d84bd9b8b7ac09aae8cc9a">这两者都满足，读取的值就是有效的</div><div class="notion-blank notion-block-5d14d1fafd424b7dad2e108131fe5fbf"> </div><div class="notion-text notion-block-fef94772957044878c6f47791d9601df">所以，顺序锁是一种<b>乐观锁</b>，是不存在「读锁」的，而是通过类似版本号的机制来读，因此只要没有其他写者，随时都可以获取到写锁，以此实现写优先</div></main></div>]]></content>
    </entry>
</feed>